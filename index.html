<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CamCom Annotation Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg:#f1f5f9;--sur:#fff;--sur2:#f7fafc;--brd:#e2e8f0;
  --tx:#0f172a;--tx2:#475569;--tx3:#94a3b8;
  --red:#df1e26;--red-d:#b91c1c;--red-l:#fff1f2;
  --blue:#2563eb;--blue-l:#eff6ff;
  --green:#16a34a;--green-l:#f0fdf4;
  --yellow:#d97706;--yel-l:#fffbeb;
  --purple:#7c3aed;--pur-l:#f5f3ff;
  --sh:0 4px 24px rgba(15,23,42,.08);--sh-sm:0 1px 6px rgba(15,23,42,.06);
  --r:14px;--rsm:9px;--rp:999px;
}
[data-theme="dark"]{
  --bg:#0d1117;--sur:#161b22;--sur2:#21262d;--brd:#30363d;
  --tx:#f0f6fc;--tx2:#8b949e;--tx3:#484f58;
  --red-l:#2a0d0f;--blue-l:#1e2d40;--green-l:#0a1f0e;--yel-l:#1f1400;--pur-l:#1a1130;
  --sh:0 4px 24px rgba(0,0,0,.4);--sh-sm:0 1px 6px rgba(0,0,0,.3);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--tx);font-family:'Inter',sans-serif;min-height:100vh;}
/* SIDEBAR */
.layout{display:flex;min-height:100vh;}
.sidebar{width:252px;background:var(--sur);border-right:1px solid var(--brd);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;overflow-y:auto;}
.logo-wrap{padding:16px 16px 14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px;}
.logo-svg{width:40px;height:40px;flex-shrink:0;border-radius:5px;overflow:hidden;}
.logo-text strong{font-family:'Space Grotesk',sans-serif;font-size:.92rem;font-weight:700;color:var(--red);display:block;line-height:1.2;}
.logo-text span{font-size:.62rem;color:var(--tx3);display:block;margin-top:1px;}
.nav-grp{padding:12px 14px 4px;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--tx3);}
.nav-btn{display:flex;align-items:center;gap:9px;padding:9px 12px;margin:1px 6px;border-radius:var(--rsm);cursor:pointer;font-size:.83rem;font-weight:500;color:var(--tx2);border:none;background:none;width:calc(100% - 12px);text-align:left;font-family:'Inter',sans-serif;transition:all .15s;}
.nav-btn:hover{background:var(--sur2);color:var(--tx);}
.nav-btn.active{background:var(--red-l);color:var(--red);font-weight:600;}
.nav-btn i{width:15px;text-align:center;font-size:.8rem;}
.nbadge{margin-left:auto;background:var(--red);color:#fff;font-size:.6rem;padding:1px 6px;border-radius:20px;font-weight:700;}
.nav-divider{height:1px;background:var(--brd);margin:6px 14px;}
.sidebar-foot{margin-top:auto;padding:12px;border-top:1px solid var(--brd);}
.theme-btn{display:flex;align-items:center;gap:8px;font-size:.8rem;color:var(--tx2);cursor:pointer;padding:7px 10px;border-radius:var(--rsm);background:none;border:none;width:100%;font-family:'Inter',sans-serif;}
.theme-btn:hover{background:var(--sur2);}
/* MAIN */
.main{margin-left:252px;flex:1;padding:22px 24px;max-width:calc(100% - 252px);}
.page{display:none;}.page.active{display:block;}
/* TOPBAR */
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap;}
.pg-title{font-family:'Space Grotesk',sans-serif;font-size:1.45rem;font-weight:700;}
.topbar-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.sbox{display:flex;align-items:center;gap:7px;background:var(--sur);border:1px solid var(--brd);border-radius:var(--rp);padding:7px 14px;min-width:195px;}
.sbox input{border:none;background:none;outline:none;color:var(--tx);font-family:inherit;font-size:.83rem;width:100%;}
.sbox i{color:var(--tx3);font-size:.8rem;}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:8px 16px;border-radius:var(--rp);font-size:.82rem;font-weight:600;cursor:pointer;border:1px solid transparent;font-family:'Inter',sans-serif;transition:all .15s;}
.btn-red{background:var(--red);color:#fff;}.btn-red:hover{background:var(--red-d);}
.btn-ghost{background:var(--sur);color:var(--tx2);border-color:var(--brd);}.btn-ghost:hover{background:var(--sur2);color:var(--tx);}
.btn-green{background:var(--green-l);color:var(--green);border-color:var(--green);}.btn-green:hover{background:var(--green);color:#fff;}
.btn-blue{background:var(--blue-l);color:var(--blue);border-color:var(--blue);}.btn-blue:hover{background:var(--blue);color:#fff;}
.btn-sm{padding:5px 11px;font-size:.74rem;}
.iBtn{width:28px;height:28px;border-radius:7px;border:none;background:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;font-size:.76rem;transition:all .15s;}
.iBtn:hover{background:var(--sur2);color:var(--tx);}
.iBtn.del:hover{background:var(--red-l);color:var(--red);}
/* STATS */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:12px;margin-bottom:20px;}
.sc{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:16px;box-shadow:var(--sh-sm);position:relative;overflow:hidden;}
.sc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--red);}
.sc.b::before{background:var(--blue);}.sc.g::before{background:var(--green);}.sc.y::before{background:var(--yellow);}.sc.p::before{background:var(--purple);}.sc.r::before{background:var(--red);}
.sc-l{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);margin-bottom:4px;}
.sc-v{font-family:'Space Grotesk',sans-serif;font-size:1.75rem;font-weight:700;line-height:1;}
.sc-s{font-size:.68rem;color:var(--tx3);margin-top:4px;}
/* FILTER BAR */
.fbar{display:flex;gap:7px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
.fc{padding:5px 12px;border-radius:var(--rp);font-size:.75rem;font-weight:500;cursor:pointer;border:1px solid var(--brd);background:var(--sur);color:var(--tx2);transition:all .15s;}
.fc:hover,.fc.on{background:var(--red-l);border-color:var(--red);color:var(--red);}
.fc.hi{border-color:#dc2626;color:#dc2626;background:#fff1f1;}.fc.hi.on{background:#dc2626;color:#fff;}
.fc.me{border-color:var(--yellow);color:var(--yellow);background:var(--yel-l);}.fc.me.on{background:var(--yellow);color:#fff;}
.fc.lo{border-color:var(--green);color:var(--green);background:var(--green-l);}.fc.lo.on{background:var(--green);color:#fff;}
select.fsel{padding:5px 11px;border-radius:var(--rp);font-size:.75rem;border:1px solid var(--brd);background:var(--sur);color:var(--tx2);outline:none;cursor:pointer;font-family:'Inter',sans-serif;}
/* CONFLICT BANNER */
.cbanner{display:flex;align-items:center;gap:8px;padding:9px 14px;background:var(--red-l);border:1px solid #fca5a5;border-radius:var(--rsm);color:#dc2626;font-size:.78rem;font-weight:600;margin-bottom:16px;}

/* ‚ïê‚ïê‚ïê‚ïê PROJECT CARDS ‚ïê‚ïê‚ïê‚ïê */
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(295px,1fr));gap:14px;}
.pcard{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);box-shadow:var(--sh-sm);cursor:pointer;position:relative;overflow:hidden;transition:all .2s;}
.pcard:hover{box-shadow:var(--sh);transform:translateY(-2px);border-color:var(--red);}
.pcard-stripe{height:3px;}
.pcard-stripe.high{background:linear-gradient(90deg,#dc2626,#f87171);}
.pcard-stripe.medium{background:linear-gradient(90deg,#d97706,#fbbf24);}
.pcard-stripe.low{background:linear-gradient(90deg,#16a34a,#4ade80);}
.pcard-body{padding:14px 14px 10px;}
.pcard-title{font-family:'Space Grotesk',sans-serif;font-size:.95rem;font-weight:700;margin-bottom:6px;line-height:1.3;}
.pcard-meta{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px;align-items:center;}
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--rp);font-size:.64rem;font-weight:700;text-transform:uppercase;}
.bh{background:#fee2e2;color:#dc2626;}.bm{background:#fef3c7;color:#d97706;}.bl{background:#dcfce7;color:#16a34a;}
.mpill{font-size:.66rem;color:var(--tx3);display:flex;align-items:center;gap:3px;}
.mpill.ov{color:#dc2626;}.mpill.sn{color:var(--yellow);}
.pcard-prog{margin-bottom:9px;}
.prog-r{display:flex;justify-content:space-between;margin-bottom:3px;}
.prog-l{font-size:.63rem;color:var(--tx3);}
.prog-p{font-size:.63rem;font-weight:700;color:var(--tx2);}
.pbar{height:4px;background:var(--sur2);border-radius:10px;overflow:hidden;border:1px solid var(--brd);}
.pf{height:100%;border-radius:10px;transition:width .4s;}
.pf-a{background:var(--blue);}.pf-r{background:var(--green);}
.pcard-foot{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;border-top:1px solid var(--brd);background:var(--sur2);}
.avatars{display:flex;} 
.av{width:22px;height:22px;border-radius:50%;color:#fff;font-size:.52rem;font-weight:700;display:flex;align-items:center;justify-content:center;border:2px solid var(--sur);margin-left:-4px;flex-shrink:0;}
.av:first-child{margin-left:0;}
.av.m{background:var(--blue);}.av.f{background:var(--purple);}
.av.more{background:var(--tx3);}
.hint-txt{font-size:.62rem;color:var(--tx3);display:flex;align-items:center;gap:3px;}
.kanban-col-badge{font-size:.63rem;padding:2px 7px;border-radius:var(--rp);font-weight:600;}

/* ‚ïê‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê‚ïê */
.dp-overlay{position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:200;opacity:0;pointer-events:none;transition:opacity .25s;}
.dp-overlay.open{opacity:1;pointer-events:all;}
.dp{position:fixed;top:0;right:0;bottom:0;width:640px;max-width:95vw;background:var(--sur);box-shadow:-8px 0 40px rgba(15,23,42,.15);transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:201;display:flex;flex-direction:column;}
.dp.open{transform:translateX(0);}
.dp-hdr{padding:16px 20px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:flex-start;flex-shrink:0;}
.dp-title{font-family:'Space Grotesk',sans-serif;font-size:1.1rem;font-weight:700;line-height:1.3;}
.dp-close{width:30px;height:30px;border-radius:7px;border:none;background:var(--sur2);color:var(--tx2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.82rem;transition:all .15s;}
.dp-close:hover{background:var(--red-l);color:var(--red);}
.dp-body{flex:1;overflow-y:auto;}
.dp-sec{padding:14px 20px;border-bottom:1px solid var(--brd);}
.dp-sec:last-child{border-bottom:none;}
.ds-hdr{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);margin-bottom:9px;display:flex;align-items:center;gap:5px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.inf label{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--tx3);display:block;margin-bottom:3px;}
.inf input,.inf select,.inf textarea{width:100%;padding:7px 10px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-family:'Inter',sans-serif;font-size:.82rem;outline:none;}
.inf input:focus,.inf select:focus,.inf textarea:focus{border-color:var(--red);}
.num-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;}
.nc{background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);padding:7px 5px;text-align:center;}
.nc input{width:100%;border:none;background:none;outline:none;font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:.9rem;color:var(--tx);text-align:center;}
.nc-l{font-size:.58rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.3px;margin-top:2px;}
.nc.comp{background:var(--blue-l);border-color:var(--blue);}
.nc.comp .ncv{font-weight:700;font-size:.9rem;font-family:'Space Grotesk',sans-serif;color:var(--blue);}
.nc.comp2{background:var(--green-l);border-color:var(--green);}
.nc.comp2 .ncv{color:var(--green);}
.tgt-row{display:flex;align-items:center;gap:8px;background:var(--yel-l);border:1px solid #fde68a;border-radius:var(--rsm);padding:9px 12px;margin-top:9px;}
.tgt-row i{color:var(--yellow);}
.tgt-row label{font-size:.76rem;font-weight:600;color:var(--yellow);}
.tgt-row input{max-width:90px;padding:4px 8px;border:1px solid #fde68a;border-radius:var(--rsm);background:#fff;color:var(--tx);font-family:'Inter',sans-serif;font-size:.82rem;outline:none;}
/* emp search in detail */
.esbox{display:flex;align-items:center;gap:7px;background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);padding:7px 11px;margin-bottom:7px;}
.esbox input{border:none;background:none;outline:none;color:var(--tx);font-family:inherit;font-size:.81rem;width:100%;}
.e-results{max-height:150px;overflow-y:auto;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur);}
.e-row{display:flex;justify-content:space-between;align-items:center;padding:7px 11px;border-bottom:1px solid var(--brd);transition:background .1s;}
.e-row:last-child{border-bottom:none;}
.e-row:hover{background:var(--sur2);}
.e-name{font-size:.81rem;font-weight:500;}
.e-sub{font-size:.66rem;color:var(--tx3);}
.e-sub.warn{color:var(--yellow);}.e-sub.taken{color:#dc2626;}
.atags{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;}
.atag{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:var(--rp);font-size:.71rem;font-weight:500;background:var(--blue-l);border:1px solid var(--blue);color:var(--blue);}
.atag.cc{background:#fee2e2;border-color:#dc2626;color:#dc2626;}
.atag button{background:none;border:none;color:inherit;cursor:pointer;font-size:.6rem;opacity:.7;}
.atag button:hover{opacity:1;}
/* upload */
.upzone{border:2px dashed var(--brd);border-radius:var(--rsm);padding:14px;text-align:center;cursor:pointer;position:relative;transition:all .2s;}
.upzone:hover{border-color:var(--red);background:var(--red-l);}
.upzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;}
.upzone i{font-size:1.3rem;color:var(--tx3);margin-bottom:5px;display:block;}
.upzone p{font-size:.76rem;color:var(--tx3);}
.doclist{display:flex;flex-direction:column;gap:5px;margin-top:8px;}
.docitem{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);}
.docitem i{color:var(--red);font-size:.82rem;}
.doc-n{font-size:.77rem;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.doc-s{font-size:.63rem;color:var(--tx3);}
.doc-rm{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:.73rem;padding:2px;}
.doc-rm:hover{color:#dc2626;}
/* comments */
.cmt-ta{width:100%;padding:8px 11px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-family:'Inter',sans-serif;font-size:.81rem;resize:vertical;min-height:65px;outline:none;}
.cmt-ta:focus{border-color:var(--red);}

/* ‚ïê‚ïê‚ïê‚ïê KANBAN ‚ïê‚ïê‚ïê‚ïê */
.kanban-wrap{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;min-height:500px;}
.kb-col{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);display:flex;flex-direction:column;min-height:400px;}
.kb-hdr{padding:12px 14px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center;}
.kb-col-title{font-family:'Space Grotesk',sans-serif;font-size:.88rem;font-weight:700;}
.kb-count{font-size:.7rem;padding:2px 8px;border-radius:var(--rp);font-weight:600;}
.col-todo .kb-hdr{border-top:3px solid var(--tx3);border-radius:var(--r) var(--r) 0 0;}
.col-todo .kb-count{background:var(--sur2);color:var(--tx3);}
.col-inprog .kb-hdr{border-top:3px solid var(--blue);border-radius:var(--r) var(--r) 0 0;}
.col-inprog .kb-count{background:var(--blue-l);color:var(--blue);}
.col-review .kb-hdr{border-top:3px solid var(--yellow);border-radius:var(--r) var(--r) 0 0;}
.col-review .kb-count{background:var(--yel-l);color:var(--yellow);}
.col-done .kb-hdr{border-top:3px solid var(--green);border-radius:var(--r) var(--r) 0 0;}
.col-done .kb-count{background:var(--green-l);color:var(--green);}
.kb-cards{flex:1;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:100px;}
.kb-cards.drag-over{background:rgba(37,99,235,.06);border-radius:var(--rsm);}
.kb-card{background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);padding:10px 12px;cursor:grab;user-select:none;transition:all .15s;}
.kb-card:hover{box-shadow:var(--sh-sm);border-color:var(--red);}
.kb-card.dragging{opacity:.5;transform:rotate(1deg);}
.kb-card-title{font-size:.82rem;font-weight:600;margin-bottom:5px;line-height:1.3;}
.kb-card-meta{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
.kb-pct{font-size:.66rem;color:var(--tx3);}
.kb-empty{text-align:center;padding:20px;color:var(--tx3);font-size:.76rem;}

/* ‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;}
.chart-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;box-shadow:var(--sh-sm);}
.chart-title{font-family:'Space Grotesk',sans-serif;font-size:.9rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.chart-wrap{position:relative;height:220px;}

/* ‚ïê‚ïê‚ïê‚ïê GANTT ‚ïê‚ïê‚ïê‚ïê */
.gantt-wrap{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;box-shadow:var(--sh-sm);overflow-x:auto;}
.gantt-table{min-width:800px;width:100%;}
.gantt-head{display:flex;border-bottom:1px solid var(--brd);padding-bottom:8px;margin-bottom:8px;}
.gantt-name-col{width:200px;flex-shrink:0;font-size:.68rem;font-weight:700;text-transform:uppercase;color:var(--tx3);}
.gantt-timeline{flex:1;display:flex;gap:0;}
.gantt-month{flex:1;font-size:.65rem;font-weight:600;color:var(--tx3);text-align:center;}
.gantt-row{display:flex;align-items:center;padding:5px 0;border-bottom:1px solid var(--brd);}
.gantt-row:last-child{border-bottom:none;}
.gantt-row:hover{background:var(--sur2);}
.gantt-proj-name{width:200px;flex-shrink:0;font-size:.8rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:10px;}
.gantt-bar-area{flex:1;position:relative;height:24px;}
.gantt-bar{position:absolute;height:18px;top:3px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:600;color:#fff;overflow:hidden;white-space:nowrap;min-width:4px;}
.gantt-bar.high{background:linear-gradient(90deg,#dc2626,#f87171);}
.gantt-bar.medium{background:linear-gradient(90deg,#d97706,#fbbf24);}
.gantt-bar.low{background:linear-gradient(90deg,#16a34a,#4ade80);}
.gantt-bar.overdue{background:linear-gradient(90deg,#7f1d1d,#dc2626);border:1px dashed #fff;}
.today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--red);opacity:.7;z-index:2;}

/* ‚ïê‚ïê‚ïê‚ïê EMPLOYEES TABLE ‚ïê‚ïê‚ïê‚ïê */
.tbl-wrap{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh-sm);}
table{width:100%;border-collapse:collapse;}
th{background:var(--sur2);padding:9px 13px;font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);text-align:left;border-bottom:1px solid var(--brd);}
td{padding:9px 13px;font-size:.81rem;border-bottom:1px solid var(--brd);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--sur2);}
.st-f{color:var(--tx3);font-size:.7rem;}.st-a{color:var(--green);font-weight:600;font-size:.7rem;}.st-c{color:#dc2626;font-weight:700;font-size:.7rem;}
.gm{color:var(--blue);font-size:.7rem;font-weight:600;}.gf{color:var(--purple);font-size:.7rem;font-weight:600;}

/* ‚ïê‚ïê‚ïê‚ïê WORKLOAD ‚ïê‚ïê‚ïê‚ïê */
.wl-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;box-shadow:var(--sh-sm);}
.wl-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--brd);gap:10px;flex-wrap:wrap;}
.wl-row:last-child{border-bottom:none;}
.wl-n{font-weight:600;font-size:.85rem;min-width:155px;}
.wl-p{color:var(--tx3);font-size:.74rem;flex:1;}
.wl-bw{width:140px;}

/* ‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.setting-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;display:flex;justify-content:space-between;align-items:center;}
.setting-info strong{font-size:.9rem;display:block;margin-bottom:3px;}
.setting-info span{font-size:.75rem;color:var(--tx2);}
.toggle-sw{position:relative;width:44px;height:24px;flex-shrink:0;}
.toggle-sw input{opacity:0;width:0;height:0;}
.toggle-sl{position:absolute;inset:0;background:var(--brd);border-radius:12px;cursor:pointer;transition:.2s;}
.toggle-sl:before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 4px rgba(0,0,0,.2);}
.toggle-sw input:checked+.toggle-sl{background:var(--green);}
.toggle-sw input:checked+.toggle-sl:before{transform:translateX(20px);}

/* ‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê */
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.5);display:flex;align-items:center;justify-content:center;z-index:300;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--sur);border-radius:18px;padding:22px;width:540px;max-width:95vw;box-shadow:0 20px 60px rgba(15,23,42,.2);transform:translateY(14px);transition:transform .2s;max-height:90vh;overflow-y:auto;}
.overlay.open .modal{transform:translateY(0);}
.modal-title{font-family:'Space Grotesk',sans-serif;font-size:1.05rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.ff{display:flex;flex-direction:column;gap:4px;}
.ff.full{grid-column:1/-1;}
.ff label{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--tx3);}
.ff input,.ff select,.ff textarea{padding:7px 11px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-family:'Inter',sans-serif;font-size:.83rem;outline:none;}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--red);}
.modal-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--brd);}
.tgl-row{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);}
.tgl-lbl{font-size:.8rem;font-weight:500;color:var(--tx2);}
.tgt-fw{margin-top:7px;padding:9px 12px;background:var(--yel-l);border:1px solid #fde68a;border-radius:var(--rsm);display:none;align-items:center;gap:8px;}
.tgt-fw.show{display:flex;}
.tgt-fw label{font-size:.74rem;font-weight:600;color:var(--yellow);white-space:nowrap;}
.tgt-fw input{flex:1;max-width:130px;padding:5px 9px;border:1px solid #fde68a;border-radius:var(--rsm);background:#fff;color:var(--tx);font-family:'Inter',sans-serif;font-size:.82rem;outline:none;}

/* TOAST + LOADING */
.toasts{position:fixed;bottom:20px;right:20px;z-index:999;display:flex;flex-direction:column;gap:6px;}
.toast{background:var(--sur);border:1px solid var(--brd);border-radius:10px;padding:9px 14px;font-size:.79rem;box-shadow:var(--sh);display:flex;align-items:center;gap:6px;animation:tIn .2s ease;max-width:270px;}
.toast.ok{border-color:var(--green);color:var(--green);}.toast.err{border-color:#dc2626;color:#dc2626;}.toast.info{border-color:var(--blue);color:var(--blue);}
@keyframes tIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
#lovl{position:fixed;inset:0;background:rgba(15,23,42,.55);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:#fff;gap:12px;}
.spin{width:40px;height:40px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:sp .75s linear infinite;}
@keyframes sp{to{transform:rotate(360deg)}}
.empty-st{text-align:center;padding:45px 20px;color:var(--tx3);}
.empty-st i{font-size:2rem;margin-bottom:9px;display:block;}

/* SECTION TABS */
.section-tabs{display:flex;gap:0;border-bottom:1px solid var(--brd);margin-bottom:20px;}
.stab{padding:9px 18px;font-size:.83rem;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--tx2);transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:'Inter',sans-serif;}
.stab:hover{color:var(--tx);}
.stab.on{color:var(--red);border-bottom-color:var(--red);font-weight:600;}

@media(max-width:900px){.charts-grid{grid-template-columns:1fr;}.kanban-wrap{grid-template-columns:1fr 1fr;}}
@media(max-width:768px){.sidebar{transform:translateX(-100%);}.main{margin-left:0;max-width:100%;padding:14px;}.proj-grid{grid-template-columns:1fr;}.kanban-wrap{grid-template-columns:1fr;}.settings-grid{grid-template-columns:1fr;}}

/* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
#loginScr{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0f172a 0%,#1a1060 50%,#0f172a 100%);}
.lcard{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:22px;
  padding:36px 40px;width:400px;max-width:95vw;backdrop-filter:blur(20px);
  box-shadow:0 32px 80px rgba(0,0,0,.6);}
.lcard-logo{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:24px;}
.lcard-logo svg{width:46px;height:46px;border-radius:7px;}
.lcard-logo-txt strong{font-family:'Space Grotesk',sans-serif;font-size:1.2rem;font-weight:700;color:#fff;display:block;}
.lcard-logo-txt span{font-size:.65rem;color:rgba(255,255,255,.45);display:block;}
.lcard h2{font-family:'Space Grotesk',sans-serif;font-size:1rem;font-weight:700;color:#fff;text-align:center;margin-bottom:4px;}
.lcard p{font-size:.76rem;color:rgba(255,255,255,.45);text-align:center;margin-bottom:24px;}
.lf{display:flex;flex-direction:column;gap:4px;margin-bottom:13px;}
.lf label{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.35);}
.lf input,.lf select{padding:10px 13px;border:1px solid rgba(255,255,255,.12);border-radius:9px;
  background:rgba(255,255,255,.07);color:#fff;font-family:'Inter',sans-serif;font-size:.86rem;outline:none;transition:border-color .15s;}
.lf input::placeholder{color:rgba(255,255,255,.2);}
.lf input:focus,.lf select:focus{border-color:var(--red);}
.lf select option{background:#1a1060;color:#fff;}
.lbtn{width:100%;padding:11px;background:var(--red);border:none;border-radius:9px;color:#fff;
  font-family:'Space Grotesk',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:background .15s;margin-top:4px;}
.lbtn:hover{background:var(--red-d);}
.lerr{color:#f87171;font-size:.76rem;text-align:center;margin-top:7px;min-height:18px;}
.ldiv{display:flex;align-items:center;gap:9px;margin:16px 0;}
.ldiv::before,.ldiv::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.1);}
.ldiv span{font-size:.68rem;color:rgba(255,255,255,.3);}
.demo-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.dbtn{padding:9px 8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
  border-radius:8px;color:rgba(255,255,255,.65);font-family:'Inter',sans-serif;font-size:.73rem;cursor:pointer;transition:all .15s;text-align:center;}
.dbtn:hover{background:rgba(255,255,255,.13);color:#fff;}
.dbtn .dname{font-weight:700;display:block;margin-bottom:2px;}
.dbtn .dsub{font-size:.6rem;opacity:.55;}

/* ‚ïê‚ïê‚ïê RBAC UI ‚ïê‚ïê‚ïê */
.user-chip{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--rsm);background:var(--sur2);border:1px solid var(--brd);margin-bottom:6px;}
.user-av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.62rem;font-weight:700;flex-shrink:0;}
.user-name{font-size:.79rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.logout-btn{background:none;border:none;cursor:pointer;color:var(--tx3);font-size:.8rem;padding:3px 5px;border-radius:5px;transition:all .15s;}
.logout-btn:hover{color:var(--red);background:var(--red-l);}
.role-pill{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--rp);font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
.rp-admin{background:#fee2e2;color:#dc2626;}
.rp-manager{background:var(--blue-l);color:var(--blue);}
.rp-reviewer{background:var(--yel-l);color:var(--yellow);}
.rp-employee{background:var(--green-l);color:var(--green);}

/* ‚ïê‚ïê‚ïê USERS TABLE ‚ïê‚ïê‚ïê */
.users-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.user-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:16px;display:flex;align-items:center;gap:12px;box-shadow:var(--sh-sm);}
.user-card-av{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.78rem;font-weight:700;flex-shrink:0;}
.user-card-info{flex:1;min-width:0;}
.user-card-info strong{font-size:.88rem;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-card-info span{font-size:.72rem;color:var(--tx2);display:block;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-card-actions{display:flex;gap:4px;flex-shrink:0;}

/* ‚ïê‚ïê‚ïê MIGRATION ALERT ‚ïê‚ïê‚ïê */
.migbanner{background:#1e1b4b;border:1px solid #6366f1;border-radius:var(--r);padding:16px 20px;margin-bottom:18px;}
.migbanner h4{color:#c7d2fe;font-size:.9rem;margin-bottom:6px;}
.migbanner p{color:rgba(199,210,254,.7);font-size:.78rem;margin-bottom:10px;}
.migbanner code{display:block;background:rgba(0,0,0,.4);border-radius:7px;padding:10px 14px;
  font-size:.78rem;color:#a5b4fc;white-space:pre;overflow-x:auto;margin-bottom:10px;line-height:1.6;}
</style>
</head>
<body>
<div id="lovl" style="display:none;"><div class="spin"></div><div style="font-size:.93rem;font-weight:600;">Loading CamCom data...</div></div>
<div class="toasts" id="toasts"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScr">
  <div class="lcard">
    <div class="lcard-logo">
      <svg viewBox="36 37 397 397" xmlns="http://www.w3.org/2000/svg">
        <rect fill="#df1e26" x="36.8" y="37.3" width="395.7" height="395.7"/>
        <path fill="#fff" d="M139,216.4c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.7c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.8,4.2-4.2,9.1-7.6,14.7-10,5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2-.7,1.5-1.9,2.3-3.4,2.7-1.5.4-2.9.2-4.3-.5-2.6-1.6-5.5-2.7-8.4-3.5s-6-1.2-9.3-1.2c-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5.8,1.4,1.1,2.7.7,4.2s-1.2,2.6-2.5,3.6c-7.6,4.4-15.9,6.8-24.9,6.8"/>
        <path fill="#fff" d="M267.6,208.2c.6,1.5.7,2.8.2,4.2s-1.5,2.4-2.8,3c-1.4.6-2.8.7-4.3.2-1.4-.5-2.4-1.5-3.2-2.8l-9.9-21.2h-25.1c-1.6,0-2.9-.5-4-1.6s-1.6-2.3-1.6-4,.5-2.8,1.6-3.9,2.3-1.6,4-1.6h19.9l-17.6-37.5-30.8,69.7c-.5,1.1-1.2,1.9-2.1,2.4s-1.9.8-3,.8-1.5-.1-2.3-.4c-1.4-.6-2.4-1.7-2.9-3.2-.5-1.4-.5-2.8.2-4.2l36-80.8c.4-1.1,1.1-1.8,2-2.4s1.9-.8,3-.8,2.1.3,3,.8,1.6,1.3,2,2.3l37.8,80.9Z"/>
        <path fill="#fff" d="M371.3,216c-1.5,0-2.7-.5-3.8-1.6s-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4s-1.9.9-2.9.9-2.1-.3-3-.8-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-1.1,1.8-1.6,3-1.9s2.4-.1,3.6.4,2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1,1.1-2.4,1.6-3.9,1.6"/>
        <path fill="#fff" d="M139,348.5c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.8c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.7s9.1-7.6,14.7-10c5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2s-1.9,2.3-3.4,2.7-2.9.2-4.3-.5c-2.6-1.6-5.5-2.7-8.4-3.5-2.9-.7-6-1.2-9.3-1.2-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5s1.1,2.7.7,4.2-1.2,2.6-2.5,3.6c-7.6,4.5-15.9,6.8-24.9,6.8"/>
        <path fill="#fff" d="M371.3,348.2c-1.5,0-2.7-.5-3.8-1.7-1.1-1.1-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4-.8.6-1.9.9-2.9,1.1-1.1,0-2.1-.3-3-.8-.9-.6-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6c-1.1-1.1-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-.9,1.8-1.7,3-1.9,1.3-.2,2.4-.1,3.6.4s2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1.9-2.4,1.6-3.9,1.6"/>
      </svg>
      <div class="lcard-logo-txt"><strong>CamCom</strong><span>Annotation Tracker</span></div>
    </div>
    <h2>Sign in to your account</h2>
    <p>Enter your credentials to access the platform</p>
    <div class="lf"><label>Email</label><input type="email" id="li-email" placeholder="you@camcom.ai" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <div class="lf"><label>Password</label><input type="password" id="li-pwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="lbtn" onclick="doLogin()"><i class="fas fa-sign-in-alt"></i> Sign In</button>
    <div class="lerr" id="loginErr"></div>
    <div class="ldiv"><span>Quick demo access</span></div>
    <div class="demo-grid">
      <button class="dbtn" onclick="quickLogin('admin')"><span class="dname">üëë Admin</span><span class="dsub">admin@camcom.ai / admin123</span></button>
      <button class="dbtn" onclick="quickLogin('manager')"><span class="dname">üîµ Manager</span><span class="dsub">manager@camcom.ai / mgr123</span></button>
      <button class="dbtn" onclick="quickLogin('reviewer')"><span class="dname">üü° Reviewer</span><span class="dsub">reviewer@camcom.ai / rev123</span></button>
      <button class="dbtn" onclick="quickLogin('employee')"><span class="dname">üü¢ Employee</span><span class="dsub">My assigned projects only</span></button>
    </div>
  </div>
</div>

<div class="layout">
<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<aside class="sidebar">
  <div class="logo-wrap">
    <!-- Fixed logo: viewBox crops to just the red square + CAM text, no footer text -->
    <svg class="logo-svg" viewBox="36 37 397 397" xmlns="http://www.w3.org/2000/svg">
      <rect fill="#df1e26" x="36.8" y="37.3" width="395.7" height="395.7"/>
      <path fill="#fff" d="M139,216.4c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.7c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.8,4.2-4.2,9.1-7.6,14.7-10,5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2-.7,1.5-1.9,2.3-3.4,2.7-1.5.4-2.9.2-4.3-.5-2.6-1.6-5.5-2.7-8.4-3.5s-6-1.2-9.3-1.2c-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5.8,1.4,1.1,2.7.7,4.2s-1.2,2.6-2.5,3.6c-7.6,4.4-15.9,6.8-24.9,6.8"/>
      <path fill="#fff" d="M267.6,208.2c.6,1.5.7,2.8.2,4.2s-1.5,2.4-2.8,3c-1.4.6-2.8.7-4.3.2-1.4-.5-2.4-1.5-3.2-2.8l-9.9-21.2h-25.1c-1.6,0-2.9-.5-4-1.6s-1.6-2.3-1.6-4,.5-2.8,1.6-3.9,2.3-1.6,4-1.6h19.9l-17.6-37.5-30.8,69.7c-.5,1.1-1.2,1.9-2.1,2.4s-1.9.8-3,.8-1.5-.1-2.3-.4c-1.4-.6-2.4-1.7-2.9-3.2-.5-1.4-.5-2.8.2-4.2l36-80.8c.4-1.1,1.1-1.8,2-2.4s1.9-.8,3-.8,2.1.3,3,.8,1.6,1.3,2,2.3l37.8,80.9Z"/>
      <path fill="#fff" d="M371.3,216c-1.5,0-2.7-.5-3.8-1.6s-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4s-1.9.9-2.9.9-2.1-.3-3-.8-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-1.1,1.8-1.6,3-1.9s2.4-.1,3.6.4,2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1,1.1-2.4,1.6-3.9,1.6"/>
      <path fill="#fff" d="M139,348.5c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.8c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.7s9.1-7.6,14.7-10c5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2s-1.9,2.3-3.4,2.7-2.9.2-4.3-.5c-2.6-1.6-5.5-2.7-8.4-3.5-2.9-.7-6-1.2-9.3-1.2-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5s1.1,2.7.7,4.2-1.2,2.6-2.5,3.6c-7.6,4.5-15.9,6.8-24.9,6.8"/>
      <path fill="#fff" d="M371.3,348.2c-1.5,0-2.7-.5-3.8-1.7-1.1-1.1-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4-.8.6-1.9.9-2.9,1.1-1.1,0-2.1-.3-3-.8-.9-.6-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6c-1.1-1.1-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-.9,1.8-1.7,3-1.9,1.3-.2,2.4-.1,3.6.4s2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1.9-2.4,1.6-3.9,1.6"/>
    </svg>
    <div class="logo-text"><strong>CamCom</strong><span>Annotation Tracker</span></div>
  </div>
  <div class="nav-grp">Main</div>
  <button class="nav-btn active" data-page="dashboard" onclick="switchPage('dashboard')"><i class="fas fa-th-large"></i> Dashboard</button>
  <button class="nav-btn" data-page="projects" onclick="switchPage('projects')"><i class="fas fa-folder-open"></i> All Projects <span class="nbadge" id="nb-p">0</span></button>
  <button class="nav-btn" data-page="kanban" onclick="switchPage('kanban')"><i class="fas fa-columns"></i> Kanban Board</button>
  <button class="nav-btn" data-page="analytics" onclick="switchPage('analytics')"><i class="fas fa-chart-pie"></i> Analytics</button>
  <button class="nav-btn" data-page="employees" onclick="switchPage('employees')"><i class="fas fa-users"></i> Employees <span class="nbadge" id="nb-e">0</span></button>
  <button class="nav-btn" data-page="workload" onclick="switchPage('workload')"><i class="fas fa-chart-bar"></i> Workload</button>
  <div class="nav-grp">Actions</div>
  <button class="nav-btn" onclick="openNewProj()"><i class="fas fa-plus-circle"></i> New Project</button>
  <button class="nav-btn" onclick="openEmpModal()"><i class="fas fa-user-plus"></i> Add Employee</button>
  <button class="nav-btn" onclick="exportCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
  <button class="nav-btn" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
  <div class="nav-divider"></div>
  <button class="nav-btn" data-page="settings" onclick="switchPage('settings')"><i class="fas fa-cog"></i> Feature Settings</button>
  <button class="nav-btn" data-page="users" id="nav-users" style="display:none" onclick="switchPage('users')"><i class="fas fa-user-shield"></i> Manage Users</button>
  <div class="sidebar-foot">
    <div class="user-chip" id="userChip">
      <div class="user-av" id="userAv" style="background:var(--red)">?</div>
      <div style="flex:1;min-width:0;">
        <div class="user-name" id="userName">‚Äî</div>
        <div id="userRole"></div>
      </div>
      <button class="logout-btn" onclick="doLogout()" title="Sign out"><i class="fas fa-sign-out-alt"></i></button>
    </div>
    <button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-moon" id="tIco"></i><span id="tLbl">Dark mode</span></button>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<main class="main">

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard">
  <div class="topbar">
    <h1 class="pg-title">Dashboard</h1>
    <div class="topbar-r">
      <div class="sbox"><i class="fas fa-search"></i><input type="text" placeholder="Search projects..." id="gSearch" oninput="handleSearch()"></div>
      <button class="btn btn-red" onclick="openNewProj()"><i class="fas fa-plus"></i> New Project</button>
    </div>
  </div>
  <div class="stat-grid" id="statGrid"></div>
  <div id="cBanner" style="display:none;" class="cbanner"><i class="fas fa-exclamation-triangle"></i><span id="cTxt"></span><button class="btn btn-ghost btn-sm" style="margin-left:auto;" onclick="switchPage('employees')">View ‚Üí</button></div>
  <div class="fbar">
    <span style="font-size:.67rem;color:var(--tx3);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Filter:</span>
    <button class="fc on" onclick="setFilter('all',this)">All</button>
    <button class="fc hi" onclick="setFilter('high',this)"><i class="fas fa-fire"></i> High</button>
    <button class="fc me" onclick="setFilter('medium',this)">‚ö° Medium</button>
    <button class="fc lo" onclick="setFilter('low',this)"><i class="fas fa-leaf"></i> Low</button>
    <select class="fsel" id="sortSel" onchange="renderProjects()">
      <option value="default">Sort: Default</option>
      <option value="name">Name A‚ÄìZ</option>
      <option value="progress">Progress ‚Üë</option>
      <option value="deadline">Deadline ‚Üë</option>
      <option value="priority">Priority</option>
    </select>
  </div>
  <div class="proj-grid" id="projGrid"></div>
</div>

<!-- ALL PROJECTS -->
<div class="page" id="page-projects">
  <div class="topbar">
    <h1 class="pg-title">All Projects</h1>
    <div class="topbar-r">
      <div class="sbox"><i class="fas fa-search"></i><input type="text" placeholder="Search projects..." id="projSearch" oninput="renderProjFull()"></div>
      <button class="btn btn-green btn-sm" onclick="exportCSV()"><i class="fas fa-file-csv"></i> CSV</button>
      <button class="btn btn-red" onclick="openNewProj()"><i class="fas fa-plus"></i> New Project</button>
    </div>
  </div>
  <div class="proj-grid" id="projGridFull"></div>
</div>

<!-- KANBAN -->
<div class="page" id="page-kanban">
  <div class="topbar">
    <h1 class="pg-title">Kanban Board</h1>
    <div class="topbar-r">
      <span style="font-size:.78rem;color:var(--tx3);"><i class="fas fa-grip-vertical"></i> Drag cards between columns</span>
      <button class="btn btn-red" onclick="openNewProj()"><i class="fas fa-plus"></i> New Project</button>
    </div>
  </div>
  <div class="kanban-wrap" id="kanbanWrap"></div>
</div>

<!-- ANALYTICS -->
<div class="page" id="page-analytics">
  <div class="topbar"><h1 class="pg-title">Analytics</h1>
    <button class="btn btn-ghost btn-sm" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Export PDF Report</button>
  </div>
  <div class="section-tabs">
    <button class="stab on" onclick="showAnalyticsTab('charts',this)"><i class="fas fa-chart-pie"></i> Charts</button>
    <button class="stab" onclick="showAnalyticsTab('gantt',this)"><i class="fas fa-stream"></i> Timeline / Gantt</button>
    <button class="stab" onclick="showAnalyticsTab('burndown',this)"><i class="fas fa-chart-line"></i> Burndown</button>
  </div>
  <div id="at-charts">
    <div class="charts-grid" id="chartsGrid">
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-pie" style="color:var(--red)"></i> Priority Distribution</div><div class="chart-wrap"><canvas id="priChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Annotation Progress by Project</div><div class="chart-wrap"><canvas id="progChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-donut" style="color:var(--green)"></i> Completion Status</div><div class="chart-wrap"><canvas id="statusChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><i class="fas fa-users" style="color:var(--purple)"></i> Employees Assigned per Project</div><div class="chart-wrap"><canvas id="empChart"></canvas></div></div>
    </div>
  </div>
  <div id="at-gantt" style="display:none;">
    <div class="gantt-wrap"><div class="chart-title"><i class="fas fa-stream" style="color:var(--blue)"></i> Project Timeline (Start ‚Üí Deadline)</div><div class="gantt-table" id="ganttTable"></div></div>
  </div>
  <div id="at-burndown" style="display:none;">
    <div class="chart-card" style="margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
        <div class="chart-title" style="margin-bottom:0;"><i class="fas fa-chart-line" style="color:var(--red)"></i> Burndown Chart</div>
        <select id="burndownSel" class="fsel" onchange="renderBurndown()"><option value="">Select project...</option></select>
      </div>
      <div class="chart-wrap" style="height:300px;"><canvas id="burndownChart"></canvas></div>
    </div>
  </div>
</div>

<!-- EMPLOYEES -->
<div class="page" id="page-employees">
  <div class="topbar"><h1 class="pg-title">Employees</h1>
    <div class="topbar-r">
      <div class="sbox"><i class="fas fa-search"></i><input type="text" placeholder="Search name or email..." id="empSearch" oninput="renderEmps()"></div>
      <button class="btn btn-red" onclick="openEmpModal()"><i class="fas fa-user-plus"></i> Add Employee</button>
    </div>
  </div>
  <div id="empCBanner" style="display:none;" class="cbanner"><i class="fas fa-exclamation-triangle"></i><span id="ecTxt"></span></div>
  <div class="tbl-wrap"><table><thead><tr><th>#</th><th>Full Name</th><th>Email</th><th>Gender</th><th>Status</th><th>Project(s)</th><th></th></tr></thead><tbody id="empTbody"></tbody></table></div>
</div>

<!-- WORKLOAD -->
<div class="page" id="page-workload">
  <div class="topbar"><h1 class="pg-title">Workload Overview</h1></div>
  <div class="wl-card"><div style="font-size:.8rem;color:var(--tx2);margin-bottom:14px;">Employees with at least one project assignment.</div><div id="wlList"></div></div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="topbar"><h1 class="pg-title">Feature Settings</h1></div>
  <p style="font-size:.85rem;color:var(--tx2);margin-bottom:18px;">Toggle features on or off. Disabled features are hidden from the sidebar.</p>
  <div id="migBanner" style="display:none;" class="migbanner">
    <h4><i class="fas fa-database"></i> Database Migration Required</h4>
    <p>Some columns are missing from your Supabase <code>projects</code> table. Run this SQL once in your <strong>Supabase ‚Üí SQL Editor</strong> to fix the save error and unlock all features:</p>
    <code>ALTER TABLE projects
  ADD COLUMN IF NOT EXISTS kanban_status TEXT DEFAULT 'todo',
  ADD COLUMN IF NOT EXISTS has_target    BOOLEAN DEFAULT false,
  ADD COLUMN IF NOT EXISTS daily_target  INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS startdate     TEXT,
  ADD COLUMN IF NOT EXISTS assignedby    TEXT DEFAULT '',
  ADD COLUMN IF NOT EXISTS comments      TEXT DEFAULT '';</code>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('migBanner').style.display='none'">Dismiss</button>
  </div>
  <div class="settings-grid" id="settingsGrid"></div>
</div>

<!-- MANAGE USERS (Admin only) -->
<div class="page" id="page-users">
  <div class="topbar">
    <h1 class="pg-title">Manage Users</h1>
    <button class="btn btn-red" onclick="openUserModal()"><i class="fas fa-user-plus"></i> Add User</button>
  </div>
  <div style="background:var(--blue-l);border:1px solid var(--blue);border-radius:var(--rsm);padding:11px 15px;margin-bottom:18px;font-size:.8rem;color:var(--blue);">
    <strong><i class="fas fa-shield-alt"></i> Role Permissions:</strong>
    &nbsp;üëë <strong>Admin</strong> ‚Äî full access &nbsp;|&nbsp;
    üîµ <strong>Manager</strong> ‚Äî create, edit, assign &nbsp;|&nbsp;
    üü° <strong>Reviewer</strong> ‚Äî read-only, sees all projects &nbsp;|&nbsp;
    üü¢ <strong>Employee</strong> ‚Äî sees only assigned projects
  </div>
  <div class="users-grid" id="usersGrid"></div>
</div>

</main>
</div>

<!-- ‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê -->
<div class="dp-overlay" id="dpOvl" onclick="closeDpBg(event)"></div>
<div class="dp" id="dp">
  <div class="dp-hdr">
    <div><div class="dp-title" id="dpTitle">Project</div><div id="dpMeta" style="margin-top:5px;display:flex;gap:7px;flex-wrap:wrap;"></div></div>
    <button class="dp-close" onclick="closeDP()"><i class="fas fa-times"></i></button>
  </div>
  <div class="dp-body" id="dpBody"></div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: PROJECT ‚ïê‚ïê‚ïê -->
<div class="overlay" id="projOvl" onclick="closeProjOvlBg(event)">
<div class="modal">
  <div class="modal-title"><i class="fas fa-folder-plus" style="color:var(--red)"></i><span id="pMTtl">New Project</span></div>
  <div class="fgrid">
    <div class="ff full"><label>Project name *</label><input type="text" id="np-name" placeholder="e.g. Road Extraction"></div>
    <div class="ff"><label>Priority</label><select id="np-pri"><option value="medium">‚ö° Medium</option><option value="high">üî• High</option><option value="low">üåø Low</option></select></div>
    <div class="ff"><label>Assigned By</label><input type="text" id="np-by" placeholder="Manager name"></div>
    <div class="ff"><label>Start Date</label><input type="date" id="np-start"></div>
    <div class="ff"><label>Deadline</label><input type="date" id="np-dead"></div>
    <div class="ff"><label>Total Images</label><input type="number" id="np-total" value="1000" min="0"></div>
    <div class="ff"><label>Annotated</label><input type="number" id="np-ann" value="0" min="0"></div>
    <div class="ff"><label>Reviewed</label><input type="number" id="np-rev" value="0" min="0"></div>
    <div class="ff"><label>Kanban Status</label><select id="np-status"><option value="todo">üìã To Do</option><option value="inprog">‚ö° In Progress</option><option value="review">üîç Review</option><option value="done">‚úÖ Completed</option></select></div>
    <div class="ff full"><label>Notes</label><textarea id="np-notes" placeholder="Project notes..." style="min-height:48px;"></textarea></div>
    <div class="ff full">
      <div class="tgl-row"><label class="toggle-sw"><input type="checkbox" id="np-tgtOn" onchange="tglTgtField('np')"><span class="toggle-sl"></span></label><span class="tgl-lbl">Set daily image target</span></div>
      <div class="tgt-fw" id="np-tgtFw"><i class="fas fa-bullseye" style="color:var(--yellow)"></i><label>Images / day</label><input type="number" id="np-target" placeholder="e.g. 200" min="1"></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeProjModal()">Cancel</button>
    <button class="btn btn-red" onclick="saveProject()"><i class="fas fa-save"></i> Save Project</button>
  </div>
</div></div>

<!-- ‚ïê‚ïê‚ïê MODAL: EMPLOYEE ‚ïê‚ïê‚ïê -->
<div class="overlay" id="empOvl" onclick="closeEmpOvlBg(event)">
<div class="modal" style="width:400px;">
  <div class="modal-title"><i class="fas fa-user-plus" style="color:var(--red)"></i><span id="eMTtl">Add Employee</span></div>
  <div class="fgrid">
    <div class="ff full"><label>Full Name *</label><input type="text" id="fe-name" placeholder="e.g. Ramyashree V R"></div>
    <div class="ff full"><label>Email ID *</label><input type="email" id="fe-email" placeholder="name@camcom.ai"></div>
    <div class="ff full"><label>Gender</label><select id="fe-gender"><option value="female">‚ôÄ Female</option><option value="male">‚ôÇ Male</option></select></div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeEmpModal()">Cancel</button>
    <button class="btn btn-red" onclick="saveEmployee()"><i class="fas fa-save"></i> Save</button>
  </div>
</div></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL='https://phtzpswuqlixaroxhkmy.supabase.co';
const SB_KEY='sb_publishable_V1bOmccJ0AKXmRyV7bFctg_ka58Wb-L';
const sb=supabase.createClient(SB_URL,SB_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let projects=[];
let employees=[
  {id:'e1',name:'Ramyashree V R',email:'ramyashree@camcom.ai',gender:'female'},
  {id:'e2',name:'Manoj Kumar Devanga Kotha',email:'manoj.devanga@camcom.ai',gender:'male'},
  {id:'e3',name:'Dande Kalyani',email:'dande.kalyani@camcom.ai',gender:'female'},
  {id:'e4',name:'Dande Sandhya',email:'dande.sandhya@camcom.ai',gender:'female'},
  {id:'e5',name:'Challa Koteswaramma',email:'challa.kotes@camcom.ai',gender:'female'},
  {id:'e6',name:'Kadagandla Hariprasad',email:'kadagandla.hari@camcom.ai',gender:'male'},
  {id:'e7',name:'Uma Krishnappa',email:'uma.krishnappa@camcom.ai',gender:'female'},
  {id:'e8',name:'Manjunath Kalakappa Bandihal',email:'manjunath.kb@camcom.ai',gender:'male'},
  {id:'e9',name:'Akshay Phatale',email:'akshay.phatale@camcom.ai',gender:'male'},
  {id:'e10',name:'Maitra Salimath',email:'maitra.salimath@camcom.ai',gender:'female'},
  {id:'e11',name:'Yathish Gowda K H',email:'yathish.gowda@camcom.ai',gender:'male'},
  {id:'e12',name:'Pavan Kalyan Yeddala',email:'pavan.kalyan@camcom.ai',gender:'male'},
  {id:'e13',name:'Sabharmathi Selvam',email:'sabharmathi@camcom.ai',gender:'female'},
  {id:'e14',name:'G Umesh',email:'g.umesh@camcom.ai',gender:'male'},
  {id:'e15',name:'Shilpa E',email:'shilpa.e@camcom.ai',gender:'female'},
  {id:'e16',name:'Prema Joshi',email:'prema.joshi@camcom.ai',gender:'female'},
  {id:'e17',name:'Keerti Doddwad',email:'keerti.doddwad@camcom.ai',gender:'female'},
  {id:'e18',name:'Ajay Reddy H',email:'ajay.reddy@camcom.ai',gender:'male'},
  {id:'e19',name:'Varun Kumar H N',email:'varun.kumar@camcom.ai',gender:'male'},
  {id:'e20',name:'Sneha B V',email:'sneha.bv@camcom.ai',gender:'female'},
  {id:'e21',name:'Fathima Reneesha',email:'fathima.reneesha@camcom.ai',gender:'female'},
  {id:'e22',name:'Vishruthi Raghu',email:'vishruthi.raghu@camcom.ai',gender:'female'},
  {id:'e23',name:'Sanjana G P',email:'sanjana.gp@camcom.ai',gender:'female'},
  {id:'e24',name:'Dhanyasri A S',email:'dhanyasri.as@camcom.ai',gender:'female'},
  {id:'e25',name:'Siddharth Anandan',email:'siddharth.anandan@camcom.ai',gender:'male'},
  {id:'e26',name:'Bindusree S N',email:'bindusree.sn@camcom.ai',gender:'female'},
  {id:'e27',name:'Anil Kumar Pasala',email:'anil.pasala@camcom.ai',gender:'male'},
  {id:'e28',name:'Mihir',email:'mihir@camcom.ai',gender:'male'},
  {id:'e29',name:'Suzan',email:'suzan@camcom.ai',gender:'female'},
  {id:'e30',name:'Umesh Nagappa Barker',email:'umesh.barker@camcom.ai',gender:'male'},
  {id:'e31',name:'Sunil Kumar',email:'sunil.kumar@camcom.ai',gender:'male'},
  {id:'e32',name:'Shanta Mantri',email:'shanta.mantri@camcom.ai',gender:'female'},
  {id:'e33',name:'Nandini Keni',email:'nandini.keni@camcom.ai',gender:'female'},
  {id:'e34',name:'Shweta Kannagar',email:'shweta.kannagar@camcom.ai',gender:'female'},
  {id:'e35',name:'Kishore Devaragudi',email:'kishore.dev@camcom.ai',gender:'male'},
  {id:'e36',name:'Anil Gandreddi',email:'anil.gandreddi@camcom.ai',gender:'male'},
  {id:'e37',name:'K Ganesh',email:'k.ganesh@camcom.ai',gender:'male'},
  {id:'e38',name:'Kiran Y',email:'kiran.y@camcom.ai',gender:'male'},
  {id:'e39',name:'Vishwas Reddy',email:'vishwas.reddy@camcom.ai',gender:'male'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RBAC ‚Äî ROLES & PERMISSIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROLES={
  admin:   {label:'Admin',   icon:'üëë', pill:'rp-admin',   color:'#dc2626',
    canCreate:true, canEdit:true, canDelete:true, canAssign:true,
    canManageUsers:true, canManageFeatures:true, seeAll:true},
  manager: {label:'Manager', icon:'üîµ', pill:'rp-manager', color:'#2563eb',
    canCreate:true, canEdit:true, canDelete:false, canAssign:true,
    canManageUsers:false, canManageFeatures:false, seeAll:true},
  reviewer:{label:'Reviewer',icon:'üü°', pill:'rp-reviewer',color:'#d97706',
    canCreate:false, canEdit:false, canDelete:false, canAssign:false,
    canManageUsers:false, canManageFeatures:false, seeAll:true},
  employee:{label:'Employee',icon:'üü¢', pill:'rp-employee',color:'#16a34a',
    canCreate:false, canEdit:false, canDelete:false, canAssign:false,
    canManageUsers:false, canManageFeatures:false, seeAll:false},
};
function can(perm){return !!(currentUser && ROLES[currentUser.role]?.[perm]);}
function visibleProjects(){
  if(!currentUser) return [];
  if(can('seeAll')) return projects;
  return projects.filter(p=>(p.assignedEmployees||[]).includes(currentUser.empId));
}

// Default users (persisted in localStorage so Admin can add more)
const DEFAULT_USERS=[
  {id:'u1',name:'CamCom Admin',  email:'admin@camcom.ai',    pwd:'admin123', role:'admin',   empId:null},
  {id:'u2',name:'Priya Manager', email:'manager@camcom.ai',  pwd:'mgr123',   role:'manager', empId:null},
  {id:'u3',name:'Ravi Reviewer', email:'reviewer@camcom.ai', pwd:'rev123',   role:'reviewer',empId:null},
  // Employee demo accounts linked to real emp records
  {id:'u4',name:'Ramyashree V R',      email:'ramyashree@camcom.ai',      pwd:'emp123',role:'employee',empId:'e1'},
  {id:'u5',name:'Akshay Phatale',      email:'akshay.phatale@camcom.ai',  pwd:'emp123',role:'employee',empId:'e9'},
  {id:'u6',name:'Sneha B V',           email:'sneha.bv@camcom.ai',        pwd:'emp123',role:'employee',empId:'e20'},
  {id:'u7',name:'Siddharth Anandan',   email:'siddharth.anandan@camcom.ai',pwd:'emp123',role:'employee',empId:'e25'},
];
let appUsers=[...DEFAULT_USERS];
let currentUser=null;
let editUserId=null;

function loadUsersLocal(){try{const s=localStorage.getItem('cc_users');if(s){const a=JSON.parse(s);if(a&&a.length)appUsers=a;}}catch(e){}}
function saveUsersLocal(){try{localStorage.setItem('cc_users',JSON.stringify(appUsers));}catch(e){}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doLogin(){
  const email=document.getElementById('li-email').value.trim().toLowerCase();
  const pwd=document.getElementById('li-pwd').value;
  const user=appUsers.find(u=>u.email.toLowerCase()===email&&u.pwd===pwd);
  if(!user){
    const err=document.getElementById('loginErr');
    err.textContent='Incorrect email or password.';
    setTimeout(()=>err.textContent='',3000);
    return;
  }
  startSession(user);
}
function quickLogin(role){
  const user=appUsers.find(u=>u.role===role);
  if(user)startSession(user);
}
function startSession(user){
  currentUser=user;
  try{localStorage.setItem('cc_sess',JSON.stringify({id:user.id,role:user.role}));}catch(e){}
  document.getElementById('loginScr').style.display='none';
  applyRoleToUI();
  appInit();
}
function tryRestoreSession(){
  loadUsersLocal();
  try{
    const s=localStorage.getItem('cc_sess');
    if(s){const sess=JSON.parse(s);const u=appUsers.find(x=>x.id===sess.id);
      if(u){currentUser=u;document.getElementById('loginScr').style.display='none';applyRoleToUI();appInit();return;}}
  }catch(e){}
  // stay on login screen
}
function doLogout(){
  currentUser=null;
  try{localStorage.removeItem('cc_sess');}catch(e){}
  document.getElementById('loginScr').style.display='flex';
  document.getElementById('li-email').value='';
  document.getElementById('li-pwd').value='';
}

function applyRoleToUI(){
  if(!currentUser)return;
  const r=ROLES[currentUser.role];
  // sidebar user chip
  const initls=currentUser.name.split(' ').filter(Boolean).map(w=>w[0]).join('').substr(0,2).toUpperCase();
  document.getElementById('userAv').textContent=initls;
  document.getElementById('userAv').style.background=r.color;
  document.getElementById('userName').textContent=currentUser.name;
  document.getElementById('userRole').innerHTML=`<span class="role-pill ${r.pill}">${r.icon} ${r.label}</span>`;
  // nav visibility
  const hide=(sel,show)=>{const el=document.querySelector(sel);if(el)el.style.display=show?'':'none';};
  hide('[onclick="openNewProj()"]', can('canCreate'));
  hide('[onclick="openEmpModal()"]', can('canManageUsers'));
  hide('[data-page="settings"]', can('canManageFeatures'));
  const nu=document.getElementById('nav-users');if(nu)nu.style.display=can('canManageUsers')?'':'none';
  // Employee role ‚Äî show a banner
  if(currentUser.role==='employee'&&!currentUser.empId){
    toast('‚ö† Your account is not linked to an employee record. Contact an admin.','info');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE FLAGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let features={kanban:true,analytics:true,gantt:true,burndown:true,exportPDF:true,exportCSV:true,workload:true,dailyTarget:true,fileUpload:true};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORE STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentFilter='all', searchQ='', openProjId=null, editEmpId=null, editProjId=null;
let projDocs={};
let chartInstances={};
let dragSrcId=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function appInit(){
  loadFeaturesLocal(); loadEmpsLocal(); loadDocsLocal();
  loadProjects();
  if(can('canManageFeatures'))renderSettings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProjects(){
  document.getElementById('lovl').style.display='flex';
  try{
    const{data,error}=await sb.from('projects').select('*').order('created_at',{ascending:false});
    if(error)throw error;
    projects=(data||[]).map(r=>({
      id:r.id, name:r.name, total:r.total||0, annotated:r.annotated||0, reviewed:r.reviewed||0,
      priority:r.priority||'medium', startdate:r.startdate||'', deadline:r.deadline||'',
      assignedby:r.assignedby||'', notes:r.notes||'', comments:r.comments||'',
      hasTarget:r.has_target||false, dailyTarget:r.daily_target||null,
      kanbanStatus:r.kanban_status||'todo',
      assignedEmployees:r.assigned_employees?r.assigned_employees.split(',').filter(Boolean):[]
    }));
    toast('Data loaded ‚úì','ok');
  }catch(e){console.error(e);toast('DB: '+e.message,'err');}
  finally{document.getElementById('lovl').style.display='none';renderAll();}
}

async function saveProjDB(p){
  // ‚îÄ‚îÄ FULL row with all v5+ columns ‚îÄ‚îÄ
  const fullRow={
    id:p.id, name:p.name, total:p.total, annotated:p.annotated, reviewed:p.reviewed,
    priority:p.priority, startdate:p.startdate||null, deadline:p.deadline||null,
    assignedby:p.assignedby||'', notes:p.notes||'', comments:p.comments||'',
    has_target:p.hasTarget||false, daily_target:p.dailyTarget||null,
    kanban_status:p.kanbanStatus||'todo',
    assigned_employees:(p.assignedEmployees||[]).join(',')
  };
  const{error}=await sb.from('projects').upsert(fullRow);
  if(error){
    // ‚îÄ‚îÄ If column missing ‚Üí show migration banner, retry with safe minimal row ‚îÄ‚îÄ
    const isSchemaMiss=error.message&&(error.message.includes('column')||error.message.includes('schema cache'));
    if(isSchemaMiss){
      // Show migration instructions
      const mb=document.getElementById('migBanner');
      if(mb){mb.style.display='';if(!document.getElementById('page-settings').classList.contains('active')){toast('‚ö† DB migration needed ‚Äî go to Feature Settings for instructions','err');}}
      // Retry with only the original safe columns
      const safeRow={
        id:p.id, name:p.name, total:p.total, annotated:p.annotated, reviewed:p.reviewed,
        priority:p.priority, deadline:p.deadline||null, notes:p.notes||'',
        assigned_employees:(p.assignedEmployees||[]).join(',')
      };
      const r2=await sb.from('projects').upsert(safeRow);
      if(r2.error){toast('Save failed: '+r2.error.message,'err');}
      else{toast('Saved (partial) ‚Äî run SQL migration for full features','info');}
    } else {
      toast('Save error: '+error.message,'err');
      console.error(error);
    }
  }
}

async function delProjDB(id){const{error}=await sb.from('projects').delete().eq('id',id);if(error)toast('Delete: '+error.message,'err');}

function saveEmpsLocal(){localStorage.setItem('cc_emps',JSON.stringify(employees));}
function loadEmpsLocal(){try{const s=localStorage.getItem('cc_emps');if(s){const a=JSON.parse(s);if(a.length)employees=a;}}catch(e){}}
function saveDocsLocal(){try{localStorage.setItem('cc_docs',JSON.stringify(projDocs));}catch(e){}}
function loadDocsLocal(){try{const s=localStorage.getItem('cc_docs');if(s)projDocs=JSON.parse(s);}catch(e){}}
function saveFeaturesLocal(){localStorage.setItem('cc_features',JSON.stringify(features));}
function loadFeaturesLocal(){try{const s=localStorage.getItem('cc_features');if(s)Object.assign(features,JSON.parse(s));}catch(e){}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uid(){return crypto.randomUUID?crypto.randomUUID():'id_'+Date.now()+'_'+Math.random().toString(36).substr(2,6);}
function esc(s){return(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function pct(a,b){return b>0?Math.round((a/b)*100):0;}
function fmtD(d){if(!d)return'‚Äî';return new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}
function dlMeta(d){if(!d)return null;const dt=new Date(d+'T00:00:00'),diff=Math.ceil((dt-new Date())/86400000);return{label:fmtD(d),diff};}
function initials(n){return(n||'?').split(' ').map(w=>w[0]||'').join('').substr(0,2).toUpperCase();}
function getEmp(id){return employees.find(e=>e.id===id)||{name:'Unknown',gender:'male'};}
function aMap(){const m=new Map();projects.forEach(p=>(p.assignedEmployees||[]).forEach(id=>m.set(id,(m.get(id)||0)+1)));return m;}
function conflicts(){const m=aMap();return[...m.entries()].filter(([,c])=>c>1).map(([id])=>id);}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}
function toast(msg,type='info'){
  const el=document.createElement('div');el.className=`toast ${type==='ok'?'ok':type==='err'?'err':'info'}`;
  el.innerHTML=`<i class="fas ${type==='ok'?'fa-check-circle':type==='err'?'fa-times-circle':'fa-info-circle'}"></i>${msg}`;
  document.getElementById('toasts').appendChild(el);setTimeout(()=>el.remove(),3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(p){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p)?.classList.add('active');
  document.querySelector(`[data-page="${p}"]`)?.classList.add('active');
  if(p==='employees')renderEmps();
  if(p==='workload')renderWorkload();
  if(p==='projects')renderProjFull();
  if(p==='kanban')renderKanban();
  if(p==='analytics'){renderCharts();renderGantt();populateBurndownSel();}
  if(p==='settings')renderSettings();
  if(p==='users')renderUsers();
}
function renderAll(){renderProjects();renderStats();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStats(){
  const tI=projects.reduce((s,p)=>s+(+p.total||0),0);
  const tA=projects.reduce((s,p)=>s+(+p.annotated||0),0);
  const tR=projects.reduce((s,p)=>s+(+p.reviewed||0),0);
  const asd=new Set(projects.flatMap(p=>p.assignedEmployees||[])).size;
  const cc=conflicts();
  document.getElementById('statGrid').innerHTML=[
    {l:'Projects',v:projects.length,s:`${projects.filter(p=>p.priority==='high').length} high priority`,c:'',i:'fa-folder-open'},
    {l:'Total Images',v:tI.toLocaleString(),s:`${pct(tA,tI)}% annotated`,c:'b',i:'fa-images'},
    {l:'Annotated',v:tA.toLocaleString(),s:`${pct(tA,tI)}% done`,c:'g',i:'fa-check-circle'},
    {l:'Reviewed',v:tR.toLocaleString(),s:`${pct(tR,tI)}% done`,c:'y',i:'fa-eye'},
    {l:'Employees',v:employees.length,s:`${asd} assigned`,c:'p',i:'fa-users'},
    {l:'Conflicts',v:cc.length,s:cc.length>0?'double-booking!':'All clear ‚úì',c:cc.length>0?'r':'g',i:'fa-exclamation-triangle'},
  ].map(x=>`<div class="sc ${x.c}"><div class="sc-l">${x.l}</div><div class="sc-v">${x.v}</div><div class="sc-s">${x.s}</div></div>`).join('');
  document.getElementById('nb-p').textContent=projects.length;
  document.getElementById('nb-e').textContent=employees.length;
  const cc2=conflicts();
  const cb=document.getElementById('cBanner');
  if(cc2.length>0){cb.style.display='flex';document.getElementById('cTxt').textContent=`‚ö† ${cc2.length} employee(s) double-booked: ${cc2.map(id=>getEmp(id).name).join(', ')}`;}
  else cb.style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECT CARD (compact)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const KB_LABELS={todo:'üìã To Do',inprog:'‚ö° In Progress',review:'üîç Review',done:'‚úÖ Done'};
const KB_COLS={todo:'var(--tx3)',inprog:'var(--blue)',review:'var(--yellow)',done:'var(--green)'};

function buildCard(p){
  const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
  const aP=pct(A,T),rP=pct(R,T);
  const dl=dlMeta(p.deadline);
  const ov=dl&&dl.diff<0,sn=dl&&dl.diff>=0&&dl.diff<=7;
  const asgn=p.assignedEmployees||[];
  const docs=projDocs[p.id]||[];
  const avs=asgn.slice(0,4).map(id=>{const e=getEmp(id);return`<div class="av ${e.gender==='male'?'m':'f'}" title="${esc(e.name)}">${initials(e.name)}</div>`;}).join('');
  const extra=asgn.length>4?`<div class="av more">+${asgn.length-4}</div>`:'';
  const pLbl={high:'üî• High',medium:'‚ö° Med',low:'üåø Low'}[p.priority]||'Med';
  const ksColor=KB_COLS[p.kanbanStatus||'todo'];
  return`<div class="pcard" onclick="openDP('${p.id}')">
    <div class="pcard-stripe ${p.priority}"></div>
    <div class="pcard-body">
      <div class="pcard-title">${esc(p.name)}</div>
      <div class="pcard-meta">
        <span class="badge b${p.priority[0]}">${pLbl}</span>
        <span class="badge" style="background:${ksColor}22;color:${ksColor};border:1px solid ${ksColor}44;font-size:.6rem;">${KB_LABELS[p.kanbanStatus||'todo']||'üìã To Do'}</span>
        ${p.assignedby?`<span class="mpill"><i class="fas fa-user-tie"></i> ${esc(p.assignedby)}</span>`:''}
        ${dl?`<span class="mpill ${ov?'ov':sn?'sn':''}"><i class="fas fa-calendar-alt"></i> ${dl.label} ${ov?'‚ö†':sn?`${dl.diff}d left`:''}</span>`:''}
        ${p.hasTarget&&p.dailyTarget?`<span class="mpill" style="color:var(--yellow);"><i class="fas fa-bullseye"></i> ${p.dailyTarget}/day</span>`:''}
        ${docs.length>0?`<span class="mpill"><i class="fas fa-paperclip"></i> ${docs.length}</span>`:''}
      </div>
      <div class="pcard-prog">
        <div class="prog-r"><span class="prog-l">Annotation</span><span class="prog-p">${aP}%</span></div>
        <div class="pbar"><div class="pf pf-a" style="width:${aP}%"></div></div>
        <div class="prog-r" style="margin-top:4px;"><span class="prog-l">Review</span><span class="prog-p">${rP}%</span></div>
        <div class="pbar"><div class="pf pf-r" style="width:${rP}%"></div></div>
      </div>
    </div>
    <div class="pcard-foot">
      <div class="avatars">${avs+extra||'<span style="font-size:.65rem;color:var(--tx3)">No assignments</span>'}</div>
      <span class="hint-txt"><i class="fas fa-arrow-right"></i> Details</span>
    </div>
  </div>`;
}

function getFiltered(){
  const sort=document.getElementById('sortSel')?.value||'default';
  let list=[...visibleProjects()];  // ‚Üê role-filtered
  if(currentFilter!=='all')list=list.filter(p=>p.priority===currentFilter);
  if(searchQ){const q=searchQ.toLowerCase();list=list.filter(p=>p.name.toLowerCase().includes(q)||(p.assignedby||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q)||(p.assignedEmployees||[]).some(id=>getEmp(id).name.toLowerCase().includes(q)));}
  if(sort==='name')list.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sort==='progress')list.sort((a,b)=>pct(b.annotated,b.total)-pct(a.annotated,a.total));
  else if(sort==='deadline')list.sort((a,b)=>(a.deadline||'9999').localeCompare(b.deadline||'9999'));
  else if(sort==='priority'){const w={high:0,medium:1,low:2};list.sort((a,b)=>(w[a.priority]||1)-(w[b.priority]||1));}
  return list;
}
function renderProjects(){
  const list=getFiltered();
  document.getElementById('projGrid').innerHTML=list.length===0?`<div class="empty-st" style="grid-column:1/-1"><i class="fas fa-folder-open"></i><p>${currentUser?.role==='employee'?'No projects assigned to you yet.':'No projects found.'}</p></div>`:list.map(buildCard).join('');
  renderStats();
}
function renderProjFull(){
  const q=(document.getElementById('projSearch')?.value||'').toLowerCase();
  let list=[...visibleProjects()];  // ‚Üê role-filtered
  if(q)list=list.filter(p=>p.name.toLowerCase().includes(q)||(p.assignedby||'').toLowerCase().includes(q)||(p.assignedEmployees||[]).some(id=>getEmp(id).name.toLowerCase().includes(q)));
  document.getElementById('projGridFull').innerHTML=list.length===0?`<div class="empty-st" style="grid-column:1/-1"><i class="fas fa-folder-open"></i><p>No projects found.</p></div>`:list.map(buildCard).join('');
}
function setFilter(v,el){currentFilter=v;document.querySelectorAll('.fc').forEach(c=>c.classList.remove('on'));el.classList.add('on');renderProjects();}
function handleSearch(){searchQ=document.getElementById('gSearch').value;renderProjects();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDP(id){
  const p=projects.find(x=>x.id===id);if(!p)return;
  openProjId=id;
  document.getElementById('dpTitle').textContent=p.name;
  const dl=dlMeta(p.deadline);
  document.getElementById('dpMeta').innerHTML=
    `<span class="badge b${p.priority[0]}">${{high:'üî• High',medium:'‚ö° Medium',low:'üåø Low'}[p.priority]}</span>`+
    (dl?`<span class="mpill ${dl.diff<0?'ov':dl.diff<=7?'sn':''}"><i class="fas fa-calendar-alt"></i> ${dl.label} ${dl.diff<0?'(Overdue)':dl.diff<=7?`(${dl.diff}d)`:''}</span>`:'');
  renderDPBody(p);
  document.getElementById('dpOvl').classList.add('open');
  document.getElementById('dp').classList.add('open');
}
function closeDP(){document.getElementById('dpOvl').classList.remove('open');document.getElementById('dp').classList.remove('open');openProjId=null;}
function closeDpBg(e){if(e.target===document.getElementById('dpOvl'))closeDP();}

function renderDPBody(p){
  const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
  const asgn=p.assignedEmployees||[];
  const am=aMap();
  const docs=projDocs[p.id]||[];
  const aTags=asgn.map(id=>{const e=getEmp(id);const isC=(am.get(id)||0)>1;return`<span class="atag ${isC?'cc':''}">
    ${isC?'‚ö† ':''}${esc(e.name)}<button onclick="rmAsgn('${p.id}','${id}')"><i class="fas fa-times"></i></button></span>`;}).join('');
  const docHtml=docs.map((d,i)=>`<div class="docitem"><i class="fas fa-file-alt"></i><span class="doc-n">${esc(d.name)}</span><span class="doc-s">${d.size}</span><button class="doc-rm" onclick="rmDoc('${p.id}',${i})"><i class="fas fa-trash"></i></button></div>`).join('');

  document.getElementById('dpBody').innerHTML=`
  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-info-circle"></i> Project Info</div>
    <div class="info-grid">
      <div class="inf"><label>Assigned By</label><input type="text" value="${esc(p.assignedby||'')}" placeholder="Manager" onchange="dpUpd('${p.id}','assignedby',this.value)"></div>
      <div class="inf"><label>Kanban Status</label>
        <select onchange="dpUpd('${p.id}','kanbanStatus',this.value)">
          <option value="todo" ${(p.kanbanStatus||'todo')==='todo'?'selected':''}>üìã To Do</option>
          <option value="inprog" ${p.kanbanStatus==='inprog'?'selected':''}>‚ö° In Progress</option>
          <option value="review" ${p.kanbanStatus==='review'?'selected':''}>üîç Review</option>
          <option value="done" ${p.kanbanStatus==='done'?'selected':''}>‚úÖ Completed</option>
        </select>
      </div>
      <div class="inf"><label>Start Date</label><input type="date" value="${p.startdate||''}" onchange="dpUpd('${p.id}','startdate',this.value)"></div>
      <div class="inf"><label>Deadline</label><input type="date" value="${p.deadline||''}" onchange="dpUpd('${p.id}','deadline',this.value)"></div>
      <div class="inf"><label>Priority</label>
        <select onchange="dpUpd('${p.id}','priority',this.value)">
          <option value="high" ${p.priority==='high'?'selected':''}>üî• High</option>
          <option value="medium" ${p.priority==='medium'?'selected':''}>‚ö° Medium</option>
          <option value="low" ${p.priority==='low'?'selected':''}>üåø Low</option>
        </select>
      </div>
    </div>
  </div>
  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-images"></i> Image Counts</div>
    <div class="num-grid">
      <div class="nc"><input type="number" value="${T}" min="0" onchange="dpField('${p.id}','total',this.value)"><div class="nc-l">Total</div></div>
      <div class="nc"><input type="number" value="${A}" min="0" onchange="dpField('${p.id}','annotated',this.value)"><div class="nc-l">Annotated</div></div>
      <div class="nc"><input type="number" value="${R}" min="0" onchange="dpField('${p.id}','reviewed',this.value)"><div class="nc-l">Reviewed</div></div>
      <div class="nc comp"><div class="ncv">${Math.max(T-A,0)}</div><div class="nc-l">Pend.Ann</div></div>
      <div class="nc comp2"><div class="ncv">${Math.max(A-R,0)}</div><div class="nc-l">Pend.Rev</div></div>
    </div>
    ${p.hasTarget&&p.dailyTarget?`<div class="tgt-row"><i class="fas fa-bullseye"></i><label>Daily Target</label><input type="number" value="${p.dailyTarget}" min="1" onchange="dpField('${p.id}','dailyTarget',this.value)"><span style="font-size:.7rem;color:var(--yellow);">imgs/day${p.dailyTarget>0&&Math.max(T-A,0)>0?' ¬∑ Est. '+Math.ceil(Math.max(T-A,0)/p.dailyTarget)+'d left':''}</span></div>`:''}
    <div style="margin-top:11px;">
      <div class="prog-r"><span class="prog-l">Annotation</span><span class="prog-p">${pct(A,T)}%</span></div>
      <div class="pbar" style="height:7px;margin-bottom:7px;"><div class="pf pf-a" style="width:${pct(A,T)}%"></div></div>
      <div class="prog-r"><span class="prog-l">Review</span><span class="prog-p">${pct(R,T)}%</span></div>
      <div class="pbar" style="height:7px;"><div class="pf pf-r" style="width:${pct(R,T)}%"></div></div>
    </div>
  </div>
  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-users"></i> Assigned Employees (${asgn.length})</div>
    ${can('canAssign')?`<div class="esbox"><i class="fas fa-search" style="color:var(--tx3);font-size:.8rem;"></i><input type="text" placeholder="Search employee to assign..." id="esrch-${p.id}" oninput="renderES('${p.id}')"></div>
    <div class="e-results" id="eres-${p.id}"></div>`:'<div style="font-size:.72rem;color:var(--tx3);margin-bottom:6px;">Contact a Manager or Admin to change assignments.</div>'}
    <div class="atags" style="margin-top:9px;">${aTags||'<span style="font-size:.74rem;color:var(--tx3);">No employees assigned yet</span>'}</div>
  </div>
  ${features.fileUpload?`<div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-paperclip"></i> Documents (${docs.length})</div>
    <div class="upzone"><input type="file" multiple onchange="handleUpload('${p.id}',this)"><i class="fas fa-cloud-upload-alt"></i><p><strong>Click or drag</strong> to upload files</p></div>
    ${docs.length>0?`<div class="doclist">${docHtml}</div>`:''}
  </div>`:''}
  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-sticky-note"></i> Notes</div>
    <textarea class="cmt-ta" onchange="dpUpd('${p.id}','notes',this.value)">${esc(p.notes||'')}</textarea>
  </div>
  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-comments"></i> Comments</div>
    <textarea class="cmt-ta" id="cmt-${p.id}" onchange="dpUpd('${p.id}','comments',this.value)">${esc(p.comments||'')}</textarea>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
      ${can('canEdit')?`<button class="btn btn-ghost btn-sm" onclick="saveNow('${p.id}')"><i class="fas fa-save"></i> Save</button>`:''}
      ${can('canEdit')?`<button class="btn btn-ghost btn-sm" onclick="openEditProj('${p.id}')"><i class="fas fa-pen"></i> Edit</button>`:''}
      ${can('canDelete')?`<button class="btn btn-sm" style="background:var(--red-l);color:var(--red);" onclick="deleteProj('${p.id}')"><i class="fas fa-trash"></i> Delete</button>`:''}
      ${!can('canEdit')?`<span style="font-size:.74rem;color:var(--tx3);align-self:center;"><i class="fas fa-lock"></i> Read-only view</span>`:''}
    </div>
  </div>`;
  if(can('canAssign'))renderES(p.id);
}

function renderES(projId){
  const q=(document.getElementById(`esrch-${projId}`)?.value||'').toLowerCase();
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const asgn=p.assignedEmployees||[];
  const am=aMap();
  let list=q?employees.filter(e=>e.name.toLowerCase().includes(q)||e.email.toLowerCase().includes(q)):employees;
  const cont=document.getElementById(`eres-${projId}`);if(!cont)return;
  if(!list.length){cont.innerHTML='<div style="padding:9px 11px;font-size:.76rem;color:var(--tx3);">No employees found</div>';return;}
  cont.innerHTML=list.slice(0,15).map(e=>{
    const alr=asgn.includes(e.id);
    const other=projects.filter(p2=>p2.id!==projId&&(p2.assignedEmployees||[]).includes(e.id));
    let sub='',sc='';
    if(alr){sub='Already in this project';sc='taken';}
    else if(other.length>0){sub=`Also in: ${other.map(x=>x.name).join(', ')}`;sc='warn';}
    else{sub=e.email;sc='';}
    return`<div class="e-row"><div><div class="e-name">${esc(e.name)} <span style="font-size:.6rem;color:var(--tx3);">${e.gender==='male'?'‚ôÇ':'‚ôÄ'}</span></div><div class="e-sub ${sc}">${esc(sub)}</div></div>
      ${alr?`<button class="btn btn-ghost btn-sm" onclick="rmAsgn('${projId}','${e.id}')">Remove</button>`:`<button class="btn btn-blue btn-sm" onclick="addAsgn('${projId}','${e.id}')">Assign</button>`}
    </div>`;
  }).join('');
}

async function addAsgn(projId,empId){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  if((p.assignedEmployees||[]).includes(empId)){toast('Already assigned','info');return;}
  if(!p.assignedEmployees)p.assignedEmployees=[];
  p.assignedEmployees.push(empId);
  toast(`${getEmp(empId).name} assigned ‚úì`,'ok');
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}
async function rmAsgn(projId,empId){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  p.assignedEmployees=(p.assignedEmployees||[]).filter(id=>id!==empId);
  toast('Removed','info');
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}
async function dpField(id,field,val){
  const p=projects.find(x=>x.id===id);if(!p)return;
  p[field]=Math.max(0,parseInt(val)||0);
  if(openProjId===id)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}
async function dpUpd(id,field,val){
  const p=projects.find(x=>x.id===id);if(!p)return;
  p[field]=val;renderProjects();await saveProjDB(p);
  if(field==='kanbanStatus'&&openProjId===id)renderDPBody(p);
}
async function saveNow(id){const p=projects.find(x=>x.id===id);if(!p)return;await saveProjDB(p);toast('Saved ‚úì','ok');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleUpload(projId,input){
  const files=[...input.files];if(!files.length)return;
  if(!projDocs[projId])projDocs[projId]=[];
  let loaded=0;
  files.forEach(f=>{
    const rdr=new FileReader();
    rdr.onload=e=>{projDocs[projId].push({name:f.name,size:fmtSize(f.size),dataUrl:e.target.result});loaded++;if(loaded===files.length){saveDocsLocal();const p=projects.find(x=>x.id===projId);if(p&&openProjId===projId)renderDPBody(p);renderProjects();}};
    rdr.readAsDataURL(f);
  });
  toast(`${files.length} file(s) uploaded`,'ok');
}
function rmDoc(projId,idx){if(!projDocs[projId])return;projDocs[projId].splice(idx,1);saveDocsLocal();const p=projects.find(x=>x.id===projId);if(p&&openProjId===projId)renderDPBody(p);renderProjects();toast('File removed','info');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE / MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function deleteProj(id){
  if(!confirm('Delete this project?'))return;
  projects=projects.filter(p=>p.id!==id);delete projDocs[id];saveDocsLocal();
  closeDP();toast('Deleted','info');renderProjects();await delProjDB(id);
}

function tglTgtField(prefix){document.getElementById(`${prefix}-tgtFw`).classList.toggle('show',document.getElementById(`${prefix}-tgtOn`).checked);}

function openNewProj(){
  editProjId=null;document.getElementById('pMTtl').textContent='New Project';
  ['name','by'].forEach(f=>document.getElementById(`np-${f}`).value='');
  ['start','dead'].forEach(f=>document.getElementById(`np-${f}`).value='');
  document.getElementById('np-total').value='1000';document.getElementById('np-ann').value='0';document.getElementById('np-rev').value='0';
  document.getElementById('np-pri').value='medium';document.getElementById('np-status').value='todo';
  document.getElementById('np-notes').value='';document.getElementById('np-tgtOn').checked=false;document.getElementById('np-target').value='';document.getElementById('np-tgtFw').classList.remove('show');
  document.getElementById('projOvl').classList.add('open');
}
function openEditProj(id){
  const p=projects.find(x=>x.id===id);if(!p)return;
  editProjId=id;document.getElementById('pMTtl').textContent='Edit Project';
  document.getElementById('np-name').value=p.name;document.getElementById('np-by').value=p.assignedby||'';
  document.getElementById('np-start').value=p.startdate||'';document.getElementById('np-dead').value=p.deadline||'';
  document.getElementById('np-total').value=p.total;document.getElementById('np-ann').value=p.annotated;document.getElementById('np-rev').value=p.reviewed;
  document.getElementById('np-pri').value=p.priority||'medium';document.getElementById('np-status').value=p.kanbanStatus||'todo';
  document.getElementById('np-notes').value=p.notes||'';
  const ht=!!p.hasTarget;document.getElementById('np-tgtOn').checked=ht;document.getElementById('np-target').value=p.dailyTarget||'';document.getElementById('np-tgtFw').classList.toggle('show',ht);
  document.getElementById('projOvl').classList.add('open');
}
function closeProjModal(){document.getElementById('projOvl').classList.remove('open');}
function closeProjOvlBg(e){if(e.target===document.getElementById('projOvl'))closeProjModal();}
async function saveProject(){
  const name=document.getElementById('np-name').value.trim();
  if(!name){toast('Name required','err');return;}
  const ht=document.getElementById('np-tgtOn').checked;
  const data={name,priority:document.getElementById('np-pri').value,assignedby:document.getElementById('np-by').value.trim(),
    startdate:document.getElementById('np-start').value,deadline:document.getElementById('np-dead').value,
    total:parseInt(document.getElementById('np-total').value)||0,annotated:parseInt(document.getElementById('np-ann').value)||0,reviewed:parseInt(document.getElementById('np-rev').value)||0,
    notes:document.getElementById('np-notes').value.trim(),
    kanbanStatus:document.getElementById('np-status').value,
    hasTarget:ht,dailyTarget:ht?(parseInt(document.getElementById('np-target').value)||null):null};
  let proj;
  if(editProjId){const idx=projects.findIndex(p=>p.id===editProjId);if(idx>-1){Object.assign(projects[idx],data);proj=projects[idx];toast('Updated ‚úì','ok');}}
  else{proj={id:uid(),assignedEmployees:[],comments:'',...data};projects.push(proj);toast('Created ‚úì','ok');}
  closeProjModal();renderProjects();if(proj)await saveProjDB(proj);
  if(openProjId===proj?.id){const p2=projects.find(x=>x.id===openProjId);if(p2)renderDPBody(p2);}
}

function openEmpModal(id=null){
  editEmpId=id;
  if(id){const e=employees.find(x=>x.id===id);if(!e)return;document.getElementById('eMTtl').textContent='Edit Employee';document.getElementById('fe-name').value=e.name;document.getElementById('fe-email').value=e.email;document.getElementById('fe-gender').value=e.gender;}
  else{document.getElementById('eMTtl').textContent='Add Employee';['fe-name','fe-email'].forEach(f=>document.getElementById(f).value='');document.getElementById('fe-gender').value='female';}
  document.getElementById('empOvl').classList.add('open');
}
function closeEmpModal(){document.getElementById('empOvl').classList.remove('open');}
function closeEmpOvlBg(e){if(e.target===document.getElementById('empOvl'))closeEmpModal();}
function saveEmployee(){
  const name=document.getElementById('fe-name').value.trim();const email=document.getElementById('fe-email').value.trim();const gender=document.getElementById('fe-gender').value;
  if(!name){toast('Name required','err');return;}if(!email){toast('Email required','err');return;}
  if(editEmpId){const idx=employees.findIndex(e=>e.id===editEmpId);if(idx>-1){employees[idx]={...employees[idx],name,email,gender};toast('Updated ‚úì','ok');}}
  else{employees.push({id:'e_'+Date.now(),name,email,gender});toast('Added ‚úì','ok');}
  saveEmpsLocal();closeEmpModal();renderEmps();renderStats();
}
function delEmp(id){
  if(!confirm('Remove employee?'))return;
  employees=employees.filter(e=>e.id!==id);
  projects.forEach(p=>{p.assignedEmployees=(p.assignedEmployees||[]).filter(e=>e!==id);});
  saveEmpsLocal();renderEmps();renderProjects();renderStats();toast('Removed','info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMPLOYEES TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEmps(){
  const am=aMap();const cc=conflicts();
  const q=(document.getElementById('empSearch')?.value||'').toLowerCase();
  const list=q?employees.filter(e=>e.name.toLowerCase().includes(q)||e.email.toLowerCase().includes(q)):employees;
  const ecb=document.getElementById('empCBanner');
  if(cc.length>0){ecb.style.display='flex';document.getElementById('ecTxt').textContent=`‚ö† Double-booking: ${cc.map(id=>getEmp(id).name).join(', ')}`;}
  else ecb.style.display='none';
  document.getElementById('empTbody').innerHTML=list.map((e,i)=>{
    const cnt=am.get(e.id)||0;const projs=projects.filter(p=>(p.assignedEmployees||[]).includes(e.id));
    const sc=cnt>1?'st-c':cnt===1?'st-a':'st-f';const st=cnt>1?`‚ö† ${cnt} projects (CONFLICT)`:cnt===1?`‚úì ${projs[0]?.name}`:'Free';
    return`<tr><td style="color:var(--tx3);font-size:.7rem;">${i+1}</td><td><strong>${esc(e.name)}</strong></td><td style="color:var(--tx2);font-size:.76rem;">${esc(e.email)}</td>
      <td><span class="${e.gender==='male'?'gm':'gf'}">${e.gender==='male'?'‚ôÇ Male':'‚ôÄ Female'}</span></td>
      <td><span class="${sc}">${st}</span></td><td style="font-size:.73rem;color:var(--tx3);">${projs.map(p=>esc(p.name)).join(', ')||'‚Äî'}</td>
      <td><button class="iBtn" onclick="openEmpModal('${e.id}')"><i class="fas fa-pen"></i></button><button class="iBtn del" onclick="delEmp('${e.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWorkload(){
  const am=aMap();const active=[...am.entries()].filter(([,c])=>c>0).sort((a,b)=>b[1]-a[1]);
  if(!active.length){document.getElementById('wlList').innerHTML='<div class="empty-st"><i class="fas fa-chart-bar"></i><p>No assignments yet.</p></div>';return;}
  const max=Math.max(...active.map(([,c])=>c));
  document.getElementById('wlList').innerHTML=active.map(([id,cnt])=>{
    const e=getEmp(id);const projs=projects.filter(p=>(p.assignedEmployees||[]).includes(id));
    const bar=Math.round((cnt/max)*100);const isC=cnt>1;
    return`<div class="wl-row"><span class="wl-n">${esc(e.name)}</span><span class="wl-p">${projs.map(p=>esc(p.name)).join(' ¬∑ ')}</span>
      <div class="wl-bw"><div class="pbar" style="height:7px;"><div class="pf ${isC?'':'pf-a'}" style="width:${bar}%;${isC?'background:#dc2626':''}"></div></div>
      <div style="font-size:.64rem;color:${isC?'#dc2626':'var(--tx3)'};margin-top:2px;text-align:right;">${cnt} proj${cnt>1?'s':''} ${isC?'‚ö† CONFLICT':''}</div></div></div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KANBAN BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderKanban(){
  const cols={todo:[],inprog:[],review:[],done:[]};
  projects.forEach(p=>{const s=p.kanbanStatus||'todo';if(cols[s])cols[s].push(p);});
  const colDefs=[
    {id:'todo',title:'üìã To Do',cls:'col-todo'},
    {id:'inprog',title:'‚ö° In Progress',cls:'col-inprog'},
    {id:'review',title:'üîç Review',cls:'col-review'},
    {id:'done',title:'‚úÖ Completed',cls:'col-done'},
  ];
  document.getElementById('kanbanWrap').innerHTML=colDefs.map(col=>`
    <div class="kb-col ${col.cls}">
      <div class="kb-hdr"><span class="kb-col-title">${col.title}</span><span class="kb-count">${cols[col.id].length}</span></div>
      <div class="kb-cards" id="kbc-${col.id}" ondragover="kbDragOver(event,'${col.id}')" ondragleave="kbDragLeave(event)" ondrop="kbDrop(event,'${col.id}')">
        ${cols[col.id].length?cols[col.id].map(p=>buildKBCard(p)).join(''):`<div class="kb-empty"><i class="fas fa-inbox" style="font-size:1.2rem;margin-bottom:6px;display:block;"></i>No projects</div>`}
      </div>
    </div>`).join('');
}

function buildKBCard(p){
  const T=+p.total||0,A=+p.annotated||0;const aP=pct(A,T);
  const dl=dlMeta(p.deadline);const ov=dl&&dl.diff<0;
  return`<div class="kb-card" draggable="true" ondragstart="kbDragStart(event,'${p.id}')" onclick="openDP('${p.id}')">
    <div class="kb-card-title">${esc(p.name)}</div>
    <div class="kb-card-meta">
      <span class="badge b${p.priority[0]}">${{high:'üî•',medium:'‚ö°',low:'üåø'}[p.priority]}</span>
      <span class="kb-pct">${aP}% annotated</span>
      ${dl?`<span class="kb-pct ${ov?'ov':''}"><i class="fas fa-calendar-alt"></i> ${dl.label}</span>`:''}
    </div>
    <div class="pbar" style="margin-top:7px;"><div class="pf pf-a" style="width:${aP}%"></div></div>
  </div>`;
}

function kbDragStart(e,id){dragSrcId=id;e.currentTarget.classList.add('dragging');e.dataTransfer.effectAllowed='move';}
function kbDragOver(e,colId){e.preventDefault();e.dataTransfer.dropEffect='move';document.getElementById(`kbc-${colId}`)?.classList.add('drag-over');}
function kbDragLeave(e){e.currentTarget.classList.remove('drag-over');}
async function kbDrop(e,colId){
  e.preventDefault();e.currentTarget.classList.remove('drag-over');
  if(!dragSrcId)return;
  const p=projects.find(x=>x.id===dragSrcId);
  if(p&&p.kanbanStatus!==colId){p.kanbanStatus=colId;renderKanban();toast(`Moved to ${KB_LABELS[colId]}`,'ok');await saveProjDB(p);}
  dragSrcId=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYTICS TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAnalyticsTab(tab,el){
  ['charts','gantt','burndown'].forEach(t=>document.getElementById('at-'+t).style.display=t===tab?'':'none');
  document.querySelectorAll('.stab').forEach(s=>s.classList.remove('on'));el.classList.add('on');
  if(tab==='charts')renderCharts();
  if(tab==='gantt')renderGantt();
  if(tab==='burndown')populateBurndownSel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function destroyChart(id){if(chartInstances[id]){chartInstances[id].destroy();delete chartInstances[id];}}

function renderCharts(){
  if(!projects.length)return;
  // Priority pie
  destroyChart('pri');
  const h=projects.filter(p=>p.priority==='high').length;
  const m=projects.filter(p=>p.priority==='medium').length;
  const l=projects.filter(p=>p.priority==='low').length;
  chartInstances.pri=new Chart(document.getElementById('priChart'),{type:'doughnut',data:{labels:['High','Medium','Low'],datasets:[{data:[h,m,l],backgroundColor:['#dc2626','#d97706','#16a34a'],borderWidth:2,borderColor:'var(--sur)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:11},color:getComputedStyle(document.body).getPropertyValue('--tx')||'#0f172a'}}}}});

  // Progress bar
  destroyChart('prog');
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const tx=isDark?'#8b949e':'#475569';
  chartInstances.prog=new Chart(document.getElementById('progChart'),{type:'bar',data:{labels:projects.map(p=>p.name.length>14?p.name.substr(0,14)+'‚Ä¶':p.name),datasets:[{label:'Annotated %',data:projects.map(p=>pct(p.annotated,p.total)),backgroundColor:'#3b82f6',borderRadius:4},{label:'Reviewed %',data:projects.map(p=>pct(p.reviewed,p.total)),backgroundColor:'#16a34a',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{size:10},color:tx}}},scales:{x:{ticks:{color:tx,font:{size:9}},grid:{display:false}},y:{min:0,max:100,ticks:{color:tx,font:{size:10}},grid:{color:isDark?'#30363d':'#e2e8f0'}}}}});

  // Status donut
  destroyChart('status');
  const statCounts={todo:0,inprog:0,review:0,done:0};
  projects.forEach(p=>{statCounts[p.kanbanStatus||'todo']++;});
  chartInstances.status=new Chart(document.getElementById('statusChart'),{type:'doughnut',data:{labels:['To Do','In Progress','Review','Done'],datasets:[{data:[statCounts.todo,statCounts.inprog,statCounts.review,statCounts.done],backgroundColor:['#94a3b8','#3b82f6','#d97706','#16a34a'],borderWidth:2,borderColor:'var(--sur)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:11},color:tx}}}}});

  // Employees per project
  destroyChart('emp');
  chartInstances.emp=new Chart(document.getElementById('empChart'),{type:'bar',data:{labels:projects.map(p=>p.name.length>14?p.name.substr(0,14)+'‚Ä¶':p.name),datasets:[{label:'Employees',data:projects.map(p=>(p.assignedEmployees||[]).length),backgroundColor:'#7c3aed',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tx,font:{size:9}},grid:{display:false}},y:{ticks:{color:tx,font:{size:10}},grid:{color:isDark?'#30363d':'#e2e8f0'}}}}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GANTT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGantt(){
  const now=new Date();
  const withDates=projects.filter(p=>p.startdate||p.deadline);
  if(!withDates.length){document.getElementById('ganttTable').innerHTML='<div class="empty-st"><i class="fas fa-stream"></i><p>No projects have start/deadline dates set.</p></div>';return;}
  // compute range
  let minDate=new Date();let maxDate=new Date();
  withDates.forEach(p=>{
    if(p.startdate){const d=new Date(p.startdate+'T00:00:00');if(d<minDate)minDate=d;}
    if(p.deadline){const d=new Date(p.deadline+'T00:00:00');if(d>maxDate)maxDate=d;}
  });
  const totalDays=Math.max(1,Math.ceil((maxDate-minDate)/86400000));
  const todayPct=Math.max(0,Math.min(100,Math.ceil((now-minDate)/86400000)/totalDays*100));
  // months header
  const months=[];let cur=new Date(minDate);cur.setDate(1);
  while(cur<=maxDate){months.push(cur.toLocaleDateString('en-US',{month:'short',year:'numeric'}));cur.setMonth(cur.getMonth()+1);}

  const rows=withDates.map(p=>{
    const s=p.startdate?new Date(p.startdate+'T00:00:00'):minDate;
    const e=p.deadline?new Date(p.deadline+'T00:00:00'):now;
    const left=Math.max(0,Math.ceil((s-minDate)/86400000)/totalDays*100);
    const width=Math.max(1,Math.ceil((e-s)/86400000)/totalDays*100);
    const isOv=e<now;
    return`<div class="gantt-row">
      <div class="gantt-proj-name" title="${esc(p.name)}">${esc(p.name)}</div>
      <div class="gantt-bar-area">
        <div class="today-line" style="left:${todayPct}%"></div>
        <div class="gantt-bar ${p.priority} ${isOv?'overdue':''}" style="left:${left}%;width:${Math.min(width,100-left)}%;" title="${fmtD(p.startdate)} ‚Üí ${fmtD(p.deadline)} ${isOv?'(OVERDUE)':''}">
          ${width>8?p.name.substr(0,12)+'‚Ä¶':''}
        </div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('ganttTable').innerHTML=`
    <div class="gantt-head">
      <div class="gantt-name-col">Project</div>
      <div class="gantt-timeline">${months.map(m=>`<div class="gantt-month">${m}</div>`).join('')}</div>
    </div>
    ${rows}
    <div style="font-size:.68rem;color:var(--tx3);margin-top:10px;display:flex;align-items:center;gap:6px;"><div style="width:12px;height:3px;background:var(--red);border-radius:2px;"></div>Today</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BURNDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateBurndownSel(){
  const sel=document.getElementById('burndownSel');
  sel.innerHTML='<option value="">Select project...</option>'+projects.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
}
function renderBurndown(){
  const id=document.getElementById('burndownSel').value;
  if(!id){destroyChart('bd');return;}
  const p=projects.find(x=>x.id===id);if(!p)return;
  const T=+p.total||0;if(!T){toast('No total images set for this project','info');return;}
  // Simulate a burndown: ideal line from total‚Üí0, actual from annotated position
  const days=14;
  const labels=Array.from({length:days+1},(_,i)=>i===0?'Start':`Day ${i}`);
  const ideal=Array.from({length:days+1},(_,i)=>Math.round(T-T*(i/days)));
  // actual: show current progress at today (mid-point of days), rest null
  const todayIdx=Math.round(days/2);
  const actualVal=T-(+p.annotated||0);
  const actual=Array.from({length:days+1},(_,i)=>{
    if(i===0)return T;
    if(i===todayIdx)return actualVal;
    if(i<todayIdx)return T-Math.round((T-actualVal)*(i/todayIdx));
    return null;
  });
  destroyChart('bd');
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const tx=isDark?'#8b949e':'#475569';
  chartInstances.bd=new Chart(document.getElementById('burndownChart'),{type:'line',data:{labels,datasets:[
    {label:'Ideal',data:ideal,borderColor:'#94a3b8',borderDash:[5,5],borderWidth:2,pointRadius:0,tension:.4,fill:false},
    {label:'Actual',data:actual,borderColor:'#df1e26',backgroundColor:'rgba(223,30,38,.1)',borderWidth:2.5,pointRadius:4,tension:.4,fill:true,spanGaps:false},
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{size:11},color:tx}}},scales:{x:{ticks:{color:tx,font:{size:9}},grid:{color:isDark?'#30363d':'#e2e8f0'}},y:{ticks:{color:tx,font:{size:10}},grid:{color:isDark?'#30363d':'#e2e8f0'},min:0}}}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(){
  const hdr=['Project','Priority','Status','Assigned By','Start','Deadline','Total','Annotated','Reviewed','Pend.Ann','Pend.Rev','%Ann','%Rev','Daily Target','Employees','Notes','Comments'];
  const rows=projects.map(p=>{const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;const emps=(p.assignedEmployees||[]).map(id=>getEmp(id).name).join('; ');
    return[`"${p.name}"`,p.priority,p.kanbanStatus||'todo',`"${p.assignedby||''}"`,p.startdate||'',p.deadline||'',T,A,R,Math.max(T-A,0),Math.max(A-R,0),pct(A,T)+'%',pct(R,T)+'%',p.hasTarget?p.dailyTarget:'‚Äî',`"${emps}"`,`"${(p.notes||'').replace(/"/g,'""')}"`,`"${(p.comments||'').replace(/"/g,'""')}"`].join(',');});
  const csv=[hdr.join(','),...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='camcom_projects.csv';a.click();URL.revokeObjectURL(url);
  toast('CSV exported ‚úì','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF(){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'landscape',format:'a4'});
  // Header
  doc.setFillColor(223,30,38);doc.rect(0,0,297,20,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(14);doc.setFont('helvetica','bold');
  doc.text('CamCom Annotation Tracker ‚Äî Project Report',14,13);
  doc.setFontSize(9);doc.text(new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}),260,13);
  // Summary
  const tI=projects.reduce((s,p)=>s+(+p.total||0),0);
  const tA=projects.reduce((s,p)=>s+(+p.annotated||0),0);
  doc.setTextColor(0,0,0);doc.setFontSize(10);doc.setFont('helvetica','normal');
  doc.text(`Total Projects: ${projects.length}   |   Total Images: ${tI.toLocaleString()}   |   Annotated: ${tA.toLocaleString()} (${pct(tA,tI)}%)   |   Employees: ${employees.length}`,14,28);
  // Table
  let y=36;
  const cols2=[['Project Name',60],['Priority',20],['Status',24],['Annotated%',22],['Reviewed%',22],['Deadline',26],['Assigned By',30],['Employees',18]];
  doc.setFillColor(240,244,249);doc.rect(10,y-5,277,8,'F');
  doc.setFont('helvetica','bold');doc.setFontSize(8);
  let x=14;cols2.forEach(([h,w])=>{doc.text(h,x,y);x+=w;});y+=6;
  doc.setDrawColor(226,232,240);doc.line(10,y-1,287,y-1);
  doc.setFont('helvetica','normal');doc.setFontSize(8);
  projects.forEach((p,i)=>{
    if(y>190){doc.addPage();doc.setFillColor(223,30,38);doc.rect(0,0,297,14,'F');doc.setTextColor(255,255,255);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text('CamCom Annotation Tracker (continued)',14,10);doc.setTextColor(0,0,0);doc.setFont('helvetica','normal');doc.setFontSize(8);y=22;}
    if(i%2===0){doc.setFillColor(248,250,252);doc.rect(10,y-4,277,7,'F');}
    x=14;const row=[p.name.length>28?p.name.substr(0,28)+'‚Ä¶':p.name,p.priority,p.kanbanStatus||'todo',pct(p.annotated,p.total)+'%',pct(p.reviewed,p.total)+'%',fmtD(p.deadline),p.assignedby||'‚Äî',(p.assignedEmployees||[]).length.toString()];
    cols2.forEach(([,w],ci)=>{doc.text(String(row[ci]||''),x,y);x+=w;});y+=8;
  });
  // Footer
  const totalPages=doc.internal.getNumberOfPages();
  for(let i=1;i<=totalPages;i++){doc.setPage(i);doc.setFontSize(7);doc.setTextColor(148,163,184);doc.text(`CamCom Annotation Tracker  ‚Ä¢  Page ${i} of ${totalPages}`,14,205);doc.text('Confidential',260,205);}
  doc.save('camcom_report.pdf');
  toast('PDF exported ‚úì','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FEATURE_DEFS=[
  {key:'kanban',label:'Kanban Board',desc:'Visual columns: To Do, In Progress, Review, Completed with drag-and-drop'},
  {key:'analytics',label:'Analytics & Charts',desc:'Priority pie chart, progress charts, employee distribution'},
  {key:'gantt',label:'Timeline / Gantt Chart',desc:'Visual project timeline and deadline overview'},
  {key:'burndown',label:'Burndown Chart',desc:'Track annotation progress burndown per project'},
  {key:'exportPDF',label:'Export PDF Report',desc:'Generate and download a PDF summary report'},
  {key:'exportCSV',label:'Export CSV',desc:'Export all project data to a spreadsheet-compatible CSV file'},
  {key:'workload',label:'Workload Overview',desc:'See which employees are assigned to how many projects'},
  {key:'dailyTarget',label:'Daily Image Target',desc:'Set a daily completion target per project'},
  {key:'fileUpload',label:'File Uploads',desc:'Attach documents and files to each project'},
];
function renderSettings(){
  document.getElementById('settingsGrid').innerHTML=FEATURE_DEFS.map(f=>`
    <div class="setting-card">
      <div class="setting-info"><strong>${f.label}</strong><span>${f.desc}</span></div>
      <label class="toggle-sw"><input type="checkbox" ${features[f.key]?'checked':''} onchange="toggleFeature('${f.key}',this.checked)"><span class="toggle-sl"></span></label>
    </div>`).join('');
  // Update sidebar visibility
  const map={kanban:'kanban',analytics:'analytics',workload:'workload'};
  Object.entries(map).forEach(([k,page])=>{
    const btn=document.querySelector(`[data-page="${page}"]`);
    if(btn)btn.style.display=features[k]?'':'none';
  });
}
function toggleFeature(key,val){
  features[key]=val;saveFeaturesLocal();renderSettings();
  toast(`${val?'Enabled':'Disabled'}: ${FEATURE_DEFS.find(f=>f.key===key)?.label}`,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANAGE USERS (Admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsers(){
  const roleColors={admin:'#dc2626',manager:'#2563eb',reviewer:'#d97706',employee:'#16a34a'};
  document.getElementById('usersGrid').innerHTML=appUsers.map(u=>{
    const r=ROLES[u.role];const initls=u.name.split(' ').filter(Boolean).map(w=>w[0]).join('').substr(0,2).toUpperCase();
    const linkedEmp=u.empId?getEmp(u.empId):null;
    const isMe=currentUser&&u.id===currentUser.id;
    return`<div class="user-card">
      <div class="user-card-av" style="background:${r.color}">${initls}</div>
      <div class="user-card-info">
        <strong>${esc(u.name)}${isMe?' <span style="font-size:.62rem;color:var(--tx3);">(you)</span>':''}</strong>
        <span>${esc(u.email)}</span>
        <div style="margin-top:5px;display:flex;gap:5px;flex-wrap:wrap;align-items:center;">
          <span class="role-pill ${r.pill}">${r.icon} ${r.label}</span>
          ${linkedEmp?`<span style="font-size:.68rem;color:var(--tx3);"><i class="fas fa-link"></i> ${esc(linkedEmp.name)}</span>`:''}
          <span style="font-size:.67rem;color:var(--tx3);font-family:monospace;">pwd: ${esc(u.pwd)}</span>
        </div>
      </div>
      <div class="user-card-actions">
        ${!isMe?`<button class="iBtn" onclick="openUserModal('${u.id}')" title="Edit"><i class="fas fa-pen"></i></button>
        <button class="iBtn del" onclick="deleteUser('${u.id}')" title="Delete"><i class="fas fa-trash"></i></button>`:''}
      </div>
    </div>`;
  }).join('');
}

function openUserModal(id=null){
  editUserId=id||null;
  const isEdit=!!id;
  document.getElementById('uMTtl').textContent=isEdit?'Edit User':'Add User';
  if(isEdit){
    const u=appUsers.find(x=>x.id===id);if(!u)return;
    document.getElementById('fu-name').value=u.name;
    document.getElementById('fu-email').value=u.email;
    document.getElementById('fu-pwd').value=u.pwd;
    document.getElementById('fu-role').value=u.role;
    // populate emp select
    populateEmpSelect();document.getElementById('fu-empId').value=u.empId||'';
    onRoleChange();
  } else {
    ['fu-name','fu-email','fu-pwd'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('fu-role').value='employee';
    populateEmpSelect();onRoleChange();
  }
  document.getElementById('userOvl').classList.add('open');
}
function closeUserModal(){document.getElementById('userOvl').classList.remove('open');}
function onRoleChange(){
  const role=document.getElementById('fu-role').value;
  document.getElementById('empLinkWrap').style.display=role==='employee'?'':'none';
}
function populateEmpSelect(){
  const sel=document.getElementById('fu-empId');
  sel.innerHTML='<option value="">‚Äî Select employee record ‚Äî</option>'+
    employees.map(e=>`<option value="${e.id}">${esc(e.name)} (${e.gender==='male'?'‚ôÇ':'‚ôÄ'})</option>`).join('');
}
function saveUser(){
  const name=document.getElementById('fu-name').value.trim();
  const email=document.getElementById('fu-email').value.trim().toLowerCase();
  const pwd=document.getElementById('fu-pwd').value.trim();
  const role=document.getElementById('fu-role').value;
  const empId=role==='employee'?(document.getElementById('fu-empId').value||null):null;
  if(!name){toast('Name is required','err');return;}
  if(!email){toast('Email is required','err');return;}
  if(!pwd){toast('Password is required','err');return;}
  // Check email uniqueness
  const dup=appUsers.find(u=>u.email===email&&u.id!==editUserId);
  if(dup){toast('Email already in use by another user','err');return;}
  if(editUserId){
    const idx=appUsers.findIndex(u=>u.id===editUserId);
    if(idx>-1){appUsers[idx]={...appUsers[idx],name,email,pwd,role,empId};toast('User updated ‚úì','ok');}
  } else {
    appUsers.push({id:'u_'+Date.now(),name,email,pwd,role,empId});
    toast('User added ‚úì','ok');
  }
  saveUsersLocal();closeUserModal();renderUsers();
}
function deleteUser(id){
  if(id===currentUser?.id){toast("You can't delete your own account",'err');return;}
  if(!confirm('Delete this user? They will no longer be able to sign in.'))return;
  appUsers=appUsers.filter(u=>u.id!==id);
  saveUsersLocal();renderUsers();toast('User removed','info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme(){
  const dark=document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme',dark?'light':'dark');
  document.getElementById('tIco').className=dark?'fas fa-moon':'fas fa-sun';
  document.getElementById('tLbl').textContent=dark?'Dark mode':'Light mode';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START ‚Äî restore session or show login
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
tryRestoreSession();
</script>
<!-- ‚ïê‚ïê‚ïê MODAL: USER ‚ïê‚ïê‚ïê -->
<div class="overlay" id="userOvl" onclick="if(event.target===this)closeUserModal()">
<div class="modal" style="width:430px;">
  <div class="modal-title"><i class="fas fa-user-shield" style="color:var(--red)"></i><span id="uMTtl">Add User</span></div>
  <div class="fgrid">
    <div class="ff full"><label>Full Name *</label><input type="text" id="fu-name" placeholder="e.g. Priya Sharma"></div>
    <div class="ff full"><label>Email *</label><input type="email" id="fu-email" placeholder="priya@camcom.ai"></div>
    <div class="ff"><label>Password *</label><input type="password" id="fu-pwd" placeholder="Set password"></div>
    <div class="ff"><label>Role</label>
      <select id="fu-role" onchange="onRoleChange()">
        <option value="admin">üëë Admin</option>
        <option value="manager">üîµ Manager</option>
        <option value="reviewer">üü° Reviewer</option>
        <option value="employee">üü¢ Employee</option>
      </select>
    </div>
    <div class="ff full" id="empLinkWrap" style="display:none;">
      <label>Link to Employee Record <span style="font-weight:400;color:var(--tx3);">(required for employees ‚Äî sets which projects they see)</span></label>
      <select id="fu-empId"><option value="">‚Äî Select employee ‚Äî</option></select>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeUserModal()">Cancel</button>
    <button class="btn btn-red" onclick="saveUser()"><i class="fas fa-save"></i> Save User</button>
  </div>
</div></div>

</body>
</html>
