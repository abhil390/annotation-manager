<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CamCom Annotation Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg:#f1f5f9;--sur:#fff;--sur2:#f7fafc;--brd:#e2e8f0;
  --tx:#0f172a;--tx2:#475569;--tx3:#94a3b8;
  --red:#df1e26;--red-d:#b91c1c;--red-l:#fff1f2;
  --blue:#2563eb;--blue-l:#eff6ff;
  --green:#16a34a;--green-l:#f0fdf4;
  --yellow:#d97706;--yel-l:#fffbeb;
  --purple:#7c3aed;--pur-l:#f5f3ff;
  --sh:0 4px 24px rgba(15,23,42,.08);--sh-sm:0 1px 6px rgba(15,23,42,.06);
  --r:14px;--rsm:9px;--rp:999px;
}
[data-theme="dark"]{
  --bg:#0d1117;--sur:#161b22;--sur2:#21262d;--brd:#30363d;
  --tx:#f0f6fc;--tx2:#8b949e;--tx3:#484f58;
  --red-l:#2a0d0f;--blue-l:#1e2d40;--green-l:#0a1f0e;--yel-l:#1f1400;--pur-l:#1a1130;
  --sh:0 4px 24px rgba(0,0,0,.4);--sh-sm:0 1px 6px rgba(0,0,0,.3);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--tx);font-family:'Inter',sans-serif;min-height:100vh;}
/* SIDEBAR */
.layout{display:flex;min-height:100vh;}
.sidebar{width:252px;background:var(--sur);border-right:1px solid var(--brd);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;overflow-y:auto;}
.logo-wrap{padding:16px 16px 14px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:10px;}
.logo-svg{width:40px;height:40px;flex-shrink:0;border-radius:5px;overflow:hidden;}
.logo-text strong{font-family:'Space Grotesk',sans-serif;font-size:.92rem;font-weight:700;color:var(--red);display:block;line-height:1.2;}
.logo-text span{font-size:.62rem;color:var(--tx3);display:block;margin-top:1px;}
.nav-grp{padding:12px 14px 4px;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--tx3);}
.nav-btn{display:flex;align-items:center;gap:9px;padding:9px 12px;margin:1px 6px;border-radius:var(--rsm);cursor:pointer;font-size:.83rem;font-weight:500;color:var(--tx2);border:none;background:none;width:calc(100% - 12px);text-align:left;font-family:'Inter',sans-serif;transition:all .15s;}
.nav-btn:hover{background:var(--sur2);color:var(--tx);}
.nav-btn.active{background:var(--red-l);color:var(--red);font-weight:600;}
.nav-btn i{width:15px;text-align:center;font-size:.8rem;}
.nbadge{margin-left:auto;background:var(--red);color:#fff;font-size:.6rem;padding:1px 6px;border-radius:20px;font-weight:700;}
.nav-divider{height:1px;background:var(--brd);margin:6px 14px;}
.sidebar-foot{margin-top:auto;padding:12px;border-top:1px solid var(--brd);}
.theme-btn{display:flex;align-items:center;gap:8px;font-size:.8rem;color:var(--tx2);cursor:pointer;padding:7px 10px;border-radius:var(--rsm);background:none;border:none;width:100%;font-family:'Inter',sans-serif;}
.theme-btn:hover{background:var(--sur2);}
/* MAIN */
.main{margin-left:252px;flex:1;padding:22px 24px;max-width:calc(100% - 252px);}
.page{display:none;}.page.active{display:block;}
/* TOPBAR */
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap;}
.pg-title{font-family:'Space Grotesk',sans-serif;font-size:1.45rem;font-weight:700;}
.topbar-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.sbox{display:flex;align-items:center;gap:7px;background:var(--sur);border:1px solid var(--brd);border-radius:var(--rp);padding:7px 14px;min-width:195px;}
.sbox input{border:none;background:none;outline:none;color:var(--tx);font-family:inherit;font-size:.83rem;width:100%;}
.sbox i{color:var(--tx3);font-size:.8rem;}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:5px;padding:8px 16px;border-radius:var(--rp);font-size:.82rem;font-weight:600;cursor:pointer;border:1px solid transparent;font-family:'Inter',sans-serif;transition:all .15s;}
.btn-red{background:var(--red);color:#fff;}.btn-red:hover{background:var(--red-d);}
.btn-ghost{background:var(--sur);color:var(--tx2);border-color:var(--brd);}.btn-ghost:hover{background:var(--sur2);color:var(--tx);}
.btn-green{background:var(--green-l);color:var(--green);border-color:var(--green);}.btn-green:hover{background:var(--green);color:#fff;}
.btn-blue{background:var(--blue-l);color:var(--blue);border-color:var(--blue);}.btn-blue:hover{background:var(--blue);color:#fff;}
.btn-sm{padding:5px 11px;font-size:.74rem;}
.iBtn{width:28px;height:28px;border-radius:7px;border:none;background:none;cursor:pointer;color:var(--tx3);display:flex;align-items:center;justify-content:center;font-size:.76rem;transition:all .15s;}
.iBtn:hover{background:var(--sur2);color:var(--tx);}
.iBtn.del:hover{background:var(--red-l);color:var(--red);}
/* STATS */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:12px;margin-bottom:20px;}
.sc{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:16px;box-shadow:var(--sh-sm);position:relative;overflow:hidden;}
.sc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--red);}
.sc.b::before{background:var(--blue);}.sc.g::before{background:var(--green);}.sc.y::before{background:var(--yellow);}.sc.p::before{background:var(--purple);}.sc.r::before{background:var(--red);}
.sc-l{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);margin-bottom:4px;}
.sc-v{font-family:'Space Grotesk',sans-serif;font-size:1.75rem;font-weight:700;line-height:1;}
.sc-s{font-size:.68rem;color:var(--tx3);margin-top:4px;}
/* FILTER BAR */
.fbar{display:flex;gap:7px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
.fc{padding:5px 12px;border-radius:var(--rp);font-size:.75rem;font-weight:500;cursor:pointer;border:1px solid var(--brd);background:var(--sur);color:var(--tx2);transition:all .15s;}
.fc:hover,.fc.on{background:var(--red-l);border-color:var(--red);color:var(--red);}
.fc.hi{border-color:#dc2626;color:#dc2626;background:#fff1f1;}.fc.hi.on{background:#dc2626;color:#fff;}
.fc.me{border-color:var(--yellow);color:var(--yellow);background:var(--yel-l);}.fc.me.on{background:var(--yellow);color:#fff;}
.fc.lo{border-color:var(--green);color:var(--green);background:var(--green-l);}.fc.lo.on{background:var(--green);color:#fff;}
select.fsel{padding:5px 11px;border-radius:var(--rp);font-size:.75rem;border:1px solid var(--brd);background:var(--sur);color:var(--tx2);outline:none;cursor:pointer;font-family:'Inter',sans-serif;}
/* CONFLICT BANNER */
.cbanner{display:flex;align-items:center;gap:8px;padding:9px 14px;background:var(--red-l);border:1px solid #fca5a5;border-radius:var(--rsm);color:#dc2626;font-size:.78rem;font-weight:600;margin-bottom:16px;}

/* ‚ïê‚ïê‚ïê‚ïê PROJECT CARDS ‚ïê‚ïê‚ïê‚ïê */
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(295px,1fr));gap:14px;}
.pcard{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);box-shadow:var(--sh-sm);cursor:pointer;position:relative;overflow:hidden;transition:all .2s;}
.pcard:hover{box-shadow:var(--sh);transform:translateY(-2px);border-color:var(--red);}
.pcard-stripe{height:3px;}
.pcard-stripe.high{background:linear-gradient(90deg,#dc2626,#f87171);}
.pcard-stripe.medium{background:linear-gradient(90deg,#d97706,#fbbf24);}
.pcard-stripe.low{background:linear-gradient(90deg,#16a34a,#4ade80);}
.pcard-body{padding:14px 14px 10px;}
.pcard-title{font-family:'Space Grotesk',sans-serif;font-size:.95rem;font-weight:700;margin-bottom:6px;line-height:1.3;}
.pcard-meta{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px;align-items:center;}
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--rp);font-size:.64rem;font-weight:700;text-transform:uppercase;}
.bh{background:#fee2e2;color:#dc2626;}.bm{background:#fef3c7;color:#d97706;}.bl{background:#dcfce7;color:#16a34a;}
.mpill{font-size:.66rem;color:var(--tx3);display:flex;align-items:center;gap:3px;}
.mpill.ov{color:#dc2626;}.mpill.sn{color:var(--yellow);}
.pcard-prog{margin-bottom:9px;}
.prog-r{display:flex;justify-content:space-between;margin-bottom:3px;}
.prog-l{font-size:.63rem;color:var(--tx3);}
.prog-p{font-size:.63rem;font-weight:700;color:var(--tx2);}
.pbar{height:4px;background:var(--sur2);border-radius:10px;overflow:hidden;border:1px solid var(--brd);}
.pf{height:100%;border-radius:10px;transition:width .4s;}
.pf-a{background:var(--blue);}.pf-r{background:var(--green);}
.pcard-foot{display:flex;justify-content:space-between;align-items:center;padding:9px 14px;border-top:1px solid var(--brd);background:var(--sur2);}
.avatars{display:flex;} 
.av{width:22px;height:22px;border-radius:50%;color:#fff;font-size:.52rem;font-weight:700;display:flex;align-items:center;justify-content:center;border:2px solid var(--sur);margin-left:-4px;flex-shrink:0;}
.av:first-child{margin-left:0;}
.av.m{background:var(--blue);}.av.f{background:var(--purple);}
.av.more{background:var(--tx3);}
.hint-txt{font-size:.62rem;color:var(--tx3);display:flex;align-items:center;gap:3px;}
.kanban-col-badge{font-size:.63rem;padding:2px 7px;border-radius:var(--rp);font-weight:600;}

/* ‚ïê‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê‚ïê */
.dp-overlay{position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:200;opacity:0;pointer-events:none;transition:opacity .25s;}
.dp-overlay.open{opacity:1;pointer-events:all;}
.dp{position:fixed;top:0;right:0;bottom:0;width:640px;max-width:95vw;background:var(--sur);box-shadow:-8px 0 40px rgba(15,23,42,.15);transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:201;display:flex;flex-direction:column;}
.dp.open{transform:translateX(0);}
.dp-hdr{padding:16px 20px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:flex-start;flex-shrink:0;}
.dp-title{font-family:'Space Grotesk',sans-serif;font-size:1.1rem;font-weight:700;line-height:1.3;}
.dp-close{width:30px;height:30px;border-radius:7px;border:none;background:var(--sur2);color:var(--tx2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.82rem;transition:all .15s;}
.dp-close:hover{background:var(--red-l);color:var(--red);}
.dp-body{flex:1;overflow-y:auto;}
.dp-sec{padding:14px 20px;border-bottom:1px solid var(--brd);}
.dp-sec:last-child{border-bottom:none;}
.ds-hdr{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);margin-bottom:9px;display:flex;align-items:center;gap:5px;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.inf label{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--tx3);display:block;margin-bottom:3px;}
.inf input,.inf select,.inf textarea{width:100%;padding:7px 10px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-family:'Inter',sans-serif;font-size:.82rem;outline:none;}
.inf input:focus,.inf select:focus,.inf textarea:focus{border-color:var(--red);}
.num-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;}
.nc{background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);padding:7px 5px;text-align:center;}
.nc input{width:100%;border:none;background:none;outline:none;font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:.9rem;color:var(--tx);text-align:center;}
.nc-l{font-size:.58rem;color:var(--tx3);text-transform:uppercase;letter-spacing:.3px;margin-top:2px;}
.nc.comp{background:var(--blue-l);border-color:var(--blue);}
.nc.comp .ncv{font-weight:700;font-size:.9rem;font-family:'Space Grotesk',sans-serif;color:var(--blue);}
.nc.comp2{background:var(--green-l);border-color:var(--green);}
.nc.comp2 .ncv{color:var(--green);}
.tgt-row{display:flex;align-items:center;gap:8px;background:var(--yel-l);border:1px solid #fde68a;border-radius:var(--rsm);padding:9px 12px;margin-top:9px;}
.tgt-row i{color:var(--yellow);}
.tgt-row label{font-size:.76rem;font-weight:600;color:var(--yellow);}
.tgt-row input{max-width:90px;padding:4px 8px;border:1px solid #fde68a;border-radius:var(--rsm);background:#fff;color:var(--tx);font-family:'Inter',sans-serif;font-size:.82rem;outline:none;}
/* emp search in detail */
.esbox{display:flex;align-items:center;gap:7px;background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);padding:7px 11px;margin-bottom:7px;}
.esbox input{border:none;background:none;outline:none;color:var(--tx);font-family:inherit;font-size:.81rem;width:100%;}
.e-results{max-height:150px;overflow-y:auto;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur);}
.e-row{display:flex;justify-content:space-between;align-items:center;padding:7px 11px;border-bottom:1px solid var(--brd);transition:background .1s;}
.e-row:last-child{border-bottom:none;}
.e-row:hover{background:var(--sur2);}
.e-name{font-size:.81rem;font-weight:500;}
.e-sub{font-size:.66rem;color:var(--tx3);}
.e-sub.warn{color:var(--yellow);}.e-sub.taken{color:#dc2626;}
.atags{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;}
.atag{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:var(--rp);font-size:.71rem;font-weight:500;background:var(--blue-l);border:1px solid var(--blue);color:var(--blue);}
.atag.cc{background:#fee2e2;border-color:#dc2626;color:#dc2626;}
.atag button{background:none;border:none;color:inherit;cursor:pointer;font-size:.6rem;opacity:.7;}
.atag button:hover{opacity:1;}
/* upload */
.upzone{border:2px dashed var(--brd);border-radius:var(--rsm);padding:14px;text-align:center;cursor:pointer;position:relative;transition:all .2s;}
.upzone:hover{border-color:var(--red);background:var(--red-l);}
.upzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;}
.upzone i{font-size:1.3rem;color:var(--tx3);margin-bottom:5px;display:block;}
.upzone p{font-size:.76rem;color:var(--tx3);}
.doclist{display:flex;flex-direction:column;gap:5px;margin-top:8px;}
.docitem{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);}
.docitem i{color:var(--red);font-size:.82rem;}
.doc-n{font-size:.77rem;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.doc-s{font-size:.63rem;color:var(--tx3);}
.doc-rm{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:.73rem;padding:2px;}
.doc-rm:hover{color:#dc2626;}
/* comments */
.cmt-ta{width:100%;padding:8px 11px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-family:'Inter',sans-serif;font-size:.81rem;resize:vertical;min-height:65px;outline:none;}
.cmt-ta:focus{border-color:var(--red);}
/* ‚îÄ‚îÄ Threaded comments ‚îÄ‚îÄ */
.tc-list{display:flex;flex-direction:column;}
.tc-item{padding:14px 16px;border-bottom:1px solid var(--brd);transition:background .15s;}
.tc-item:last-child{border-bottom:none;}
.tc-item.tc-mine{background:rgba(220,38,38,.03);}
.tc-item.tc-unread{background:rgba(37,99,235,.05);}
.tc-item:hover{background:var(--sur2);}
.tc-hdr{display:flex;align-items:center;gap:9px;margin-bottom:8px;}
.tc-av{width:30px;height:30px;border-radius:50%;color:#fff;font-size:.65rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.tc-meta{display:flex;flex-direction:column;gap:1px;}
.tc-name{font-size:.8rem;font-weight:700;color:var(--tx);}
.tc-role{font-size:.64rem;font-weight:600;padding:1px 6px;border-radius:8px;}
.tc-time{font-size:.67rem;color:var(--tx3);margin-left:auto;white-space:nowrap;}
.tc-body{font-size:.84rem;color:var(--tx2);line-height:1.7;white-space:pre-wrap;word-break:break-word;padding-left:39px;margin-bottom:8px;}
.tc-mention{color:var(--blue);font-weight:600;background:rgba(37,99,235,.1);border-radius:4px;padding:1px 5px;}
.tc-actions{display:flex;gap:8px;padding-left:39px;}
.tc-btn{background:none;border:none;color:var(--tx3);font-size:.7rem;cursor:pointer;padding:3px 8px;border-radius:5px;display:inline-flex;align-items:center;gap:4px;font-weight:500;}
.tc-btn:hover{background:var(--sur2);color:var(--tx);}
.tc-btn.del:hover{background:rgba(220,38,38,.08);color:var(--red);}
.tc-replies{border-left:3px solid var(--brd);margin:10px 0 0 15px;}
.tc-replies .tc-item{padding-left:12px;}
/* reply banner */
.tc-reply-banner{display:flex;align-items:center;justify-content:space-between;background:rgba(37,99,235,.07);border:1px solid rgba(37,99,235,.2);border-radius:var(--rsm);padding:7px 12px;margin-bottom:10px;font-size:.76rem;color:var(--blue);}
/* compose area */
.tc-compose{display:flex;align-items:flex-start;gap:10px;padding:14px 16px;background:var(--sur2);border-top:1px solid var(--brd);}
.tc-compose-av{width:30px;height:30px;border-radius:50%;color:#fff;font-size:.65rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;}
.tc-compose-right{flex:1;display:flex;flex-direction:column;gap:6px;}
.tc-textarea{width:100%;padding:10px 13px;border:1.5px solid var(--brd);border-radius:10px;background:var(--sur);color:var(--tx);font-family:'Inter',sans-serif;font-size:.83rem;resize:none;min-height:48px;max-height:200px;outline:none;transition:border-color .2s;line-height:1.55;box-sizing:border-box;}
.tc-textarea:focus{border-color:var(--red);}
.tc-compose-foot{display:flex;align-items:center;justify-content:space-between;}
.tc-hint{font-size:.64rem;color:var(--tx3);}
.tc-send{padding:7px 16px;background:var(--red);color:#fff;border:none;border-radius:8px;font-size:.78rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:opacity .15s;}
.tc-send:hover{opacity:.82;}
/* @mention popup */
.mention-pop{position:fixed;background:var(--sur);border:1px solid var(--brd);border-radius:var(--rp);box-shadow:0 8px 28px rgba(0,0,0,.18);z-index:9999;max-height:240px;overflow-y:auto;min-width:210px;}
.mention-row{padding:9px 14px;cursor:pointer;font-size:.81rem;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--brd);}
.mention-row:last-child{border-bottom:none;}
.mention-row:hover,.mention-row.active{background:var(--sur2);}
.mention-row .m-av{width:26px;height:26px;border-radius:50%;background:var(--red);color:#fff;font-size:.62rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.mention-row .m-info{display:flex;flex-direction:column;gap:1px;}
.mention-row .m-name{font-size:.79rem;font-weight:600;color:var(--tx);}
.mention-row .m-email{font-size:.64rem;color:var(--tx3);}
/* notification bell */
.nb-btn{position:relative;background:none;border:none;color:var(--tx2);cursor:pointer;padding:5px 7px;border-radius:var(--rsm);font-size:.95rem;}
.nb-btn:hover{background:var(--sur2);}
.nb-dot{position:absolute;top:3px;right:3px;width:8px;height:8px;background:#dc2626;border-radius:50%;display:none;}
.nb-dot.on{display:block;}
.notif-panel{position:fixed;top:56px;right:16px;width:340px;max-height:480px;background:var(--sur);border:1px solid var(--brd);border-radius:var(--rp);box-shadow:0 8px 32px rgba(0,0,0,.18);z-index:600;display:none;flex-direction:column;}
.notif-panel.open{display:flex;}
.np-hdr{padding:12px 16px;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between;}
.np-hdr strong{font-size:.88rem;}
.np-hdr button{background:none;border:none;color:var(--tx3);font-size:.72rem;cursor:pointer;padding:3px 8px;border-radius:var(--rsm);}
.np-hdr button:hover{background:var(--sur2);color:var(--tx);}
.np-list{overflow-y:auto;flex:1;}
.np-item{padding:11px 14px 11px 12px;border-bottom:1px solid var(--brd);cursor:pointer;display:flex;gap:0;transition:background .12s;}
.np-item:hover{background:var(--sur2);}
.np-item.unread{background:rgba(37,99,235,.05);}
.np-unread-dot{width:7px;height:7px;background:var(--blue);border-radius:50%;flex-shrink:0;margin-top:5px;margin-right:7px;}
.np-read-dot{width:7px;flex-shrink:0;margin-right:7px;}
.np-body{flex:1;}
.np-proj{font-size:.7rem;font-weight:700;color:var(--red);margin-bottom:2px;}
.np-text{font-size:.78rem;color:var(--tx2);line-height:1.45;}
.np-time{font-size:.65rem;color:var(--tx3);margin-top:3px;}
.np-empty{padding:36px 20px;text-align:center;color:var(--tx3);font-size:.82rem;}
/* realtime indicator */
.rt-badge{display:inline-flex;align-items:center;gap:5px;padding:2px 8px;border-radius:20px;font-size:.65rem;font-weight:600;background:rgba(22,163,74,.1);color:#16a34a;border:1px solid rgba(22,163,74,.25);}
.rt-dot{width:7px;height:7px;border-radius:50%;background:#16a34a;animation:rtP 1.8s infinite;}
@keyframes rtP{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}

/* ‚ïê‚ïê‚ïê‚ïê KANBAN ‚ïê‚ïê‚ïê‚ïê */
.kanban-wrap{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;min-height:500px;}
.kb-col{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);display:flex;flex-direction:column;min-height:400px;}
.kb-hdr{padding:12px 14px;border-bottom:1px solid var(--brd);display:flex;justify-content:space-between;align-items:center;}
.kb-col-title{font-family:'Space Grotesk',sans-serif;font-size:.88rem;font-weight:700;}
.kb-count{font-size:.7rem;padding:2px 8px;border-radius:var(--rp);font-weight:600;}
.col-todo .kb-hdr{border-top:3px solid var(--tx3);border-radius:var(--r) var(--r) 0 0;}
.col-todo .kb-count{background:var(--sur2);color:var(--tx3);}
.col-inprog .kb-hdr{border-top:3px solid var(--blue);border-radius:var(--r) var(--r) 0 0;}
.col-inprog .kb-count{background:var(--blue-l);color:var(--blue);}
.col-review .kb-hdr{border-top:3px solid var(--yellow);border-radius:var(--r) var(--r) 0 0;}
.col-review .kb-count{background:var(--yel-l);color:var(--yellow);}
.col-done .kb-hdr{border-top:3px solid var(--green);border-radius:var(--r) var(--r) 0 0;}
.col-done .kb-count{background:var(--green-l);color:var(--green);}
.kb-cards{flex:1;padding:10px;display:flex;flex-direction:column;gap:8px;min-height:100px;}
.kb-cards.drag-over{background:rgba(37,99,235,.06);border-radius:var(--rsm);}
.kb-card{background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);padding:10px 12px;cursor:grab;user-select:none;transition:all .15s;}
.kb-card:hover{box-shadow:var(--sh-sm);border-color:var(--red);}
.kb-card.dragging{opacity:.5;transform:rotate(1deg);}
.kb-card-title{font-size:.82rem;font-weight:600;margin-bottom:5px;line-height:1.3;}
.kb-card-meta{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
.kb-pct{font-size:.66rem;color:var(--tx3);}
.kb-empty{text-align:center;padding:20px;color:var(--tx3);font-size:.76rem;}

/* ‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;}
.chart-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;box-shadow:var(--sh-sm);}
.chart-title{font-family:'Space Grotesk',sans-serif;font-size:.9rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.chart-wrap{position:relative;height:220px;}

/* ‚ïê‚ïê‚ïê‚ïê GANTT ‚ïê‚ïê‚ïê‚ïê */
.gantt-wrap{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;box-shadow:var(--sh-sm);overflow-x:auto;}
.gantt-table{min-width:800px;width:100%;}
.gantt-head{display:flex;border-bottom:1px solid var(--brd);padding-bottom:8px;margin-bottom:8px;}
.gantt-name-col{width:200px;flex-shrink:0;font-size:.68rem;font-weight:700;text-transform:uppercase;color:var(--tx3);}
.gantt-timeline{flex:1;display:flex;gap:0;}
.gantt-month{flex:1;font-size:.65rem;font-weight:600;color:var(--tx3);text-align:center;}
.gantt-row{display:flex;align-items:center;padding:5px 0;border-bottom:1px solid var(--brd);}
.gantt-row:last-child{border-bottom:none;}
.gantt-row:hover{background:var(--sur2);}
.gantt-proj-name{width:200px;flex-shrink:0;font-size:.8rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:10px;}
.gantt-bar-area{flex:1;position:relative;height:24px;}
.gantt-bar{position:absolute;height:18px;top:3px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:600;color:#fff;overflow:hidden;white-space:nowrap;min-width:4px;}
.gantt-bar.high{background:linear-gradient(90deg,#dc2626,#f87171);}
.gantt-bar.medium{background:linear-gradient(90deg,#d97706,#fbbf24);}
.gantt-bar.low{background:linear-gradient(90deg,#16a34a,#4ade80);}
.gantt-bar.overdue{background:linear-gradient(90deg,#7f1d1d,#dc2626);border:1px dashed #fff;}
.today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--red);opacity:.7;z-index:2;}

/* ‚ïê‚ïê‚ïê‚ïê EMPLOYEES TABLE ‚ïê‚ïê‚ïê‚ïê */
.tbl-wrap{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh-sm);}
table{width:100%;border-collapse:collapse;}
th{background:var(--sur2);padding:9px 13px;font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);text-align:left;border-bottom:1px solid var(--brd);}
td{padding:9px 13px;font-size:.81rem;border-bottom:1px solid var(--brd);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--sur2);}
.st-f{color:var(--tx3);font-size:.7rem;}.st-a{color:var(--green);font-weight:600;font-size:.7rem;}.st-c{color:#dc2626;font-weight:700;font-size:.7rem;}
.gm{color:var(--blue);font-size:.7rem;font-weight:600;}.gf{color:var(--purple);font-size:.7rem;font-weight:600;}

/* ‚ïê‚ïê‚ïê‚ïê WORKLOAD ‚ïê‚ïê‚ïê‚ïê */
.wl-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;box-shadow:var(--sh-sm);}
.wl-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--brd);gap:10px;flex-wrap:wrap;}
.wl-row:last-child{border-bottom:none;}
.wl-n{font-weight:600;font-size:.85rem;min-width:155px;}
.wl-p{color:var(--tx3);font-size:.74rem;flex:1;}
.wl-bw{width:140px;}

/* ‚ïê‚ïê‚ïê‚ïê WORKLOAD ENHANCED ‚ïê‚ïê‚ïê‚ïê */
.wl-summary-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:20px;}
.wl-sc{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:14px 16px;box-shadow:var(--sh-sm);position:relative;overflow:hidden;display:flex;flex-direction:column;gap:3px;}
.wl-sc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.wl-sc.ann::before{background:var(--blue);}
.wl-sc.rev::before{background:var(--yellow);}
.wl-sc.dual::before{background:var(--red);}
.wl-sc.free::before{background:var(--green);}
.wl-sc.tot::before{background:var(--purple);}
.wl-sc-lbl{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);}
.wl-sc-val{font-family:'Space Grotesk',sans-serif;font-size:1.7rem;font-weight:700;line-height:1;}
.wl-sc-sub{font-size:.66rem;color:var(--tx3);margin-top:2px;}
.wl-section-title{font-family:'Space Grotesk',sans-serif;font-size:.92rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:7px;padding-bottom:8px;border-bottom:1px solid var(--brd);}
.wl-proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;margin-bottom:24px;}
.wl-proj-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);box-shadow:var(--sh-sm);overflow:hidden;}
.wl-proj-hdr{padding:11px 14px 9px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:8px;}
.wl-proj-name{font-family:'Space Grotesk',sans-serif;font-size:.88rem;font-weight:700;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.wl-proj-count{font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:var(--rp);}
.wl-proj-body{padding:10px 14px;}
.wl-member-row{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--brd);}
.wl-member-row:last-child{border-bottom:none;}
.wl-member-av{width:24px;height:24px;border-radius:50%;color:#fff;font-size:.54rem;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.wl-member-name{font-size:.79rem;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.wl-role-pill{font-size:.58rem;font-weight:700;padding:2px 7px;border-radius:var(--rp);white-space:nowrap;}
.wl-role-ann{background:var(--blue-l);color:var(--blue);border:1px solid var(--blue);}
.wl-role-rev{background:var(--yel-l);color:var(--yellow);border:1px solid var(--yellow);}
.wl-role-dual{background:#fee2e2;color:#dc2626;border:1px solid #dc2626;}
.wl-empty-proj{font-size:.74rem;color:var(--tx3);font-style:italic;padding:4px 0;}
/* ‚ïê‚ïê‚ïê‚ïê WORKLOAD PDF MODAL ‚ïê‚ïê‚ïê‚ïê */
.wlpdf-opt{display:flex;align-items:center;gap:12px;padding:12px 14px;border:1.5px solid var(--brd);border-radius:var(--r);cursor:pointer;transition:border-color .15s,background .15s;background:var(--sur);user-select:none;}
.wlpdf-opt:hover{background:var(--sur2);}
.wlpdf-opt.selected{border-color:var(--red);background:var(--red)08;}
.wlpdf-opt-icon{width:36px;height:36px;border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:1rem;}
.wlpdf-check{margin-left:auto;width:20px;height:20px;border-radius:50%;background:var(--brd);display:flex;align-items:center;justify-content:center;font-size:.6rem;color:transparent;transition:background .15s,color .15s;flex-shrink:0;}
.wlpdf-opt.selected .wlpdf-check{background:var(--red);color:#fff;}
/* ‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê */
.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.setting-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;display:flex;justify-content:space-between;align-items:center;}
.setting-info strong{font-size:.9rem;display:block;margin-bottom:3px;}
.setting-info span{font-size:.75rem;color:var(--tx2);}
.toggle-sw{position:relative;width:44px;height:24px;flex-shrink:0;}
.toggle-sw input{opacity:0;width:0;height:0;}
.toggle-sl{position:absolute;inset:0;background:var(--brd);border-radius:12px;cursor:pointer;transition:.2s;}
.toggle-sl:before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 4px rgba(0,0,0,.2);}
.toggle-sw input:checked+.toggle-sl{background:var(--green);}
.toggle-sw input:checked+.toggle-sl:before{transform:translateX(20px);}

/* ‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê */
.overlay{position:fixed;inset:0;background:rgba(15,23,42,.5);display:flex;align-items:center;justify-content:center;z-index:300;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--sur);border-radius:18px;padding:22px;width:540px;max-width:95vw;box-shadow:0 20px 60px rgba(15,23,42,.2);transform:translateY(14px);transition:transform .2s;max-height:90vh;overflow-y:auto;}
.overlay.open .modal{transform:translateY(0);}
.modal-title{font-family:'Space Grotesk',sans-serif;font-size:1.05rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.ff{display:flex;flex-direction:column;gap:4px;}
.ff.full{grid-column:1/-1;}
.ff label{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--tx3);}
.ff input,.ff select,.ff textarea{padding:7px 11px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-family:'Inter',sans-serif;font-size:.83rem;outline:none;}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--red);}
.modal-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:14px;padding-top:12px;border-top:1px solid var(--brd);}
.tgl-row{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);}
.tgl-lbl{font-size:.8rem;font-weight:500;color:var(--tx2);}
.tgt-fw{margin-top:7px;padding:9px 12px;background:var(--yel-l);border:1px solid #fde68a;border-radius:var(--rsm);display:none;align-items:center;gap:8px;}
.tgt-fw.show{display:flex;}
.tgt-fw label{font-size:.74rem;font-weight:600;color:var(--yellow);white-space:nowrap;}
.tgt-fw input{flex:1;max-width:130px;padding:5px 9px;border:1px solid #fde68a;border-radius:var(--rsm);background:#fff;color:var(--tx);font-family:'Inter',sans-serif;font-size:.82rem;outline:none;}

/* TOAST + LOADING */
.toasts{position:fixed;bottom:20px;right:20px;z-index:999;display:flex;flex-direction:column;gap:6px;}
.toast{background:var(--sur);border:1px solid var(--brd);border-radius:10px;padding:9px 14px;font-size:.79rem;box-shadow:var(--sh);display:flex;align-items:center;gap:6px;animation:tIn .2s ease;max-width:270px;}
.toast.ok{border-color:var(--green);color:var(--green);}.toast.err{border-color:#dc2626;color:#dc2626;}.toast.info{border-color:var(--blue);color:var(--blue);}
@keyframes tIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
#lovl{position:fixed;inset:0;background:rgba(15,23,42,.55);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:#fff;gap:12px;}
.spin{width:40px;height:40px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:sp .75s linear infinite;}
@keyframes sp{to{transform:rotate(360deg)}}
.empty-st{text-align:center;padding:45px 20px;color:var(--tx3);}
.empty-st i{font-size:2rem;margin-bottom:9px;display:block;}

/* SECTION TABS */
.section-tabs{display:flex;gap:0;border-bottom:1px solid var(--brd);margin-bottom:20px;}
.stab{padding:9px 18px;font-size:.83rem;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;color:var(--tx2);transition:all .15s;background:none;border-top:none;border-left:none;border-right:none;font-family:'Inter',sans-serif;}
.stab:hover{color:var(--tx);}
.stab.on{color:var(--red);border-bottom-color:var(--red);font-weight:600;}

@media(max-width:900px){.charts-grid{grid-template-columns:1fr;}.kanban-wrap{grid-template-columns:1fr 1fr;}}
@media(max-width:768px){.sidebar{transform:translateX(-100%);}.main{margin-left:0;max-width:100%;padding:14px;}.proj-grid{grid-template-columns:1fr;}.kanban-wrap{grid-template-columns:1fr;}.settings-grid{grid-template-columns:1fr;}}

/* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
#loginScr{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0f172a 0%,#1a1060 50%,#0f172a 100%);}
.lcard{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:22px;
  padding:36px 40px;width:400px;max-width:95vw;backdrop-filter:blur(20px);
  box-shadow:0 32px 80px rgba(0,0,0,.6);}
.lcard-logo{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:24px;}
.lcard-logo svg{width:46px;height:46px;border-radius:7px;}
.lcard-logo-txt strong{font-family:'Space Grotesk',sans-serif;font-size:1.2rem;font-weight:700;color:#fff;display:block;}
.lcard-logo-txt span{font-size:.65rem;color:rgba(255,255,255,.45);display:block;}
.lcard h2{font-family:'Space Grotesk',sans-serif;font-size:1rem;font-weight:700;color:#fff;text-align:center;margin-bottom:4px;}
.lcard p{font-size:.76rem;color:rgba(255,255,255,.45);text-align:center;margin-bottom:24px;}
.lf{display:flex;flex-direction:column;gap:4px;margin-bottom:13px;}
.lf label{font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.35);}
.lf input,.lf select{padding:10px 13px;border:1px solid rgba(255,255,255,.12);border-radius:9px;
  background:rgba(255,255,255,.07);color:#fff;font-family:'Inter',sans-serif;font-size:.86rem;outline:none;transition:border-color .15s;}
.lf input::placeholder{color:rgba(255,255,255,.2);}
.lf input:focus,.lf select:focus{border-color:var(--red);}
.lf select option{background:#1a1060;color:#fff;}
.lbtn{width:100%;padding:11px;background:var(--red);border:none;border-radius:9px;color:#fff;
  font-family:'Space Grotesk',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:background .15s;margin-top:4px;}
.lbtn:hover{background:var(--red-d);}
.lerr{color:#f87171;font-size:.76rem;text-align:center;margin-top:7px;min-height:18px;}
.ldiv{display:flex;align-items:center;gap:9px;margin:16px 0;}
.ldiv::before,.ldiv::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.1);}
.ldiv span{font-size:.68rem;color:rgba(255,255,255,.3);}
.demo-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.dbtn{padding:9px 8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
  border-radius:8px;color:rgba(255,255,255,.65);font-family:'Inter',sans-serif;font-size:.73rem;cursor:pointer;transition:all .15s;text-align:center;}
.dbtn:hover{background:rgba(255,255,255,.13);color:#fff;}
.dbtn .dname{font-weight:700;display:block;margin-bottom:2px;}
.dbtn .dsub{font-size:.6rem;opacity:.55;}

/* ‚ïê‚ïê‚ïê RBAC UI ‚ïê‚ïê‚ïê */
.user-chip{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:var(--rsm);background:var(--sur2);border:1px solid var(--brd);margin-bottom:6px;}
.user-av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.62rem;font-weight:700;flex-shrink:0;}
.user-name{font-size:.79rem;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.logout-btn{background:none;border:none;cursor:pointer;color:var(--tx3);font-size:.8rem;padding:3px 5px;border-radius:5px;transition:all .15s;}
.logout-btn:hover{color:var(--red);background:var(--red-l);}
.role-pill{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--rp);font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
.rp-admin{background:#fee2e2;color:#dc2626;}
.rp-manager{background:var(--blue-l);color:var(--blue);}
.rp-reviewer{background:var(--yel-l);color:var(--yellow);}
.rp-employee{background:var(--green-l);color:var(--green);}
.rp-stakeholder{background:var(--pur-l);color:var(--purple);}
.rp-stakeholder{background:var(--pur-l);color:var(--purple);}

/* ‚ïê‚ïê‚ïê USERS TABLE ‚ïê‚ïê‚ïê */
.users-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;}
.user-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:16px;display:flex;align-items:center;gap:12px;box-shadow:var(--sh-sm);}
.user-card-av{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.78rem;font-weight:700;flex-shrink:0;}
.user-card-info{flex:1;min-width:0;}
.user-card-info strong{font-size:.88rem;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-card-info span{font-size:.72rem;color:var(--tx2);display:block;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-card-actions{display:flex;gap:4px;flex-shrink:0;}

/* ‚ïê‚ïê‚ïê ACTIVITY LOG ‚ïê‚ïê‚ïê */
.actlog{display:flex;flex-direction:column;gap:0;}
.actlog-entry{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--brd);position:relative;}
.actlog-entry:last-child{border-bottom:none;}
.act-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.act-dot.create{background:var(--green);}
.act-dot.edit{background:var(--blue);}
.act-dot.delete{background:var(--red);}
.act-dot.assign{background:var(--purple);}
.act-dot.status{background:var(--yellow);}
.act-dot.comment{background:var(--tx3);}
.act-body{flex:1;min-width:0;}
.act-msg{font-size:.79rem;color:var(--tx);line-height:1.4;}
.act-msg strong{font-weight:600;color:var(--tx);}
.act-meta{font-size:.66rem;color:var(--tx3);margin-top:2px;display:flex;gap:8px;}
.act-proj{font-size:.66rem;color:var(--blue);background:var(--blue-l);padding:1px 6px;border-radius:4px;}
.actlog-empty{text-align:center;padding:30px;color:var(--tx3);font-size:.82rem;}

/* ‚ïê‚ïê‚ïê STAKEHOLDER VIEW ‚ïê‚ïê‚ïê */
.sh-dashboard{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:24px;}
.sh-stat{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;text-align:center;box-shadow:var(--sh-sm);}
.sh-stat-icon{font-size:1.6rem;margin-bottom:8px;}
.sh-stat-val{font-family:'Space Grotesk',sans-serif;font-size:2rem;font-weight:700;line-height:1;}
.sh-stat-lbl{font-size:.72rem;color:var(--tx2);margin-top:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;}
.sh-proj-table{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh-sm);}
.sh-proj-table table{width:100%;border-collapse:collapse;}
.sh-proj-table th{background:var(--sur2);padding:10px 14px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx3);text-align:left;border-bottom:1px solid var(--brd);}
.sh-proj-table td{padding:10px 14px;font-size:.82rem;border-bottom:1px solid var(--brd);vertical-align:middle;}
.sh-proj-table tr:last-child td{border-bottom:none;}
.sh-proj-table tr:nth-child(even) td{background:var(--sur2);}
.sh-badge{padding:3px 8px;border-radius:var(--rp);font-size:.64rem;font-weight:700;text-transform:uppercase;}

/* ‚ïê‚ïê‚ïê VISIBILITY CONFIG ‚ïê‚ïê‚ïê */
.vis-config-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.vis-role-card{background:var(--sur);border:1px solid var(--brd);border-radius:var(--r);padding:18px;box-shadow:var(--sh-sm);}
.vis-role-title{font-size:.88rem;font-weight:700;margin-bottom:3px;display:flex;align-items:center;gap:7px;}
.vis-role-sub{font-size:.72rem;color:var(--tx2);margin-bottom:14px;}
.vis-toggle-list{display:flex;flex-direction:column;gap:7px;}
.vis-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;background:var(--sur2);border-radius:var(--rsm);}
.vis-toggle-lbl{font-size:.78rem;color:var(--tx);}

/* ‚ïê‚ïê‚ïê MIGRATION ALERT ‚ïê‚ïê‚ïê */
.migbanner{background:#1e1b4b;border:1px solid #6366f1;border-radius:var(--r);padding:16px 20px;margin-bottom:18px;}
.migbanner h4{color:#c7d2fe;font-size:.9rem;margin-bottom:6px;}
.migbanner p{color:rgba(199,210,254,.7);font-size:.78rem;margin-bottom:10px;}
.migbanner code{display:block;background:rgba(0,0,0,.4);border-radius:7px;padding:10px 14px;
  font-size:.78rem;color:#a5b4fc;white-space:pre;overflow-x:auto;margin-bottom:10px;line-height:1.6;}

/* ‚ïê‚ïê‚ïê‚ïê PROJECT TAGS ‚ïê‚ïê‚ïê‚ïê */
.proj-tag{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:var(--rp);font-size:.62rem;font-weight:600;background:var(--pur-l);color:var(--purple);border:1px solid var(--purple);cursor:default;}
.proj-tag.rm{cursor:pointer;}
.proj-tag.rm:hover{background:var(--purple);color:#fff;}
.tag-input-row{display:flex;gap:6px;margin-top:6px;}
.tag-input-row input{flex:1;padding:5px 9px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-family:inherit;font-size:.8rem;outline:none;}
.tag-input-row input:focus{border-color:var(--purple);}
.tag-input-row button{padding:5px 12px;border-radius:var(--rsm);background:var(--pur-l);color:var(--purple);border:1px solid var(--purple);font-size:.76rem;font-weight:600;cursor:pointer;}
.tag-input-row button:hover{background:var(--purple);color:#fff;}
/* ‚ïê‚ïê‚ïê‚ïê REVIEW EMPLOYEES ‚ïê‚ïê‚ïê‚ïê */
.atag.rev{background:#fef3c7;border-color:#d97706;color:#d97706;}
/* ‚ïê‚ïê‚ïê‚ïê DAILY REPORT MODAL ‚ïê‚ïê‚ïê‚ïê */
.report-preview{background:var(--sur2);border:1px solid var(--brd);border-radius:var(--rsm);padding:14px;font-size:.8rem;line-height:1.7;max-height:400px;overflow-y:auto;white-space:pre-wrap;font-family:monospace;}

.dr-bar{display:flex;align-items:center;gap:8px;background:var(--yel-l);border:1px solid #fde68a;border-radius:var(--rsm);padding:9px 14px;margin-bottom:14px;flex-wrap:wrap;}
.dr-bar label{font-size:.73rem;font-weight:700;color:var(--yellow);white-space:nowrap;}
.dr-bar input[type=date]{padding:5px 9px;border:1px solid #fde68a;border-radius:var(--rsm);background:var(--sur);color:var(--tx);font-family:'Inter',sans-serif;font-size:.78rem;outline:none;}
.dr-result-pill{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:var(--rp);background:var(--yellow);color:#fff;font-size:.69rem;font-weight:700;}
.dr-clear-btn{background:none;border:1px solid #fde68a;color:var(--yellow);cursor:pointer;font-size:.72rem;padding:4px 10px;border-radius:var(--rp);font-weight:600;}
.dr-clear-btn:hover{background:var(--yellow);color:#fff;}
.dr-result-banner{background:var(--blue-l);border:1px solid var(--blue);border-radius:var(--rsm);padding:9px 14px;font-size:.79rem;color:var(--blue);margin-bottom:14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
/* ‚ïê‚ïê‚ïê‚ïê ACCESS CONTROL CHIPS ‚ïê‚ïê‚ïê‚ïê */
.acc2-chip{display:inline-flex;align-items:center;gap:4px;padding:5px 11px;border-radius:var(--rp);font-size:.71rem;font-weight:600;cursor:pointer;border:1.5px solid var(--brd);background:var(--sur2);color:var(--tx3);transition:all .13s;user-select:none;margin:2px 2px 2px 0;}
.acc2-chip.on{border-color:var(--green);background:var(--green-l);color:var(--green);}
.acc2-chip.locked{cursor:not-allowed;opacity:.45;pointer-events:none;}
.acc2-role-hdr{font-size:.75rem;font-weight:700;color:var(--tx2);margin:12px 0 5px;display:flex;align-items:center;gap:6px;}
.acc2-section{margin-top:18px;padding-top:16px;border-top:1px solid var(--brd);}

</style>
</head>
<body>
<div id="lovl" style="display:none;"><div class="spin"></div><div style="font-size:.93rem;font-weight:600;">Loading CamCom data...</div></div>
<div class="toasts" id="toasts"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScr">
  <div class="lcard">
    <div class="lcard-logo">
      <svg viewBox="36 37 397 397" xmlns="http://www.w3.org/2000/svg">
        <rect fill="#df1e26" x="36.8" y="37.3" width="395.7" height="395.7"/>
        <path fill="#fff" d="M139,216.4c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.7c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.8,4.2-4.2,9.1-7.6,14.7-10,5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2-.7,1.5-1.9,2.3-3.4,2.7-1.5.4-2.9.2-4.3-.5-2.6-1.6-5.5-2.7-8.4-3.5s-6-1.2-9.3-1.2c-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5.8,1.4,1.1,2.7.7,4.2s-1.2,2.6-2.5,3.6c-7.6,4.4-15.9,6.8-24.9,6.8"/>
        <path fill="#fff" d="M267.6,208.2c.6,1.5.7,2.8.2,4.2s-1.5,2.4-2.8,3c-1.4.6-2.8.7-4.3.2-1.4-.5-2.4-1.5-3.2-2.8l-9.9-21.2h-25.1c-1.6,0-2.9-.5-4-1.6s-1.6-2.3-1.6-4,.5-2.8,1.6-3.9,2.3-1.6,4-1.6h19.9l-17.6-37.5-30.8,69.7c-.5,1.1-1.2,1.9-2.1,2.4s-1.9.8-3,.8-1.5-.1-2.3-.4c-1.4-.6-2.4-1.7-2.9-3.2-.5-1.4-.5-2.8.2-4.2l36-80.8c.4-1.1,1.1-1.8,2-2.4s1.9-.8,3-.8,2.1.3,3,.8,1.6,1.3,2,2.3l37.8,80.9Z"/>
        <path fill="#fff" d="M371.3,216c-1.5,0-2.7-.5-3.8-1.6s-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4s-1.9.9-2.9.9-2.1-.3-3-.8-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-1.1,1.8-1.6,3-1.9s2.4-.1,3.6.4,2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1,1.1-2.4,1.6-3.9,1.6"/>
        <path fill="#fff" d="M139,348.5c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.8c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.7s9.1-7.6,14.7-10c5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2s-1.9,2.3-3.4,2.7-2.9.2-4.3-.5c-2.6-1.6-5.5-2.7-8.4-3.5-2.9-.7-6-1.2-9.3-1.2-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5s1.1,2.7.7,4.2-1.2,2.6-2.5,3.6c-7.6,4.5-15.9,6.8-24.9,6.8"/>
        <path fill="#fff" d="M371.3,348.2c-1.5,0-2.7-.5-3.8-1.7-1.1-1.1-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4-.8.6-1.9.9-2.9,1.1-1.1,0-2.1-.3-3-.8-.9-.6-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6c-1.1-1.1-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-.9,1.8-1.7,3-1.9,1.3-.2,2.4-.1,3.6.4s2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1.9-2.4,1.6-3.9,1.6"/>
      </svg>
      <div class="lcard-logo-txt"><strong>CamCom</strong><span>Annotation Tracker <span class="rt-badge" id="rt-badge" style="display:none;"><span class="rt-dot" id="rt-dot"></span>Live</span></span></div>
    </div>
    <h2>Sign in to your account</h2>
    <p>Enter your credentials to access the platform</p>
    <div class="lf"><label>Email</label><input type="email" id="li-email" placeholder="your email address" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <div class="lf"><label>Password</label><input type="password" id="li-pwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="lbtn" onclick="doLogin()"><i class="fas fa-sign-in-alt"></i> Sign In</button>
    <div class="lerr" id="loginErr"></div>
    <div class="ldiv"><span>Quick demo access</span></div>
    <div class="demo-grid">
      <button class="dbtn" onclick="quickLogin('admin')"><span class="dname">üëë Admin</span><span class="dsub"> / admin123</span></button>
      <button class="dbtn" onclick="quickLogin('manager')"><span class="dname">üîµ Manager</span><span class="dsub"> / mgr123</span></button>
      <button class="dbtn" onclick="quickLogin('reviewer')"><span class="dname">üü° Reviewer</span><span class="dsub"> / rev123</span></button>
      <button class="dbtn" onclick="quickLogin('employee')"><span class="dname">üü¢ Employee</span><span class="dsub">My assigned projects only</span></button>
      <button class="dbtn" onclick="quickLogin('stakeholder')" style="grid-column:1/-1;"><span class="dname">üü£ Stakeholder</span><span class="dsub">Executive / investor view ‚Äî admin configures what they see</span></button>
    </div>
  </div>
</div>

<div class="layout">
<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<aside class="sidebar">
  <div class="logo-wrap">
    <!-- Fixed logo: viewBox crops to just the red square + CAM text, no footer text -->
    <svg class="logo-svg" viewBox="36 37 397 397" xmlns="http://www.w3.org/2000/svg">
      <rect fill="#df1e26" x="36.8" y="37.3" width="395.7" height="395.7"/>
      <path fill="#fff" d="M139,216.4c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.7c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.8,4.2-4.2,9.1-7.6,14.7-10,5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2-.7,1.5-1.9,2.3-3.4,2.7-1.5.4-2.9.2-4.3-.5-2.6-1.6-5.5-2.7-8.4-3.5s-6-1.2-9.3-1.2c-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5.8,1.4,1.1,2.7.7,4.2s-1.2,2.6-2.5,3.6c-7.6,4.4-15.9,6.8-24.9,6.8"/>
      <path fill="#fff" d="M267.6,208.2c.6,1.5.7,2.8.2,4.2s-1.5,2.4-2.8,3c-1.4.6-2.8.7-4.3.2-1.4-.5-2.4-1.5-3.2-2.8l-9.9-21.2h-25.1c-1.6,0-2.9-.5-4-1.6s-1.6-2.3-1.6-4,.5-2.8,1.6-3.9,2.3-1.6,4-1.6h19.9l-17.6-37.5-30.8,69.7c-.5,1.1-1.2,1.9-2.1,2.4s-1.9.8-3,.8-1.5-.1-2.3-.4c-1.4-.6-2.4-1.7-2.9-3.2-.5-1.4-.5-2.8.2-4.2l36-80.8c.4-1.1,1.1-1.8,2-2.4s1.9-.8,3-.8,2.1.3,3,.8,1.6,1.3,2,2.3l37.8,80.9Z"/>
      <path fill="#fff" d="M371.3,216c-1.5,0-2.7-.5-3.8-1.6s-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4s-1.9.9-2.9.9-2.1-.3-3-.8-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-1.1,1.8-1.6,3-1.9s2.4-.1,3.6.4,2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1,1.1-2.4,1.6-3.9,1.6"/>
      <path fill="#fff" d="M139,348.5c-6.4,0-12.4-1.3-18.1-3.7-5.7-2.4-10.5-5.8-14.7-10s-7.6-9.1-10-14.8c-2.4-5.7-3.7-11.7-3.7-18.1s1.3-12.4,3.7-18.1c2.4-5.7,5.8-10.5,10-14.7s9.1-7.6,14.7-10c5.7-2.4,11.7-3.7,18.1-3.7s16,2,23.1,6.1c1.4.7,2.3,1.9,2.7,3.4.4,1.5.2,2.8-.5,4.2s-1.9,2.3-3.4,2.7-2.9.2-4.3-.5c-2.6-1.6-5.5-2.7-8.4-3.5-2.9-.7-6-1.2-9.3-1.2-4.9,0-9.6.9-13.9,2.8-4.3,1.9-8,4.4-11.3,7.6-3.2,3.2-5.7,6.9-7.6,11.3-1.9,4.3-2.8,8.9-2.8,13.8s.9,9.6,2.8,13.9c1.9,4.3,4.4,8.1,7.6,11.3,3.2,3.3,6.9,5.8,11.3,7.7,4.3,1.9,8.9,2.8,13.9,2.8s6.7-.5,10-1.5c3.2-.9,6.2-2.3,9-4.1,1.4-.9,2.7-1.3,4.2-.8,1.5.3,2.6,1.2,3.5,2.5s1.1,2.7.7,4.2-1.2,2.6-2.5,3.6c-7.6,4.5-15.9,6.8-24.9,6.8"/>
      <path fill="#fff" d="M371.3,348.2c-1.5,0-2.7-.5-3.8-1.7-1.1-1.1-1.6-2.4-1.6-3.9v-56.7l-25.1,58.9c-.4,1.1-1.1,1.8-1.9,2.4-.8.6-1.9.9-2.9,1.1-1.1,0-2.1-.3-3-.8-.9-.6-1.6-1.4-2-2.2l-29.2-61.6v59.3c0,1.5-.5,2.7-1.6,3.8s-2.3,1.6-3.8,1.6-2.8-.5-3.9-1.6c-1.1-1.1-1.7-2.3-1.7-3.8v-83.5c0-1.3.4-2.4,1.2-3.4.7-.9,1.8-1.7,3-1.9,1.3-.2,2.4-.1,3.6.4s2,1.4,2.5,2.5l34.4,72.4,30.8-72.2c.5-1.2,1.4-2,2.5-2.6s2.4-.7,3.6-.5c1.3.2,2.3.8,3.2,1.9s1.3,2.1,1.3,3.4v83.4c0,1.5-.5,2.8-1.6,3.9-1.1.9-2.4,1.6-3.9,1.6"/>
    </svg>
    <div class="logo-text"><strong>CamCom</strong><span>Annotation Tracker <span class="rt-badge" id="rt-badge" style="display:none;"><span class="rt-dot" id="rt-dot"></span>Live</span></span></div>
  </div>
  <div class="nav-grp">Main</div>
  <button class="nav-btn active" id="nav-dashboard" data-page="dashboard" onclick="switchPage('dashboard')"><i class="fas fa-th-large"></i> Dashboard</button>
  <button class="nav-btn" id="nav-projects" data-page="projects" onclick="switchPage('projects')"><i class="fas fa-folder-open"></i> All Projects <span class="nbadge" id="nb-p">0</span></button>
  <button class="nav-btn" id="nav-kanban" data-page="kanban" onclick="switchPage('kanban')"><i class="fas fa-columns"></i> Kanban Board</button>
  <button class="nav-btn" id="nav-analytics" data-page="analytics" onclick="switchPage('analytics')"><i class="fas fa-chart-pie"></i> Analytics</button>
  <button class="nav-btn" id="nav-employees" data-page="employees" onclick="switchPage('employees')"><i class="fas fa-users"></i> Employees <span class="nbadge" id="nb-e">0</span></button>
  <button class="nav-btn" id="nav-workload" data-page="workload" onclick="switchPage('workload')"><i class="fas fa-chart-bar"></i> Workload</button>
  <div class="nav-grp">Actions</div>
  <button class="nav-btn" id="nav-newproj" onclick="openNewProj()"><i class="fas fa-plus-circle"></i> New Project</button>
  <button class="nav-btn" id="nav-exportcsv" onclick="exportCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
  <button class="nav-btn" id="nav-exportpdf" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
  <button class="nav-btn" id="nav-dailyreport" onclick="openDailyReport()"><i class="fas fa-paper-plane" style="color:var(--blue)"></i> Daily Report</button>
  <div class="nav-divider"></div>
  <button class="nav-btn" data-page="settings" onclick="switchPage('settings')"><i class="fas fa-cog"></i> Feature Settings</button>
  <button class="nav-btn" data-page="access" id="nav-access" style="display:none" onclick="switchPage('access')"><i class="fas fa-shield-alt"></i> Access Control</button>
  <button class="nav-btn" data-page="users" id="nav-users" style="display:none" onclick="switchPage('users')"><i class="fas fa-user-shield"></i> Manage Users</button>
  <button class="nav-btn" data-page="actlog" id="nav-actlog" style="display:none" onclick="switchPage('actlog')"><i class="fas fa-history"></i> Activity Log <span class="nbadge" id="nb-act">0</span></button>
  <button class="nav-btn" data-page="stakeholder" id="nav-stakeholder" style="display:none" onclick="switchPage('stakeholder')"><i class="fas fa-eye"></i> My Dashboard</button>
  <div class="sidebar-foot">
    <div class="user-chip" id="userChip">
      <div class="user-av" id="userAv" style="background:var(--red)">?</div>
      <div style="flex:1;min-width:0;">
        <div class="user-name" id="userName">‚Äî</div>
        <div id="userRole"></div>
      </div>
      <button class="nb-btn" id="nbBtn" onclick="toggleNotifPanel()" title="Notifications"><i class="fas fa-bell"></i><span class="nb-dot" id="nbDot"></span></button>
      <button class="logout-btn" onclick="doLogout()" title="Sign out"><i class="fas fa-sign-out-alt"></i></button>
    </div>
    <button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-moon" id="tIco"></i><span id="tLbl">Dark mode</span></button>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<main class="main">

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard">
  <div class="topbar">
    <h1 class="pg-title">Dashboard</h1>
    <div class="topbar-r">
      <div class="sbox"><i class="fas fa-search"></i><input type="text" placeholder="Search projects..." id="gSearch" oninput="handleSearch()"></div>
      <button class="btn btn-red" onclick="openNewProj()"><i class="fas fa-plus"></i> New Project</button>
    </div>
  </div>
  <div class="stat-grid" id="statGrid"></div>
  <div id="cBanner" style="display:none;" class="cbanner"><i class="fas fa-exclamation-triangle"></i><span id="cTxt"></span><button class="btn btn-ghost btn-sm" style="margin-left:auto;" onclick="switchPage('employees')">View ‚Üí</button></div>
  <!-- Date Range Filter Bar ‚Äî shown only to roles with access -->
  <div class="dr-bar" id="drBar" style="display:none;">
    <i class="fas fa-calendar-alt" style="color:var(--yellow);font-size:.85rem;"></i>
    <label>Date Range:</label>
    <input type="date" id="drFrom" onchange="applyDateRange()">
    <label>to</label>
    <input type="date" id="drTo" onchange="applyDateRange()">
    <button class="dr-clear-btn" onclick="clearDateRange()"><i class="fas fa-times"></i> Clear</button>
    <span id="drResultPill" style="display:none;" class="dr-result-pill"><i class="fas fa-filter"></i> <span id="drResultTxt"></span></span>
  </div>
  <div class="dr-result-banner" id="drResultBanner" style="display:none;"></div>
  <div class="fbar">
    <span style="font-size:.67rem;color:var(--tx3);font-weight:700;text-transform:uppercase;letter-spacing:.5px;">Filter:</span>
    <button class="fc on" onclick="setFilter('all',this)">All</button>
    <button class="fc hi" onclick="setFilter('high',this)"><i class="fas fa-fire"></i> High</button>
    <button class="fc me" onclick="setFilter('medium',this)">‚ö° Medium</button>
    <button class="fc lo" onclick="setFilter('low',this)"><i class="fas fa-leaf"></i> Low</button>
    <select class="fsel" id="sortSel" onchange="renderProjects()">
      <option value="default">Sort: Default</option>
      <option value="name">Name A‚ÄìZ</option>
      <option value="progress">Progress ‚Üë</option>
      <option value="deadline">Deadline ‚Üë</option>
      <option value="priority">Priority</option>
    </select>
  </div>
  <div class="proj-grid" id="projGrid"></div>
</div>

<!-- ALL PROJECTS -->
<div class="page" id="page-projects">
  <div class="topbar">
    <h1 class="pg-title">All Projects</h1>
    <div class="topbar-r">
      <div class="sbox"><i class="fas fa-search"></i><input type="text" placeholder="Search projects..." id="projSearch" oninput="renderProjFull()"></div>
      <button class="btn btn-green btn-sm" onclick="exportCSV()"><i class="fas fa-file-csv"></i> CSV</button>
      <button class="btn btn-red" onclick="openNewProj()"><i class="fas fa-plus"></i> New Project</button>
    </div>
  </div>
  <div class="proj-grid" id="projGridFull"></div>
</div>

<!-- KANBAN -->
<div class="page" id="page-kanban">
  <div class="topbar">
    <h1 class="pg-title">Kanban Board</h1>
    <div class="topbar-r">
      <span style="font-size:.78rem;color:var(--tx3);"><i class="fas fa-grip-vertical"></i> Drag cards between columns</span>
      <button class="btn btn-red" onclick="openNewProj()"><i class="fas fa-plus"></i> New Project</button>
    </div>
  </div>
  <div class="kanban-wrap" id="kanbanWrap"></div>
</div>

<!-- ANALYTICS -->
<div class="page" id="page-analytics">
  <div class="topbar"><h1 class="pg-title">Analytics</h1>
    <button class="btn btn-ghost btn-sm" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Export PDF Report</button>
  </div>
  <div class="section-tabs">
    <button class="stab on" onclick="showAnalyticsTab('charts',this)"><i class="fas fa-chart-pie"></i> Charts</button>
    <button class="stab" onclick="showAnalyticsTab('gantt',this)"><i class="fas fa-stream"></i> Timeline / Gantt</button>
    <button class="stab" onclick="showAnalyticsTab('burndown',this)"><i class="fas fa-chart-line"></i> Burndown</button>
  </div>
  <div id="at-charts">
    <div class="charts-grid" id="chartsGrid">
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-pie" style="color:var(--red)"></i> Priority Distribution</div><div class="chart-wrap"><canvas id="priChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Annotation Progress by Project</div><div class="chart-wrap"><canvas id="progChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-donut" style="color:var(--green)"></i> Completion Status</div><div class="chart-wrap"><canvas id="statusChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><i class="fas fa-users" style="color:var(--purple)"></i> Employees Assigned per Project</div><div class="chart-wrap"><canvas id="empChart"></canvas></div></div>
    </div>
  </div>
  <div id="at-gantt" style="display:none;">
    <div class="gantt-wrap"><div class="chart-title"><i class="fas fa-stream" style="color:var(--blue)"></i> Project Timeline (Start ‚Üí Deadline)</div><div class="gantt-table" id="ganttTable"></div></div>
  </div>
  <div id="at-burndown" style="display:none;">
    <div class="chart-card" style="margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
        <div class="chart-title" style="margin-bottom:0;"><i class="fas fa-chart-line" style="color:var(--red)"></i> Burndown Chart</div>
        <select id="burndownSel" class="fsel" onchange="renderBurndown()"><option value="">Select project...</option></select>
      </div>
      <div class="chart-wrap" style="height:300px;"><canvas id="burndownChart"></canvas></div>
    </div>
  </div>
</div>

<!-- EMPLOYEES -->
<div class="page" id="page-employees">
  <div class="topbar"><h1 class="pg-title">Employees</h1>
    <div class="topbar-r">
      <div class="sbox"><i class="fas fa-search"></i><input type="text" placeholder="Search name or email..." id="empSearch" oninput="renderEmps()"></div>
      
    </div>
  </div>
  <div id="empCBanner" style="display:none;" class="cbanner"><i class="fas fa-exclamation-triangle"></i><span id="ecTxt"></span></div>
  <div class="tbl-wrap"><table><thead><tr><th>#</th><th>Full Name</th><th>Email</th><th>Gender</th><th>Status</th><th>Annotating</th><th>Reviewing</th><th></th></tr></thead><tbody id="empTbody"></tbody></table></div>
</div>

<!-- WORKLOAD -->
<div class="page" id="page-workload">
  <div class="topbar">
    <h1 class="pg-title">Workload Overview</h1>
    <div class="topbar-r">
      <div class="sbox"><i class="fas fa-search"></i><input type="text" placeholder="Search employee..." id="wlSearch" oninput="renderWorkload()"></div>
      <button class="btn btn-ghost btn-sm" onclick="exportWorkloadCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
      <button class="btn btn-red btn-sm" onclick="openWLPdfModal()"><i class="fas fa-file-pdf"></i> Export PDF</button>
    </div>
  </div>
  <div id="wlSummaryGrid" class="wl-summary-grid"></div>
  <div class="wl-section-title" style="margin-top:4px;"><i class="fas fa-building" style="color:var(--purple)"></i> Team Loading by Client / Task</div>
  <div id="wlClientGrid" class="wl-proj-grid"></div>
  <div class="wl-section-title"><i class="fas fa-folder-open" style="color:var(--blue)"></i> Team Loading by Project</div>
  <div id="wlProjGrid" class="wl-proj-grid"></div>
  <div class="wl-section-title"><i class="fas fa-user" style="color:var(--purple)"></i> Employee Assignments</div>
  <div class="wl-card"><div id="wlList"></div></div>
</div>


<!-- ‚ïê‚ïê‚ïê NOTIFICATION PANEL ‚ïê‚ïê‚ïê -->
<div class="notif-panel" id="notifPanel">
  <div class="np-hdr">
    <strong><i class="fas fa-bell" style="color:var(--red);margin-right:6px;"></i>Notifications</strong>
    <div style="display:flex;gap:4px;">
      <button onclick="markAllNotifsRead()">Mark all read</button>
      <button onclick="clearNotifs()">Clear all</button>
      <button onclick="toggleNotifPanel()" style="font-size:.9rem;padding:3px 7px;">‚úï</button>
    </div>
  </div>
  <div class="np-list" id="np-list"></div>
</div>

<!-- realtime indicator in logo area -->

<!-- ‚ïê‚ïê‚ïê MODAL: WORKLOAD PDF OPTIONS ‚ïê‚ïê‚ïê -->
<div class="overlay" id="wlPdfOvl" onclick="if(event.target===this)closeWLPdfModal()">
<div class="modal" style="width:460px;">
  <div class="modal-title"><i class="fas fa-file-pdf" style="color:var(--red)"></i><span>Export Workload PDF</span>
    <button class="modal-cls" onclick="closeWLPdfModal()"><i class="fas fa-times"></i></button>
  </div>
  <p style="font-size:.82rem;color:var(--tx2);margin:0 0 18px;">Choose what to include in the exported PDF report.</p>
  <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:22px;">
    <label id="wlopt-client" class="wlpdf-opt selected" onclick="selectWLOpt('client')">
      <div class="wlpdf-opt-icon" style="background:#7c3aed22;border:1.5px solid var(--purple);"><i class="fas fa-building" style="color:var(--purple);"></i></div>
      <div>
        <div style="font-weight:700;font-size:.88rem;">By Client / Task</div>
        <div style="font-size:.73rem;color:var(--tx3);margin-top:2px;">Team loading grouped by client or task name. Best for manager overview.</div>
      </div>
      <div class="wlpdf-check"><i class="fas fa-check"></i></div>
    </label>
    <label id="wlopt-project" class="wlpdf-opt" onclick="selectWLOpt('project')">
      <div class="wlpdf-opt-icon" style="background:#2563eb22;border:1.5px solid var(--blue);"><i class="fas fa-folder-open" style="color:var(--blue);"></i></div>
      <div>
        <div style="font-weight:700;font-size:.88rem;">By Project</div>
        <div style="font-size:.73rem;color:var(--tx3);margin-top:2px;">Detailed per-project team breakdown with progress and conflict flags.</div>
      </div>
      <div class="wlpdf-check"><i class="fas fa-check"></i></div>
    </label>
    <label id="wlopt-both" class="wlpdf-opt" onclick="selectWLOpt('both')">
      <div class="wlpdf-opt-icon" style="background:#dc262622;border:1.5px solid var(--red);"><i class="fas fa-layer-group" style="color:var(--red);"></i></div>
      <div>
        <div style="font-weight:700;font-size:.88rem;">Both Together</div>
        <div style="font-size:.73rem;color:var(--tx3);margin-top:2px;">Client/task summary first, then full project breakdown. Most comprehensive.</div>
      </div>
      <div class="wlpdf-check"><i class="fas fa-check"></i></div>
    </label>
  </div>
  <div style="display:flex;gap:10px;justify-content:flex-end;">
    <button class="btn btn-ghost" onclick="closeWLPdfModal()">Cancel</button>
    <button class="btn btn-red" onclick="generateWLPdf()"><i class="fas fa-file-pdf"></i> Generate PDF</button>
  </div>
</div>
</div>
<!-- SETTINGS -->
<div class="page" id="page-settings">
  <div class="topbar"><h1 class="pg-title">Feature Settings</h1></div>
  <p style="font-size:.85rem;color:var(--tx2);margin-bottom:18px;">Toggle features on or off. Disabled features are hidden from the sidebar.</p>
  <div id="migBanner" style="display:none;" class="migbanner">
    <h4><i class="fas fa-database"></i> Database Migration Required</h4>
    <p>Some columns are missing from your Supabase <code>projects</code> table. Run this SQL once in your <strong>Supabase ‚Üí SQL Editor</strong> to fix the save error and unlock all features:</p>
    <code>ALTER TABLE projects ADD COLUMN IF NOT EXISTS kanban_status TEXT DEFAULT 'todo';
ALTER TABLE projects ADD COLUMN IF NOT EXISTS has_target BOOLEAN DEFAULT false;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS daily_target INTEGER DEFAULT 0;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS startdate TEXT;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS assignedby TEXT DEFAULT '';
ALTER TABLE projects ADD COLUMN IF NOT EXISTS comments TEXT DEFAULT '';
ALTER TABLE projects ADD COLUMN IF NOT EXISTS review_employees TEXT DEFAULT '';
ALTER TABLE projects ADD COLUMN IF NOT EXISTS tags TEXT DEFAULT '';</code>
    <button class="btn btn-ghost btn-sm" onclick="document.getElementById('migBanner').style.display='none'">Dismiss</button>
  </div>
  <div class="settings-grid" id="settingsGrid"></div>
</div>

<!-- MANAGE USERS (Admin only) -->
<div class="page" id="page-users">
  <div class="topbar">
    <h1 class="pg-title">Manage Users</h1>
    <button class="btn btn-red" onclick="openUserModal()"><i class="fas fa-user-plus"></i> Add User</button>
  </div>
  <div style="background:var(--blue-l);border:1px solid var(--blue);border-radius:var(--rsm);padding:11px 15px;margin-bottom:18px;font-size:.8rem;color:var(--blue);">
    <strong><i class="fas fa-shield-alt"></i> Role Permissions:</strong>
    &nbsp;üëë <strong>Admin</strong> ‚Äî full access &nbsp;|&nbsp;
    üîµ <strong>Manager</strong> ‚Äî create, edit, assign &nbsp;|&nbsp;
    üü° <strong>Reviewer</strong> ‚Äî read-only, all projects &nbsp;|&nbsp;
    üü¢ <strong>Employee</strong> ‚Äî assigned projects only, read-only &nbsp;|&nbsp;
    üü£ <strong>Stakeholder</strong> ‚Äî admin-configured summary view
  </div>
  <div class="users-grid" id="usersGrid"></div>
</div>

<!-- STAKEHOLDER DASHBOARD -->
<div class="page" id="page-stakeholder">
  <div class="topbar">
    <h1 class="pg-title"><i class="fas fa-chart-line" style="color:var(--purple)"></i> Executive Dashboard</h1>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div id="shDrBar" style="display:flex;align-items:center;gap:7px;background:var(--yel-l);border:1px solid #fde68a;border-radius:var(--rsm);padding:7px 12px;">
        <i class="fas fa-calendar-alt" style="color:var(--yellow);font-size:.8rem;"></i>
        <label style="font-size:.72rem;font-weight:700;color:var(--yellow);">Filter:</label>
        <input type="date" id="shDrFrom" onchange="renderStakeholderDashboard()" style="padding:4px 8px;border:1px solid #fde68a;border-radius:5px;background:var(--sur);color:var(--tx);font-family:inherit;font-size:.75rem;outline:none;">
        <span style="font-size:.72rem;color:var(--yellow);">to</span>
        <input type="date" id="shDrTo" onchange="renderStakeholderDashboard()" style="padding:4px 8px;border:1px solid #fde68a;border-radius:5px;background:var(--sur);color:var(--tx);font-family:inherit;font-size:.75rem;outline:none;">
        <button onclick="document.getElementById('shDrFrom').value='';document.getElementById('shDrTo').value='';renderStakeholderDashboard();" style="background:none;border:1px solid #fde68a;color:var(--yellow);cursor:pointer;font-size:.68rem;padding:3px 8px;border-radius:var(--rp);font-weight:600;">‚úï Clear</button>
      </div>
      <div style="font-size:.78rem;color:var(--tx3);display:flex;align-items:center;gap:6px;">
        <i class="fas fa-lock" style="font-size:.7rem;"></i> View-only &nbsp;¬∑&nbsp; Last updated: <span id="sh-lastUpdated">‚Äî</span>
      </div>
    </div>
  </div>
  <div id="shDashboard"></div>
</div>

<!-- ACCESS CONTROL (Admin only) -->
<div class="page" id="page-access">
  <div class="topbar"><h1 class="pg-title"><i class="fas fa-shield-alt" style="color:var(--red)"></i> Access Control</h1></div>
  <p style="font-size:.82rem;color:var(--tx2);margin-bottom:20px;">Configure who sees what. Changes apply immediately when users navigate to those pages.</p>
  <div id="visConfigGrid" class="vis-config-grid"></div>
</div>

<!-- ACTIVITY LOG (Admin + configurable for Manager/Reviewer) -->
<div class="page" id="page-actlog">
  <div class="topbar">
    <h1 class="pg-title"><i class="fas fa-history" style="color:var(--red)"></i> Activity Log</h1>
    <div class="topbar-r">
      <select class="fsel" id="actFilter" onchange="renderActivityLog()">
        <option value="all">All Actions</option>
        <option value="create">Creates</option>
        <option value="edit">Edits</option>
        <option value="assign">Assignments</option>
        <option value="status">Status Changes</option>
        <option value="delete">Deletes</option>
        <option value="comment">Comments</option>
      </select>
      <select class="fsel" id="actProjFilter" onchange="renderActivityLog()"><option value="">All Projects</option></select>
      <button class="btn btn-ghost btn-sm" onclick="if(confirm('Clear all activity logs?')){actLog=[];saveActLog();renderActivityLog();}"><i class="fas fa-trash"></i> Clear Log</button>
    </div>
  </div>
  <div id="actLogContainer"><div class="actlog-empty"><i class="fas fa-history" style="font-size:1.5rem;display:block;margin-bottom:8px;"></i>No activity recorded yet.</div></div>
</div>

</main>
</div>

<!-- ‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê -->
<div class="dp-overlay" id="dpOvl" onclick="closeDpBg(event)"></div>
<div class="dp" id="dp">
  <div class="dp-hdr">
    <div><div class="dp-title" id="dpTitle">Project</div><div id="dpMeta" style="margin-top:5px;display:flex;gap:7px;flex-wrap:wrap;"></div></div>
    <button class="dp-close" onclick="closeDP()"><i class="fas fa-times"></i></button>
  </div>
  <div class="dp-body" id="dpBody"></div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: PROJECT ‚ïê‚ïê‚ïê -->
<div class="overlay" id="projOvl" onclick="closeProjOvlBg(event)">
<div class="modal">
  <div class="modal-title"><i class="fas fa-folder-plus" style="color:var(--red)"></i><span id="pMTtl">New Project</span></div>
  <div class="fgrid">
    <div class="ff full"><label>Project name *</label><input type="text" id="np-name" placeholder="e.g. Road Extraction"></div>
    <div class="ff"><label>Client / Task name</label><input type="text" id="np-client" placeholder="e.g. Acme Corp ‚Äì Detection"></div>
    <div class="ff"><label><i class="fas fa-external-link-alt" style="color:var(--blue);margin-right:4px;"></i>LabelStudio Link</label><input type="url" id="np-link" placeholder="https://labelstudio.example.com/projects/..."></div>
    <div class="ff"><label>Priority</label><select id="np-pri"><option value="medium">‚ö° Medium</option><option value="high">üî• High</option><option value="low">üåø Low</option></select></div>
    <div class="ff"><label>Assigned By</label><input type="text" id="np-by" placeholder="Manager name"></div>
    <div class="ff"><label>Start Date</label><input type="date" id="np-start"></div>
    <div class="ff"><label>Deadline</label><input type="date" id="np-dead"></div>
    <div class="ff"><label>Total Images</label><input type="number" id="np-total" value="1000" min="0"></div>
    <div class="ff"><label>Annotated</label><input type="number" id="np-ann" value="0" min="0"></div>
    <div class="ff"><label>Reviewed</label><input type="number" id="np-rev" value="0" min="0"></div>
    <div class="ff"><label>Kanban Status</label><select id="np-status"><option value="todo">üìã To Do</option><option value="inprog">‚ö° In Progress</option><option value="review">üîç Review</option><option value="done">‚úÖ Completed</option></select></div>
    <div class="ff full"><label>Notes</label><textarea id="np-notes" placeholder="Project notes..." style="min-height:48px;"></textarea></div>
    <div class="ff full">
      <div class="tgl-row"><label class="toggle-sw"><input type="checkbox" id="np-tgtOn" onchange="tglTgtField('np')"><span class="toggle-sl"></span></label><span class="tgl-lbl">Set daily image target</span></div>
      <div class="tgt-fw" id="np-tgtFw"><i class="fas fa-bullseye" style="color:var(--yellow)"></i><label>Images / day</label><input type="number" id="np-target" placeholder="e.g. 200" min="1"></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeProjModal()">Cancel</button>
    <button class="btn btn-red" onclick="saveProject()"><i class="fas fa-save"></i> Save Project</button>
  </div>
</div></div>

<!-- ‚ïê‚ïê‚ïê MODAL: EMPLOYEE ‚ïê‚ïê‚ïê -->
<div class="overlay" id="empOvl" onclick="closeEmpOvlBg(event)">
<div class="modal" style="width:400px;">
  <div class="modal-title"><i class="fas fa-user-plus" style="color:var(--red)"></i><span id="eMTtl">Add Employee</span></div>
  <div class="fgrid">
    <div class="ff full"><label>Full Name *</label><input type="text" id="fe-name" placeholder="e.g. Ramyashree V R"></div>
    <div class="ff full"><label>Email ID *</label><input type="email" id="fe-email" placeholder="name at camcom.ai"></div>
    <div class="ff full"><label>Gender</label><select id="fe-gender"><option value="female">‚ôÄ Female</option><option value="male">‚ôÇ Male</option></select></div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeEmpModal()">Cancel</button>
    <button class="btn btn-red" onclick="saveEmployee()"><i class="fas fa-save"></i> Save</button>
  </div>
</div></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL='https://phtzpswuqlixaroxhkmy.supabase.co';
const SB_KEY='sb_publishable_V1bOmccJ0AKXmRyV7bFctg_ka58Wb-L';
const sb=supabase.createClient(SB_URL,SB_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let projects=[];
const AT='@'; // prevents proxy email obfuscation
let employees=[
  {id:'e1', name:'Ramyashree V R',             email:'ramyashree.ragupathy'+AT+'camcom.ai',  gender:'female'},
  {id:'e2', name:'Manoj Kumar Devanga Kotha',   email:'manoj.kotha'+AT+'camcom.ai',           gender:'male'},
  {id:'e3', name:'Dande Kalyani',               email:'dande.kalyani'+AT+'camcom.ai',         gender:'female'},
  {id:'e4', name:'Dande Sandhya',               email:'dande.sandhya'+AT+'camcom.ai',         gender:'female'},
  {id:'e5', name:'Challa Koteswaramma',         email:'challa.koteswaramma'+AT+'camcom.ai',   gender:'female'},
  {id:'e6', name:'Kadagandla Hariprasad',       email:'kadagandla.hariprasad'+AT+'camcom.ai', gender:'male'},
  {id:'e7', name:'Uma Krishnappa',              email:'uma.krishnappa'+AT+'camcom.ai',        gender:'female'},
  {id:'e8', name:'Manjunath Kalakappa Bandihal',email:'manjunath.bandihal'+AT+'camcom.ai',    gender:'male'},
  {id:'e9', name:'Akshay Phatale',              email:'akshay.phatale'+AT+'camcom.ai',        gender:'male'},
  {id:'e10',name:'Maitra Salimath',             email:'maitra.salimath'+AT+'camcom.ai',       gender:'female'},
  {id:'e11',name:'Yathish Gowda K H',           email:'yathish.gowda'+AT+'camcom.ai',         gender:'male'},
  {id:'e12',name:'Pavan Kalyan Yeddala',        email:'pavan.yeddala'+AT+'camcom.ai',         gender:'male'},
  {id:'e13',name:'Sabharmathi Selvam',          email:'sabarmathi.selvam'+AT+'camcom.ai',     gender:'female'},
  {id:'e14',name:'G Umesh',                     email:'umesh.g'+AT+'camcom.ai',               gender:'male'},
  {id:'e15',name:'Shilpa E',                    email:'shilpa.e'+AT+'camcom.ai',              gender:'female'},
  {id:'e16',name:'Prema Joshi',                 email:'prema.joshi'+AT+'camcom.ai',           gender:'female'},
  {id:'e17',name:'Keerti Doddwad',              email:'keerti.doddwad'+AT+'camcom.ai',        gender:'female'},
  {id:'e18',name:'Ajay Reddy H',                email:'ajay.reddy'+AT+'camcom.ai',            gender:'male'},
  {id:'e19',name:'Varun Kumar H N',             email:'varun.kumar'+AT+'camcom.ai',           gender:'male'},
  {id:'e20',name:'Sneha B V',                   email:'sneha.bv'+AT+'camcom.ai',              gender:'female'},
  {id:'e21',name:'Fathima Reneesha',            email:'fathima.reneesha'+AT+'camcom.ai',      gender:'female'},
  {id:'e22',name:'Vishruthi Raghu',             email:'vishruthi.raghu'+AT+'camcom.ai',       gender:'female'},
  {id:'e23',name:'Sanjana G P',                 email:'sanjana.gp'+AT+'camcom.ai',            gender:'female'},
  {id:'e24',name:'Dhanyasri A S',               email:'dhanyasri.as'+AT+'camcom.ai',          gender:'female'},
  {id:'e25',name:'Siddharth Anandan',           email:'siddharth.anandan'+AT+'camcom.ai',     gender:'male'},
  {id:'e26',name:'Bindusree S N',               email:'bindusree.sn'+AT+'camcom.ai',          gender:'female'},
  {id:'e27',name:'Anil Kumar Pasala',           email:'anilkumar.pasala'+AT+'camcom.ai',      gender:'male'},
  {id:'e28',name:'Mihir',                       email:'mihir.singh'+AT+'camcom.ai',           gender:'male'},
  {id:'e29',name:'Suzan',                       email:'suzan.john'+AT+'camcom.ai',            gender:'female'},
  {id:'e30',name:'Umesh Nagappa Barker',        email:'umesh'+AT+'zuru.ai',                   gender:'male'},
  {id:'e31',name:'Sunil Kumar',                 email:'sunilkumar'+AT+'zuru.ai',              gender:'male'},
  {id:'e32',name:'Shanta Mantri',               email:'shanta'+AT+'zuru.ai',                  gender:'female'},
  {id:'e33',name:'Nandini Keni',                email:'nandini'+AT+'zuru.ai',                 gender:'female'},
  {id:'e34',name:'Shweta Kannagar',             email:'shwetak'+AT+'zuru.ai',                 gender:'female'},
  {id:'e35',name:'Kishore Devaragudi',          email:'kishored'+AT+'zuru.ai',                gender:'male'},
  {id:'e36',name:'Anil Gandredi',               email:'anilg'+AT+'zuru.ai',                   gender:'male'},
  {id:'e37',name:'K Ganesh',                    email:'ganeshk'+AT+'zuru.ai',                 gender:'male'},
  {id:'e38',name:'Kiran Y',                     email:'kirany'+AT+'zuru.ai',                  gender:'male'},
  {id:'e39',name:'Vishwas Reddy',               email:'vishwasreddy'+AT+'zuru.ai',            gender:'male'},
  {id:'e40',name:'Sandhya K',                   email:'sandhya.k'+AT+'camcom.ai',             gender:'female'},
  {id:'e41',name:'Venkatesh Chilukuri',         email:'venkatesh.chilukuri'+AT+'camcom.ai',   gender:'male'},
  {id:'e42',name:'Abhil C Sasindran',           email:'abhil.sasindran'+AT+'camcom.ai',       gender:'male'}
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RBAC ‚Äî ROLES & PERMISSIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ROLES={
  admin:      {label:'Admin',      icon:'üëë', pill:'rp-admin',       color:'#dc2626',
    canCreate:true, canEdit:true, canDelete:true, canAssign:true,
    canManageUsers:true, canManageFeatures:true, seeAll:true, canViewLog:true, isStakeholder:false},
  manager:    {label:'Manager',    icon:'üîµ', pill:'rp-manager',     color:'#2563eb',
    canCreate:true, canEdit:true, canDelete:false, canAssign:true,
    canManageUsers:false, canManageFeatures:false, seeAll:true, canViewLog:true, isStakeholder:false},
  reviewer:   {label:'Reviewer',   icon:'üü°', pill:'rp-reviewer',   color:'#d97706',
    canCreate:false, canEdit:false, canDelete:false, canAssign:false,
    canManageUsers:false, canManageFeatures:false, seeAll:true, canViewLog:false, isStakeholder:false},
  employee:   {label:'Employee',   icon:'üü¢', pill:'rp-employee',   color:'#16a34a',
    canCreate:false, canEdit:false, canDelete:false, canAssign:false,
    canManageUsers:false, canManageFeatures:false, seeAll:false, canViewLog:false, isStakeholder:false},
  stakeholder:{label:'Stakeholder',icon:'üü£', pill:'rp-stakeholder',color:'#7c3aed',
    canCreate:false, canEdit:false, canDelete:false, canAssign:false,
    canManageUsers:false, canManageFeatures:false, seeAll:false, canViewLog:false, isStakeholder:true},
};
function can(perm){
  if(!currentUser)return false;
  // Check dynamic overrides first (admin-configurable)
  const dyn=visConfig.roleCaps?.[currentUser.role]?.[perm];
  if(dyn!==undefined)return !!dyn;
  return !!(ROLES[currentUser.role]?.[perm]);
}
function visibleProjects(){
  if(!currentUser) return [];
  if(can('seeAll')) return projects;
  if(currentUser.role==='stakeholder') return projects; // all but filtered display
  return projects.filter(p=>(p.assignedEmployees||[]).includes(currentUser.empId));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VISIBILITY CONFIG (Admin-controlled)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ VISIBILITY CONFIG ‚Äî everything admin can control ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// pageAccess: which nav pages each role can see
//   admin = always full; employee = fixed (only projects); stakeholder = fixed (only sh-dashboard)
//   manager/reviewer = configurable
// dateFilter: which roles can use the date range filter
// actLogVisible: which roles can see the Activity Log page
// stakeholderFields: which data fields show on the stakeholder dashboard
let visConfig={
  pageAccess:{
    manager:  {dashboard:true, projects:true, kanban:true,  analytics:true, employees:true,  workload:true,  exportCSV:true,  exportPDF:true},
    reviewer: {dashboard:true, projects:true, kanban:false, analytics:true, employees:false, workload:false, exportCSV:false, exportPDF:false},
    stakeholder:{dashboard:false},  // stakeholder only sees their own page ‚Äî not configurable
  },
  dateFilter:{manager:true, reviewer:true, employee:false, stakeholder:false},
  actLogVisible:{manager:true, reviewer:false, employee:false, stakeholder:false},
  stakeholderFields:{
    totalProjects:true, totalImages:true, annotatedPct:true, reviewedPct:true,
    highPriorityCount:true, onTrackCount:true,
    projectTable:true, projectName:true, projectPriority:true, projectStatus:true,
    projectAnnotatedPct:true, projectReviewedPct:true, projectDeadline:true,
    projectAssignedBy:false, projectEmployeeCount:false, projectNotes:false, analyticsCharts:false,
  },
};

// Deep-merge saved config on top of defaults
function loadVisConfig(){
  try{
    const s=localStorage.getItem('cc_vis');
    if(!s)return;
    const c=JSON.parse(s);
    // merge nested objects
    if(c.pageAccess){
      if(c.pageAccess.manager)Object.assign(visConfig.pageAccess.manager,c.pageAccess.manager);
      if(c.pageAccess.reviewer)Object.assign(visConfig.pageAccess.reviewer,c.pageAccess.reviewer);
    }
    if(c.dateFilter)Object.assign(visConfig.dateFilter,c.dateFilter);
    if(c.actLogVisible)Object.assign(visConfig.actLogVisible,c.actLogVisible);
    if(c.stakeholderFields)Object.assign(visConfig.stakeholderFields,c.stakeholderFields);
  }catch(e){}
}
function saveVisConfig(){try{localStorage.setItem('cc_vis',JSON.stringify(visConfig));}catch(e){}}

// ‚îÄ‚îÄ‚îÄ PAGE ACCESS HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function canSeePage(page){
  if(!currentUser)return false;
  const role=currentUser.role;
  if(role==='admin')return true;                          // admin sees all
  if(role==='employee')return page==='projects';          // employee: fixed ‚Äî only "My Projects"
  if(role==='stakeholder')return page==='stakeholder';    // stakeholder: only their dashboard
  return !!(visConfig.pageAccess[role]&&visConfig.pageAccess[role][page]);
}
function canUseDateFilter(){
  if(!currentUser)return false;
  if(currentUser.role==='admin')return true;
  return !!(visConfig.dateFilter[currentUser.role]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIVITY LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let actLog=[]; // [{id, ts, type, user, projId, projName, msg}]
// types: create, edit, assign, status, delete, comment

function loadActLog(){try{const s=localStorage.getItem('cc_actlog');if(s)actLog=JSON.parse(s);}catch(e){}}
function saveActLog(){try{localStorage.setItem('cc_actlog',JSON.stringify(actLog.slice(0,500)));}catch(e){}}

function logActivity(type, projId, projName, msg){
  if(!currentUser)return;
  actLog.unshift({
    id:'al_'+Date.now(),
    ts:new Date().toISOString(),
    type, // create|edit|assign|status|delete|comment
    user:currentUser.name,
    userRole:currentUser.role,
    projId, projName:projName||'Unknown',
    msg
  });
  saveActLog();
  // update badge
  const nb=document.getElementById('nb-act');
  if(nb)nb.textContent=actLog.length;
}

function canSeeLog(){
  if(!currentUser)return false;
  // Admin always sees it
  if(currentUser.role==='admin')return true;
  // Check the configurable setting
  return !!(visConfig.actLogVisible?.[currentUser.role]);
}

function renderActivityLog(){
  const filter=(document.getElementById('actFilter')?.value)||'all';
  const projFilter=(document.getElementById('actProjFilter')?.value)||'';
  let list=[...actLog];
  if(filter!=='all')list=list.filter(e=>e.type===filter);
  if(projFilter)list=list.filter(e=>e.projId===projFilter);

  // Populate project filter dropdown
  const projSel=document.getElementById('actProjFilter');
  if(projSel&&projSel.options.length<2){
    const seen=new Set();
    actLog.forEach(e=>{if(!seen.has(e.projId)){seen.add(e.projId);projSel.add(new Option(e.projName,e.projId));}});
  }

  const TYPE_INFO={
    create:{dot:'create',icon:'fa-plus-circle',color:'var(--green)'},
    edit:{dot:'edit',icon:'fa-pen',color:'var(--blue)'},
    assign:{dot:'assign',icon:'fa-user-plus',color:'var(--purple)'},
    status:{dot:'status',icon:'fa-exchange-alt',color:'var(--yellow)'},
    delete:{dot:'delete',icon:'fa-trash',color:'var(--red)'},
    comment:{dot:'comment',icon:'fa-comment',color:'var(--tx3)'},
  };

  if(!list.length){
    document.getElementById('actLogContainer').innerHTML=`<div class="actlog-empty"><i class="fas fa-history" style="font-size:1.5rem;display:block;margin-bottom:8px;"></i>${filter==='all'?'No activity recorded yet.':'No entries match this filter.'}</div>`;
    return;
  }

  document.getElementById('actLogContainer').innerHTML=`<div class="actlog">${list.map(e=>{
    const ti=TYPE_INFO[e.type]||{dot:'edit',icon:'fa-circle',color:'var(--tx3)'};
    const dt=new Date(e.ts);
    const relTime=formatRelTime(dt);
    return`<div class="actlog-entry">
      <div class="act-dot ${ti.dot}" style="margin-top:6px;"></div>
      <div class="act-body">
        <div class="act-msg"><i class="fas ${ti.icon}" style="color:${ti.color};font-size:.72rem;"></i> ${esc(e.msg)}</div>
        <div class="act-meta">
          <span><i class="fas fa-user" style="font-size:.58rem;"></i> ${esc(e.user)}</span>
          <span class="role-pill ${ROLES[e.userRole]?.pill||'rp-reviewer'}" style="font-size:.58rem;padding:1px 5px;">${ROLES[e.userRole]?.icon||''} ${ROLES[e.userRole]?.label||e.userRole}</span>
          <span class="act-proj"><i class="fas fa-folder" style="font-size:.58rem;"></i> ${esc(e.projName)}</span>
          <span title="${dt.toLocaleString()}">${relTime}</span>
        </div>
      </div>
    </div>`;
  }).join('')}</div>`;

  const nb=document.getElementById('nb-act');if(nb)nb.textContent=actLog.length;
}

function formatRelTime(dt){
  const diff=Math.floor((Date.now()-dt.getTime())/1000);
  if(diff<60)return 'just now';
  if(diff<3600)return Math.floor(diff/60)+'m ago';
  if(diff<86400)return Math.floor(diff/3600)+'h ago';
  if(diff<604800)return Math.floor(diff/86400)+'d ago';
  return dt.toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STAKEHOLDER DASHBOARD RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStakeholderDashboard(){
  const sf=visConfig.stakeholderFields;
  // Apply date range filter for stakeholder
  const shFrom=document.getElementById('shDrFrom')?.value||'';
  const shTo=document.getElementById('shDrTo')?.value||'';
  let shProjects=projects;
  if(shFrom||shTo){
    const from=shFrom?new Date(shFrom+'T00:00:00'):null;
    const to=shTo?new Date(shTo+'T23:59:59'):null;
    shProjects=projects.filter(p=>{
      const projStart=p.startdate?new Date(p.startdate+'T00:00:00'):null;
      const projEnd=p.deadline?new Date(p.deadline+'T23:59:59'):null;
      if(!projStart&&!projEnd)return true;
      const startOk=!from||!projEnd||projEnd>=from;
      const endOk=!to||!projStart||projStart<=to;
      return startOk&&endOk;
    });
  }
  const tI=shProjects.reduce((s,p)=>s+(+p.total||0),0);
  const tA=shProjects.reduce((s,p)=>s+(+p.annotated||0),0);
  const tR=shProjects.reduce((s,p)=>s+(+p.reviewed||0),0);
  const highPri=shProjects.filter(p=>p.priority==='high').length;
  const onTrack=shProjects.filter(p=>{const dl=dlMeta(p.deadline);return dl&&dl.diff>=0;}).length;

  // Update last-updated time
  const lu=document.getElementById('sh-lastUpdated');
  if(lu)lu.textContent=new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});

  // Build stat cards
  const stats=[];
  if(sf.totalProjects)stats.push({icon:'üìÅ',val:shProjects.length,lbl:'Total Projects',color:'var(--red)'});
  if(sf.totalImages)stats.push({icon:'üñºÔ∏è',val:tI.toLocaleString(),lbl:'Total Images',color:'var(--blue)'});
  if(sf.annotatedPct)stats.push({icon:'‚úÖ',val:pct(tA,tI)+'%',lbl:'Annotated',color:'var(--green)'});
  if(sf.reviewedPct)stats.push({icon:'üëÅÔ∏è',val:pct(tR,tI)+'%',lbl:'Reviewed',color:'var(--purple)'});
  if(sf.highPriorityCount)stats.push({icon:'üî•',val:highPri,lbl:'High Priority',color:'var(--red)'});
  if(sf.onTrackCount)stats.push({icon:'üìÖ',val:onTrack,lbl:'On Track',color:'var(--green)'});

  const statsHtml=stats.length?`<div class="sh-dashboard">${stats.map(s=>`
    <div class="sh-stat">
      <div class="sh-stat-icon">${s.icon}</div>
      <div class="sh-stat-val" style="color:${s.color};">${s.val}</div>
      <div class="sh-stat-lbl">${s.lbl}</div>
    </div>`).join('')}</div>`:'';

  // Build project table
  let tableHtml='';
  if(sf.projectTable){
    const showCols=[];
    if(sf.projectName)showCols.push('Project Name');
    if(sf.projectPriority)showCols.push('Priority');
    if(sf.projectStatus)showCols.push('Status');
    if(sf.projectAnnotatedPct)showCols.push('Annotated');
    if(sf.projectReviewedPct)showCols.push('Reviewed');
    if(sf.projectDeadline)showCols.push('Deadline');
    if(sf.projectAssignedBy)showCols.push('Assigned By');
    if(sf.projectEmployeeCount)showCols.push('Team Size');

    if(showCols.length){
      const priColors={high:'#dc2626',medium:'#d97706',low:'#16a34a'};
      const statusLabels={todo:'üìã To Do',inprog:'‚ö° In Progress',review:'üîç Review',done:'‚úÖ Done'};
      const rows=shProjects.map(p=>{
        const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
        const dl=dlMeta(p.deadline);
        const cells=[];
        if(sf.projectName)cells.push(`<td><strong>${esc(p.name)}</strong></td>`);
        if(sf.projectPriority)cells.push(`<td><span class="sh-badge" style="background:${priColors[p.priority]}22;color:${priColors[p.priority]};">${p.priority.toUpperCase()}</span></td>`);
        if(sf.projectStatus)cells.push(`<td><span style="font-size:.76rem;">${statusLabels[p.kanbanStatus||'todo']}</span></td>`);
        if(sf.projectAnnotatedPct)cells.push(`<td><div style="display:flex;align-items:center;gap:7px;"><div class="pbar" style="width:60px;flex-shrink:0;"><div class="pf pf-a" style="width:${pct(A,T)}%"></div></div><span style="font-size:.78rem;font-weight:600;">${pct(A,T)}%</span></div></td>`);
        if(sf.projectReviewedPct)cells.push(`<td><div style="display:flex;align-items:center;gap:7px;"><div class="pbar" style="width:60px;flex-shrink:0;"><div class="pf pf-r" style="width:${pct(R,T)}%"></div></div><span style="font-size:.78rem;font-weight:600;">${pct(R,T)}%</span></div></td>`);
        if(sf.projectDeadline)cells.push(`<td style="font-size:.78rem;${dl&&dl.diff<0?'color:#dc2626;font-weight:600;':''}">${dl?dl.label+''+( dl.diff<0?' ‚ö†':''):'‚Äî'}</td>`);
        if(sf.projectAssignedBy)cells.push(`<td style="font-size:.78rem;color:var(--tx2);">${esc(p.assignedby||'‚Äî')}</td>`);
        if(sf.projectEmployeeCount)cells.push(`<td style="font-size:.78rem;">${(p.assignedEmployees||[]).length} people</td>`);
        return`<tr>${cells.join('')}</tr>`;
      }).join('');
      tableHtml=`<div class="sh-proj-table">
        <table><thead><tr>${showCols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
        <tbody>${rows}</tbody></table></div>`;
    }
  }

  // Charts if enabled
  let chartsHtml='';
  if(sf.analyticsCharts){
    chartsHtml=`<div class="charts-grid" style="margin-top:20px;">
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-pie" style="color:var(--red)"></i> Annotation Progress</div><div class="chart-wrap"><canvas id="shProgChart"></canvas></div></div>
      <div class="chart-card"><div class="chart-title"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Status Overview</div><div class="chart-wrap"><canvas id="shStatusChart"></canvas></div></div>
    </div>`;
  }

  const empty=!stats.length&&!sf.projectTable&&!sf.analyticsCharts;
  document.getElementById('shDashboard').innerHTML=empty
    ?`<div class="empty-st"><i class="fas fa-eye-slash" style="font-size:2rem;display:block;margin-bottom:10px;"></i><p>No data is currently configured for your dashboard.<br><small>Contact an administrator to enable dashboard fields.</small></p></div>`
    :statsHtml+tableHtml+chartsHtml;

  // Render stakeholder charts if needed
  if(sf.analyticsCharts){
    setTimeout(()=>{
      destroyChart('shProg');
      const isDark=document.documentElement.getAttribute('data-theme')==='dark';
      const tx=isDark?'#8b949e':'#475569';
      const shPc=document.getElementById('shProgChart');
      if(shPc)chartInstances.shProg=new Chart(shPc,{type:'bar',data:{labels:shProjects.map(p=>p.name.substr(0,12)),datasets:[{label:'Annotated %',data:shProjects.map(p=>pct(p.annotated,p.total)),backgroundColor:'#3b82f6',borderRadius:4},{label:'Reviewed %',data:shProjects.map(p=>pct(p.reviewed,p.total)),backgroundColor:'#16a34a',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:tx,font:{size:10}}}},scales:{x:{ticks:{color:tx,font:{size:9}},grid:{display:false}},y:{min:0,max:100,ticks:{color:tx}}}}});
      destroyChart('shStatus');
      const statCounts={todo:0,inprog:0,review:0,done:0};
      shProjects.forEach(p=>{statCounts[p.kanbanStatus||'todo']++;});
      const shSc=document.getElementById('shStatusChart');
      if(shSc)chartInstances.shStatus=new Chart(shSc,{type:'doughnut',data:{labels:['To Do','In Progress','Review','Done'],datasets:[{data:[statCounts.todo,statCounts.inprog,statCounts.review,statCounts.done],backgroundColor:['#94a3b8','#3b82f6','#d97706','#16a34a'],borderWidth:2,borderColor:'var(--sur)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:tx,font:{size:10}}}}}});
    },50);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACCESS CONTROL RENDERER (Admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAccessControl(){
  const sf=visConfig.stakeholderFields;
  const alv=visConfig.actLogVisible;
  const pa=visConfig.pageAccess;
  const df=visConfig.dateFilter;

  // Page definitions ‚Äî pages admin can toggle per role
  const PAGE_DEFS=[
    {key:'dashboard',  label:'Dashboard',     icon:'fa-th-large'},
    {key:'projects',   label:'All Projects',  icon:'fa-folder-open'},
    {key:'kanban',     label:'Kanban Board',  icon:'fa-columns'},
    {key:'analytics',  label:'Analytics',     icon:'fa-chart-pie'},
    {key:'employees',  label:'Employees',     icon:'fa-users'},
    {key:'workload',   label:'Workload',       icon:'fa-chart-bar'},
    {key:'exportCSV',  label:'Export CSV',     icon:'fa-file-csv'},
    {key:'exportPDF',  label:'Export PDF',     icon:'fa-file-pdf'},
  ];

  const renderChips=(roleKey)=>PAGE_DEFS.map(pg=>{
    const isOn=!!(pa[roleKey]&&pa[roleKey][pg.key]);
    return`<span class="acc2-chip ${isOn?'on':'off'}" onclick="togglePageAccess('${roleKey}','${pg.key}',${!isOn})">
      <i class="fas ${isOn?'fa-check-circle':'fa-times-circle'}" style="font-size:.62rem;"></i>
      <i class="fas ${pg.icon}" style="font-size:.62rem;"></i> ${pg.label}
    </span>`;
  }).join('');

  const SH_FIELDS=[
    {key:'totalProjects',label:'Total Projects',group:'Summary Stats'},
    {key:'totalImages',label:'Total Images',group:'Summary Stats'},
    {key:'annotatedPct',label:'Annotation %',group:'Summary Stats'},
    {key:'reviewedPct',label:'Review %',group:'Summary Stats'},
    {key:'highPriorityCount',label:'High Priority Count',group:'Summary Stats'},
    {key:'onTrackCount',label:'On Track Count',group:'Summary Stats'},
    {key:'analyticsCharts',label:'Charts & Analytics',group:'Summary Stats'},
    {key:'projectTable',label:'Show Project Table',group:'Project Table'},
    {key:'projectName',label:'Project Name',group:'Project Table'},
    {key:'projectPriority',label:'Priority',group:'Project Table'},
    {key:'projectStatus',label:'Status',group:'Project Table'},
    {key:'projectAnnotatedPct',label:'Annotation %',group:'Project Table'},
    {key:'projectReviewedPct',label:'Review %',group:'Project Table'},
    {key:'projectDeadline',label:'Deadline',group:'Project Table'},
    {key:'projectAssignedBy',label:'Assigned By ‚ö† sensitive',group:'Project Table'},
    {key:'projectEmployeeCount',label:'Employee Count ‚ö† sensitive',group:'Project Table'},
    {key:'projectNotes',label:'Notes ‚ö† sensitive',group:'Project Table'},
  ];

  const shGroups={};
  SH_FIELDS.forEach(f=>{if(!shGroups[f.group])shGroups[f.group]=[];shGroups[f.group].push(f);});

  document.getElementById('visConfigGrid').innerHTML=`
  <!-- ‚ïê‚ïê SECTION 1: Page Access ‚ïê‚ïê -->
  <div class="vis-role-card" style="grid-column:1/-1;">
    <div class="vis-role-title"><i class="fas fa-door-open" style="color:var(--blue)"></i> Page Access ‚Äî Control Who Sees What</div>
    <div class="vis-role-sub">Toggle which pages each role can navigate to. Changes take effect immediately. Fixed roles (Employee, Stakeholder, Admin) cannot be edited.</div>
    <div style="background:var(--blue-l);border:1px solid var(--blue);border-radius:var(--rsm);padding:9px 14px;margin-bottom:14px;font-size:.75rem;color:var(--blue);">
      <strong>Fixed access:</strong> &nbsp;
      üëë Admin ‚Äî full access &nbsp;|&nbsp;
      üü¢ Employee ‚Äî only "My Projects" (read-only) &nbsp;|&nbsp;
      üü£ Stakeholder ‚Äî only their executive dashboard
    </div>
    <div class="acc2-role-hdr"><span class="role-pill rp-manager">üîµ Manager</span> ‚Äî click chips to toggle</div>
    <div style="display:flex;flex-wrap:wrap;gap:0;margin-bottom:12px;">${renderChips('manager')}</div>
    <div class="acc2-role-hdr"><span class="role-pill rp-reviewer">üü° Reviewer</span> ‚Äî click chips to toggle</div>
    <div style="display:flex;flex-wrap:wrap;gap:0;">${renderChips('reviewer')}</div>
  </div>

  <!-- ‚ïê‚ïê SECTION 2: Activity Log + Date Filter ‚ïê‚ïê -->
  <div class="vis-role-card">
    <div class="vis-role-title"><i class="fas fa-history" style="color:var(--blue)"></i> Activity Log Access</div>
    <div class="vis-role-sub">Who can view the activity log? Admin always has access. Employee never has access.</div>
    <div class="vis-toggle-list">
      <div class="vis-toggle-row" style="opacity:.4;pointer-events:none;">
        <span class="vis-toggle-lbl">üëë Admin ‚Äî always on</span>
        <label class="toggle-sw"><input type="checkbox" checked disabled><span class="toggle-sl"></span></label>
      </div>
      <div class="vis-toggle-row">
        <span class="vis-toggle-lbl">üîµ Manager</span>
        <label class="toggle-sw"><input type="checkbox" ${alv.manager?'checked':''} onchange="toggleActLogAccess('manager',this.checked)"><span class="toggle-sl"></span></label>
      </div>
      <div class="vis-toggle-row">
        <span class="vis-toggle-lbl">üü° Reviewer</span>
        <label class="toggle-sw"><input type="checkbox" ${alv.reviewer?'checked':''} onchange="toggleActLogAccess('reviewer',this.checked)"><span class="toggle-sl"></span></label>
      </div>
      <div class="vis-toggle-row">
        <span class="vis-toggle-lbl">üü£ Stakeholder</span>
        <label class="toggle-sw"><input type="checkbox" ${alv.stakeholder?'checked':''} onchange="toggleActLogAccess('stakeholder',this.checked)"><span class="toggle-sl"></span></label>
      </div>
      <div class="vis-toggle-row" style="opacity:.4;pointer-events:none;">
        <span class="vis-toggle-lbl">üü¢ Employee ‚Äî always off</span>
        <label class="toggle-sw"><input type="checkbox" disabled><span class="toggle-sl"></span></label>
      </div>
    </div>

    <div class="acc2-section">
      <div class="vis-role-title" style="font-size:.83rem;"><i class="fas fa-calendar-alt" style="color:var(--yellow)"></i> Date Range Filter Access</div>
      <div class="vis-role-sub">Who can filter dashboard data by date range? Useful to see work done in a specific period.</div>
      <div class="vis-toggle-list">
        <div class="vis-toggle-row" style="opacity:.4;pointer-events:none;">
          <span class="vis-toggle-lbl">üëë Admin ‚Äî always on</span>
          <label class="toggle-sw"><input type="checkbox" checked disabled><span class="toggle-sl"></span></label>
        </div>
        <div class="vis-toggle-row">
          <span class="vis-toggle-lbl">üîµ Manager</span>
          <label class="toggle-sw"><input type="checkbox" ${df.manager?'checked':''} onchange="toggleDateFilter('manager',this.checked)"><span class="toggle-sl"></span></label>
        </div>
        <div class="vis-toggle-row">
          <span class="vis-toggle-lbl">üü° Reviewer</span>
          <label class="toggle-sw"><input type="checkbox" ${df.reviewer?'checked':''} onchange="toggleDateFilter('reviewer',this.checked)"><span class="toggle-sl"></span></label>
        </div>
        <div class="vis-toggle-row">
          <span class="vis-toggle-lbl">üü£ Stakeholder</span>
          <label class="toggle-sw"><input type="checkbox" ${df.stakeholder?'checked':''} onchange="toggleDateFilter('stakeholder',this.checked)"><span class="toggle-sl"></span></label>
        </div>
        <div class="vis-toggle-row" style="opacity:.4;pointer-events:none;">
          <span class="vis-toggle-lbl">üü¢ Employee ‚Äî always off</span>
          <label class="toggle-sw"><input type="checkbox" disabled><span class="toggle-sl"></span></label>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê SECTION 3: Stakeholder Dashboard Fields ‚ïê‚ïê -->
  <div class="vis-role-card">
    <div class="vis-role-title"><i class="fas fa-eye" style="color:var(--purple)"></i> Stakeholder Dashboard ‚Äî Visible Fields</div>
    <div class="vis-role-sub">Control exactly what data stakeholders (investors, executives) can see. Sensitive fields are hidden by default.</div>
    <div class="vis-toggle-list">
      ${Object.entries(shGroups).map(([grp,fields])=>`
        <div style="font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--tx3);padding:8px 0 3px;margin-top:6px;">${grp}</div>
        ${fields.map(f=>{
          const isSens=f.key.includes('Assigned')||f.key.includes('Notes')||f.key.includes('Count')&&f.key.includes('Employee');
          return`<div class="vis-toggle-row" style="${isSens?'background:var(--yel-l);border-radius:5px;padding:5px 8px;':''}">
          <span class="vis-toggle-lbl" style="${isSens?'color:var(--yellow);font-size:.76rem;':''}">${f.label}</span>
          <label class="toggle-sw"><input type="checkbox" ${sf[f.key]?'checked':''} onchange="toggleStakeholderField('${f.key}',this.checked)"><span class="toggle-sl"></span></label>
        </div>`;
        }).join('')}
      `).join('')}
    </div>
  </div>`;
}

function togglePageAccess(role,page,val){
  if(!visConfig.pageAccess[role])visConfig.pageAccess[role]={};
  visConfig.pageAccess[role][page]=val;
  saveVisConfigDB(); // saves locally + broadcasts to all browsers
  renderAccessControl();
  applyRoleToUI();
  toast(`${role}: "${page}" ${val?'enabled':'disabled'}`,'ok');
}
function toggleDateFilter(role,val){
  visConfig.dateFilter[role]=val;
  saveVisConfigDB();
  applyRoleToUI();
  toast(`Date filter ${val?'on':'off'} for ${role}s`,'ok');
}
function toggleActLogAccess(role,val){
  visConfig.actLogVisible[role]=val;
  saveVisConfigDB();
  applyRoleToUI();
  toast(`Activity Log ${val?'visible to':'hidden from'} ${role}s`,'ok');
}
function toggleStakeholderField(key,val){
  visConfig.stakeholderFields[key]=val;
  saveVisConfigDB();
  toast(`Stakeholder field "${key}" ${val?'enabled':'disabled'}`,'ok');
}

// Default users (persisted in localStorage so Admin can add more)
const DEFAULT_USERS=[
  {id:'u1', name:'CamCom Admin',    email:'admin'+AT+'camcom.ai',        pwd:'admin123',  role:'admin',       empId:null},
  {id:'u2', name:'Priya Manager',   email:'manager'+AT+'camcom.ai',      pwd:'mgr123',    role:'manager',     empId:null},
  {id:'u3', name:'Ravi Reviewer',   email:'reviewer'+AT+'camcom.ai',     pwd:'rev123',    role:'reviewer',    empId:null},
  {id:'u8', name:'Investor View',   email:'stakeholder'+AT+'camcom.ai',  pwd:'stake123',  role:'stakeholder', empId:null},
  {id:'u10',name:'Ramyashree V R',              email:'ramyashree.ragupathy'+AT+'camcom.ai',  pwd:'emp123', role:'manager',  empId:'e1'},
  {id:'u11',name:'Manoj Kumar Devanga Kotha',   email:'manoj.kotha'+AT+'camcom.ai',           pwd:'emp123', role:'employee', empId:'e2'},
  {id:'u12',name:'Dande Kalyani',               email:'dande.kalyani'+AT+'camcom.ai',         pwd:'emp123', role:'employee', empId:'e3'},
  {id:'u13',name:'Dande Sandhya',               email:'dande.sandhya'+AT+'camcom.ai',         pwd:'emp123', role:'reviewer', empId:'e4'},
  {id:'u14',name:'Challa Koteswaramma',         email:'challa.koteswaramma'+AT+'camcom.ai',   pwd:'emp123', role:'employee', empId:'e5'},
  {id:'u15',name:'Kadagandla Hariprasad',       email:'kadagandla.hariprasad'+AT+'camcom.ai', pwd:'emp123', role:'reviewer', empId:'e6'},
  {id:'u16',name:'Uma Krishnappa',              email:'uma.krishnappa'+AT+'camcom.ai',        pwd:'emp123', role:'employee', empId:'e7'},
  {id:'u17',name:'Manjunath Kalakappa Bandihal',email:'manjunath.bandihal'+AT+'camcom.ai',    pwd:'emp123', role:'employee', empId:'e8'},
  {id:'u18',name:'Akshay Phatale',              email:'akshay.phatale'+AT+'camcom.ai',        pwd:'emp123', role:'reviewer', empId:'e9'},
  {id:'u19',name:'Maitra Salimath',             email:'maitra.salimath'+AT+'camcom.ai',       pwd:'emp123', role:'reviewer', empId:'e10'},
  {id:'u20',name:'Yathish Gowda K H',           email:'yathish.gowda'+AT+'camcom.ai',         pwd:'emp123', role:'reviewer', empId:'e11'},
  {id:'u21',name:'Pavan Kalyan Yeddala',        email:'pavan.yeddala'+AT+'camcom.ai',         pwd:'emp123', role:'employee', empId:'e12'},
  {id:'u22',name:'Sabharmathi Selvam',          email:'sabarmathi.selvam'+AT+'camcom.ai',     pwd:'emp123', role:'employee', empId:'e13'},
  {id:'u23',name:'G Umesh',                     email:'umesh.g'+AT+'camcom.ai',               pwd:'emp123', role:'employee', empId:'e14'},
  {id:'u24',name:'Shilpa E',                    email:'shilpa.e'+AT+'camcom.ai',              pwd:'emp123', role:'employee', empId:'e15'},
  {id:'u25',name:'Prema Joshi',                 email:'prema.joshi'+AT+'camcom.ai',           pwd:'emp123', role:'employee', empId:'e16'},
  {id:'u26',name:'Keerti Doddwad',              email:'keerti.doddwad'+AT+'camcom.ai',        pwd:'emp123', role:'employee', empId:'e17'},
  {id:'u27',name:'Ajay Reddy H',                email:'ajay.reddy'+AT+'camcom.ai',            pwd:'emp123', role:'employee', empId:'e18'},
  {id:'u28',name:'Varun Kumar H N',             email:'varun.kumar'+AT+'camcom.ai',           pwd:'emp123', role:'employee', empId:'e19'},
  {id:'u29',name:'Sneha B V',                   email:'sneha.bv'+AT+'camcom.ai',              pwd:'emp123', role:'employee', empId:'e20'},
  {id:'u30',name:'Fathima Reneesha',            email:'fathima.reneesha'+AT+'camcom.ai',      pwd:'emp123', role:'employee', empId:'e21'},
  {id:'u31',name:'Vishruthi Raghu',             email:'vishruthi.raghu'+AT+'camcom.ai',       pwd:'emp123', role:'employee', empId:'e22'},
  {id:'u32',name:'Sanjana G P',                 email:'sanjana.gp'+AT+'camcom.ai',            pwd:'emp123', role:'employee', empId:'e23'},
  {id:'u33',name:'Dhanyasri A S',               email:'dhanyasri.as'+AT+'camcom.ai',          pwd:'emp123', role:'employee', empId:'e24'},
  {id:'u34',name:'Siddharth Anandan',           email:'siddharth.anandan'+AT+'camcom.ai',     pwd:'emp123', role:'employee', empId:'e25'},
  {id:'u35',name:'Bindusree S N',               email:'bindusree.sn'+AT+'camcom.ai',          pwd:'emp123', role:'employee', empId:'e26'},
  {id:'u36',name:'Anil Kumar Pasala',           email:'anilkumar.pasala'+AT+'camcom.ai',      pwd:'emp123', role:'employee', empId:'e27'},
  {id:'u37',name:'Mihir',                       email:'mihir.singh'+AT+'camcom.ai',           pwd:'emp123', role:'employee', empId:'e28'},
  {id:'u38',name:'Suzan',                       email:'suzan.john'+AT+'camcom.ai',            pwd:'emp123', role:'employee', empId:'e29'},
  {id:'u39',name:'Umesh Nagappa Barker',        email:'umesh'+AT+'zuru.ai',                   pwd:'emp123', role:'employee', empId:'e30'},
  {id:'u40',name:'Sunil Kumar',                 email:'sunilkumar'+AT+'zuru.ai',              pwd:'emp123', role:'employee', empId:'e31'},
  {id:'u41',name:'Shanta Mantri',               email:'shanta'+AT+'zuru.ai',                  pwd:'emp123', role:'employee', empId:'e32'},
  {id:'u42',name:'Nandini Keni',                email:'nandini'+AT+'zuru.ai',                 pwd:'emp123', role:'employee', empId:'e33'},
  {id:'u43',name:'Shweta Kannagar',             email:'shwetak'+AT+'zuru.ai',                 pwd:'emp123', role:'employee', empId:'e34'},
  {id:'u44',name:'Kishore Devaragudi',          email:'kishored'+AT+'zuru.ai',                pwd:'emp123', role:'employee', empId:'e35'},
  {id:'u45',name:'Anil Gandredi',               email:'anilg'+AT+'zuru.ai',                   pwd:'emp123', role:'employee', empId:'e36'},
  {id:'u46',name:'K Ganesh',                    email:'ganeshk'+AT+'zuru.ai',                 pwd:'emp123', role:'employee', empId:'e37'},
  {id:'u47',name:'Kiran Y',                     email:'kirany'+AT+'zuru.ai',                  pwd:'emp123', role:'employee', empId:'e38'},
  {id:'u48',name:'Vishwas Reddy',               email:'vishwasreddy'+AT+'zuru.ai',            pwd:'emp123', role:'employee', empId:'e39'},
  {id:'u49',name:'Sandhya K',                   email:'sandhya.k'+AT+'camcom.ai',             pwd:'emp123', role:'employee', empId:'e40'},
  {id:'u50',name:'Venkatesh Chilukuri',         email:'venkatesh.chilukuri'+AT+'camcom.ai',   pwd:'emp123', role:'employee', empId:'e41'},
  {id:'u51',name:'Abhil C Sasindran',           email:'abhil.sasindran'+AT+'camcom.ai',       pwd:'emp123', role:'manager',  empId:'e42'}
];
let appUsers=[...DEFAULT_USERS];
let currentUser=null;
let editUserId=null;

function loadUsersLocal(){
  try{
    const s=localStorage.getItem('cc_users');
    if(s){
      const a=JSON.parse(s);
      if(a&&a.length){
        const savedIds=new Set(a.map(u=>u.id));
        const merged=[...a];
        DEFAULT_USERS.forEach(du=>{if(!savedIds.has(du.id))merged.push(du);});
        appUsers=merged;
      }
    }
  }catch(e){appUsers=[...DEFAULT_USERS];}
}
async function loadUsersFromDB(){
  try{
    const{data,error}=await sb.from('app_settings').select('value').eq('key','app_users').single();
    if(error||!data?.value){
      // First time: push DEFAULT_USERS to DB so all browsers get them
      await saveUsersToDB();
      return;
    }
    const remote=JSON.parse(data.value);
    if(remote&&remote.length){
      // Merge: always include DEFAULT_USERS so hardcoded accounts always work
      const savedIds=new Set(remote.map(u=>u.id));
      const merged=[...remote];
      DEFAULT_USERS.forEach(du=>{if(!savedIds.has(du.id))merged.push(du);});
      appUsers=merged;
      saveUsersLocal(); // sync to local cache
    }
  }catch(e){console.warn('loadUsersFromDB failed, using local:',e);loadUsersLocal();}
}
function saveUsersLocal(){try{localStorage.setItem('cc_users',JSON.stringify(appUsers));}catch(e){}} // keep for fallback
async function saveUsersToDB(){
  saveUsersLocal(); // local backup
  try{
    await sb.from('app_settings').upsert({key:'app_users',value:JSON.stringify(appUsers)},{onConflict:'key'});
  }catch(e){console.warn('saveUsersToDB failed:',e);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doLogin(){
  const email=document.getElementById('li-email').value.trim().toLowerCase();
  const pwd=document.getElementById('li-pwd').value;
  const user=appUsers.find(u=>u.email.toLowerCase()===email&&u.pwd===pwd);
  if(!user){
    const err=document.getElementById('loginErr');
    err.textContent='Incorrect email or password.';
    setTimeout(()=>err.textContent='',3000);
    return;
  }
  startSession(user);
}
function quickLogin(role){
  const user=appUsers.find(u=>u.role===role);
  if(user)startSession(user);
}
function startSession(user){
  currentUser=user;
  try{localStorage.setItem('cc_sess',JSON.stringify({id:user.id,role:user.role}));}catch(e){}
  document.getElementById('loginScr').style.display='none';
  applyRoleToUI();
  appInit();
}
async function tryRestoreSession(){
  // Always load latest users+emps from DB before checking session
  try{await Promise.all([loadUsersFromDB(),loadEmpsFromDB()]);}catch(e){}
  loadUsersLocal();
  loadActLog();
  try{
    const s=localStorage.getItem('cc_sess');
    if(s){const sess=JSON.parse(s);const u=appUsers.find(x=>x.id===sess.id);
      if(u){currentUser=u;document.getElementById('loginScr').style.display='none';applyRoleToUI();appInit();return;}}
  }catch(e){}
  // stay on login screen
}
function doLogout(){
  currentUser=null;
  try{localStorage.removeItem('cc_sess');}catch(e){}
  document.getElementById('loginScr').style.display='flex';
  document.getElementById('li-email').value='';
  document.getElementById('li-pwd').value='';
}

function applyRoleToUI(){
  if(!currentUser)return;
  loadVisConfig(); // always use latest saved config
  const role=currentUser.role;
  const r=ROLES[role]||ROLES.employee;

  // ‚îÄ‚îÄ‚îÄ User chip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const initls=currentUser.name.split(' ').filter(Boolean).map(w=>w[0]).join('').substr(0,2).toUpperCase();
  document.getElementById('userAv').textContent=initls;
  document.getElementById('userAv').style.background=r.color;
  document.getElementById('userName').textContent=currentUser.name;
  document.getElementById('userRole').innerHTML=`<span class="role-pill ${r.pill}">${r.icon} ${r.label}</span>`;

  // ‚îÄ‚îÄ‚îÄ Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const showId=(id,show)=>{const el=document.getElementById(id);if(el)el.style.display=show?'':'none';};

  // ‚îÄ‚îÄ‚îÄ Main navigation pages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  showId('nav-dashboard', canSeePage('dashboard'));
  showId('nav-projects',  canSeePage('projects'));
  showId('nav-kanban',    canSeePage('kanban'));
  showId('nav-analytics', canSeePage('analytics'));
  showId('nav-employees', canSeePage('employees'));
  showId('nav-workload',  canSeePage('workload'));

  // ‚îÄ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  showId('nav-newproj',   can('canCreate'));
  // nav-addemp removed ‚Äî employees added via Manage Users
  showId('nav-exportcsv', canSeePage('exportCSV'));
  showId('nav-exportpdf', canSeePage('exportPDF'));
  showId('nav-dailyreport', role==='admin'||role==='manager');

  // ‚îÄ‚îÄ‚îÄ Admin-only items ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  showId('nav-access',  role==='admin');
  showId('nav-users',   role==='admin');
  showId('nav-settings', role==='admin');
  // Feature Settings nav button (data-page="settings") ‚Äî use querySelector since no ID
  const settingsBtn=document.querySelector('[data-page="settings"]');
  if(settingsBtn)settingsBtn.style.display=(role==='admin')?'':'none';

  // ‚îÄ‚îÄ‚îÄ Activity Log nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const canLog=role==='admin'||!!(visConfig.actLogVisible[role]);
  showId('nav-actlog', canLog);

  // ‚îÄ‚îÄ‚îÄ Stakeholder-only nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  showId('nav-stakeholder', role==='stakeholder');

  // ‚îÄ‚îÄ‚îÄ Date filter bar on dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  showId('drBar', canUseDateFilter());

  // ‚îÄ‚îÄ‚îÄ Rename "All Projects" label for employee ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const projBtn=document.getElementById('nav-projects');
  if(projBtn){
    if(role==='employee'){
      projBtn.innerHTML='<i class="fas fa-folder-open"></i> My Projects <span class="nbadge" id="nb-p">0</span>';
    } else {
      projBtn.innerHTML='<i class="fas fa-folder-open"></i> All Projects <span class="nbadge" id="nb-p">0</span>';
    }
  }

  // ‚îÄ‚îÄ‚îÄ Landing page after login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(role==='stakeholder')setTimeout(()=>switchPage('stakeholder'),80);
  else if(role==='employee')setTimeout(()=>switchPage('projects'),80);

  // ‚îÄ‚îÄ‚îÄ Warn unlinked employee ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(role==='employee'&&!currentUser.empId){
    setTimeout(()=>toast('‚ö† Account not linked to an employee record ‚Äî contact admin.','info'),600);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURE FLAGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let features={kanban:true,analytics:true,gantt:true,burndown:true,exportPDF:true,exportCSV:true,workload:true,dailyTarget:true,fileUpload:true};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORE STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentFilter='all', searchQ='', openProjId=null, editEmpId=null, editProjId=null;
let projDocs={};
let chartInstances={};
let dragSrcId=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function appInit(){
  loadFeaturesLocal(); loadDocsLocal(); loadVisConfig(); loadActLog();
  loadThreadedComments(); loadNotifications();
  // Load users + employees from Supabase (so all browsers are in sync)
  await Promise.all([loadUsersFromDB(), loadEmpsFromDB()]);
  loadProjects();
  if(can('canManageFeatures'))renderSettings();
  startRealtime();
  startVisConfigPoll();
  updateNbDot();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProjects(){
  document.getElementById('lovl').style.display='flex';
  try{
    const{data,error}=await sb.from('projects').select('*').order('created_at',{ascending:false});
    if(error)throw error;
    projects=(data||[]).map(r=>({
      id:r.id, name:r.name, client:r.client||'', labellink:r.labellink||'',
      total:r.total||0, annotated:r.annotated||0, reviewed:r.reviewed||0,
      priority:r.priority||'medium', startdate:r.startdate||'', deadline:r.deadline||'',
      assignedby:r.assignedby||'', notes:r.notes||'', comments:r.comments||'',
      hasTarget:r.has_target||false, dailyTarget:r.daily_target||null,
      kanbanStatus:r.kanban_status||'todo',
      assignedEmployees:r.assigned_employees?r.assigned_employees.split(',').filter(Boolean):[],
      reviewEmployees:r.review_employees?r.review_employees.split(',').filter(Boolean):[],
      tags:r.tags?r.tags.split(',').filter(Boolean):[]
    }));
    toast('Data loaded ‚úì','ok');
  }catch(e){console.error(e);toast('DB: '+e.message,'err');}
  finally{document.getElementById('lovl').style.display='none';renderAll();}
}

async function saveProjDB(p){
  if(_saveProjDBRunning.has(p.id))return;
  _saveProjDBRunning.add(p.id);
  _lastSave=Date.now();
  _ownSaves.set(p.id,Date.now());
  try{
  // ‚îÄ‚îÄ FULL row with all v5+ columns ‚îÄ‚îÄ
  const fullRow={
    id:p.id, name:p.name, client:p.client||'', labellink:p.labellink||'',
    total:p.total, annotated:p.annotated, reviewed:p.reviewed,
    priority:p.priority, startdate:p.startdate||null, deadline:p.deadline||null,
    assignedby:p.assignedby||'', notes:p.notes||'', comments:p.comments||'',
    has_target:p.hasTarget||false, daily_target:p.dailyTarget||null,
    kanban_status:p.kanbanStatus||'todo',
    assigned_employees:(p.assignedEmployees||[]).join(','),
    review_employees:(p.reviewEmployees||[]).join(','),
    tags:(p.tags||[]).join(',')
  };
  const{error}=await sb.from('projects').upsert(fullRow);
  if(error){
    // ‚îÄ‚îÄ If column missing ‚Üí show migration banner, retry with safe minimal row ‚îÄ‚îÄ
    const isSchemaMiss=error.message&&(error.message.includes('column')||error.message.includes('schema cache'));
    if(isSchemaMiss){
      // Show migration instructions
      const mb=document.getElementById('migBanner');
      if(mb){mb.style.display='';if(!document.getElementById('page-settings').classList.contains('active')){toast('‚ö† DB migration needed ‚Äî go to Feature Settings for instructions','err');}}
      // Retry with only the original safe columns
      const safeRow={
        id:p.id, name:p.name, total:p.total, annotated:p.annotated, reviewed:p.reviewed,
        priority:p.priority, deadline:p.deadline||null, notes:p.notes||'',
        assigned_employees:(p.assignedEmployees||[]).join(',')
      };
      const r2=await sb.from('projects').upsert(safeRow);
      if(r2.error){toast('Save failed: '+r2.error.message,'err');}
      else{toast('Saved (partial) ‚Äî run SQL migration for full features','info');}
    } else {
      toast('Save error: '+error.message,'err');
      console.error(error);
    }
  }
  }finally{_saveProjDBRunning.delete(p.id);}
}

async function delProjDB(id){const{error}=await sb.from('projects').delete().eq('id',id);if(error)toast('Delete: '+error.message,'err');}

function saveEmpsLocal(){try{localStorage.setItem('cc_emps',JSON.stringify(employees));}catch(e){}} // keep for fallback
async function saveEmpsToDB(){
  saveEmpsLocal(); // local backup
  try{
    await sb.from('app_settings').upsert({key:'app_emps',value:JSON.stringify(employees)},{onConflict:'key'});
  }catch(e){console.warn('saveEmpsToDB failed:',e);}
}
function loadEmpsLocal(){try{const s=localStorage.getItem('cc_emps');if(s){const a=JSON.parse(s);if(a.length)employees=a;}}catch(e){}}
async function loadEmpsFromDB(){
  try{
    const{data,error}=await sb.from('app_settings').select('value').eq('key','app_emps').single();
    if(error||!data?.value){await saveEmpsToDB();return;}
    const remote=JSON.parse(data.value);
    if(remote&&remote.length){employees=remote;saveEmpsLocal();}
  }catch(e){console.warn('loadEmpsFromDB failed, using local:',e);loadEmpsLocal();}
}
function saveDocsLocal(){try{localStorage.setItem('cc_docs',JSON.stringify(projDocs));}catch(e){}}
function loadDocsLocal(){try{const s=localStorage.getItem('cc_docs');if(s)projDocs=JSON.parse(s);}catch(e){}}
function saveFeaturesLocal(){localStorage.setItem('cc_features',JSON.stringify(features));}
function loadFeaturesLocal(){try{const s=localStorage.getItem('cc_features');if(s)Object.assign(features,JSON.parse(s));}catch(e){}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uid(){return crypto.randomUUID?crypto.randomUUID():'id_'+Date.now()+'_'+Math.random().toString(36).substr(2,6);}
function esc(s){return(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function pct(a,b){return b>0?Math.round((a/b)*100):0;}
function fillDemoLabels(){
  if(document.getElementById('dlbl-admin'))document.getElementById('dlbl-admin').textContent='admin'+AT+'camcom.ai / admin123';
  if(document.getElementById('dlbl-manager'))document.getElementById('dlbl-manager').textContent='manager'+AT+'camcom.ai / mgr123';
  if(document.getElementById('dlbl-reviewer'))document.getElementById('dlbl-reviewer').textContent='reviewer'+AT+'camcom.ai / rev123';
}
function fmtAgo(ts){
  if(!ts)return'';
  const diff=Date.now()-new Date(ts).getTime();
  const s=Math.floor(diff/1000),m=Math.floor(s/60),h=Math.floor(m/60),d=Math.floor(h/24);
  if(s<60)return'just now';
  if(m<60)return m+'m ago';
  if(h<24)return h+'h ago';
  if(d<7)return d+'d ago';
  return new Date(ts).toLocaleDateString('en-IN',{day:'2-digit',month:'short'});
}
function fmtD(d){if(!d)return'‚Äî';return new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}
function dlMeta(d){if(!d)return null;const dt=new Date(d+'T00:00:00'),diff=Math.ceil((dt-new Date())/86400000);return{label:fmtD(d),diff};}
function initials(n){return(n||'?').split(' ').map(w=>w[0]||'').join('').substr(0,2).toUpperCase();}
function getEmp(id){return employees.find(e=>e.id===id)||{name:'Unknown',gender:'male'};}
function aMap(){const m=new Map();projects.forEach(p=>(p.assignedEmployees||[]).forEach(id=>m.set(id,(m.get(id)||0)+1)));return m;}
// Returns set of empIds doing both annotation AND review (any project)
function dualRoleIds(){
  const ann=new Set(projects.flatMap(p=>p.assignedEmployees||[]));
  const rev=new Set(projects.flatMap(p=>p.reviewEmployees||[]));
  return new Set([...ann].filter(id=>rev.has(id)));
}
// Returns empIds assigned to 2+ annotation projects (double-booked annotators)
function multiAnnotators(){const m=aMap();return new Set([...m.entries()].filter(([,c])=>c>1).map(([id])=>id));}
// Combined conflict list: multi-annotation OR dual-role
function conflicts(){
  const ma=multiAnnotators();
  const dr=dualRoleIds();
  return [...new Set([...ma,...dr])];
}
function fmtSize(b){if(b<1024)return b+'B';if(b<1048576)return(b/1024).toFixed(1)+'KB';return(b/1048576).toFixed(1)+'MB';}
function toast(msg,type='info'){
  const el=document.createElement('div');el.className=`toast ${type==='ok'?'ok':type==='err'?'err':'info'}`;
  el.innerHTML=`<i class="fas ${type==='ok'?'fa-check-circle':type==='err'?'fa-times-circle':'fa-info-circle'}"></i>${msg}`;
  document.getElementById('toasts').appendChild(el);setTimeout(()=>el.remove(),3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(p){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p)?.classList.add('active');
  document.querySelector(`[data-page="${p}"]`)?.classList.add('active');
  if(p==='employees')renderEmps();
  if(p==='workload')renderWorkload();
  if(p==='projects')renderProjFull();
  if(p==='kanban')renderKanban();
  if(p==='analytics'){renderCharts();renderGantt();populateBurndownSel();}
  if(p==='settings')renderSettings();
  if(p==='users')renderUsers();
  if(p==='actlog')renderActivityLog();
  if(p==='stakeholder')renderStakeholderDashboard();
  if(p==='access')renderAccessControl();
}
function renderAll(){renderProjects();renderStats();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStats(){
  const filteredProj=dateFilterProjects([...visibleProjects()]);
  const tI=filteredProj.reduce((s,p)=>s+(+p.total||0),0);
  const tA=filteredProj.reduce((s,p)=>s+(+p.annotated||0),0);
  const tR=filteredProj.reduce((s,p)=>s+(+p.reviewed||0),0);
  const asd=new Set(filteredProj.flatMap(p=>p.assignedEmployees||[])).size;
  const cc=conflicts();
  document.getElementById('statGrid').innerHTML=[
    {l:'Projects',v:filteredProj.length,s:`${filteredProj.filter(p=>p.priority==='high').length} high priority`,c:'',i:'fa-folder-open'},
    {l:'Total Images',v:tI.toLocaleString(),s:`${pct(tA,tI)}% annotated`,c:'b',i:'fa-images'},
    {l:'Annotated',v:tA.toLocaleString(),s:`${pct(tA,tI)}% done`,c:'g',i:'fa-check-circle'},
    {l:'Reviewed',v:tR.toLocaleString(),s:`${pct(tR,tI)}% done`,c:'y',i:'fa-eye'},
    {l:'Employees',v:employees.length,s:`${asd} assigned`,c:'p',i:'fa-users'},
    {l:'Conflicts',v:cc.length,s:cc.length>0?`${[...multiAnnotators()].length} overloaded, ${[...dualRoleIds()].length} dual-role`:'All clear ‚úì',c:cc.length>0?'r':'g',i:'fa-exclamation-triangle'},
  ].map(x=>`<div class="sc ${x.c}"><div class="sc-l">${x.l}</div><div class="sc-v">${x.v}</div><div class="sc-s">${x.s}</div></div>`).join('');
  document.getElementById('nb-p').textContent=projects.length;
  document.getElementById('nb-e').textContent=employees.length;
  const cc2=conflicts();
  const cb=document.getElementById('cBanner');
  if(cc2.length>0){
    const ma=multiAnnotators();const dr=dualRoleIds();
    const parts=[];
    const maNames=[...ma].map(id=>getEmp(id).name);
    const drNames=[...dr].filter(id=>!ma.has(id)).map(id=>getEmp(id).name);
    if(maNames.length)parts.push('Multi-project annotators: '+maNames.join(', '));
    if(drNames.length)parts.push('Annotating & reviewing: '+drNames.join(', '));
    cb.style.display='flex';document.getElementById('cTxt').textContent='‚ö† '+parts.join(' | ');
  }
  else cb.style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE RANGE FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dateRange={active:false,from:'',to:''};

function applyDateRange(){
  const from=document.getElementById('drFrom')?.value||'';
  const to=document.getElementById('drTo')?.value||'';
  if(!from&&!to){clearDateRange();return;}
  dateRange={active:true,from,to};
  const pill=document.getElementById('drResultPill');
  const pillTxt=document.getElementById('drResultTxt');
  if(pill&&pillTxt){
    const fmtFrom=from?new Date(from+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short'}):'';
    const fmtTo=to?new Date(to+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short'}):'';
    pillTxt.textContent=fmtFrom+(fmtTo?' ‚Üí '+fmtTo:'');
    pill.style.display='';
  }
  renderDateFilterSummary();
  renderProjects();
}
function clearDateRange(){
  dateRange={active:false,from:'',to:''};
  const drFrom=document.getElementById('drFrom');const drTo=document.getElementById('drTo');
  if(drFrom)drFrom.value='';if(drTo)drTo.value='';
  const pill=document.getElementById('drResultPill');if(pill)pill.style.display='none';
  const banner=document.getElementById('drResultBanner');if(banner)banner.style.display='none';
  renderProjects();
}
function renderDateFilterSummary(){
  if(!dateRange.active)return;
  const from=dateRange.from?new Date(dateRange.from+'T00:00:00'):null;
  const to=dateRange.to?new Date(dateRange.to+'T23:59:59'):null;
  // Count activity log entries in range
  const entriesInRange=actLog.filter(e=>{
    const d=new Date(e.ts);
    return(!from||d>=from)&&(!to||d<=to);
  });
  // Sum annotated/reviewed changes from logs in range
  let annotatedInRange=0,reviewedInRange=0;
  entriesInRange.forEach(e=>{
    const am=e.msg.match(/Annotated count updated to (\d+)/);
    const rm=e.msg.match(/Reviewed count updated to (\d+)/);
    if(am)annotatedInRange+=parseInt(am[1]);
    if(rm)reviewedInRange+=parseInt(rm[1]);
  });
  const fmtFrom=dateRange.from?new Date(dateRange.from+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}):'';
  const fmtTo=dateRange.to?new Date(dateRange.to+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}):'';
  const banner=document.getElementById('drResultBanner');
  if(banner){
    banner.style.display='';
    banner.innerHTML=`<i class="fas fa-calendar-check" style="font-size:1rem;"></i>
      <span><strong>Date Filter Active</strong>: ${fmtFrom||'‚Äî'}${fmtTo?' ‚Üí '+fmtTo:''} &nbsp;|&nbsp;
      <strong>${entriesInRange.length}</strong> activity entries &nbsp;|&nbsp;
      Projects with deadline in range shown below. Activity log entries in this period: <strong>${entriesInRange.length}</strong></span>
      <button class="dr-clear-btn" style="margin-left:auto;" onclick="clearDateRange()"><i class="fas fa-times"></i> Clear filter</button>`;
  }
}
function dateFilterProjects(list){
  if(!dateRange.active)return list;
  const from=dateRange.from?new Date(dateRange.from+'T00:00:00'):null;
  const to=dateRange.to?new Date(dateRange.to+'T23:59:59'):null;
  return list.filter(p=>{
    // Project overlaps the date range: start <= rangeTo AND deadline >= rangeFrom
    const projStart=p.startdate?new Date(p.startdate+'T00:00:00'):null;
    const projEnd=p.deadline?new Date(p.deadline+'T23:59:59'):null;
    const startOk=!from||!projEnd||projEnd>=from;   // project ends after range start
    const endOk=!to||!projStart||projStart<=to;      // project starts before range end
    // If project has no dates, include it only if no range filter is strict
    if(!projStart&&!projEnd)return true;
    return startOk&&endOk;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECT CARD (compact)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const KB_LABELS={todo:'üìã To Do',inprog:'‚ö° In Progress',review:'üîç Review',done:'‚úÖ Done'};
const KB_COLS={todo:'var(--tx3)',inprog:'var(--blue)',review:'var(--yellow)',done:'var(--green)'};

function buildCard(p){
  const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
  const aP=pct(A,T),rP=pct(R,T);
  const dl=dlMeta(p.deadline);
  const ov=dl&&dl.diff<0,sn=dl&&dl.diff>=0&&dl.diff<=7;
  const asgn=p.assignedEmployees||[];
  const docs=projDocs[p.id]||[];
  const avs=asgn.slice(0,4).map(id=>{const e=getEmp(id);return`<div class="av ${e.gender==='male'?'m':'f'}" title="${esc(e.name)}">${initials(e.name)}</div>`;}).join('');
  const extra=asgn.length>4?`<div class="av more">+${asgn.length-4}</div>`:'';
  const pLbl={high:'üî• High',medium:'‚ö° Med',low:'üåø Low'}[p.priority]||'Med';
  const ksColor=KB_COLS[p.kanbanStatus||'todo'];
  return`<div class="pcard" onclick="openDP('${p.id}')">
    <div class="pcard-stripe ${p.priority}"></div>
    <div class="pcard-body">
      <div class="pcard-title">${esc(p.name)}</div>
      ${p.client?`<div style="font-size:.67rem;color:var(--blue);font-weight:600;margin-top:1px;opacity:.85;"><i class="fas fa-building" style="margin-right:3px;opacity:.7;"></i>${esc(p.client)}</div>`:''}
      <div class="pcard-meta">
        <span class="badge b${p.priority[0]}">${pLbl}</span>
        <span class="badge" style="background:${ksColor}22;color:${ksColor};border:1px solid ${ksColor}44;font-size:.6rem;">${KB_LABELS[p.kanbanStatus||'todo']||'üìã To Do'}</span>
        ${p.assignedby?`<span class="mpill"><i class="fas fa-user-tie"></i> ${esc(p.assignedby)}</span>`:''}
        ${dl?`<span class="mpill ${ov?'ov':sn?'sn':''}"><i class="fas fa-calendar-alt"></i> ${dl.label} ${ov?'‚ö†':sn?`${dl.diff}d left`:''}</span>`:''}
        ${p.hasTarget&&p.dailyTarget?`<span class="mpill" style="color:var(--yellow);"><i class="fas fa-bullseye"></i> ${p.dailyTarget}/day</span>`:''}
        ${docs.length>0?`<span class="mpill"><i class="fas fa-paperclip"></i> ${docs.length}</span>`:''}
        ${(p.tags||[]).length>0?`<div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:3px;width:100%;">${(p.tags||[]).map(t=>`<span class="proj-tag">#${esc(t)}</span>`).join('')}</div>`:''}
      </div>
      <div class="pcard-prog">
        <div class="prog-r"><span class="prog-l">Annotation</span><span class="prog-p">${aP}%</span></div>
        <div class="pbar"><div class="pf pf-a" style="width:${aP}%"></div></div>
        <div class="prog-r" style="margin-top:4px;"><span class="prog-l">Review</span><span class="prog-p">${rP}%</span></div>
        <div class="pbar"><div class="pf pf-r" style="width:${rP}%"></div></div>
      </div>
    </div>
    <div class="pcard-foot">
      <div class="avatars">${avs+extra||'<span style="font-size:.65rem;color:var(--tx3)">No assignments</span>'}</div>
      <div style="display:flex;align-items:center;gap:6px;">
        ${p.labellink?`<a href="${esc(p.labellink)}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="Open in LabelStudio" style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:var(--blue);border-radius:var(--rp);color:#fff;font-size:.6rem;font-weight:700;text-decoration:none;"><i class="fas fa-external-link-alt"></i> LabelStudio</a>`:''}
        <span class="hint-txt"><i class="fas fa-arrow-right"></i> Details</span>
      </div>
    </div>
  </div>`;
}

function getFiltered(){
  const sort=document.getElementById('sortSel')?.value||'default';
  let list=[...visibleProjects()];  // ‚Üê role-filtered
  list=dateFilterProjects(list);    // ‚Üê date range filter
  if(currentFilter!=='all')list=list.filter(p=>p.priority===currentFilter);
  if(searchQ){const q=searchQ.toLowerCase();list=list.filter(p=>p.name.toLowerCase().includes(q)||(p.assignedby||'').toLowerCase().includes(q)||(p.notes||'').toLowerCase().includes(q)||(p.assignedEmployees||[]).some(id=>getEmp(id).name.toLowerCase().includes(q)));}
  if(sort==='name')list.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sort==='progress')list.sort((a,b)=>pct(b.annotated,b.total)-pct(a.annotated,a.total));
  else if(sort==='deadline')list.sort((a,b)=>(a.deadline||'9999').localeCompare(b.deadline||'9999'));
  else if(sort==='priority'){const w={high:0,medium:1,low:2};list.sort((a,b)=>(w[a.priority]||1)-(w[b.priority]||1));}
  return list;
}
function renderProjects(){
  const list=getFiltered();
  document.getElementById('projGrid').innerHTML=list.length===0?`<div class="empty-st" style="grid-column:1/-1"><i class="fas fa-folder-open"></i><p>${currentUser?.role==='employee'?'No projects assigned to you yet.':'No projects found.'}</p></div>`:list.map(buildCard).join('');
  renderStats();
}
function renderProjFull(){
  const q=(document.getElementById('projSearch')?.value||'').toLowerCase();
  let list=[...visibleProjects()];  // ‚Üê role-filtered
  if(q)list=list.filter(p=>p.name.toLowerCase().includes(q)||(p.assignedby||'').toLowerCase().includes(q)||(p.client||'').toLowerCase().includes(q)||(p.assignedEmployees||[]).some(id=>getEmp(id).name.toLowerCase().includes(q)));
  document.getElementById('projGridFull').innerHTML=list.length===0?`<div class="empty-st" style="grid-column:1/-1"><i class="fas fa-folder-open"></i><p>No projects found.</p></div>`:list.map(buildCard).join('');
}
function setFilter(v,el){currentFilter=v;document.querySelectorAll('.fc').forEach(c=>c.classList.remove('on'));el.classList.add('on');renderProjects();}
function handleSearch(){searchQ=document.getElementById('gSearch').value;renderProjects();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DETAIL PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDP(id){
  const p=projects.find(x=>x.id===id);if(!p)return;
  openProjId=id;
  document.getElementById('dpTitle').textContent=p.name;
  const dl=dlMeta(p.deadline);
  document.getElementById('dpMeta').innerHTML=
    `<span class="badge b${p.priority[0]}">${{high:'üî• High',medium:'‚ö° Medium',low:'üåø Low'}[p.priority]}</span>`+
    (dl?`<span class="mpill ${dl.diff<0?'ov':dl.diff<=7?'sn':''}"><i class="fas fa-calendar-alt"></i> ${dl.label} ${dl.diff<0?'(Overdue)':dl.diff<=7?`(${dl.diff}d)`:''}</span>`:'');
  renderDPBody(p);
  document.getElementById('dpOvl').classList.add('open');
  document.getElementById('dp').classList.add('open');
}
function closeDP(){document.getElementById('dpOvl').classList.remove('open');document.getElementById('dp').classList.remove('open');openProjId=null;}
function closeDpBg(e){if(e.target===document.getElementById('dpOvl'))closeDP();}

function renderDPBody(p){
  const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
  const asgn=p.assignedEmployees||[];
  const am=aMap();
  const docs=projDocs[p.id]||[];
  const isRO=!can('canEdit'); // read-only if cannot edit

  // ‚îÄ‚îÄ Build assignment tags (no remove button when read-only) ‚îÄ‚îÄ
  const aTags=asgn.map(id=>{
    const e=getEmp(id);const isC=(am.get(id)||0)>1;
    return`<span class="atag ${isC?'cc':''}">${isC?'‚ö† ':''}${esc(e.name)}${can('canAssign')?`<button onclick="rmAsgn('${p.id}','${id}')"><i class="fas fa-times"></i></button>`:''}</span>`;
  }).join('');
  const docHtml=docs.map((d,i)=>`<div class="docitem"><i class="fas fa-file-alt"></i><span class="doc-n">${esc(d.name)}</span><span class="doc-s">${d.size}</span>${!isRO?`<button class="doc-rm" onclick="rmDoc('${p.id}',${i})"><i class="fas fa-trash"></i></button>`:''}</div>`).join('');

  // ‚îÄ‚îÄ Read-only display helpers ‚îÄ‚îÄ
  const roFld=(label,val,extra='')=>`<div class="inf"><label>${label}</label><div style="padding:7px 10px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);font-size:.83rem;color:var(--tx2);min-height:33px;${extra}">${esc(String(val||'‚Äî'))}</div></div>`;
  const SL={todo:'üìã To Do',inprog:'‚ö° In Progress',review:'üîç Review',done:'‚úÖ Done'};
  const PL={high:'üî• High',medium:'‚ö° Medium',low:'üåø Low'};

  document.getElementById('dpBody').innerHTML=`
  ${isRO?`<div style="display:flex;align-items:center;gap:7px;background:var(--blue-l);border:1px solid var(--blue);border-radius:var(--rsm);padding:8px 14px;margin:12px 20px 0;font-size:.75rem;color:var(--blue);">
    <i class="fas fa-lock"></i> <strong>View-only access.</strong>&nbsp; Contact a Manager or Admin to make changes.
  </div>`:''}

  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-info-circle"></i> Project Info</div>
    <div class="info-grid">
      ${isRO
        ? (p.client?roFld('Client / Task', p.client):'') + (p.labellink?`<div class="inf"><label><i class="fas fa-external-link-alt" style="color:var(--blue);margin-right:4px;"></i>LabelStudio Link</label><div style="padding:7px 10px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);font-size:.83rem;"><a href="${esc(p.labellink)}" target="_blank" rel="noopener" style="color:var(--blue);word-break:break-all;">${esc(p.labellink)}</a></div></div>`:'') + roFld('Assigned By', p.assignedby||'‚Äî') + roFld('Status', SL[p.kanbanStatus||'todo']) + roFld('Start Date', fmtD(p.startdate)) + roFld('Deadline', fmtD(p.deadline)) + roFld('Priority', PL[p.priority||'medium'])
        : `<div class="inf"><label>Client / Task name</label><input type="text" value="${esc(p.client||'')}" placeholder="e.g. Acme Corp" onchange="dpUpd('${p.id}','client',this.value)"></div>
           <div class="inf full"><label><i class="fas fa-external-link-alt" style="color:var(--blue);margin-right:4px;"></i>LabelStudio Link</label>
             <div style="display:flex;gap:6px;align-items:center;">
               <input type="url" style="flex:1;" value="${esc(p.labellink||'')}" placeholder="https://labelstudio..." onchange="dpUpd('${p.id}','labellink',this.value)">
               ${p.labellink?`<a href="${esc(p.labellink)}" target="_blank" rel="noopener" title="Open in LabelStudio" style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:var(--blue);border-radius:var(--rsm);color:#fff;font-size:.8rem;flex-shrink:0;"><i class="fas fa-external-link-alt"></i></a>`:''}
             </div>
           </div>
           <div class="inf"><label>Assigned By</label><input type="text" value="${esc(p.assignedby||'')}" placeholder="Manager" onchange="dpUpd('${p.id}','assignedby',this.value)"></div>
           <div class="inf"><label>Kanban Status</label><select onchange="dpUpd('${p.id}','kanbanStatus',this.value)">
             <option value="todo" ${(p.kanbanStatus||'todo')==='todo'?'selected':''}>üìã To Do</option>
             <option value="inprog" ${p.kanbanStatus==='inprog'?'selected':''}>‚ö° In Progress</option>
             <option value="review" ${p.kanbanStatus==='review'?'selected':''}>üîç Review</option>
             <option value="done" ${p.kanbanStatus==='done'?'selected':''}>‚úÖ Completed</option>
           </select></div>
           <div class="inf"><label>Start Date</label><input type="date" value="${p.startdate||''}" onchange="dpUpd('${p.id}','startdate',this.value)"></div>
           <div class="inf"><label>Deadline</label><input type="date" value="${p.deadline||''}" onchange="dpUpd('${p.id}','deadline',this.value)"></div>
           <div class="inf"><label>Priority</label><select onchange="dpUpd('${p.id}','priority',this.value)">
             <option value="high" ${p.priority==='high'?'selected':''}>üî• High</option>
             <option value="medium" ${p.priority==='medium'?'selected':''}>‚ö° Medium</option>
             <option value="low" ${p.priority==='low'?'selected':''}>üåø Low</option>
           </select></div>`}
    </div>
  </div>

  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-images"></i> Image Counts</div>
    <div class="num-grid">
      ${isRO
        ? `<div class="nc"><div class="ncv">${T}</div><div class="nc-l">Total</div></div>
           <div class="nc"><div class="ncv">${A}</div><div class="nc-l">Annotated</div></div>
           <div class="nc"><div class="ncv">${R}</div><div class="nc-l">Reviewed</div></div>`
        : `<div class="nc"><input type="number" value="${T}" min="0" onchange="dpField('${p.id}','total',this.value)"><div class="nc-l">Total</div></div>
           <div class="nc"><input type="number" value="${A}" min="0" onchange="dpField('${p.id}','annotated',this.value)"><div class="nc-l">Annotated</div></div>
           <div class="nc"><input type="number" value="${R}" min="0" onchange="dpField('${p.id}','reviewed',this.value)"><div class="nc-l">Reviewed</div></div>`}
      <div class="nc comp"><div class="ncv">${Math.max(T-A,0)}</div><div class="nc-l">Pend.Ann</div></div>
      <div class="nc comp2"><div class="ncv">${Math.max(A-R,0)}</div><div class="nc-l">Pend.Rev</div></div>
    </div>
    ${!isRO&&p.hasTarget&&p.dailyTarget?`<div class="tgt-row"><i class="fas fa-bullseye"></i><label>Daily Target</label><input type="number" value="${p.dailyTarget}" min="1" onchange="dpField('${p.id}','dailyTarget',this.value)"><span style="font-size:.7rem;color:var(--yellow);">imgs/day${p.dailyTarget>0&&Math.max(T-A,0)>0?' ¬∑ Est. '+Math.ceil(Math.max(T-A,0)/p.dailyTarget)+'d left':''}</span></div>`:''}
    <div style="margin-top:11px;">
      <div class="prog-r"><span class="prog-l">Annotation</span><span class="prog-p">${pct(A,T)}%</span></div>
      <div class="pbar" style="height:7px;margin-bottom:7px;"><div class="pf pf-a" style="width:${pct(A,T)}%"></div></div>
      <div class="prog-r"><span class="prog-l">Review</span><span class="prog-p">${pct(R,T)}%</span></div>
      <div class="pbar" style="height:7px;"><div class="pf pf-r" style="width:${pct(R,T)}%"></div></div>
    </div>
  </div>

  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-users"></i> Assigned Employees ‚Äî Annotation (${asgn.length})</div>
    ${can('canAssign')?`<div class="esbox"><i class="fas fa-search" style="color:var(--tx3);font-size:.8rem;"></i><input type="text" placeholder="Search employee to assign (annotation)..." id="esrch-${p.id}" oninput="renderES('${p.id}')"></div><div class="e-results" id="eres-${p.id}"></div>`:''}
    <div class="atags" style="margin-top:9px;">${aTags||'<span style="font-size:.74rem;color:var(--tx3);">No employees assigned yet</span>'}</div>
  </div>

  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-eye" style="color:var(--yellow)"></i> Assigned for Review (${(p.reviewEmployees||[]).length})</div>
    ${can('canAssign')?`<div class="esbox"><i class="fas fa-search" style="color:var(--tx3);font-size:.8rem;"></i><input type="text" placeholder="Search employee to assign (review)..." id="esrch-rev-${p.id}" oninput="renderESRev('${p.id}')"></div><div class="e-results" id="eres-rev-${p.id}"></div>`:''}
    <div class="atags" style="margin-top:9px;">${(p.reviewEmployees||[]).map(id=>{const e=getEmp(id);return`<span class="atag rev">${esc(e.name)}${can('canAssign')?`<button onclick="rmRev('${p.id}','${id}')"><i class="fas fa-times"></i></button>`:''}</span>`;}).join('')||'<span style="font-size:.74rem;color:var(--tx3);">No reviewers assigned yet</span>'}</div>
  </div>

  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-tags" style="color:var(--purple)"></i> Tags</div>
    <div class="atags" id="tags-wrap-${p.id}">${(p.tags||[]).map(t=>`<span class="proj-tag rm" onclick="removeTag('${p.id}','${esc(t)}')">#${esc(t)} <i class="fas fa-times" style="font-size:.55rem;margin-left:2px;"></i></span>`).join('')||'<span style="font-size:.74rem;color:var(--tx3);">No tags yet</span>'}</div>
    ${can('canEdit')?`<div class="tag-input-row"><input type="text" id="tag-inp-${p.id}" placeholder="Add tag (e.g. satellite, road)" onkeydown="if(event.key==='Enter')addTag('${p.id}',this.value)"><button onclick="addTag('${p.id}',document.getElementById('tag-inp-${p.id}').value)"><i class="fas fa-plus"></i> Add</button></div>`:''}
  </div>

  ${features.fileUpload&&!isRO?`<div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-paperclip"></i> Documents (${docs.length})</div>
    <div class="upzone"><input type="file" multiple onchange="handleUpload('${p.id}',this)"><i class="fas fa-cloud-upload-alt"></i><p><strong>Click or drag</strong> to upload files</p></div>
    ${docs.length>0?`<div class="doclist">${docHtml}</div>`:''}
  </div>`:docs.length>0?`<div class="dp-sec"><div class="ds-hdr"><i class="fas fa-paperclip"></i> Documents (${docs.length})</div><div class="doclist">${docHtml}</div></div>`:''}

  <div class="dp-sec">
    <div class="ds-hdr"><i class="fas fa-sticky-note"></i> Notes</div>
    ${isRO
      ?`<div style="font-size:.83rem;color:var(--tx2);line-height:1.6;white-space:pre-wrap;">${esc(p.notes||'‚Äî')}</div>`
      :`<textarea class="cmt-ta" oninput="dpUpd('${p.id}','notes',this.value)">${esc(p.notes||'')}</textarea>`}
  </div>
  <div class="dp-sec" style="padding:0;">
    <div class="ds-hdr" style="padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--brd);margin:0;">
      <span><i class="fas fa-comments" style="color:var(--blue);margin-right:6px;"></i>Comments <span id="tc-count-${p.id}" style="font-size:.72rem;color:var(--tx3);font-weight:400;">(${(threadedComments[p.id]||[]).filter(c=>!c.parentId).length})</span></span>
      ${notifications.filter(n=>n.userId===currentUser?.id&&!n.read&&n.projId===p.id).length?`<span class="nbadge" style="font-size:.68rem;">${notifications.filter(n=>n.userId===currentUser?.id&&!n.read&&n.projId===p.id).length} new</span>`:''}
    </div>
    <div class="tc-list" id="tc-list-${p.id}" style="max-height:340px;overflow-y:auto;"></div>
    <div class="tc-compose">
      <div class="tc-compose-av" style="background:${ROLE_COLORS[currentUser?.role]||'#64748b'};">${avInit(currentUser?.name||'?')}</div>
      <div class="tc-compose-right">
        <div id="tc-reply-banner-${p.id}" class="tc-reply-banner" style="display:none;">
          <span id="tc-reply-label-${p.id}">Replying to ‚Ä¶</span>
          <button style="background:none;border:none;cursor:pointer;color:var(--blue);font-size:.75rem;" onclick="cancelReply('${p.id}')"><i class="fas fa-times"></i></button>
        </div>
        <textarea class="tc-textarea" id="tc-inp-${p.id}"
          placeholder="Write a comment‚Ä¶ type @ to mention someone"
          oninput="onCmtInput(event,'${p.id}')"
          onkeydown="onCmtKey(event,'${p.id}')"
          onblur="setTimeout(hideMentionPop,160)"></textarea>
        <div class="tc-compose-foot">
          <span class="tc-hint">Enter&nbsp;=&nbsp;send &nbsp;¬∑&nbsp; Shift+Enter&nbsp;=&nbsp;new line &nbsp;¬∑&nbsp; @Name&nbsp;=&nbsp;mention</span>
          <button class="tc-send" onclick="postComment('${p.id}')"><i class="fas fa-paper-plane"></i> Send</button>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:8px;padding:10px 16px;border-top:1px solid var(--brd);flex-wrap:wrap;">
      ${can('canEdit')?`<button class="btn btn-ghost btn-sm" onclick="saveNow('${p.id}')"><i class="fas fa-save"></i> Save</button>`:''}
      ${can('canEdit')?`<button class="btn btn-ghost btn-sm" onclick="openEditProj('${p.id}')"><i class="fas fa-pen"></i> Edit</button>`:''}
      ${can('canDelete')?`<button class="btn btn-sm" style="background:var(--red-l);color:var(--red);" onclick="deleteProj('${p.id}')"><i class="fas fa-trash"></i> Delete</button>`:''}
    </div>
  </div>`;
  if(can('canAssign')){renderES(p.id);renderESRev(p.id);}
  // Render threaded comments (DOM must exist first)
  setTimeout(()=>{renderThreadList(p.id);loadCommentsFromDB(p.id);},0);
}
function renderES(projId){
  const q=(document.getElementById(`esrch-${projId}`)?.value||'').toLowerCase();
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const asgn=p.assignedEmployees||[];
  const am=aMap();
  let list=q?employees.filter(e=>e.name.toLowerCase().includes(q)||e.email.toLowerCase().includes(q)):employees;
  const cont=document.getElementById(`eres-${projId}`);if(!cont)return;
  if(!list.length){cont.innerHTML='<div style="padding:9px 11px;font-size:.76rem;color:var(--tx3);">No employees found</div>';return;}
  cont.innerHTML=list.slice(0,15).map(e=>{
    const alr=asgn.includes(e.id);
    const other=projects.filter(p2=>p2.id!==projId&&(p2.assignedEmployees||[]).includes(e.id));
    const otherRev=projects.filter(p2=>(p2.reviewEmployees||[]).includes(e.id));
    // Check if already a reviewer on THIS project
    const alreadyRevHere=(p.reviewEmployees||[]).includes(e.id);
    let sub='',sc='';
    if(alr){sub='Already assigned (annotation)';sc='taken';}
    else if(alreadyRevHere&&other.length>0){sub='‚ö† Reviewing this project + annotating others';sc='taken';}
    else if(alreadyRevHere){sub='‚ö† Already reviewing this project ‚Äî assigning will create a conflict';sc='warn';}
    else if(other.length>0){
      const reviewTag=otherRev.length?` | Reviewing: ${otherRev.map(x=>x.name).join(', ')}`:'';
      sub=`Annotating: ${other.map(x=>x.name).join(', ')}${reviewTag}`;sc='warn';}
    else if(otherRev.length>0){sub=`Reviewing: ${otherRev.map(x=>x.name).join(', ')}`;sc='warn';}
    else{sub=e.email;sc='';}
    return`<div class="e-row"><div><div class="e-name">${esc(e.name)} <span style="font-size:.6rem;color:var(--tx3);">${e.gender==='male'?'‚ôÇ':'‚ôÄ'}</span></div><div class="e-sub ${sc}">${esc(sub)}</div></div>
      ${alr?`<button class="btn btn-ghost btn-sm" onclick="rmAsgn('${projId}','${e.id}')">Remove</button>`:`<button class="btn btn-blue btn-sm" onclick="addAsgn('${projId}','${e.id}')">Assign</button>`}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ
async function addTag(projId,tagVal){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const tag=(tagVal||'').trim().toLowerCase().replace(/[^a-z0-9_-]/g,'');
  if(!tag){toast('Enter a valid tag','err');return;}
  if(!p.tags)p.tags=[];
  if(p.tags.includes(tag)){toast('Tag already exists','info');return;}
  p.tags.push(tag);
  const inp=document.getElementById(`tag-inp-${projId}`);if(inp)inp.value='';
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);toast(`Tag #${tag} added`,'ok');
}
async function removeTag(projId,tag){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  p.tags=(p.tags||[]).filter(t=>t!==tag);
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}

// ‚îÄ‚îÄ REVIEW EMPLOYEES ‚îÄ‚îÄ
function renderESRev(projId){
  const q=(document.getElementById(`esrch-rev-${projId}`)?.value||'').toLowerCase();
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const revs=p.reviewEmployees||[];
  let list=q?employees.filter(e=>e.name.toLowerCase().includes(q)||e.email.toLowerCase().includes(q)):employees;
  const cont=document.getElementById(`eres-rev-${projId}`);if(!cont)return;
  if(!list.length){cont.innerHTML='<div style="padding:9px 11px;font-size:.76rem;color:var(--tx3);">No employees found</div>';return;}
  cont.innerHTML=list.slice(0,15).map(e=>{
    const alr=revs.includes(e.id);
    const otherAnn=projects.filter(p2=>(p2.assignedEmployees||[]).includes(e.id));
    const otherRev=projects.filter(p2=>p2.id!==projId&&(p2.reviewEmployees||[]).includes(e.id));
    // Check if already an annotator on THIS project
    const alreadyAnnHere=(p.assignedEmployees||[]).includes(e.id);
    let revSub,revSc;
    if(alr){revSub='Already assigned (review)';revSc='taken';}
    else if(alreadyAnnHere&&otherRev.length>0){revSub='‚ö† Annotating this project + reviewing others';revSc='taken';}
    else if(alreadyAnnHere){revSub='‚ö† Already annotating this project ‚Äî assigning will create a conflict';revSc='warn';}
    else if(otherAnn.length){revSub='Annotating: '+otherAnn.map(x=>x.name).join(', ')+(otherRev.length?' | Reviewing: '+otherRev.map(x=>x.name).join(', '):'');revSc='warn';}
    else if(otherRev.length){revSub='Also reviewing: '+otherRev.map(x=>x.name).join(', ');revSc='warn';}
    else{revSub=e.email;revSc='';};
    return`<div class="e-row"><div><div class="e-name">${esc(e.name)} <span style="font-size:.6rem;color:var(--tx3);">${e.gender==='male'?'‚ôÇ':'‚ôÄ'}</span></div><div class="e-sub ${revSc}">${esc(revSub)}</div></div>
      ${alr?`<button class="btn btn-ghost btn-sm" onclick="rmRev('${projId}','${e.id}')">Remove</button>`:`<button class="btn btn-sm" style="background:var(--yel-l);color:var(--yellow);border:1px solid var(--yellow);" onclick="addRev('${projId}','${e.id}')">Assign Review</button>`}
    </div>`;
  }).join('');
}
async function addRev(projId,empId){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  if(!p.reviewEmployees)p.reviewEmployees=[];
  if(p.reviewEmployees.includes(empId)){toast('Already assigned for review','info');return;}
  p.reviewEmployees.push(empId);
  const empName=getEmp(empId).name;
  toast(`${empName} assigned for review ‚úì`,'ok');
  logActivity('assign',projId,(projects.find(x=>x.id===projId)||{name:'?'}).name,`${empName} assigned as reviewer`);
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}
async function rmRev(projId,empId){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const empName=getEmp(empId).name;
  p.reviewEmployees=(p.reviewEmployees||[]).filter(id=>id!==empId);
  toast('Reviewer removed','info');
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}

async function addAsgn(projId,empId){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  if((p.assignedEmployees||[]).includes(empId)){toast('Already assigned','info');return;}
  if(!p.assignedEmployees)p.assignedEmployees=[];
  p.assignedEmployees.push(empId);
  const empName=getEmp(empId).name;
  toast(`${empName} assigned ‚úì`,'ok');
  logActivity('assign',projId,(projects.find(x=>x.id===projId)||{name:'?'}).name,`${empName} assigned to this project`);
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}
async function rmAsgn(projId,empId){
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const empName=getEmp(empId).name;
  p.assignedEmployees=(p.assignedEmployees||[]).filter(id=>id!==empId);
  toast('Removed','info');
  logActivity('assign',projId,(projects.find(x=>x.id===projId)||{name:'?'}).name,`${empName} removed from this project`);
  if(openProjId===projId)renderDPBody(p);
  renderProjects();await saveProjDB(p);
}
async function dpField(id,field,val){
  const p=projects.find(x=>x.id===id);if(!p)return;
  p[field]=Math.max(0,parseInt(val)||0);
  if(openProjId===id)renderDPBody(p);
  renderProjects();await saveProjDB(p);
  logActivity('edit',id,(projects.find(x=>x.id===id)||{name:'?'}).name,`${field==='total'?'Total images':field==='annotated'?'Annotated count':'Reviewed count'} updated to ${p[field]}`);
}
let _dpSaveTimers={};
async function dpUpd(id,field,val){
  const p=projects.find(x=>x.id===id);if(!p)return;
  const prevVal=p[field];
  // Auto-unassign BEFORE updating the field, so markCompleted sees old status
  if(field==='kanbanStatus'&&val==='done'&&prevVal!=='done'){
    await markCompleted(p);
  }
  p[field]=val;
  if(field==='kanbanStatus'&&val==='done'&&prevVal!=='done'){
    // Re-render the detail panel so assigned lists clear immediately
    renderDPBody(p);
  }
  renderProjects();
  clearTimeout(_dpSaveTimers[id+'_'+field]);
  _dpSaveTimers[id+'_'+field]=setTimeout(async()=>{
    await saveProjDB(p);
    logActivity('edit',id,(projects.find(x=>x.id===id)||{name:'?'}).name,field+' updated to '+val);
  },1000);
}
async function saveNow(id){const p=projects.find(x=>x.id===id);if(!p)return;await saveProjDB(p);toast('Saved ‚úì','ok');}

function activityLogs(){}
function saveActivityLogs(){}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleUpload(projId,input){
  const files=[...input.files];if(!files.length)return;
  if(!projDocs[projId])projDocs[projId]=[];
  let loaded=0;
  files.forEach(f=>{
    const rdr=new FileReader();
    rdr.onload=e=>{projDocs[projId].push({name:f.name,size:fmtSize(f.size),dataUrl:e.target.result});loaded++;if(loaded===files.length){saveDocsLocal();const p=projects.find(x=>x.id===projId);if(p&&openProjId===projId)renderDPBody(p);renderProjects();}};
    rdr.readAsDataURL(f);
  });
  toast(`${files.length} file(s) uploaded`,'ok');
}
function rmDoc(projId,idx){if(!projDocs[projId])return;projDocs[projId].splice(idx,1);saveDocsLocal();const p=projects.find(x=>x.id===projId);if(p&&openProjId===projId)renderDPBody(p);renderProjects();toast('File removed','info');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE / MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function deleteProj(id){
  if(!confirm('Delete this project?'))return;
  const p=projects.find(x=>x.id===id);
  const pName=p?p.name:'project';
  logActivity('delete',id,pName,'Project deleted');
  projects=projects.filter(x=>x.id!==id);delete projDocs[id];saveDocsLocal();
  closeDP();toast('Deleted','info');renderProjects();await delProjDB(id);
}

function tglTgtField(prefix){document.getElementById(`${prefix}-tgtFw`).classList.toggle('show',document.getElementById(`${prefix}-tgtOn`).checked);}

function openNewProj(){
  editProjId=null;document.getElementById('pMTtl').textContent='New Project';
  ['name','by','client','link'].forEach(f=>document.getElementById(`np-${f}`).value='');
  ['start','dead'].forEach(f=>document.getElementById(`np-${f}`).value='');
  document.getElementById('np-total').value='1000';document.getElementById('np-ann').value='0';document.getElementById('np-rev').value='0';
  document.getElementById('np-pri').value='medium';document.getElementById('np-status').value='todo';
  document.getElementById('np-notes').value='';document.getElementById('np-tgtOn').checked=false;document.getElementById('np-target').value='';document.getElementById('np-tgtFw').classList.remove('show');
  document.getElementById('projOvl').classList.add('open');
}
function openEditProj(id){
  const p=projects.find(x=>x.id===id);if(!p)return;
  editProjId=id;document.getElementById('pMTtl').textContent='Edit Project';
  document.getElementById('np-name').value=p.name;document.getElementById('np-client').value=p.client||'';document.getElementById('np-link').value=p.labellink||'';document.getElementById('np-by').value=p.assignedby||'';
  document.getElementById('np-start').value=p.startdate||'';document.getElementById('np-dead').value=p.deadline||'';
  document.getElementById('np-total').value=p.total;document.getElementById('np-ann').value=p.annotated;document.getElementById('np-rev').value=p.reviewed;
  document.getElementById('np-pri').value=p.priority||'medium';document.getElementById('np-status').value=p.kanbanStatus||'todo';
  document.getElementById('np-notes').value=p.notes||'';
  const ht=!!p.hasTarget;document.getElementById('np-tgtOn').checked=ht;document.getElementById('np-target').value=p.dailyTarget||'';document.getElementById('np-tgtFw').classList.toggle('show',ht);
  document.getElementById('projOvl').classList.add('open');
}
function closeProjModal(){document.getElementById('projOvl').classList.remove('open');}
function closeProjOvlBg(e){if(e.target===document.getElementById('projOvl'))closeProjModal();}
async function saveProject(){
  const name=document.getElementById('np-name').value.trim();
  if(!name){toast('Name required','err');return;}
  const ht=document.getElementById('np-tgtOn').checked;
  const data={name,client:document.getElementById('np-client').value.trim(),labellink:document.getElementById('np-link').value.trim(),priority:document.getElementById('np-pri').value,assignedby:document.getElementById('np-by').value.trim(),
    startdate:document.getElementById('np-start').value,deadline:document.getElementById('np-dead').value,
    total:parseInt(document.getElementById('np-total').value)||0,annotated:parseInt(document.getElementById('np-ann').value)||0,reviewed:parseInt(document.getElementById('np-rev').value)||0,
    notes:document.getElementById('np-notes').value.trim(),
    kanbanStatus:document.getElementById('np-status').value,
    hasTarget:ht,dailyTarget:ht?(parseInt(document.getElementById('np-target').value)||null):null};
  let proj;
  if(editProjId){
    const idx=projects.findIndex(p=>p.id===editProjId);
    if(idx>-1){
      const prev=projects[idx];
      const wasNotDone=prev.kanbanStatus!=='done';
      const becomingDone=data.kanbanStatus==='done'&&wasNotDone;
      // Unassign BEFORE overwriting project data so markCompleted sees old status
      if(becomingDone) await markCompleted(prev);
      Object.assign(projects[idx],data);
      proj=projects[idx];
      // Preserve the cleared assignments from markCompleted if project just completed
      if(becomingDone){proj.assignedEmployees=[];proj.reviewEmployees=[];}
      toast('Updated ‚úì','ok');
      logActivity('edit',proj.id,proj.name,'Project details updated');
    }
  } else{
    proj={id:uid(),assignedEmployees:[],reviewEmployees:[],tags:[],comments:'',...data};
    projects.push(proj);
    toast('Created ‚úì','ok');
    logActivity('create',proj.id,proj.name,`Project created`);
  }
  closeProjModal();renderProjects();if(proj)await saveProjDB(proj);
  if(openProjId===proj?.id){const p2=projects.find(x=>x.id===openProjId);if(p2)renderDPBody(p2);}
}

function openEmpModal(id=null){
  editEmpId=id;
  if(id){const e=employees.find(x=>x.id===id);if(!e)return;document.getElementById('eMTtl').textContent='Edit Employee';document.getElementById('fe-name').value=e.name;document.getElementById('fe-email').value=e.email;document.getElementById('fe-gender').value=e.gender;}
  else{document.getElementById('eMTtl').textContent='Add Employee';['fe-name','fe-email'].forEach(f=>document.getElementById(f).value='');document.getElementById('fe-gender').value='female';}
  document.getElementById('empOvl').classList.add('open');
}
function closeEmpModal(){document.getElementById('empOvl').classList.remove('open');}
function closeEmpOvlBg(e){if(e.target===document.getElementById('empOvl'))closeEmpModal();}
function saveEmployee(){
  const name=document.getElementById('fe-name').value.trim();const email=document.getElementById('fe-email').value.trim();const gender=document.getElementById('fe-gender').value;
  if(!name){toast('Name required','err');return;}if(!email){toast('Email required','err');return;}
  if(editEmpId){const idx=employees.findIndex(e=>e.id===editEmpId);if(idx>-1){employees[idx]={...employees[idx],name,email,gender};toast('Updated ‚úì','ok');}}
  else{employees.push({id:'e_'+Date.now(),name,email,gender});toast('Added ‚úì','ok');}
  saveEmpsLocal();closeEmpModal();renderEmps();renderStats();
}
function delEmp(id){
  const emp=employees.find(e=>e.id===id);
  const name=emp?.name||'this employee';
  if(!confirm('Remove '+name+'? They will be unassigned from all projects.'))return;
  employees=employees.filter(e=>e.id!==id);
  projects.forEach(p=>{
    p.assignedEmployees=(p.assignedEmployees||[]).filter(e=>e!==id);
    p.reviewEmployees=(p.reviewEmployees||[]).filter(e=>e!==id);
  });
  await saveEmpsToDB();renderEmps();renderProjects();renderStats();toast(name+' removed','info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMPLOYEES TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEmps(){
  const am=aMap();const cc=conflicts();
  const q=(document.getElementById('empSearch')?.value||'').toLowerCase();
  const list=q?employees.filter(e=>e.name.toLowerCase().includes(q)||e.email.toLowerCase().includes(q)):employees;
  const ecb=document.getElementById('empCBanner');
  if(cc.length>0){
    const ma=multiAnnotators();const dr=dualRoleIds();
    const parts=[];
    const maNames=[...ma].map(id=>getEmp(id).name);
    const drNames=[...dr].filter(id=>!ma.has(id)).map(id=>getEmp(id).name);
    if(maNames.length)parts.push('Multi-project: '+maNames.join(', '));
    if(drNames.length)parts.push('Annotating & reviewing: '+drNames.join(', '));
    ecb.style.display='flex';document.getElementById('ecTxt').textContent='‚ö† Conflicts ‚Äî '+parts.join(' | ');
  }
  else ecb.style.display='none';
  document.getElementById('empTbody').innerHTML=list.map((e,i)=>{
    const cnt=am.get(e.id)||0;const projs=projects.filter(p=>(p.assignedEmployees||[]).includes(e.id));
    const revProjs=projects.filter(p=>(p.reviewEmployees||[]).includes(e.id));
    const isMultiAnn=cnt>1;
    const isRev=revProjs.length>0;
    const isAnn=cnt>0;
    const isDual=isAnn&&isRev;
    let sc,st;
    if(isMultiAnn&&isRev){sc='st-c';st=`‚ö† Conflict (${cnt} projects + Reviewing)`;}
    else if(isMultiAnn){sc='st-c';st=`‚ö† ${cnt} Projects (Conflict)`;}
    else if(isDual){sc='st-c';st='Annotating & Reviewing';}
    else if(isAnn){sc='st-a';st='Annotating';}
    else if(isRev){sc='st-a';st='Reviewing';}
    else{sc='st-f';st='Free';}
    return`<tr><td style="color:var(--tx3);font-size:.7rem;">${i+1}</td><td><strong>${esc(e.name)}</strong></td><td style="color:var(--tx2);font-size:.76rem;">${esc(e.email)}</td>
      <td><span class="${e.gender==='male'?'gm':'gf'}">${e.gender==='male'?'‚ôÇ Male':'‚ôÄ Female'}</span></td>
      <td><span class="${sc}">${st}</span></td>
      <td style="font-size:.73rem;color:var(--tx2);">${projs.map(p=>esc(p.name)).join(', ')||'<span style="color:var(--tx3);">‚Äî</span>'}</td>
      <td style="font-size:.73rem;color:var(--yellow);">${revProjs.map(p=>esc(p.name)).join(', ')||'<span style="color:var(--tx3);">‚Äî</span>'}</td>
      <td><button class="iBtn del" onclick="delEmp('${e.id}')" title="Remove employee and unassign from all projects"><i class="fas fa-trash"></i></button></td></tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWorkload(){
  const am=aMap();
  const revMap=new Map();
  projects.forEach(p=>(p.reviewEmployees||[]).forEach(id=>revMap.set(id,(revMap.get(id)||0)+1)));
  const allActiveIds=new Set([...am.keys(),...revMap.keys()]);
  const q=(document.getElementById('wlSearch')?.value||'').toLowerCase();

  // ‚îÄ‚îÄ Summary stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const annOnly=[...allActiveIds].filter(id=>am.get(id)>0&&!(revMap.get(id)>0));
  const revOnly=[...allActiveIds].filter(id=>!(am.get(id)>0)&&revMap.get(id)>0);
  const dual=[...dualRoleIds()];
  const multiAnn=[...multiAnnotators()].filter(id=>!dual.includes(id));
  const conflicts2=dual.length+multiAnn.length;
  const free=employees.filter(e=>!allActiveIds.has(e.id));

  document.getElementById('wlSummaryGrid').innerHTML=[
    {lbl:'Total Employees',val:employees.length,sub:'in roster',cls:'tot',icon:'fa-users'},
    {lbl:'Annotating',val:annOnly.length,sub:'annotation only',cls:'ann',icon:'fa-pen-nib'},
    {lbl:'Reviewing',val:revOnly.length,sub:'review only',cls:'rev',icon:'fa-eye'},
    {lbl:'Both Roles',val:dual.length,sub:'ann + review conflict',cls:'dual',icon:'fa-exclamation-triangle'},
    {lbl:'Multi-Project',val:multiAnn.length,sub:'overloaded annotators',cls:'dual',icon:'fa-layer-group'},
    {lbl:'Free',val:free.length,sub:'no current assignment',cls:'free',icon:'fa-check-circle'},
  ].map(s=>`<div class="wl-sc ${s.cls}">
    <div class="wl-sc-lbl"><i class="fas ${s.icon}" style="margin-right:3px;"></i>${s.lbl}</div>
    <div class="wl-sc-val">${s.val}</div>
    <div class="wl-sc-sub">${s.sub}</div>
  </div>`).join('');

  // ‚îÄ‚îÄ Per-project team cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const priColors3={high:'var(--red)',medium:'var(--yellow)',low:'var(--green)'};
  const projCards=projects.map(p=>{
    const annEmps=(p.assignedEmployees||[]).map(id=>({emp:getEmp(id),role:'ann',isDual:(p.reviewEmployees||[]).includes(id)}));
    const revEmps=(p.reviewEmployees||[]).filter(id=>!(p.assignedEmployees||[]).includes(id)).map(id=>({emp:getEmp(id),role:'rev',isDual:false}));
    const members=[...annEmps,...revEmps];
    const total=members.length;
    const conflictCount=annEmps.filter(x=>x.isDual).length;
    const T=+p.total||0,A=+p.annotated||0;
    const pBg={high:'#fee2e2',medium:'#fef3c7',low:'#dcfce7'}[p.priority];
    const pClr={high:'#dc2626',medium:'#d97706',low:'#16a34a'}[p.priority];
    return`<div class="wl-proj-card">
      <div class="wl-proj-hdr" style="background:${pBg}20;">
        <div style="width:8px;height:8px;border-radius:50%;background:${pClr};flex-shrink:0;"></div>
        <div class="wl-proj-name" title="${esc(p.name)}">${esc(p.name)}</div>
        <span class="wl-proj-count" style="background:${pBg};color:${pClr};">${total} member${total!==1?'s':''}</span>
        ${conflictCount>0?`<span class="wl-proj-count" style="background:#fee2e2;color:#dc2626;">‚ö† ${conflictCount} dual</span>`:''}
      </div>
      <div style="padding:6px 14px 3px;display:flex;gap:8px;align-items:center;border-bottom:1px solid var(--brd);">
        <div style="flex:1;">
          <div style="font-size:.6rem;color:var(--tx3);margin-bottom:2px;">Annotation progress</div>
          <div class="pbar" style="height:5px;"><div class="pf pf-a" style="width:${T>0?Math.round(A/T*100):0}%"></div></div>
        </div>
        <span style="font-size:.68rem;font-weight:700;color:var(--blue);min-width:32px;text-align:right;">${T>0?Math.round(A/T*100):0}%</span>
      </div>
      <div class="wl-proj-body">
        ${members.length===0
          ?'<div class="wl-empty-proj">No team members assigned</div>'
          :members.map(({emp,role,isDual})=>{
            const bg=emp.gender==='male'?'var(--blue)':'var(--purple)';
            const roleCls=isDual?'wl-role-dual':role==='ann'?'wl-role-ann':'wl-role-rev';
            const roleTxt=isDual?'Ann & Rev':role==='ann'?'Annotating':'Reviewing';
            return`<div class="wl-member-row">
              <div class="wl-member-av" style="background:${bg};">${initials(emp.name)}</div>
              <div class="wl-member-name">${esc(emp.name)}</div>
              <span class="wl-role-pill ${roleCls}">${roleTxt}</span>
            </div>`;
          }).join('')
        }
      </div>
    </div>`;
  });
  document.getElementById('wlProjGrid').innerHTML=projCards.join('')||'<div class="empty-st"><i class="fas fa-folder-open"></i><p>No projects yet.</p></div>';

  // ‚îÄ‚îÄ Client / Task breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Group projects by client name (blank client ‚Üí "Untagged")
  const clientMap=new Map();
  projects.forEach(p=>{
    const key=p.client&&p.client.trim()?p.client.trim():'(No Client / Task)';
    if(!clientMap.has(key))clientMap.set(key,{projects:[],empSet:new Set(),annSet:new Set(),revSet:new Set(),dualSet:new Set()});
    const g=clientMap.get(key);
    g.projects.push(p);
    const ann=p.assignedEmployees||[];
    const rev=p.reviewEmployees||[];
    ann.forEach(id=>{g.empSet.add(id);g.annSet.add(id);});
    rev.forEach(id=>{g.empSet.add(id);g.revSet.add(id);});
    ann.filter(id=>rev.includes(id)).forEach(id=>g.dualSet.add(id));
  });

  const clientCards=[...clientMap.entries()].sort((a,b)=>b[1].empSet.size-a[1].empSet.size).map(([clientName,g])=>{
    const totalPeople=g.empSet.size;
    const annOnly=[...g.annSet].filter(id=>!g.revSet.has(id));
    const revOnly=[...g.revSet].filter(id=>!g.annSet.has(id));
    const dual=[...g.dualSet];
    const isUntagged=clientName==='(No Client / Task)';

    // Unique employees with their roles across all projects in this client
    const empRoles=new Map();
    g.projects.forEach(p=>{
      (p.assignedEmployees||[]).forEach(id=>{
        if(!empRoles.has(id))empRoles.set(id,{ann:new Set(),rev:new Set()});
        empRoles.get(id).ann.add(p.name);
      });
      (p.reviewEmployees||[]).forEach(id=>{
        if(!empRoles.has(id))empRoles.set(id,{ann:empRoles.get(id)?.ann||new Set(),rev:new Set(),...(empRoles.get(id)||{})});
        if(!empRoles.has(id))empRoles.set(id,{ann:new Set(),rev:new Set()});
        empRoles.get(id).rev.add(p.name);
      });
    });

    const memberRows=[...empRoles.entries()].map(([id,roles])=>{
      const e=getEmp(id);
      const isAnn=roles.ann.size>0;
      const isRev=roles.rev.size>0;
      const isDual2=isAnn&&isRev;
      const bg=e.gender==='male'?'var(--blue)':'var(--purple)';
      const roleCls=isDual2?'wl-role-dual':isAnn?'wl-role-ann':'wl-role-rev';
      const roleTxt=isDual2?'Ann & Rev':isAnn?'Annotating':'Reviewing';
      const projTip=[...new Set([...roles.ann,...roles.rev])].join(', ');
      return`<div class="wl-member-row">
        <div class="wl-member-av" style="background:${bg};">${initials(e.name)}</div>
        <div class="wl-member-name" title="${esc(projTip)}">${esc(e.name)}</div>
        <span class="wl-role-pill ${roleCls}">${roleTxt}</span>
      </div>`;
    }).join('');

    return`<div class="wl-proj-card">
      <div class="wl-proj-hdr" style="background:${isUntagged?'var(--sur2)':'var(--blue)10'};">
        <i class="fas fa-building" style="color:${isUntagged?'var(--tx3)':'var(--blue)'};font-size:.8rem;flex-shrink:0;"></i>
        <div class="wl-proj-name" title="${esc(clientName)}" style="color:${isUntagged?'var(--tx3)':''};">${esc(clientName)}</div>
        <span class="wl-proj-count" style="background:var(--blue)22;color:var(--blue);">${totalPeople} people</span>
        <span class="wl-proj-count" style="background:var(--sur2);color:var(--tx2);">${g.projects.length} proj</span>
        ${dual.length>0?`<span class="wl-proj-count" style="background:#fee2e2;color:#dc2626;">‚ö† ${dual.length} dual</span>`:''}
      </div>
      <div style="padding:5px 14px 3px;display:flex;gap:14px;border-bottom:1px solid var(--brd);">
        <span style="font-size:.67rem;color:var(--blue);font-weight:600;"><i class="fas fa-pen-nib" style="margin-right:3px;"></i>${annOnly.length} annotating</span>
        <span style="font-size:.67rem;color:var(--yellow);font-weight:600;"><i class="fas fa-eye" style="margin-right:3px;"></i>${revOnly.length} reviewing</span>
        ${dual.length>0?`<span style="font-size:.67rem;color:#dc2626;font-weight:600;"><i class="fas fa-exclamation-triangle" style="margin-right:3px;"></i>${dual.length} both</span>`:''}
      </div>
      <div class="wl-proj-body">
        <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--tx3);margin-bottom:5px;">Projects: ${g.projects.map(p=>`<span style="color:var(--tx2);">${esc(p.name)}</span>`).join(', ')}</div>
        ${memberRows||'<div class="wl-empty-proj">No members assigned</div>'}
      </div>
    </div>`;
  });

  document.getElementById('wlClientGrid').innerHTML=clientCards.join('')||'<div class="empty-st"><i class="fas fa-building"></i><p>No client data yet.</p></div>';

  // ‚îÄ‚îÄ Employee rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const active=[...allActiveIds].map(id=>[id,am.get(id)||0]).sort((a,b)=>b[1]-a[1]);
  const allForList=q
    ?employees.filter(e=>e.name.toLowerCase().includes(q)||e.email.toLowerCase().includes(q))
    :employees;
  const max=Math.max(...active.map(([,c])=>c),1);

  if(!allForList.length){
    document.getElementById('wlList').innerHTML='<div class="empty-st"><i class="fas fa-search"></i><p>No employees match.</p></div>';
    return;
  }

  document.getElementById('wlList').innerHTML=allForList.map(e=>{
    const cnt=am.get(e.id)||0;
    const annProjs=projects.filter(p=>(p.assignedEmployees||[]).includes(e.id));
    const revProjs=projects.filter(p=>(p.reviewEmployees||[]).includes(e.id));
    const isMultiAnn=cnt>1;
    const isDual2=cnt>0&&revProjs.length>0;
    const isC=isMultiAnn||isDual2;
    const bar=Math.round((cnt/max)*100);
    let statusTxt,statusColor;
    if(isMultiAnn&&isDual2){statusTxt=`‚ö† ${cnt} ann. + reviewing`;statusColor='#dc2626';}
    else if(isMultiAnn){statusTxt=`‚ö† ${cnt} projects (conflict)`;statusColor='#dc2626';}
    else if(isDual2){statusTxt='‚ö† Annotating & Reviewing';statusColor='#dc2626';}
    else if(revProjs.length>0&&cnt===0){statusTxt='Reviewing only';statusColor='var(--yellow)';}
    else if(cnt===1){statusTxt='Annotating';statusColor='var(--blue)';}
    else{statusTxt='Free';statusColor='var(--green)';}
    const allProjNames=[...new Set([...annProjs.map(p=>'[Ann] '+p.name),...revProjs.map(p=>'[Rev] '+p.name)])];
    return`<div class="wl-row">
      <span class="wl-n">${esc(e.name)}</span>
      <span class="wl-p">${allProjNames.length?allProjNames.map(esc).join(' ¬∑ '):'<span style="color:var(--tx3);font-style:italic;">Free ‚Äî no assignments</span>'}</span>
      <div class="wl-bw">
        <div class="pbar" style="height:7px;"><div class="pf ${isC?'':'pf-a'}" style="width:${bar}%;${isC?'background:#dc2626':''}"></div></div>
        <div style="font-size:.64rem;color:${statusColor};margin-top:2px;text-align:right;">${statusTxt}</div>
      </div>
    </div>`;
  }).join('');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKLOAD EXPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportWorkloadCSV(){
  const am=aMap();
  const revMap=new Map();
  projects.forEach(p=>(p.reviewEmployees||[]).forEach(id=>revMap.set(id,(revMap.get(id)||0)+1)));
  const dual=dualRoleIds();
  const multiAnn=multiAnnotators();

  const hdr=['Employee','Email','Gender','Ann.Projects','Rev.Projects','Status','Conflict','Annotation Projects','Review Projects'];
  const rows=employees.map(e=>{
    const cnt=am.get(e.id)||0;
    const annProjs=projects.filter(p=>(p.assignedEmployees||[]).includes(e.id));
    const revProjs=projects.filter(p=>(p.reviewEmployees||[]).includes(e.id));
    const isDual=dual.has(e.id);
    const isMulti=multiAnn.has(e.id);
    let status;
    if(isMulti&&isDual)status='CONFLICT: Multi-Ann + Reviewing';
    else if(isMulti)status='CONFLICT: Multiple Annotation Projects';
    else if(isDual)status='CONFLICT: Annotating & Reviewing';
    else if(cnt>0&&revProjs.length===0)status='Annotating';
    else if(cnt===0&&revProjs.length>0)status='Reviewing';
    else if(cnt===0&&revProjs.length===0)status='Free';
    else status='Active';
    const conflict=isDual||isMulti?'YES':'NO';
    return[`"${e.name}"`,`"${e.email}"`,e.gender,cnt,revProjs.length,`"${status}"`,conflict,
      `"${annProjs.map(p=>p.name).join('; ')}"`,`"${revProjs.map(p=>p.name).join('; ')}"`].join(',');
  });

  // Add project summary rows
  const projRows=['',' PROJECT TEAM SUMMARY','Project,Total Members,Annotators,Reviewers,Dual Role,Annotation%'];
  projects.forEach(p=>{
    const ann=(p.assignedEmployees||[]).length;
    const rev=(p.reviewEmployees||[]).length;
    const dualCount=(p.assignedEmployees||[]).filter(id=>(p.reviewEmployees||[]).includes(id)).length;
    const T=+p.total||0,A=+p.annotated||0;
    projRows.push([`"${p.name}"`,ann+rev-dualCount,ann,rev,dualCount,pct(A,T)+'%'].join(','));
  });

  const csv=[hdr.join(','),...rows,...projRows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='camcom_workload.csv';a.click();URL.revokeObjectURL(url);
  toast('Workload CSV exported','ok');
}

// ‚îÄ‚îÄ Workload PDF modal controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _wlPdfMode='client';
function openWLPdfModal(){
  _wlPdfMode='client';
  selectWLOpt('client');
  const ovl=document.getElementById('wlPdfOvl');
  ovl.style.display='flex';requestAnimationFrame(()=>ovl.classList.add('open'));
}
function closeWLPdfModal(){
  const ovl=document.getElementById('wlPdfOvl');
  ovl.classList.remove('open');
  setTimeout(()=>ovl.style.display='none',200);
}
function selectWLOpt(mode){
  _wlPdfMode=mode;
  ['client','project','both'].forEach(m=>{
    document.getElementById('wlopt-'+m).classList.toggle('selected',m===mode);
  });
}
function generateWLPdf(){
  closeWLPdfModal();
  setTimeout(()=>exportWorkloadPDF(_wlPdfMode),250);
}

function exportWorkloadPDF(mode='both'){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'landscape',format:'a4',unit:'mm'});
  const W=297,H=210,MARGIN=14,CW=W-2*MARGIN;
  const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
  const am=aMap();
  const revMap=new Map();
  projects.forEach(p=>(p.reviewEmployees||[]).forEach(id=>revMap.set(id,(revMap.get(id)||0)+1)));
  const allIds=new Set([...am.keys(),...revMap.keys()]);
  const dual=dualRoleIds();
  const multiAnn=multiAnnotators();

  const annOnly=[...allIds].filter(id=>am.get(id)>0&&!revMap.get(id));
  const revOnly=[...allIds].filter(id=>!am.get(id)&&revMap.get(id)>0);
  const dualList=[...dual];
  const multiOnly=[...multiAnn].filter(id=>!dual.has(id));
  const freeList=employees.filter(e=>!allIds.has(e.id));

  const modeLbl={client:'By Client / Task',project:'By Project',both:'By Client / Task & By Project'}[mode];

  // ‚îÄ‚îÄ Footer (defined first so helpers can call it) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function drawWLFooter(){
    const pg=doc.internal.getNumberOfPages();
    for(let i=1;i<=pg;i++){
      doc.setPage(i);
      doc.setFillColor(15,23,42);doc.rect(0,H-10,W,10,'F');
      doc.setFillColor(223,30,38);doc.rect(0,H-10,6,10,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(6);doc.setTextColor(255,255,255);
      doc.text('CamCom',MARGIN,H-4.5);
      doc.setFont('helvetica','normal');doc.setTextColor(100,116,139);
      doc.text('Team Workload Report  ‚Ä¢  '+modeLbl+'  ‚Ä¢  Confidential',MARGIN+18,H-4.5);
      doc.text('Page '+i+' of '+pg,W/2,H-4.5,{align:'center'});
      doc.text('Generated: '+today,W-MARGIN,H-4.5,{align:'right'});
    }
  }

  // ‚îÄ‚îÄ Page break helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function newPage(label){
    drawWLFooter();
    doc.addPage();
    doc.setFillColor(15,23,42);doc.rect(0,0,W,14,'F');
    doc.setFillColor(223,30,38);doc.rect(0,0,6,14,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(8);doc.setTextColor(255,255,255);
    doc.text('CamCom ‚Äî Team Workload Report: '+label,MARGIN+2,9);
    return 20;
  }

  // ‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  doc.setFillColor(15,23,42);doc.rect(0,0,W,24,'F');
  doc.setFillColor(223,30,38);doc.rect(0,0,6,24,'F');
  doc.setFillColor(223,30,38);doc.roundedRect(12,4,16,16,2,2,'F');
  doc.setDrawColor(255,255,255);doc.setLineWidth(0.2);doc.line(14,13,26,13);
  doc.setTextColor(255,255,255);doc.setFont('helvetica','bold');doc.setFontSize(5.5);
  doc.text('CAM',20,10,{align:'center'});doc.text('COM',20,16.5,{align:'center'});
  doc.setFont('helvetica','bold');doc.setFontSize(14);doc.setTextColor(255,255,255);
  doc.text('CamCom ‚Äî Team Workload Report',32,12);
  doc.setFont('helvetica','normal');doc.setFontSize(7.5);doc.setTextColor(148,163,184);
  doc.text(modeLbl,32,18);
  doc.setTextColor(203,213,225);doc.setFontSize(7);
  doc.text(today,W-MARGIN,10,{align:'right'});
  doc.text('Prepared by: '+(currentUser?.name||'‚Äî'),W-MARGIN,16,{align:'right'});

  // ‚ïê‚ïê SUMMARY STAT BOXES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let y=30;
  const summStats=[
    {l:'Total Employees',v:employees.length,c:[124,58,237]},
    {l:'Annotating',v:annOnly.length,c:[37,99,235]},
    {l:'Reviewing',v:revOnly.length,c:[217,119,6]},
    {l:'Dual Role',v:dualList.length,c:[220,38,38]},
    {l:'Multi-Project',v:multiOnly.length,c:[220,38,38]},
    {l:'Free',v:freeList.length,c:[22,163,74]},
    {l:'Total Projects',v:projects.length,c:[15,23,42]},
  ];
  const sbW=(CW-(summStats.length-1)*3)/summStats.length,sbH=20;
  summStats.forEach((s,i)=>{
    const bx=MARGIN+i*(sbW+3);
    doc.setFillColor(241,245,249);doc.setDrawColor(226,232,240);doc.setLineWidth(0.3);
    doc.roundedRect(bx,y,sbW,sbH,2,2,'FD');
    doc.setFillColor(...s.c);doc.rect(bx,y,sbW,2.5,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(12);doc.setTextColor(...s.c);
    doc.text(String(s.v),bx+sbW/2,y+12,{align:'center'});
    doc.setFont('helvetica','normal');doc.setFontSize(5.5);doc.setTextColor(100,116,139);
    doc.text(s.l.toUpperCase(),bx+sbW/2,y+18,{align:'center'});
  });
  y+=sbH+8;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CLIENT / TASK SECTION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function drawClientSection(startY){
    let ly=startY;

    // Section header
    doc.setFillColor(88,28,135);doc.rect(MARGIN,ly,CW,8,'F');
    doc.setTextColor(255,255,255);doc.setFont('helvetica','bold');doc.setFontSize(8.5);
    doc.text('TEAM LOADING BY CLIENT / TASK',MARGIN+4,ly+5.5);
    doc.setFont('helvetica','normal');doc.setFontSize(7);doc.setTextColor(216,180,254);
    doc.text('Employees grouped by client or task name across all their projects',MARGIN+4+80,ly+5.5);
    ly+=12;

    // Build client map
    const clientMap=new Map();
    projects.forEach(p=>{
      const key=p.client&&p.client.trim()?p.client.trim():'(No Client / Task)';
      if(!clientMap.has(key))clientMap.set(key,{projects:[],empRoles:new Map()});
      const g=clientMap.get(key);
      g.projects.push(p);
      (p.assignedEmployees||[]).forEach(id=>{
        if(!g.empRoles.has(id))g.empRoles.set(id,{ann:new Set(),rev:new Set()});
        g.empRoles.get(id).ann.add(p.name);
      });
      (p.reviewEmployees||[]).forEach(id=>{
        if(!g.empRoles.has(id))g.empRoles.set(id,{ann:g.empRoles.get(id)?.ann||new Set(),rev:new Set(),...(g.empRoles.get(id)||{})});
        if(!g.empRoles.has(id))g.empRoles.set(id,{ann:new Set(),rev:new Set()});
        g.empRoles.get(id).rev.add(p.name);
      });
    });

    // Sort by employee count desc
    const sorted=[...clientMap.entries()].sort((a,b)=>b[1].empRoles.size-a[1].empRoles.size);

    // Table header
    const cCols=[{h:'Client / Task',w:55},{h:'Projects',w:18},{h:'People',w:14},{h:'Annotating',w:18},{h:'Reviewing',w:18},{h:'Both Roles',w:18},{h:'Team Members',w:0}];
    const cUsed=cCols.slice(0,-1).reduce((s,c)=>s+c.w,0);
    cCols[cCols.length-1].w=CW-cUsed-4;

    doc.setFillColor(74,4,78);doc.rect(MARGIN,ly,CW,7,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(6.5);doc.setTextColor(233,213,255);
    let cx2=MARGIN+2;
    cCols.forEach(c=>{doc.text(c.h,cx2,ly+4.8);cx2+=c.w;});
    ly+=7;

    sorted.forEach(([clientName,g],i)=>{
      const isUntagged=clientName==='(No Client / Task)';
      const empRoles=g.empRoles;
      const annOnly2=[...empRoles.entries()].filter(([,r])=>r.ann.size>0&&r.rev.size===0);
      const revOnly2=[...empRoles.entries()].filter(([,r])=>r.ann.size===0&&r.rev.size>0);
      const dual2=[...empRoles.entries()].filter(([,r])=>r.ann.size>0&&r.rev.size>0);
      const totalPpl=empRoles.size;
      const memberNames=[...empRoles.keys()].map(id=>{
        const e=getEmp(id);const r=empRoles.get(id);
        const tag=r.ann.size>0&&r.rev.size>0?' (A+R)':r.ann.size>0?' (Ann)':' (Rev)';
        return e.name+tag;
      }).join(', ');

      const rowH3=totalPpl>0?9:8;
      if(ly>H-22){ly=newPage('Client / Task');
        doc.setFillColor(74,4,78);doc.rect(MARGIN,ly,CW,7,'F');
        doc.setFont('helvetica','bold');doc.setFontSize(6.5);doc.setTextColor(233,213,255);
        cx2=MARGIN+2;cCols.forEach(c=>{doc.text(c.h,cx2,ly+4.8);cx2+=c.w;});ly+=7;
      }

      if(i%2===0)doc.setFillColor(248,245,255); else doc.setFillColor(255,255,255);
      doc.rect(MARGIN,ly,CW,rowH3,'F');
      doc.setFillColor(isUntagged?150:124,isUntagged?150:58,isUntagged?150:237);
      doc.rect(MARGIN,ly,2.5,rowH3,'F');

      const cRow=[
        clientName.length>28?clientName.substr(0,26)+'‚Ä¶':clientName,
        String(g.projects.length),String(totalPpl),
        String(annOnly2.length),String(revOnly2.length),dual2.length>0?'‚ö† '+dual2.length:'0',
        memberNames.length>55?memberNames.substr(0,53)+'‚Ä¶':memberNames
      ];
      doc.setFont('helvetica','normal');doc.setFontSize(7);
      cx2=MARGIN+2;
      cCols.forEach((c,ci)=>{
        if(ci===0){doc.setFont('helvetica',isUntagged?'normal':'bold');doc.setTextColor(isUntagged?150:51,isUntagged?150:65,isUntagged?150:85);}
        else if(ci===2)doc.setTextColor(124,58,237);
        else if(ci===3){doc.setFont('helvetica','normal');doc.setTextColor(37,99,235);}
        else if(ci===4){doc.setTextColor(217,119,6);}
        else if(ci===5&&dual2.length>0){doc.setFont('helvetica','bold');doc.setTextColor(220,38,38);}
        else{doc.setFont('helvetica','normal');doc.setTextColor(ci===6?71:15,ci===6?85:23,ci===6?105:42);}
        doc.text(String(cRow[ci]||''),cx2,ly+rowH3/2+2);cx2+=c.w;
      });
      doc.setDrawColor(230,220,255);doc.setLineWidth(0.1);doc.line(MARGIN,ly+rowH3,MARGIN+CW,ly+rowH3);
      ly+=rowH3;
    });
    return ly;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROJECT SECTION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function drawProjectSection(startY){
    let ly=startY;

    doc.setFillColor(30,41,59);doc.rect(MARGIN,ly,CW,8,'F');
    doc.setTextColor(255,255,255);doc.setFont('helvetica','bold');doc.setFontSize(8.5);
    doc.text('TEAM LOADING BY PROJECT',MARGIN+4,ly+5.5);
    doc.setFont('helvetica','normal');doc.setFontSize(7);doc.setTextColor(148,163,184);
    doc.text('Per-project team breakdown with progress and conflict flags',MARGIN+4+64,ly+5.5);
    ly+=12;

    const pCols=[
      {h:'Project Name',w:54},{h:'Client / Task',w:36},{h:'Pri',w:11},{h:'Status',w:20},
      {h:'Members',w:14},{h:'Ann',w:11},{h:'Rev',w:11},
      {h:'Dual',w:12},{h:'Ann%',w:13},{h:'Rev%',w:13},{h:'Annotator Names',w:0}
    ];
    const usedW=pCols.slice(0,-1).reduce((s,c)=>s+c.w,0);
    pCols[pCols.length-1].w=CW-usedW-4;

    const drawProjHeader=()=>{
      doc.setFillColor(51,65,85);doc.rect(MARGIN,ly,CW,7,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(6.5);doc.setTextColor(203,213,225);
      let cx3=MARGIN+2;pCols.forEach(c=>{doc.text(c.h,cx3,ly+4.8);cx3+=c.w;});ly+=7;
    };
    drawProjHeader();

    const priC3={high:[220,38,38],medium:[217,119,6],low:[22,163,74]};
    const statL3={todo:'To Do',inprog:'In Progress',review:'Review',done:'Done'};
    const statC3={todo:[100,116,139],inprog:[37,99,235],review:[217,119,6],done:[22,163,74]};

    projects.forEach((p,i)=>{
      if(ly>H-22){
        ly=newPage('By Project');
        drawProjHeader();
      }
      const ann=p.assignedEmployees||[];
      const rev=p.reviewEmployees||[];
      const dualCount=ann.filter(id=>rev.includes(id)).length;
      const totalMembers=new Set([...ann,...rev]).size;
      const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
      const pc4=priC3[p.priority]||[100,116,139];
      const sc4=statC3[p.kanbanStatus||'todo']||[100,116,139];
      const hasConflict=dualCount>0;
      const rowH4=8;

      if(i%2===0)doc.setFillColor(248,250,252); else doc.setFillColor(255,255,255);
      doc.rect(MARGIN,ly,CW,rowH4,'F');
      doc.setFillColor(...pc4);doc.rect(MARGIN,ly,2.5,rowH4,'F');
      if(hasConflict){doc.setFillColor(255,240,240);doc.rect(MARGIN+2.5,ly,CW-2.5,rowH4,'F');}

      const annNames=ann.map(id=>getEmp(id).name).join(', ')||'‚Äî';
      const clientTxt=p.client||'‚Äî';
      const row3=[
        p.name.length>28?p.name.substr(0,26)+'‚Ä¶':p.name,
        clientTxt.length>20?clientTxt.substr(0,18)+'‚Ä¶':clientTxt,
        p.priority.substr(0,3).toUpperCase(),
        statL3[p.kanbanStatus||'todo'],
        String(totalMembers),String(ann.length),String(rev.length),
        dualCount>0?'‚ö† '+dualCount:'0',
        pct(A,T)+'%',pct(R,T)+'%',
        annNames.length>38?annNames.substr(0,36)+'‚Ä¶':annNames
      ];

      doc.setFont('helvetica','normal');doc.setFontSize(7);
      let cx3=MARGIN+2;
      pCols.forEach((c,ci)=>{
        if(ci===2)doc.setTextColor(...pc4);
        else if(ci===3)doc.setTextColor(...sc4);
        else if(ci===7&&dualCount>0){doc.setFont('helvetica','bold');doc.setTextColor(220,38,38);}
        else if(ci===8)doc.setTextColor(37,99,235);
        else if(ci===9)doc.setTextColor(22,163,74);
        else{doc.setFont('helvetica','normal');doc.setTextColor(15,23,42);}
        if(ci===1)doc.setTextColor(124,58,237);
        doc.text(String(row3[ci]||''),cx3,ly+5.5);cx3+=c.w;
      });

      const barStartX=MARGIN+pCols.slice(0,8).reduce((s,c)=>s+c.w,0)+2;
      doc.setFillColor(226,232,240);doc.roundedRect(barStartX,ly+6.2,9,1.5,0.4,0.4,'F');
      if(T>0){doc.setFillColor(37,99,235);doc.roundedRect(barStartX,ly+6.2,9*pct(A,T)/100,1.5,0.4,0.4,'F');}

      doc.setDrawColor(226,232,240);doc.setLineWidth(0.1);doc.line(MARGIN,ly+rowH4,MARGIN+CW,ly+rowH4);
      ly+=rowH4;
    });

    // Conflict summary
    const conflictEmps=[...dual,...multiAnnotators()].filter((id,i,a)=>a.indexOf(id)===i);
    if(conflictEmps.length>0){
      ly+=5;
      if(ly>H-30){ly=newPage('Conflict Summary');}
      doc.setFillColor(220,38,38);doc.rect(MARGIN,ly,CW,8,'F');
      doc.setTextColor(255,255,255);doc.setFont('helvetica','bold');doc.setFontSize(8);
      doc.text('CONFLICT SUMMARY ‚Äî Employees with Overlapping Roles',MARGIN+4,ly+5.5);
      ly+=10;
      doc.setFillColor(255,241,242);doc.rect(MARGIN,ly,CW,6,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(6.5);doc.setTextColor(100,116,139);
      ['Employee','Conflict Type','Annotating Projects','Reviewing Projects'].forEach((h,hi)=>{
        doc.text(h,MARGIN+2+[0,50,90,165][hi],ly+4.5);
      });
      ly+=6;
      conflictEmps.forEach((id,i)=>{
        if(ly>H-18){ly=newPage('Conflict Summary');}
        const e=getEmp(id);
        const aP=projects.filter(p=>(p.assignedEmployees||[]).includes(id));
        const rP=projects.filter(p=>(p.reviewEmployees||[]).includes(id));
        const isD=dual.has(id);const isM=multiAnn.has(id);
        let ctype=isD&&isM?'Multi-ann + Review':isM?'Multiple Annotation':'Annotating & Reviewing';
        if(i%2===0)doc.setFillColor(255,248,248); else doc.setFillColor(255,255,255);
        doc.rect(MARGIN,ly,CW,7,'F');
        doc.setFillColor(220,38,38);doc.rect(MARGIN,ly,2,7,'F');
        doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(15,23,42);
        doc.text(e.name.length>24?e.name.substr(0,22)+'‚Ä¶':e.name,MARGIN+4,ly+4.8);
        doc.setFont('helvetica','normal');doc.setTextColor(220,38,38);
        doc.text(ctype,MARGIN+52,ly+4.8);
        doc.setTextColor(37,99,235);
        const aNames=aP.map(p=>p.name).join(', ');
        doc.text(aNames.length>38?aNames.substr(0,36)+'‚Ä¶':aNames,MARGIN+92,ly+4.8);
        doc.setTextColor(217,119,6);
        const rNames=rP.map(p=>p.name).join(', ');
        doc.text(rNames.length>38?rNames.substr(0,36)+'‚Ä¶':rNames,MARGIN+167,ly+4.8);
        doc.setDrawColor(255,220,220);doc.setLineWidth(0.1);doc.line(MARGIN,ly+7,MARGIN+CW,ly+7);
        ly+=7;
      });
    }
    return ly;
  }

  // ‚ïê‚ïê RENDER BASED ON MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  if(mode==='client'){
    y=drawClientSection(y);
  } else if(mode==='project'){
    y=drawProjectSection(y);
  } else {
    // both ‚Äî client first, then project on next page
    y=drawClientSection(y);
    y=newPage('By Project');
    // Redraw summary stats on new page header area would be too much; just continue
    y=drawProjectSection(y);
  }

  drawWLFooter();
  const fname='camcom_workload_'+(mode==='client'?'by_client':mode==='project'?'by_project':'full')+'_'+today.replace(/ /g,'_')+'.pdf';
  doc.save(fname);
  toast('Workload PDF exported','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KANBAN BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderKanban(){
  const cols={todo:[],inprog:[],review:[],done:[]};
  projects.forEach(p=>{const s=p.kanbanStatus||'todo';if(cols[s])cols[s].push(p);});
  const colDefs=[
    {id:'todo',title:'üìã To Do',cls:'col-todo'},
    {id:'inprog',title:'‚ö° In Progress',cls:'col-inprog'},
    {id:'review',title:'üîç Review',cls:'col-review'},
    {id:'done',title:'‚úÖ Completed',cls:'col-done'},
  ];
  document.getElementById('kanbanWrap').innerHTML=colDefs.map(col=>`
    <div class="kb-col ${col.cls}">
      <div class="kb-hdr"><span class="kb-col-title">${col.title}</span><span class="kb-count">${cols[col.id].length}</span></div>
      <div class="kb-cards" id="kbc-${col.id}" ondragover="kbDragOver(event,'${col.id}')" ondragleave="kbDragLeave(event)" ondrop="kbDrop(event,'${col.id}')">
        ${cols[col.id].length?cols[col.id].map(p=>buildKBCard(p)).join(''):`<div class="kb-empty"><i class="fas fa-inbox" style="font-size:1.2rem;margin-bottom:6px;display:block;"></i>No projects</div>`}
      </div>
    </div>`).join('');
}

function buildKBCard(p){
  const T=+p.total||0,A=+p.annotated||0;const aP=pct(A,T);
  const dl=dlMeta(p.deadline);const ov=dl&&dl.diff<0;
  return`<div class="kb-card" draggable="true" ondragstart="kbDragStart(event,'${p.id}')" onclick="openDP('${p.id}')">
    <div class="kb-card-title">${esc(p.name)}</div>
    <div class="kb-card-meta">
      <span class="badge b${p.priority[0]}">${{high:'üî•',medium:'‚ö°',low:'üåø'}[p.priority]}</span>
      <span class="kb-pct">${aP}% annotated</span>
      ${dl?`<span class="kb-pct ${ov?'ov':''}"><i class="fas fa-calendar-alt"></i> ${dl.label}</span>`:''}
      ${(p.tags||[]).map(t=>`<span class="proj-tag" style="font-size:.55rem;padding:1px 5px;">#${esc(t)}</span>`).join('')}
    </div>
    <div class="pbar" style="margin-top:7px;"><div class="pf pf-a" style="width:${aP}%"></div></div>
  </div>`;
}

function kbDragStart(e,id){dragSrcId=id;e.currentTarget.classList.add('dragging');e.dataTransfer.effectAllowed='move';}
function kbDragOver(e,colId){e.preventDefault();e.dataTransfer.dropEffect='move';document.getElementById(`kbc-${colId}`)?.classList.add('drag-over');}
function kbDragLeave(e){e.currentTarget.classList.remove('drag-over');}
// ‚îÄ‚îÄ Auto-unassign all employees when project marked as Completed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function markCompleted(p){
  if(!p)return;
  // Note: callers already ensure we only call this when transitioning TO done
  const annCount=(p.assignedEmployees||[]).length;
  const revCount=(p.reviewEmployees||[]).length;
  const total=annCount+revCount;
  if(total===0)return; // nobody assigned, nothing to do

  const names=[...new Set([
    ...(p.assignedEmployees||[]).map(id=>getEmp(id).name),
    ...(p.reviewEmployees||[]).map(id=>getEmp(id).name)
  ])];
  // Unassign everyone
  p.assignedEmployees=[];
  p.reviewEmployees=[];
  toast(`‚úÖ Project completed ‚Äî ${names.join(', ')} removed from this project`,'ok');
  logActivity('status',p.id,p.name,`Marked as Completed; ${names.join(', ')} unassigned`);
}

async function kbDrop(e,colId){
  e.preventDefault();e.currentTarget.classList.remove('drag-over');
  if(!dragSrcId)return;
  const p=projects.find(x=>x.id===dragSrcId);
  if(p&&p.kanbanStatus!==colId){
    if(colId==='done') await markCompleted(p);
    p.kanbanStatus=colId;
    renderKanban();renderProjects();
    toast(`Moved to ${KB_LABELS[colId]}`,'ok');
    await saveProjDB(p);
  }
  dragSrcId=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYTICS TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAnalyticsTab(tab,el){
  ['charts','gantt','burndown'].forEach(t=>document.getElementById('at-'+t).style.display=t===tab?'':'none');
  document.querySelectorAll('.stab').forEach(s=>s.classList.remove('on'));el.classList.add('on');
  if(tab==='charts')renderCharts();
  if(tab==='gantt')renderGantt();
  if(tab==='burndown')populateBurndownSel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function destroyChart(id){if(chartInstances[id]){chartInstances[id].destroy();delete chartInstances[id];}}

function renderCharts(){
  if(!projects.length)return;
  const active=projects.filter(p=>(p.kanbanStatus||'todo')!=='done');
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const tx=isDark?'#8b949e':'#475569';
  const txMain=getComputedStyle(document.body).getPropertyValue('--tx')||'#0f172a';
  const subtitle=active.length<projects.length?`Active only (${active.length}/${projects.length})`:'';

  // Priority pie ‚Äî active only
  destroyChart('pri');
  const h=active.filter(p=>p.priority==='high').length;
  const m=active.filter(p=>p.priority==='medium').length;
  const l=active.filter(p=>p.priority==='low').length;
  chartInstances.pri=new Chart(document.getElementById('priChart'),{type:'doughnut',data:{labels:['High','Medium','Low'],datasets:[{data:[h,m,l],backgroundColor:['#dc2626','#d97706','#16a34a'],borderWidth:2,borderColor:'var(--sur)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:!!subtitle,text:subtitle,font:{size:9},color:tx},legend:{position:'bottom',labels:{font:{size:11},color:txMain}}}}});

  // Annotation progress ‚Äî active only
  destroyChart('prog');
  chartInstances.prog=new Chart(document.getElementById('progChart'),{type:'bar',data:{labels:active.map(p=>p.name.length>14?p.name.substr(0,14)+'‚Ä¶':p.name),datasets:[{label:'Annotated %',data:active.map(p=>pct(p.annotated,p.total)),backgroundColor:'#3b82f6',borderRadius:4},{label:'Reviewed %',data:active.map(p=>pct(p.reviewed,p.total)),backgroundColor:'#16a34a',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:!!subtitle,text:subtitle,font:{size:9},color:tx},legend:{labels:{font:{size:10},color:tx}}},scales:{x:{ticks:{color:tx,font:{size:9}},grid:{display:false}},y:{min:0,max:100,ticks:{color:tx,font:{size:10}},grid:{color:isDark?'#30363d':'#e2e8f0'}}}}});

  // Status donut ‚Äî all projects
  destroyChart('status');
  const sc={todo:0,inprog:0,review:0,done:0};
  projects.forEach(p=>{sc[p.kanbanStatus||'todo']++;});
  chartInstances.status=new Chart(document.getElementById('statusChart'),{type:'doughnut',data:{labels:['To Do','In Progress','Review','Done'],datasets:[{data:[sc.todo,sc.inprog,sc.review,sc.done],backgroundColor:['#94a3b8','#3b82f6','#d97706','#16a34a'],borderWidth:2,borderColor:'var(--sur)'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font:{size:11},color:tx}}}}});

  // Employees per project ‚Äî active only
  destroyChart('emp');
  chartInstances.emp=new Chart(document.getElementById('empChart'),{type:'bar',data:{labels:active.map(p=>p.name.length>14?p.name.substr(0,14)+'‚Ä¶':p.name),datasets:[{label:'Employees',data:active.map(p=>(p.assignedEmployees||[]).length),backgroundColor:'#7c3aed',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:tx,font:{size:9}},grid:{display:false}},y:{ticks:{color:tx,font:{size:10}},grid:{color:isDark?'#30363d':'#e2e8f0'}}}}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GANTT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGantt(){
  const now=new Date();
  const withDates=projects.filter(p=>p.startdate||p.deadline);
  if(!withDates.length){document.getElementById('ganttTable').innerHTML='<div class="empty-st"><i class="fas fa-stream"></i><p>No projects have start/deadline dates set.</p></div>';return;}
  // compute range
  let minDate=new Date();let maxDate=new Date();
  withDates.forEach(p=>{
    if(p.startdate){const d=new Date(p.startdate+'T00:00:00');if(d<minDate)minDate=d;}
    if(p.deadline){const d=new Date(p.deadline+'T00:00:00');if(d>maxDate)maxDate=d;}
  });
  const totalDays=Math.max(1,Math.ceil((maxDate-minDate)/86400000));
  const todayPct=Math.max(0,Math.min(100,Math.ceil((now-minDate)/86400000)/totalDays*100));
  // months header
  const months=[];let cur=new Date(minDate);cur.setDate(1);
  while(cur<=maxDate){months.push(cur.toLocaleDateString('en-US',{month:'short',year:'numeric'}));cur.setMonth(cur.getMonth()+1);}

  const rows=withDates.map(p=>{
    const s=p.startdate?new Date(p.startdate+'T00:00:00'):minDate;
    const e=p.deadline?new Date(p.deadline+'T00:00:00'):now;
    const left=Math.max(0,Math.ceil((s-minDate)/86400000)/totalDays*100);
    const width=Math.max(1,Math.ceil((e-s)/86400000)/totalDays*100);
    const isOv=e<now;
    return`<div class="gantt-row">
      <div class="gantt-proj-name" title="${esc(p.name)}">${esc(p.name)}</div>
      <div class="gantt-bar-area">
        <div class="today-line" style="left:${todayPct}%"></div>
        <div class="gantt-bar ${p.priority} ${isOv?'overdue':''}" style="left:${left}%;width:${Math.min(width,100-left)}%;" title="${fmtD(p.startdate)} ‚Üí ${fmtD(p.deadline)} ${isOv?'(OVERDUE)':''}">
          ${width>8?p.name.substr(0,12)+'‚Ä¶':''}
        </div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('ganttTable').innerHTML=`
    <div class="gantt-head">
      <div class="gantt-name-col">Project</div>
      <div class="gantt-timeline">${months.map(m=>`<div class="gantt-month">${m}</div>`).join('')}</div>
    </div>
    ${rows}
    <div style="font-size:.68rem;color:var(--tx3);margin-top:10px;display:flex;align-items:center;gap:6px;"><div style="width:12px;height:3px;background:var(--red);border-radius:2px;"></div>Today</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BURNDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateBurndownSel(){
  const sel=document.getElementById('burndownSel');
  sel.innerHTML='<option value="">Select project...</option>'+projects.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
}
function renderBurndown(){
  const id=document.getElementById('burndownSel').value;
  if(!id){destroyChart('bd');return;}
  const p=projects.find(x=>x.id===id);if(!p)return;
  const T=+p.total||0;if(!T){toast('No total images set for this project','info');return;}
  // Simulate a burndown: ideal line from total‚Üí0, actual from annotated position
  const days=14;
  const labels=Array.from({length:days+1},(_,i)=>i===0?'Start':`Day ${i}`);
  const ideal=Array.from({length:days+1},(_,i)=>Math.round(T-T*(i/days)));
  // actual: show current progress at today (mid-point of days), rest null
  const todayIdx=Math.round(days/2);
  const actualVal=T-(+p.annotated||0);
  const actual=Array.from({length:days+1},(_,i)=>{
    if(i===0)return T;
    if(i===todayIdx)return actualVal;
    if(i<todayIdx)return T-Math.round((T-actualVal)*(i/todayIdx));
    return null;
  });
  destroyChart('bd');
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const tx=isDark?'#8b949e':'#475569';
  chartInstances.bd=new Chart(document.getElementById('burndownChart'),{type:'line',data:{labels,datasets:[
    {label:'Ideal',data:ideal,borderColor:'#94a3b8',borderDash:[5,5],borderWidth:2,pointRadius:0,tension:.4,fill:false},
    {label:'Actual',data:actual,borderColor:'#df1e26',backgroundColor:'rgba(223,30,38,.1)',borderWidth:2.5,pointRadius:4,tension:.4,fill:true,spanGaps:false},
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{size:11},color:tx}}},scales:{x:{ticks:{color:tx,font:{size:9}},grid:{color:isDark?'#30363d':'#e2e8f0'}},y:{ticks:{color:tx,font:{size:10}},grid:{color:isDark?'#30363d':'#e2e8f0'},min:0}}}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(){
  const hdr=['Project','Priority','Status','Assigned By','Start','Deadline','Total','Annotated','Reviewed','Pend.Ann','Pend.Rev','%Ann','%Rev','Daily Target','Employees','Notes','Comments'];
  const rows=projects.map(p=>{const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;const emps=(p.assignedEmployees||[]).map(id=>getEmp(id).name).join('; ');
    return[`"${p.name}"`,p.priority,p.kanbanStatus||'todo',`"${p.assignedby||''}"`,p.startdate||'',p.deadline||'',T,A,R,Math.max(T-A,0),Math.max(A-R,0),pct(A,T)+'%',pct(R,T)+'%',p.hasTarget?p.dailyTarget:'‚Äî',`"${emps}"`,`"${(p.notes||'').replace(/"/g,'""')}"`,`"${(p.comments||'').replace(/"/g,'""')}"`].join(',');});
  const csv=[hdr.join(','),...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='camcom_projects.csv';a.click();URL.revokeObjectURL(url);
  toast('CSV exported ‚úì','ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF(){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'landscape',format:'a4',unit:'mm'});
  const W=297,H=210,MARGIN=14,CONTENT_W=W-2*MARGIN;

  const tI=projects.reduce((s,p)=>s+(+p.total||0),0);
  const tA=projects.reduce((s,p)=>s+(+p.annotated||0),0);
  const tR=projects.reduce((s,p)=>s+(+p.reviewed||0),0);
  const today=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});

  function drawPageHeader(continued){
    // Dark header
    doc.setFillColor(15,23,42);doc.rect(0,0,W,22,'F');
    doc.setFillColor(223,30,38);doc.rect(0,0,6,22,'F');

    // Logo box
    const LX=12,LY=4,LSZ=14;
    doc.setFillColor(223,30,38);doc.roundedRect(LX,LY,LSZ,LSZ,1.5,1.5,'F');
    doc.setDrawColor(255,255,255);doc.setLineWidth(0.2);
    doc.line(LX+2,LY+7,LX+LSZ-2,LY+7);
    doc.setTextColor(255,255,255);doc.setFont('helvetica','bold');doc.setFontSize(5);
    doc.text('CAM',LX+LSZ/2,LY+5.5,{align:'center'});
    doc.text('COM',LX+LSZ/2,LY+10,{align:'center'});

    // Title
    doc.setFont('helvetica','bold');doc.setFontSize(12);doc.setTextColor(255,255,255);
    doc.text('CamCom Annotation Tracker',LX+LSZ+4,LY+7);
    doc.setFont('helvetica','normal');doc.setFontSize(7.5);doc.setTextColor(148,163,184);
    doc.text(continued?'Project Report (continued)':'Project Report ‚Äî All Projects',LX+LSZ+4,LY+12);

    // Right: date
    doc.setFont('helvetica','normal');doc.setFontSize(7);doc.setTextColor(203,213,225);
    doc.text(today,W-MARGIN,LY+7,{align:'right'});
    if(!continued){
      doc.setFontSize(6.5);doc.setTextColor(148,163,184);
      doc.text('Prepared by: '+(currentUser?.name||'‚Äî'),W-MARGIN,LY+12,{align:'right'});
    }
  }

  function drawSummaryBar(){
    const sy=22;
    doc.setFillColor(241,245,249);doc.rect(0,sy,W,16,'F');
    doc.setDrawColor(226,232,240);doc.setLineWidth(0.3);doc.line(0,sy+16,W,sy+16);
    const summaryItems=[
      {label:'Total Projects',value:projects.length,color:[15,23,42]},
      {label:'Total Images',value:tI.toLocaleString(),color:[37,99,235]},
      {label:'Annotated',value:tA.toLocaleString()+' ('+pct(tA,tI)+'%)',color:[22,163,74]},
      {label:'Reviewed',value:tR.toLocaleString()+' ('+pct(tR,tI)+'%)',color:[124,58,237]},
      {label:'Employees',value:employees.length,color:[217,119,6]},
      {label:'High Priority',value:projects.filter(p=>p.priority==='high').length,color:[220,38,38]},
    ];
    const sw=CONTENT_W/summaryItems.length;
    summaryItems.forEach((s,i)=>{
      const sx=MARGIN+i*sw+sw/2;
      doc.setFont('helvetica','bold');doc.setFontSize(9);doc.setTextColor(...s.color);
      doc.text(String(s.value),sx,sy+8,{align:'center'});
      doc.setFont('helvetica','normal');doc.setFontSize(6);doc.setTextColor(100,116,139);
      doc.text(s.label.toUpperCase(),sx,sy+13,{align:'center'});
      if(i<summaryItems.length-1){
        doc.setDrawColor(226,232,240);doc.setLineWidth(0.3);
        doc.line(MARGIN+((i+1)*sw),sy+3,MARGIN+((i+1)*sw),sy+13);
      }
    });
  }

  function drawTableHeader(ty){
    const cols=[
      {h:'Project Name',w:62},{h:'Priority',w:18},{h:'Status',w:22},
      {h:'Ann%',w:14},{h:'Rev%',w:14},{h:'Total Imgs',w:18},
      {h:'Annotated',w:18},{h:'Reviewed',w:18},{h:'Deadline',w:22},{h:'Assigned By',w:28},{h:'Team',w:11}
    ];
    doc.setFillColor(30,41,59);doc.rect(MARGIN,ty,CONTENT_W,8,'F');
    doc.setFont('helvetica','bold');doc.setFontSize(6.5);doc.setTextColor(148,163,184);
    let cx=MARGIN+2;
    cols.forEach(c=>{doc.text(c.h,cx,ty+5.5);cx+=c.w;});
    return {cols,ty:ty+8};
  }

  // Draw header & summary
  drawPageHeader(false);
  drawSummaryBar();

  let y=42;
  let {cols, ty:tableY}=drawTableHeader(y);
  y=tableY;

  const priColors2={high:[220,38,38],medium:[217,119,6],low:[22,163,74]};
  const statColors={todo:[100,116,139],inprog:[37,99,235],review:[217,119,6],done:[22,163,74]};
  const statLabels2={todo:'To Do',inprog:'In Progress',review:'Review',done:'Done'};

  projects.forEach((p,i)=>{
    if(y>H-22){
      drawPageFooter();
      doc.addPage();
      drawPageHeader(true);
      y=26;
      const res=drawTableHeader(y);
      cols=res.cols;y=res.ty;
    }

    const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
    const aPct=pct(A,T),rPct=pct(R,T);
    const dl=dlMeta(p.deadline);
    const rowH=8;

    // Alternating row background
    if(i%2===0){doc.setFillColor(248,250,252);doc.rect(MARGIN,y,CONTENT_W,rowH,'F');}
    else{doc.setFillColor(255,255,255);doc.rect(MARGIN,y,CONTENT_W,rowH,'F');}

    // Priority left accent
    const pc2=priColors2[p.priority]||[100,116,139];
    doc.setFillColor(...pc2);doc.rect(MARGIN,y,2.5,rowH,'F');

    const row=[
      p.name.length>30?p.name.substr(0,28)+'‚Ä¶':p.name,
      p.priority.toUpperCase(),
      statLabels2[p.kanbanStatus||'todo'],
      aPct+'%', rPct+'%',
      T.toLocaleString(), A.toLocaleString(), R.toLocaleString(),
      dl?dl.label:'‚Äî',
      (p.assignedby||'‚Äî').substr(0,14),
      String((p.assignedEmployees||[]).length)
    ];

    doc.setFont('helvetica','normal');doc.setFontSize(7);
    let cx=MARGIN+2;
    cols.forEach((c,ci)=>{
      // Color coding
      if(ci===1){doc.setTextColor(...pc2);}
      else if(ci===2){doc.setTextColor(...(statColors[p.kanbanStatus||'todo']||[100,116,139]));}
      else if(ci===3){doc.setTextColor(37,99,235);}
      else if(ci===4){doc.setTextColor(22,163,74);}
      else if(ci===8&&dl&&dl.diff<0){doc.setTextColor(220,38,38);}
      else{doc.setTextColor(15,23,42);}
      doc.text(String(row[ci]||''),cx,y+5.5);cx+=c.w;
    });

    // Mini progress bar for annotation
    const barX=MARGIN+cols[0].w+cols[1].w+cols[2].w+2;
    const barW=cols[3].w-4;
    doc.setFillColor(226,232,240);doc.roundedRect(barX,y+5.8,barW,1.5,0.5,0.5,'F');
    if(aPct>0){doc.setFillColor(37,99,235);doc.roundedRect(barX,y+5.8,barW*aPct/100,1.5,0.5,0.5,'F');}

    // Row border
    doc.setDrawColor(226,232,240);doc.setLineWidth(0.1);
    doc.line(MARGIN,y+rowH,MARGIN+CONTENT_W,y+rowH);
    y+=rowH;
  });

  function drawPageFooter(){
    const totalPg=doc.internal.getNumberOfPages();
    for(let pg=1;pg<=totalPg;pg++){
      doc.setPage(pg);
      doc.setFillColor(15,23,42);doc.rect(0,H-10,W,10,'F');
      doc.setFillColor(223,30,38);doc.rect(0,H-10,6,10,'F');
      doc.setFont('helvetica','bold');doc.setFontSize(6);doc.setTextColor(255,255,255);
      doc.text('CamCom',MARGIN,H-4.5);
      doc.setFont('helvetica','normal');doc.setTextColor(100,116,139);
      doc.text('Annotation Tracker  ‚Ä¢  Confidential',MARGIN+18,H-4.5);
      doc.text('Page '+pg+' of '+totalPg,W/2,H-4.5,{align:'center'});
      doc.text('Generated: '+today,W-MARGIN,H-4.5,{align:'right'});
    }
  }

  drawPageFooter();
  doc.save('camcom_report.pdf');
  toast('PDF exported','ok');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FEATURE_DEFS=[
  {key:'kanban',label:'Kanban Board',desc:'Visual columns: To Do, In Progress, Review, Completed with drag-and-drop'},
  {key:'analytics',label:'Analytics & Charts',desc:'Priority pie chart, progress charts, employee distribution'},
  {key:'gantt',label:'Timeline / Gantt Chart',desc:'Visual project timeline and deadline overview'},
  {key:'burndown',label:'Burndown Chart',desc:'Track annotation progress burndown per project'},
  {key:'exportPDF',label:'Export PDF Report',desc:'Generate and download a PDF summary report'},
  {key:'exportCSV',label:'Export CSV',desc:'Export all project data to a spreadsheet-compatible CSV file'},
  {key:'workload',label:'Workload Overview',desc:'See which employees are assigned to how many projects'},
  {key:'dailyTarget',label:'Daily Image Target',desc:'Set a daily completion target per project'},
  {key:'fileUpload',label:'File Uploads',desc:'Attach documents and files to each project'},
];
function renderSettings(){
  document.getElementById('settingsGrid').innerHTML=FEATURE_DEFS.map(f=>`
    <div class="setting-card">
      <div class="setting-info"><strong>${f.label}</strong><span>${f.desc}</span></div>
      <label class="toggle-sw"><input type="checkbox" ${features[f.key]?'checked':''} onchange="toggleFeature('${f.key}',this.checked)"><span class="toggle-sl"></span></label>
    </div>`).join('');
  // Update sidebar visibility
  const map={kanban:'kanban',analytics:'analytics',workload:'workload'};
  Object.entries(map).forEach(([k,page])=>{
    const btn=document.querySelector(`[data-page="${page}"]`);
    if(btn)btn.style.display=features[k]?'':'none';
  });
}
function toggleFeature(key,val){
  features[key]=val;saveFeaturesLocal();renderSettings();
  toast(`${val?'Enabled':'Disabled'}: ${FEATURE_DEFS.find(f=>f.key===key)?.label}`,'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAILY REPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDailyReport(){
  // Populate project selector
  const sel=document.getElementById('rep-proj');
  sel.innerHTML='<option value="">‚Äî Select a project ‚Äî</option>'+projects.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join('');
  // Default to today
  document.getElementById('rep-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('rep-sendto').value='';
  document.getElementById('rep-preview-wrap').style.display='none';
  document.getElementById('reportOvl').classList.add('open');
}
function closeReport(){document.getElementById('reportOvl').classList.remove('open');}

function generateReport(){
  const projId=document.getElementById('rep-proj').value;
  const dateVal=document.getElementById('rep-date').value;
  if(!projId||!dateVal){document.getElementById('rep-preview-wrap').style.display='none';return;}
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
  const pendAnn=Math.max(T-A,0),pendRev=Math.max(A-R,0);
  const annPct=pct(A,T),revPct=pct(R,T);
  const dl=dlMeta(p.deadline);
  const annotators=(p.assignedEmployees||[]).map(id=>getEmp(id).name).join(', ')||'‚Äî';
  const reviewers=(p.reviewEmployees||[]).map(id=>getEmp(id).name).join(', ')||'‚Äî';
  const tags=(p.tags||[]).map(t=>'#'+t).join(' ')||'‚Äî';
  const repDate=new Date(dateVal+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const sendTo=document.getElementById('rep-sendto').value.trim();

  const report=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä CAMCOM ANNOTATION TRACKER ‚Äî DAILY REPORT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Date: ${repDate}
Project: ${p.name}
Prepared by: ${currentUser?.name||'‚Äî'}${sendTo?'\nSent to: '+sendTo:''}

‚îÄ‚îÄ PROJECT OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Priority:     ${p.priority?.toUpperCase()||'MEDIUM'}
Status:       ${{todo:'To Do',inprog:'In Progress',review:'Under Review',done:'Completed'}[p.kanbanStatus||'todo']}
Assigned By:  ${p.assignedby||'‚Äî'}
Deadline:     ${fmtD(p.deadline)||'‚Äî'}${dl?(dl.diff<0?' ‚ö† OVERDUE':dl.diff===0?' (Due Today)':` (${dl.diff} days remaining)`):''}
Tags:         ${tags}

‚îÄ‚îÄ IMAGE PROGRESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Images:       ${T.toLocaleString()}
Annotated:          ${A.toLocaleString()} (${annPct}%)
Reviewed:           ${R.toLocaleString()} (${revPct}%)
Pending Annotation: ${pendAnn.toLocaleString()}
Pending Review:     ${pendRev.toLocaleString()}
${p.hasTarget&&p.dailyTarget?`Daily Target:       ${p.dailyTarget} images/day
Est. Days Left:     ${pendAnn>0?Math.ceil(pendAnn/p.dailyTarget):'Complete'}`:''}

‚îÄ‚îÄ TEAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Annotators: ${annotators}
Reviewers:  ${reviewers}

‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${p.notes||'No notes.'}

‚îÄ‚îÄ COMMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${p.comments||'No comments.'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Generated by CamCom Annotation Tracker
${new Date().toLocaleString('en-IN')}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

  document.getElementById('rep-preview').textContent=report;
  document.getElementById('rep-preview-wrap').style.display='';
}

function copyReport(){
  const txt=document.getElementById('rep-preview')?.textContent;
  if(!txt){toast('Generate a report first','err');return;}
  navigator.clipboard.writeText(txt).then(()=>toast('Report copied to clipboard ‚úì','ok')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();toast('Copied ‚úì','ok');
  });
}

function downloadReport(){
  const txt=document.getElementById('rep-preview')?.textContent;
  if(!txt){toast('Generate a report first','err');return;}
  const projId=document.getElementById('rep-proj').value;
  const p=projects.find(x=>x.id===projId);
  const dateVal=document.getElementById('rep-date').value||'report';
  const fname=`camcom_report_${(p?.name||'project').replace(/\s+/g,'_')}_${dateVal}.txt`;
  const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=fname;a.click();URL.revokeObjectURL(url);
  toast('Report downloaded ‚úì','ok');
}

function downloadReportPDF(){
  const projId=document.getElementById('rep-proj').value;
  if(!projId){toast('Please select a project first','err');return;}
  const p=projects.find(x=>x.id===projId);if(!p)return;
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',format:'a4',unit:'mm'});
  const W=210,MARGIN=16,CONTENT_W=W-2*MARGIN;

  const dateVal=document.getElementById('rep-date').value||new Date().toISOString().split('T')[0];
  const repDate=new Date(dateVal+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const sendTo=document.getElementById('rep-sendto').value.trim();
  const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
  const pendAnn=Math.max(T-A,0),pendRev=Math.max(A-R,0);
  const annPct=pct(A,T),revPct=pct(R,T);
  const dl=dlMeta(p.deadline);
  const annotators=(p.assignedEmployees||[]).map(id=>getEmp(id).name).join(', ')||'‚Äî';
  const reviewers=(p.reviewEmployees||[]).map(id=>getEmp(id).name).join(', ')||'‚Äî';
  const tags=(p.tags||[]).map(t=>'#'+t).join('  ')||'‚Äî';
  const priColors={high:[220,38,38],medium:[217,119,6],low:[22,163,74]};
  const pc=priColors[p.priority||'medium'];

  // ‚îÄ‚îÄ Helper: draw CamCom logo square at (lx,ly) with size sz ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function drawLogo(lx,ly,sz){
    // Red background square
    doc.setFillColor(223,30,38);
    doc.rect(lx,ly,sz,sz,'F');
    // Scale factor: SVG viewBox is 36,37 to 433,434 => 397x397
    const scale=sz/397;
    const ox=lx-36*scale, oy=ly-37*scale;
    doc.setFillColor(255,255,255);
    // Draw "C" letter (top) ‚Äî simplified as two arcs approximated by bezier
    // We'll use the SVG path data translated to jsPDF lines
    // Using a simplified block approach: draw white rectangles to form letters
    // Letter C (top-left) ‚Äî white rounded shape
    const u=(sz/14); // unit
    // Top C
    doc.setFillColor(255,255,255);
    doc.roundedRect(lx+u*0.5, ly+u*1.2, u*4.5, u*5.5, u*0.6, u*0.6, 'F');
    doc.setFillColor(223,30,38);
    doc.roundedRect(lx+u*2.0, ly+u*2.2, u*3.5, u*3.5, u*0.4, u*0.4, 'F');
    doc.roundedRect(lx+u*0.5, ly+u*3.5, u*1.8, u*1.5, u*0.2, u*0.2, 'F');
    // Top A ‚Äî white triangle-ish shape
    doc.setFillColor(255,255,255);
    // A shape: two white slanted bars + crossbar
    doc.rect(lx+u*5.5, ly+u*1.2, u*1.0, u*5.5, 'F');
    doc.rect(lx+u*8.5, ly+u*1.2, u*1.0, u*5.5, 'F');
    // slant left bar
    for(let si=0;si<5;si++){doc.rect(lx+u*(5.5+si*0.28), ly+u*(1.2+si*1.0), u*1.0, u*1.1, 'F');}
    for(let si=0;si<5;si++){doc.rect(lx+u*(8.5-si*0.28), ly+u*(1.2+si*1.0), u*1.0, u*1.1, 'F');}
    doc.rect(lx+u*6.0, ly+u*4.0, u*3.0, u*0.8, 'F');
    // Top M
    doc.setFillColor(255,255,255);
    doc.rect(lx+u*10.0, ly+u*1.2, u*1.0, u*5.5, 'F');
    doc.rect(lx+u*13.0, ly+u*1.2, u*1.0, u*5.5, 'F');
    for(let si=0;si<3;si++){doc.rect(lx+u*(10.5+si*0.8), ly+u*(1.2+si*0.9), u*1.2, u*1.0, 'F');}
    for(let si=0;si<3;si++){doc.rect(lx+u*(12.3-si*0.8+0.5), ly+u*(1.2+si*0.9), u*1.2, u*1.0, 'F');}
    // Bottom row C C M ‚Äî same but shifted down
    const dy=u*7;
    // Bottom C
    doc.setFillColor(255,255,255);
    doc.roundedRect(lx+u*0.5, ly+u*1.2+dy, u*4.5, u*5.5, u*0.6, u*0.6, 'F');
    doc.setFillColor(223,30,38);
    doc.roundedRect(lx+u*2.0, ly+u*2.2+dy, u*3.5, u*3.5, u*0.4, u*0.4, 'F');
    doc.roundedRect(lx+u*0.5, ly+u*3.5+dy, u*1.8, u*1.5, u*0.2, u*0.2, 'F');
    // Bottom second C (reuse at different x)
    doc.setFillColor(255,255,255);
    doc.roundedRect(lx+u*5.0, ly+u*1.2+dy, u*4.5, u*5.5, u*0.6, u*0.6, 'F');
    doc.setFillColor(223,30,38);
    doc.roundedRect(lx+u*6.5, ly+u*2.2+dy, u*3.5, u*3.5, u*0.4, u*0.4, 'F');
    doc.roundedRect(lx+u*5.0, ly+u*3.5+dy, u*1.8, u*1.5, u*0.2, u*0.2, 'F');
    // Bottom M
    doc.setFillColor(255,255,255);
    doc.rect(lx+u*10.0, ly+u*1.2+dy, u*1.0, u*5.5, 'F');
    doc.rect(lx+u*13.0, ly+u*1.2+dy, u*1.0, u*5.5, 'F');
    for(let si=0;si<3;si++){doc.rect(lx+u*(10.5+si*0.8), ly+u*(1.2+si*0.9)+dy, u*1.2, u*1.0, 'F');}
    for(let si=0;si<3;si++){doc.rect(lx+u*(12.3-si*0.8+0.5), ly+u*(1.2+si*0.9)+dy, u*1.2, u*1.0, 'F');}
  }

  // ‚îÄ‚îÄ HEADER BAND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const HDR_H=42;
  // Dark navy background
  doc.setFillColor(15,23,42);
  doc.rect(0,0,W,HDR_H,'F');
  // Red accent left stripe
  doc.setFillColor(223,30,38);
  doc.rect(0,0,6,HDR_H,'F');

  // Logo box (white bg for logo)
  const LOGO_SZ=28;
  const LOGO_X=12, LOGO_Y=7;
  doc.setFillColor(223,30,38);
  doc.roundedRect(LOGO_X,LOGO_Y,LOGO_SZ,LOGO_SZ,3,3,'F');
  // Draw white "CAM" / "COM" text inside logo box
  doc.setTextColor(255,255,255);
  doc.setFont('helvetica','bold');
  doc.setFontSize(8.5);
  doc.text('CAM',LOGO_X+LOGO_SZ/2,LOGO_Y+11,{align:'center'});
  doc.setFontSize(7);
  doc.text('COM',LOGO_X+LOGO_SZ/2,LOGO_Y+18,{align:'center'});
  // Divider line inside logo
  doc.setDrawColor(255,255,255);
  doc.setLineWidth(0.3);
  doc.line(LOGO_X+4,LOGO_Y+13.5,LOGO_X+LOGO_SZ-4,LOGO_Y+13.5);

  // Company name & subtitle
  doc.setTextColor(255,255,255);
  doc.setFont('helvetica','bold');
  doc.setFontSize(16);
  doc.text('CamCom',LOGO_X+LOGO_SZ+5,LOGO_Y+9);
  doc.setFont('helvetica','normal');
  doc.setFontSize(8);
  doc.setTextColor(148,163,184);
  doc.text('Annotation Tracker',LOGO_X+LOGO_SZ+5,LOGO_Y+15);

  // Report type label (right side)
  doc.setFillColor(223,30,38);
  doc.roundedRect(W-MARGIN-38,LOGO_Y,38,10,2,2,'F');
  doc.setTextColor(255,255,255);
  doc.setFont('helvetica','bold');
  doc.setFontSize(7);
  doc.text('DAILY REPORT',W-MARGIN-19,LOGO_Y+6.5,{align:'center'});

  // Date & recipient
  doc.setFont('helvetica','normal');
  doc.setFontSize(7.5);
  doc.setTextColor(148,163,184);
  doc.text(repDate,LOGO_X+LOGO_SZ+5,LOGO_Y+22);
  if(sendTo){
    doc.setTextColor(203,213,225);
    doc.text('To: '+sendTo,W-MARGIN,LOGO_Y+22,{align:'right'});
  }

  // ‚îÄ‚îÄ PROJECT TITLE BAND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  doc.setFillColor(241,245,249);
  doc.rect(0,HDR_H,W,26,'F');
  // Priority color left bar
  doc.setFillColor(...pc);
  doc.rect(0,HDR_H,5,26,'F');

  const pname=p.name.length>50?p.name.substr(0,47)+'...':p.name;
  doc.setTextColor(15,23,42);
  doc.setFont('helvetica','bold');
  doc.setFontSize(13);
  doc.text(pname,MARGIN+2,HDR_H+11);

  // Priority pill
  const priLbl={high:'HIGH PRIORITY',medium:'MEDIUM PRIORITY',low:'LOW PRIORITY'}[p.priority||'medium'];
  const pillW=36;
  doc.setFillColor(...pc);
  doc.roundedRect(W-MARGIN-pillW,HDR_H+3,pillW,8,2,2,'F');
  doc.setTextColor(255,255,255);
  doc.setFont('helvetica','bold');
  doc.setFontSize(6);
  doc.text(priLbl,W-MARGIN-pillW/2,HDR_H+8,{align:'center'});

  // Status text
  const statMap={todo:'To Do',inprog:'In Progress',review:'Under Review',done:'Completed'};
  const statLblClean=statMap[p.kanbanStatus||'todo']||'To Do';
  doc.setTextColor(71,85,105);
  doc.setFont('helvetica','normal');
  doc.setFontSize(8);
  doc.text('Status: '+statLblClean+'   |   Assigned by: '+(p.assignedby||'‚Äî'),MARGIN+2,HDR_H+20);

  // ‚îÄ‚îÄ BODY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let y=HDR_H+34;

  // ‚îÄ‚îÄ Section header helper ‚îÄ‚îÄ
  const secHdr=(title,icon,color)=>{
    doc.setFillColor(...color);
    doc.roundedRect(MARGIN,y,CONTENT_W,8,1.5,1.5,'F');
    doc.setTextColor(255,255,255);
    doc.setFont('helvetica','bold');
    doc.setFontSize(7.5);
    doc.text(icon+'  '+title,MARGIN+4,y+5.5);
    y+=12;
  };

  // ‚îÄ‚îÄ Field row helper ‚îÄ‚îÄ
  const fieldRow=(label,value,labelW=52)=>{
    doc.setFont('helvetica','bold');
    doc.setFontSize(8);
    doc.setTextColor(100,116,139);
    doc.text(label,MARGIN+2,y);
    doc.setFont('helvetica','normal');
    doc.setTextColor(15,23,42);
    const maxW=CONTENT_W-labelW-4;
    const lines=doc.splitTextToSize(String(value||'‚Äî'),maxW);
    doc.text(lines,MARGIN+labelW,y);
    y+=lines.length*5+2;
  };

  // ‚îÄ‚îÄ Stat box helper ‚îÄ‚îÄ
  const statBox=(label,value,bx,by,bw,bh,valColor)=>{
    doc.setFillColor(248,250,252);
    doc.setDrawColor(226,232,240);
    doc.setLineWidth(0.3);
    doc.roundedRect(bx,by,bw,bh,2,2,'FD');
    doc.setFont('helvetica','bold');
    doc.setFontSize(13);
    doc.setTextColor(...(valColor||[15,23,42]));
    doc.text(String(value),bx+bw/2,by+bh/2+2,{align:'center'});
    doc.setFont('helvetica','normal');
    doc.setFontSize(6.5);
    doc.setTextColor(100,116,139);
    doc.text(label.toUpperCase(),bx+bw/2,by+bh-3,{align:'center'});
  };

  // ‚îÄ‚îÄ Progress bar helper ‚îÄ‚îÄ
  const progBar=(label,val,maxVal,fillColor,showPct=true)=>{
    const pv=maxVal>0?Math.round((val/maxVal)*100):0;
    const barW=CONTENT_W-6;
    doc.setFont('helvetica','bold');doc.setFontSize(7.5);doc.setTextColor(51,65,85);
    doc.text(label,MARGIN+2,y);
    if(showPct){
      doc.setTextColor(...fillColor);
      doc.text(pv+'%',W-MARGIN-2,y,{align:'right'});
    }
    y+=3;
    // Track
    doc.setFillColor(226,232,240);doc.roundedRect(MARGIN+2,y,barW,4.5,1.5,1.5,'F');
    // Fill
    if(pv>0){doc.setFillColor(...fillColor);doc.roundedRect(MARGIN+2,y,barW*pv/100,4.5,1.5,1.5,'F');}
    y+=9;
  };

  // ‚îÄ‚îÄ Divider ‚îÄ‚îÄ
  const divider=()=>{
    doc.setDrawColor(226,232,240);doc.setLineWidth(0.3);
    doc.line(MARGIN,y-2,W-MARGIN,y-2);
  };

  // ‚ïê‚ïê‚ïê SECTION 1: IMAGE PROGRESS ‚ïê‚ïê‚ïê
  secHdr('IMAGE PROGRESS','',  [37,99,235]);

  // 5 stat boxes
  const boxData=[
    {l:'Total',v:T.toLocaleString(),c:[15,23,42]},
    {l:'Annotated',v:A.toLocaleString(),c:[37,99,235]},
    {l:'Reviewed',v:R.toLocaleString(),c:[22,163,74]},
    {l:'Pend. Ann.',v:pendAnn.toLocaleString(),c:[217,119,6]},
    {l:'Pend. Rev.',v:pendRev.toLocaleString(),c:[124,58,237]},
  ];
  const nbx=5,bxGap=2,bxW=(CONTENT_W-(nbx-1)*bxGap)/nbx,bxH=22;
  boxData.forEach((b,i)=>statBox(b.l,b.v,MARGIN+i*(bxW+bxGap),y,bxW,bxH,b.c));
  y+=bxH+6;

  progBar('Annotation Progress',A,T,[59,130,246]);
  progBar('Review Progress',R,T,[22,163,74]);

  if(p.hasTarget&&p.dailyTarget){
    doc.setFillColor(255,251,235);
    doc.setDrawColor(253,230,138);
    doc.setLineWidth(0.3);
    doc.roundedRect(MARGIN,y,CONTENT_W,10,2,2,'FD');
    doc.setFont('helvetica','bold');doc.setFontSize(7.5);doc.setTextColor(180,83,9);
    doc.text('Daily Target: '+p.dailyTarget+' images/day',MARGIN+4,y+6.5);
    if(pendAnn>0){
      doc.setFont('helvetica','normal');doc.setTextColor(120,53,15);
      doc.text('Est. completion: '+Math.ceil(pendAnn/p.dailyTarget)+' days remaining',W-MARGIN-2,y+6.5,{align:'right'});
    }
    y+=14;
  }

  // ‚ïê‚ïê‚ïê SECTION 2: PROJECT DETAILS ‚ïê‚ïê‚ïê
  y+=2;
  secHdr('PROJECT DETAILS','', [51,65,85]);

  // Two-column grid for details
  const col1x=MARGIN, col2x=MARGIN+CONTENT_W/2+2, colW=CONTENT_W/2-4;
  const detailPairs=[
    ['Assigned By', p.assignedby||'‚Äî'],
    ['Deadline', fmtD(p.deadline)||'‚Äî'],
    ['Days Left', dl?(dl.diff<0?'OVERDUE by '+Math.abs(dl.diff)+'d':dl.diff+' days remaining'):'‚Äî'],
    ['Start Date', fmtD(p.startdate)||'‚Äî'],
    ['Tags', tags],
    ['Kanban Status', statLblClean],
  ];
  const savedY=y;
  // Left column
  [detailPairs[0],detailPairs[2],detailPairs[4]].forEach(([lbl,val])=>{
    doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(100,116,139);
    doc.text(lbl.toUpperCase(),col1x,y);y+=4;
    doc.setFont('helvetica','normal');doc.setFontSize(8.5);doc.setTextColor(15,23,42);
    const vlines=doc.splitTextToSize(String(val),colW);
    doc.text(vlines,col1x,y);y+=vlines.length*5+4;
  });
  const afterLeft=y;
  y=savedY;
  // Right column
  [detailPairs[1],detailPairs[3],detailPairs[5]].forEach(([lbl,val])=>{
    doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(100,116,139);
    doc.text(lbl.toUpperCase(),col2x,y);y+=4;
    doc.setFont('helvetica','normal');doc.setFontSize(8.5);
    // Color overdue dates red
    if(lbl==='Days Left'&&dl&&dl.diff<0)doc.setTextColor(220,38,38);
    else doc.setTextColor(15,23,42);
    const vlines=doc.splitTextToSize(String(val),colW);
    doc.text(vlines,col2x,y);y+=vlines.length*5+4;
  });
  y=Math.max(afterLeft,y)+2;

  // ‚ïê‚ïê‚ïê SECTION 3: TEAM ‚ïê‚ïê‚ïê
  secHdr('TEAM','', [124,58,237]);

  doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(100,116,139);
  doc.text('ANNOTATORS',MARGIN,y);y+=4;
  doc.setFont('helvetica','normal');doc.setFontSize(8.5);doc.setTextColor(15,23,42);
  const annL=doc.splitTextToSize(annotators,CONTENT_W);
  doc.text(annL,MARGIN,y);y+=annL.length*5+5;

  doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(100,116,139);
  doc.text('REVIEWERS',MARGIN,y);y+=4;
  doc.setFont('helvetica','normal');doc.setFontSize(8.5);doc.setTextColor(15,23,42);
  const revL=doc.splitTextToSize(reviewers,CONTENT_W);
  doc.text(revL,MARGIN,y);y+=revL.length*5+4;

  // ‚ïê‚ïê‚ïê SECTION 4: NOTES ‚ïê‚ïê‚ïê
  if(p.notes&&p.notes.trim()){
    y+=2;
    secHdr('NOTES','', [71,85,105]);
    doc.setFont('helvetica','normal');doc.setFontSize(8.5);doc.setTextColor(15,23,42);
    const nLines=doc.splitTextToSize(p.notes,CONTENT_W);
    nLines.slice(0,12).forEach(l=>{
      if(y>272){doc.addPage();y=20;}
      doc.text(l,MARGIN,y);y+=5;
    });
    y+=3;
  }

  // ‚ïê‚ïê‚ïê SECTION 5: COMMENTS ‚ïê‚ïê‚ïê
  if(p.comments&&p.comments.trim()){
    y+=2;
    secHdr('COMMENTS','', [71,85,105]);
    doc.setFont('helvetica','normal');doc.setFontSize(8.5);doc.setTextColor(15,23,42);
    const cLines=doc.splitTextToSize(p.comments,CONTENT_W);
    cLines.slice(0,12).forEach(l=>{
      if(y>272){doc.addPage();y=20;}
      doc.text(l,MARGIN,y);y+=5;
    });
  }

  // ‚îÄ‚îÄ FOOTER (all pages) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const totalPg=doc.internal.getNumberOfPages();
  for(let pg=1;pg<=totalPg;pg++){
    doc.setPage(pg);
    const FY=292;
    // Footer bar
    doc.setFillColor(15,23,42);
    doc.rect(0,FY-4,W,14,'F');
    doc.setFillColor(223,30,38);
    doc.rect(0,FY-4,6,14,'F');
    // Logo text in footer
    doc.setFont('helvetica','bold');doc.setFontSize(7);doc.setTextColor(255,255,255);
    doc.text('CamCom',MARGIN,FY+2);
    doc.setFont('helvetica','normal');doc.setTextColor(100,116,139);
    doc.text('Annotation Tracker',MARGIN+22,FY+2);
    // Center: generated time
    doc.setTextColor(100,116,139);
    doc.text('Generated: '+new Date().toLocaleString('en-IN'),W/2,FY+2,{align:'center'});
    // Right: page + preparer
    doc.setTextColor(148,163,184);
    doc.text('Page '+pg+' of '+totalPg+'   |   '+( currentUser?.name||'‚Äî'),W-MARGIN,FY+2,{align:'right'});
    // Thin red line above footer
    doc.setDrawColor(223,30,38);doc.setLineWidth(0.4);
    doc.line(0,FY-4,W,FY-4);
  }

  const fname='camcom_report_'+(p.name||'project').replace(/\s+/g,'_')+'_'+dateVal+'.pdf';
  doc.save(fname);
  toast('PDF Report downloaded','ok');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANAGE USERS (Admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderUsers(){
  const roleColors={admin:'#dc2626',manager:'#2563eb',reviewer:'#d97706',employee:'#16a34a'};
  document.getElementById('usersGrid').innerHTML=appUsers.map(u=>{
    const r=ROLES[u.role];const initls=u.name.split(' ').filter(Boolean).map(w=>w[0]).join('').substr(0,2).toUpperCase();
    const linkedEmp=u.empId?getEmp(u.empId):null;
    const isMe=currentUser&&u.id===currentUser.id;
    return`<div class="user-card">
      <div class="user-card-av" style="background:${r.color}">${initls}</div>
      <div class="user-card-info">
        <strong>${esc(u.name)}${isMe?' <span style="font-size:.62rem;color:var(--tx3);">(you)</span>':''}</strong>
        <span>${esc(u.email)}</span>
        <div style="margin-top:5px;display:flex;gap:5px;flex-wrap:wrap;align-items:center;">
          <span class="role-pill ${r.pill}">${r.icon} ${r.label}</span>
          ${linkedEmp?`<span style="font-size:.68rem;color:var(--tx3);"><i class="fas fa-link"></i> ${esc(linkedEmp.name)}</span>`:''}
          <span style="font-size:.67rem;color:var(--tx3);font-family:monospace;">pwd: ${esc(u.pwd)}</span>
        </div>
      </div>
      <div class="user-card-actions">
        ${!isMe?`<button class="iBtn" onclick="openUserModal('${u.id}')" title="Edit"><i class="fas fa-pen"></i></button>
        <button class="iBtn del" onclick="deleteUser('${u.id}')" title="Delete"><i class="fas fa-trash"></i></button>`:''}
      </div>
    </div>`;
  }).join('');
}

function openUserModal(id=null){
  editUserId=id||null;
  const isEdit=!!id;
  document.getElementById('uMTtl').textContent=isEdit?'Edit User':'Add User';
  if(isEdit){
    const u=appUsers.find(x=>x.id===id);if(!u)return;
    document.getElementById('fu-name').value=u.name;
    document.getElementById('fu-email').value=u.email;
    document.getElementById('fu-pwd').value=u.pwd;
    document.getElementById('fu-role').value=u.role;
    // populate emp select
    populateEmpSelect();document.getElementById('fu-empId').value=u.empId||'';
    onRoleChange();
  } else {
    ['fu-name','fu-email','fu-pwd'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('fu-role').value='employee';
    populateEmpSelect();onRoleChange();
  }
  document.getElementById('userOvl').classList.add('open');
}
function closeUserModal(){document.getElementById('userOvl').classList.remove('open');}
function onRoleChange(){
  const role=document.getElementById('fu-role').value;
  const showLink=['employee','reviewer','manager'].includes(role);
  document.getElementById('empLinkWrap').style.display=showLink?'':'none';
  const note=document.getElementById('emp-auto-note');
  if(note)note.style.display=showLink?'':'none';
}
function populateEmpSelect(){
  const sel=document.getElementById('fu-empId');
  sel.innerHTML='<option value="">‚Äî Select employee record ‚Äî</option>'+
    employees.map(e=>`<option value="${e.id}">${esc(e.name)} (${e.gender==='male'?'‚ôÇ':'‚ôÄ'})</option>`).join('');
}
async function saveUser(){
  const name=document.getElementById('fu-name').value.trim();
  const email=document.getElementById('fu-email').value.trim().toLowerCase();
  const pwd=document.getElementById('fu-pwd').value.trim();
  const role=document.getElementById('fu-role').value;
  const empId=role==='employee'?(document.getElementById('fu-empId').value||null):null;
  if(!name){toast('Name is required','err');return;}
  if(!email){toast('Email is required','err');return;}
  if(!pwd){toast('Password is required','err');return;}
  // Check email uniqueness
  const dup=appUsers.find(u=>u.email===email&&u.id!==editUserId);
  if(dup){toast('Email already in use by another user','err');return;}
  const uid = editUserId || ('u_'+Date.now());
  if(editUserId){
    const idx=appUsers.findIndex(u=>u.id===editUserId);
    if(idx>-1){appUsers[idx]={...appUsers[idx],name,email,pwd,role,empId};toast('User updated ‚úì','ok');}
  } else {
    appUsers.push({id:uid,name,email,pwd,role,empId});
    toast('User added ‚úì','ok');
  }
  // ‚îÄ‚îÄ Auto-sync to employees array so they appear in workload/assignment ‚îÄ‚îÄ
  const empRole = ['employee','reviewer','manager'].includes(role);
  if(empRole){
    // Use empId if linked, otherwise use uid as emp id
    const eid = empId || uid;
    const existing = employees.find(e=>e.id===eid || e.email===email);
    if(existing){
      // Update name/email if changed
      existing.name = name;
      existing.email = email;
    } else {
      // Add new employee record
      employees.push({id:eid, name, email, gender:'male'});
    }
    // Ensure the user's empId is linked
    const uIdx = appUsers.findIndex(u=>u.id===uid||u.id===editUserId);
    if(uIdx>-1) appUsers[uIdx].empId = eid;
  }
  await Promise.all([saveUsersToDB(),saveEmpsToDB()]);closeUserModal();renderUsers();renderEmps();renderStats();
}
async function deleteUser(id){
  if(id===currentUser?.id){toast("You can't delete your own account",'err');return;}
  if(!confirm('Delete this user? They will no longer be able to sign in.'))return;
  const u=appUsers.find(x=>x.id===id);
  appUsers=appUsers.filter(u=>u.id!==id);
  // Also remove from employees if linked
  if(u?.empId){
    employees=employees.filter(e=>e.id!==u.empId);
    projects.forEach(p=>{
      p.assignedEmployees=(p.assignedEmployees||[]).filter(e=>e!==u.empId);
      p.reviewEmployees=(p.reviewEmployees||[]).filter(e=>e!==u.empId);
    });
  }
  await Promise.all([saveUsersToDB(),saveEmpsToDB()]);
  renderUsers();renderEmps();renderProjects();renderStats();toast('User removed','info');
}

// START ‚Äî restore session or show login
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme(){
  const html=document.documentElement;
  const isDark=html.getAttribute('data-theme')==='dark';
  html.setAttribute('data-theme',isDark?'light':'dark');
  localStorage.setItem('cc_theme',isDark?'light':'dark');
  const ico=document.getElementById('tIco');const lbl=document.getElementById('tLbl');
  if(ico)ico.className=isDark?'fas fa-moon':'fas fa-sun';
  if(lbl)lbl.textContent=isDark?'Dark mode':'Light mode';
}
function loadTheme(){
  const t=localStorage.getItem('cc_theme')||'light';
  document.documentElement.setAttribute('data-theme',t);
  const ico=document.getElementById('tIco');const lbl=document.getElementById('tLbl');
  if(ico)ico.className=t==='dark'?'fas fa-sun':'fas fa-moon';
  if(lbl)lbl.textContent=t==='dark'?'Light mode':'Dark mode';
}
loadTheme();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIS-CONFIG REALTIME SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveVisConfigDB(){
  saveVisConfig(); // always save locally first
  try{
    await sb.from('app_settings').upsert({key:'vis_config',value:JSON.stringify(visConfig)},{onConflict:'key'});
  }catch(e){ /* table may not exist yet ‚Äî fallback is localStorage */ }
}

// Poll every 5s as fallback for environments where WebSocket is blocked
function startVisConfigPoll(){
  setInterval(async()=>{
    if(!currentUser)return;
    try{
      const{data}=await sb.from('app_settings').select('value').eq('key','vis_config').single();
      if(data?.value){
        const remote=JSON.parse(data.value);
        if(JSON.stringify(remote)!==JSON.stringify(visConfig)){
          Object.assign(visConfig,remote);
          saveVisConfig();
          applyRoleToUI();
          if(currentUser.role!=='admin')toast('‚öôÔ∏è Access settings updated','info');
        }
      }
    }catch(e){}
  },5000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE REALTIME ‚Äî project changes + access control sync
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _rtChannel=null, _lastSave=0;

function startRealtime(){
  if(_rtChannel)return;
  try{
    _rtChannel=sb.channel('cc-realtime')
      .on('postgres_changes',{event:'*',schema:'public',table:'projects'},(pl)=>{
        const {eventType,new:nr,old:or}=pl;
        if(nr&&_ownSaves&&_ownSaves.has(nr.id)&&Date.now()-(_ownSaves.get(nr.id)||0)<3000)return;
        if(eventType==='DELETE'){projects=projects.filter(p=>p.id!==or.id);renderAll();toast('Project deleted by another user','info');return;}
        const mapped={
          id:nr.id,name:nr.name,client:nr.client||'',labellink:nr.labellink||'',
          total:nr.total||0,annotated:nr.annotated||0,reviewed:nr.reviewed||0,
          priority:nr.priority||'medium',startdate:nr.startdate||'',deadline:nr.deadline||'',
          assignedby:nr.assignedby||'',notes:nr.notes||'',comments:nr.comments||'',
          hasTarget:nr.has_target||false,dailyTarget:nr.daily_target||null,
          kanbanStatus:nr.kanban_status||'todo',
          assignedEmployees:nr.assigned_employees?nr.assigned_employees.split(',').filter(Boolean):[],
          reviewEmployees:nr.review_employees?nr.review_employees.split(',').filter(Boolean):[],
          tags:nr.tags?nr.tags.split(',').filter(Boolean):[]
        };
        if(eventType==='INSERT'){if(!projects.find(p=>p.id===mapped.id)){projects.unshift(mapped);renderAll();toast(`New project: "${mapped.name}"`,'ok');}}
        else if(eventType==='UPDATE'){
          const i=projects.findIndex(p=>p.id===mapped.id);
          if(i>=0){
            const prev=projects[i];
            projects[i]=mapped;
            renderAll();
            if(openProjId===mapped.id)renderDPBody(mapped);
            if((mapped.assignedEmployees||[]).includes(currentUser?.empId)||(mapped.reviewEmployees||[]).includes(currentUser?.empId)){
              if(prev.kanbanStatus!==mapped.kanbanStatus)toast(`"${mapped.name}" moved to ${KB_LABELS[mapped.kanbanStatus]||mapped.kanbanStatus}`,'info');
            }
          }
        }
      })
      .on('postgres_changes',{event:'*',schema:'public',table:'app_settings'},(pl)=>{
        const row=pl.new;
        if(!row)return;
        try{
          if(row.key==='vis_config'){
            const remote=JSON.parse(row.value);
            if(JSON.stringify(remote)!==JSON.stringify(visConfig)){Object.assign(visConfig,remote);saveVisConfig();applyRoleToUI();if(currentUser?.role!=='admin')toast('Access settings updated','info');}
          } else if(row.key==='app_users'){
            const remote=JSON.parse(row.value);
            if(remote&&remote.length){
              const savedIds=new Set(remote.map(u=>u.id));
              const merged=[...remote];
              DEFAULT_USERS.forEach(du=>{if(!savedIds.has(du.id))merged.push(du);});
              appUsers=merged;saveUsersLocal();
              renderStats();
              if(document.getElementById('usersPage')?.style.display!=='none')renderUsers();
            }
          } else if(row.key==='app_emps'){
            const remote=JSON.parse(row.value);
            if(remote&&remote.length){employees=remote;saveEmpsLocal();renderStats();renderEmps();renderProjects();}
          }
        }catch(e){}
      })
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'project_comments'},(pl)=>{
        const nr=pl.new;if(!nr)return;
        const cmt={id:nr.id,parentId:nr.parent_id||null,authorId:nr.author_id,author:nr.author,role:nr.role,text:nr.text,ts:nr.ts,mentions:nr.mentions?JSON.parse(nr.mentions):[]};
        if(!threadedComments[nr.proj_id])threadedComments[nr.proj_id]=[];
        if(!threadedComments[nr.proj_id].find(c=>c.id===cmt.id)){
          threadedComments[nr.proj_id].push(cmt);saveThreadedComments();
          if(openProjId===nr.proj_id){renderThreadList(nr.proj_id);const cnt=document.getElementById('tc-count-'+nr.proj_id);if(cnt)cnt.textContent='('+(threadedComments[nr.proj_id]||[]).filter(c=>!c.parentId).length+')';}
        }
      })
      .on('postgres_changes',{event:'DELETE',schema:'public',table:'project_comments'},(pl)=>{
        const or=pl.old;if(!or||!threadedComments[or.proj_id])return;
        threadedComments[or.proj_id]=threadedComments[or.proj_id].filter(c=>c.id!==or.id&&c.parentId!==or.id);
        saveThreadedComments();if(openProjId===or.proj_id)renderThreadList(or.proj_id);
      })
      .subscribe(status=>{
        const dot=document.getElementById('rt-dot');
        const badge=document.getElementById('rt-badge');
        const on=status==='SUBSCRIBED';
        if(dot)dot.style.display=on?'inline-block':'none';
        if(badge)badge.style.display=on?'':'none';
      });
  }catch(e){console.warn('Realtime unavailable:',e);}
}

// saveProjDB already includes _lastSave and _ownSaves tracking (see above)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THREADED COMMENTS + @MENTIONS + NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let threadedComments={};   // { projId: [{id,parentId,authorId,author,role,text,ts,mentions:[]}] }
let notifications=[];      // [{id,userId,projId,projName,cmtId,author,text,ts,read}]
let _replyTo=null;         // {projId,cmtId,authorName}
let _mentionActive=false;

const ROLE_COLORS={admin:'#dc2626',manager:'#2563eb',reviewer:'#d97706',employee:'#16a34a',stakeholder:'#7c3aed'};

function loadThreadedComments(){try{const s=localStorage.getItem('cc_threads');if(s)threadedComments=JSON.parse(s);}catch(e){}}
function saveThreadedComments(){try{localStorage.setItem('cc_threads',JSON.stringify(threadedComments));}catch(e){}}
async function loadCommentsFromDB(projId){
  try{
    const{data,error}=await sb.from('project_comments').select('*').eq('proj_id',projId).order('ts',{ascending:true});
    if(error||!data)return;
    threadedComments[projId]=data.map(r=>({id:r.id,parentId:r.parent_id||null,authorId:r.author_id,author:r.author,role:r.role,text:r.text,ts:r.ts,mentions:r.mentions?JSON.parse(r.mentions):[]}));
    saveThreadedComments();
    renderThreadList(projId);
    const cnt=document.getElementById('tc-count-'+projId);
    if(cnt)cnt.textContent='('+(threadedComments[projId]||[]).filter(c=>!c.parentId).length+')';
  }catch(e){}
}
async function saveCommentToDB(projId,cmt){
  try{await sb.from('project_comments').upsert({id:cmt.id,proj_id:projId,parent_id:cmt.parentId||null,author_id:cmt.authorId,author:cmt.author,role:cmt.role,text:cmt.text,ts:cmt.ts,mentions:JSON.stringify(cmt.mentions||[])},{onConflict:'id'});}catch(e){}
}
async function deleteCommentFromDB(cmtId){
  try{await sb.from('project_comments').delete().eq('id',cmtId);}catch(e){}
}
function loadNotifications(){try{const s=localStorage.getItem('cc_notifs');if(s)notifications=JSON.parse(s);}catch(e){}}
function saveNotifications(){try{localStorage.setItem('cc_notifs',JSON.stringify(notifications));}catch(e){}}

function avInit(name){return(name||'?').split(' ').filter(Boolean).map(w=>w[0]).join('').substr(0,2).toUpperCase();}

function renderCommentText(text){
  // highlight @mentions
  return esc(text).replace(/@([\w][\w\s]*[\w])/g,(match,name)=>{
    const e=employees.find(e=>e.name.toLowerCase()===name.toLowerCase());
    return e?`<span class="tc-mention">@${esc(name)}</span>`:match;
  });
}

function parseMentions(text){
  const re=/@([\w][\w\s]{0,40}[\w])/g;
  const found=[];let m;
  while((m=re.exec(text))!==null){
    const emp=employees.find(e=>e.name.toLowerCase()===m[1].trim().toLowerCase());
    if(emp&&!found.includes(emp.id))found.push(emp.id);
  }
  return found;
}

// ‚îÄ‚îÄ Render the thread list into #tc-list-{projId} ‚îÄ‚îÄ
function renderThreadList(projId){
  const wrap=document.getElementById('tc-list-'+projId);
  if(!wrap)return;
  const cmts=threadedComments[projId]||[];
  const roots=cmts.filter(c=>!c.parentId);
  const unreadIds=new Set(notifications.filter(n=>n.userId===currentUser?.id&&!n.read&&n.projId===projId).map(n=>n.cmtId));

  if(!roots.length){wrap.innerHTML='<div style="padding:20px 16px;font-size:.8rem;color:var(--tx3);text-align:center;"><i class="fas fa-comments" style="display:block;font-size:1.4rem;margin-bottom:7px;opacity:.35;"></i>No comments yet. Be the first!</div>';return;}

  function build(cmt,depth){
    const isMe=cmt.authorId===currentUser?.id;
    const replies=cmts.filter(c=>c.parentId===cmt.id);
    const rc=ROLE_COLORS[cmt.role]||'#64748b';
    const unread=unreadIds.has(cmt.id);
    const canDel=isMe||currentUser?.role==='admin';
    return `<div class="tc-item${isMe?' tc-mine':''}${unread?' tc-unread':''}">
      <div class="tc-hdr">
        <div class="tc-av" style="background:${rc}">${avInit(cmt.author)}</div>
        <div class="tc-meta">
          <span class="tc-name">${esc(cmt.author)}</span>
          <span class="tc-role" style="background:${rc}22;color:${rc}">${cmt.role}</span>
        </div>
        <span class="tc-time">${fmtAgo(cmt.ts)}</span>
      </div>
      <div class="tc-body">${renderCommentText(cmt.text)}</div>
      <div class="tc-actions">
        <button class="tc-btn" onclick="startReply('${projId}','${cmt.id}','${esc(cmt.author)}')"><i class="fas fa-reply"></i> Reply</button>
        ${canDel?`<button class="tc-btn del" onclick="deleteComment('${projId}','${cmt.id}')"><i class="fas fa-trash"></i></button>`:''}
      </div>
      ${replies.length?`<div class="tc-replies">${replies.map(r=>build(r,depth+1)).join('')}</div>`:''}
    </div>`;
  }

  wrap.innerHTML=roots.map(c=>build(c,0)).join('');

  // Mark as read when viewed
  const toRead=notifications.filter(n=>n.userId===currentUser?.id&&!n.read&&n.projId===projId);
  if(toRead.length){toRead.forEach(n=>n.read=true);saveNotifications();updateNbDot();renderNotifList();}

  // Update count header
  const cnt=document.getElementById('tc-count-'+projId);
  if(cnt)cnt.textContent=`(${roots.length})`;
}

// ‚îÄ‚îÄ Post a new comment ‚îÄ‚îÄ
async function postComment(projId){
  if(!currentUser)return;
  const inp=document.getElementById('tc-inp-'+projId);
  if(!inp)return;
  const text=inp.value.trim();
  if(!text)return;
  const p=projects.find(x=>x.id===projId);if(!p)return;

  const mentions=parseMentions(text);
  const cmt={
    id:'c'+Date.now()+Math.random().toString(36).substr(2,4),
    parentId:_replyTo?.projId===projId?_replyTo.cmtId:null,
    authorId:currentUser.id, author:currentUser.name, role:currentUser.role,
    text, ts:new Date().toISOString(), mentions
  };
  if(!threadedComments[projId])threadedComments[projId]=[];
  threadedComments[projId].push(cmt);
  saveThreadedComments();

  // Create notifications for mentioned employees
  mentions.forEach(empId=>{
    const u=appUsers.find(u=>u.empId===empId);
    if(!u)return;
    notifications.push({
      id:'n'+Date.now()+Math.random().toString(36).substr(2,3),
      userId:u.id, projId, projName:p.name, cmtId:cmt.id, author:currentUser.name,
      text:`${currentUser.name} mentioned you in "${p.name}": ${text.substr(0,70)}${text.length>70?'‚Ä¶':''}`,
      ts:new Date().toISOString(), read:false
    });
  });
  // Notify project assignor if someone else comments
  if(p.assignedby&&currentUser.name!==p.assignedby){
    const mgr=appUsers.find(u=>u.name===p.assignedby);
    if(mgr&&!mentions.includes(mgr.empId||'')){
      notifications.push({
        id:'n'+Date.now()+'m',
        userId:mgr.id, projId, projName:p.name, cmtId:cmt.id, author:currentUser.name,
        text:`${currentUser.name} commented on "${p.name}": ${text.substr(0,70)}${text.length>70?'‚Ä¶':''}`,
        ts:new Date().toISOString(), read:false
      });
    }
  }
  saveNotifications();
  updateNbDot();
  inp.value='';
  inp.style.height='';
  cancelReply(projId);
  renderThreadList(projId);
  saveCommentToDB(projId,cmt);
}

function deleteComment(projId,cmtId){
  const cmts=threadedComments[projId]||[];
  const cmt=cmts.find(c=>c.id===cmtId);
  if(!cmt)return;
  if(cmt.authorId!==currentUser?.id&&currentUser?.role!=='admin'){toast('Can only delete your own comments','err');return;}
  threadedComments[projId]=cmts.filter(c=>c.id!==cmtId&&c.parentId!==cmtId);
  saveThreadedComments();
  renderThreadList(projId);
  deleteCommentFromDB(cmtId);
}

function startReply(projId,cmtId,authorName){
  _replyTo={projId,cmtId,authorName};
  const banner=document.getElementById('tc-reply-banner-'+projId);
  const label=document.getElementById('tc-reply-label-'+projId);
  if(banner)banner.style.display='flex';
  if(label)label.textContent='Replying to '+authorName;
  const inp=document.getElementById('tc-inp-'+projId);
  if(inp)inp.focus();
}

function cancelReply(projId){
  _replyTo=null;
  const banner=document.getElementById('tc-reply-banner-'+projId);
  if(banner)banner.style.display='none';
}

// ‚îÄ‚îÄ @Mention autocomplete ‚îÄ‚îÄ
function onCmtInput(e,projId){
  const inp=e.target;
  const val=inp.value,pos=inp.selectionStart;
  const before=val.substring(0,pos);
  const atIdx=before.lastIndexOf('@');
  if(atIdx>=0){
    const q=before.substring(atIdx+1);
    if(!q.includes('  ')&&q.length<32){showMentionPop(inp,q,projId);return;}
  }
  hideMentionPop();
}

function onCmtKey(e,projId){
  if(e.key==='Escape'){hideMentionPop();return;}
  if(e.key==='Enter'&&!e.shiftKey&&!_mentionActive){e.preventDefault();postComment(projId);}
}

function showMentionPop(inp,query,projId){
  let pop=document.getElementById('_mentionPop');
  if(!pop){pop=document.createElement('div');pop.id='_mentionPop';pop.className='mention-pop';document.body.appendChild(pop);}
  const list=employees.filter(e=>e.name.toLowerCase().includes(query.toLowerCase())).slice(0,8);
  if(!list.length){hideMentionPop();return;}
  const rect=inp.getBoundingClientRect();
  const above=window.innerHeight-rect.bottom<200&&rect.top>200;
  pop.style.cssText=`display:block;left:${Math.max(8,Math.min(rect.left,window.innerWidth-220))}px;${above?'bottom:'+(window.innerHeight-rect.top+4)+'px;':'top:'+(rect.bottom+4)+'px;'}`;
  pop.innerHTML=list.map(e=>`<div class="mention-row" onmousedown="event.preventDefault();insertMention('${projId}','${e.name.replace(/'/g,"\'")}')">
    <div class="m-av">${avInit(e.name)}</div>
    <div class="m-info"><div class="m-name">${esc(e.name)}</div><div class="m-email">${esc(e.email||'')}</div></div>
  </div>`).join('');
  _mentionActive=true;
}

function hideMentionPop(){
  const pop=document.getElementById('_mentionPop');
  if(pop)pop.style.display='none';
  _mentionActive=false;
}

function insertMention(projId,name){
  const inp=document.getElementById('tc-inp-'+projId);
  if(!inp)return;
  const val=inp.value,pos=inp.selectionStart;
  const before=val.substring(0,pos);
  const atIdx=before.lastIndexOf('@');
  inp.value=val.substring(0,atIdx)+'@'+name+' '+val.substring(pos);
  inp.focus();
  hideMentionPop();
}

// ‚îÄ‚îÄ Notification panel ‚îÄ‚îÄ
function toggleNotifPanel(){
  const p=document.getElementById('notifPanel');
  if(p){p.classList.toggle('open');if(p.classList.contains('open'))renderNotifList();}
}

function renderNotifList(){
  const list=document.getElementById('np-list');
  if(!list||!currentUser)return;
  const mine=notifications.filter(n=>n.userId===currentUser.id).sort((a,b)=>new Date(b.ts)-new Date(a.ts));
  if(!mine.length){list.innerHTML='<div class="np-empty"><i class="fas fa-check-circle" style="font-size:1.5rem;color:var(--green);display:block;margin-bottom:8px;"></i>All caught up!</div>';return;}
  list.innerHTML=mine.map(n=>`<div class="np-item${n.read?'':' unread'}" onclick="openNotif('${n.projId}','${n.id}')">
    <div class="${n.read?'np-read-dot':'np-unread-dot'}"></div>
    <div class="np-body">
      <div class="np-proj"><i class="fas fa-folder" style="margin-right:4px;"></i>${esc(n.projName)}</div>
      <div class="np-text">${esc(n.text)}</div>
      <div class="np-time">${fmtAgo(n.ts)}</div>
    </div>
  </div>`).join('');
}

function openNotif(projId,notifId){
  const n=notifications.find(x=>x.id===notifId);
  if(n)n.read=true;
  saveNotifications();updateNbDot();renderNotifList();
  toggleNotifPanel();
  const p=projects.find(x=>x.id===projId);if(p)openDP(p);
}

function markAllNotifsRead(){
  if(!currentUser)return;
  notifications.filter(n=>n.userId===currentUser.id).forEach(n=>n.read=true);
  saveNotifications();updateNbDot();renderNotifList();
}

function clearNotifs(){
  if(!currentUser)return;
  notifications=notifications.filter(n=>n.userId!==currentUser.id);
  saveNotifications();updateNbDot();renderNotifList();
  toast('Notifications cleared','info');
}

function updateNbDot(){
  if(!currentUser)return;
  const count=notifications.filter(n=>n.userId===currentUser.id&&!n.read).length;
  const dot=document.getElementById('nbDot');
  if(dot)dot.classList.toggle('on',count>0);
}

fillDemoLabels();
tryRestoreSession();
</script>

<!-- ‚ïê‚ïê‚ïê MODAL: DAILY REPORT ‚ïê‚ïê‚ïê -->
<div class="overlay" id="reportOvl" onclick="if(event.target===this)closeReport()">
<div class="modal" style="width:640px;">
  <div class="modal-title"><i class="fas fa-paper-plane" style="color:var(--blue)"></i><span>Daily Project Report</span></div>
  <div class="fgrid">
    <div class="ff full"><label>Select Project *</label>
      <select id="rep-proj" onchange="generateReport()"><option value="">‚Äî Select a project ‚Äî</option></select>
    </div>
    <div class="ff"><label>Report Date</label><input type="date" id="rep-date" onchange="generateReport()"></div>
    <div class="ff"><label>Send To (ML Team Member)</label><input type="text" id="rep-sendto" placeholder="Name or email of recipient" oninput="generateReport()"></div>
  </div>
  <div id="rep-preview-wrap" style="display:none;margin-bottom:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <label style="font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--tx3);">Report Preview</label>
      <button class="btn btn-ghost btn-sm" onclick="copyReport()"><i class="fas fa-copy"></i> Copy text</button>
    </div>
    <div class="report-preview" id="rep-preview"></div>
  </div>
  <div class="modal-foot">
    <button class="btn btn-ghost" onclick="closeReport()">Close</button>
    <button class="btn btn-ghost btn-sm" onclick="downloadReport()"><i class="fas fa-file-alt"></i> Download .txt</button>
    <button class="btn btn-green" onclick="downloadReportPDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
    <button class="btn btn-red" onclick="copyReport()"><i class="fas fa-copy"></i> Copy</button>
  </div>
</div></div>

<!-- ‚ïê‚ïê‚ïê MODAL: USER ‚ïê‚ïê‚ïê -->
<div class="overlay" id="userOvl" onclick="if(event.target===this)closeUserModal()">
<div class="modal" style="width:430px;">
  <div class="modal-title"><i class="fas fa-user-shield" style="color:var(--red)"></i><span id="uMTtl">Add User</span></div>
  <div class="fgrid">
    <div class="ff full"><label>Full Name *</label><input type="text" id="fu-name" placeholder="e.g. Priya Sharma"></div>
    <div class="ff full"><label>Email *</label><input type="email" id="fu-email" placeholder="priya at camcom.ai"></div>
    <div class="ff"><label>Password *</label><input type="password" id="fu-pwd" placeholder="Set password"></div>
    <div class="ff"><label>Role</label>
      <select id="fu-role" onchange="onRoleChange()">
        <option value="admin">&#x1F451; Admin</option>
        <option value="manager">&#x1F535; Manager</option>
        <option value="reviewer">&#x1F7E1; Reviewer</option>
        <option value="employee">&#x1F7E2; Employee</option>
        <option value="stakeholder">&#x1F7E3; Stakeholder</option>
      </select>
    </div>
    <div class="ff full" id="empLinkWrap" style="display:none;">
      <label>Link to Existing Employee Record <span style="font-weight:400;color:var(--tx3);font-size:.75rem;">(optional ‚Äî leave blank to auto-create)</span></label>
      <select id="fu-empId" style="width:100%;padding:7px 10px;border:1px solid var(--brd);border-radius:var(--rsm);background:var(--sur2);color:var(--tx);font-size:.83rem;"><option value="">‚Äî Auto-create new employee record ‚Äî</option></select>
      <p id="emp-auto-note" style="font-size:.73rem;color:var(--blue);margin:4px 0 0;"><i class="fas fa-info-circle"></i> This user will automatically appear in the Employees list and can be assigned to projects.</p>
    </div>
  </div>
  <div style="display:flex;gap:10px;justify-content:flex-end;padding:16px 20px 20px;border-top:1px solid var(--brd);margin-top:8px;">
    <button class="btn" onclick="closeUserModal()" style="background:var(--sur2);color:var(--tx);border:1px solid var(--brd);">Cancel</button>
    <button class="btn btn-red" onclick="saveUser()"><i class="fas fa-check"></i> Save User</button>
  </div>
</div>
