<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AnnotateHQ ¬∑ Project Manager</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg:#f0f4f9; --surface:#fff; --surface2:#f7fafd; --border:#dde5f0;
  --text:#0d1f33; --text2:#4a6080; --text3:#8098b4;
  --accent:#2563eb; --accent-light:#eff4ff;
  --green:#16a34a; --green-light:#dcfce7;
  --yellow:#d97706; --yellow-light:#fef3c7;
  --red:#dc2626; --red-light:#fee2e2;
  --purple:#7c3aed; --purple-light:#ede9fe;
  --shadow:0 4px 20px rgba(13,31,51,.07); --shadow-sm:0 2px 8px rgba(13,31,51,.05);
  --r:16px; --rsm:10px; --rpill:100px;
}
[data-theme="dark"] {
  --bg:#0d1117; --surface:#161b22; --surface2:#21262d; --border:#30363d;
  --text:#e6edf3; --text2:#8b949e; --text3:#484f58;
  --accent:#58a6ff; --accent-light:#1f2b3e;
  --green-light:#0d2a1a; --yellow-light:#2a1f0d;
  --red-light:#2a0d0d; --purple-light:#1e1430;
  --shadow:0 4px 20px rgba(0,0,0,.3); --shadow-sm:0 2px 8px rgba(0,0,0,.2);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;transition:background .3s,color .3s;}
h1,h2,h3{font-family:'Space Grotesk',sans-serif;}
a{color:inherit;text-decoration:none;}

/* LAYOUT */
.layout{display:flex;min-height:100vh;}
.sidebar{width:250px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;overflow-y:auto;}
.sidebar-logo{padding:22px 20px 14px;border-bottom:1px solid var(--border);}
.sidebar-logo h2{font-size:1.15rem;color:var(--accent);display:flex;align-items:center;gap:8px;}
.sidebar-logo span{font-size:.68rem;color:var(--text3);display:block;margin-top:2px;padding-left:26px;}
.nav-sec{padding:12px 14px 5px;font-size:.63rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 14px;margin:2px 8px;border-radius:var(--rsm);cursor:pointer;font-size:.86rem;font-weight:500;color:var(--text2);border:none;background:none;width:calc(100% - 16px);text-align:left;transition:all .15s;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:var(--accent-light);color:var(--accent);}
.nav-item i{width:16px;text-align:center;font-size:.82rem;}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:.62rem;padding:1px 7px;border-radius:20px;font-weight:700;}
.sidebar-bottom{margin-top:auto;padding:14px;border-top:1px solid var(--border);}
.theme-btn{display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--text2);cursor:pointer;padding:8px 10px;border-radius:var(--rsm);background:none;border:none;width:100%;font-family:'DM Sans',sans-serif;}
.theme-btn:hover{background:var(--surface2);}
.main{margin-left:250px;flex:1;padding:24px 28px;max-width:calc(100% - 250px);}
.page{display:none;} .page.active{display:block;}

/* TOPBAR */
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;gap:14px;flex-wrap:wrap;}
.page-title{font-size:1.55rem;font-weight:700;}
.topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.search-box{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--rpill);padding:8px 16px;min-width:210px;}
.search-box input{border:none;background:none;outline:none;color:var(--text);font-family:inherit;font-size:.86rem;width:100%;}
.search-box i{color:var(--text3);}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border-radius:var(--rpill);font-size:.84rem;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .15s;font-family:'DM Sans',sans-serif;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#1d4ed8;}
.btn-ghost{background:var(--surface);color:var(--text2);border-color:var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:var(--red-light);color:var(--red);}
.btn-danger:hover{background:var(--red);color:#fff;}
.btn-green{background:var(--green-light);color:var(--green);border-color:var(--green);}
.btn-green:hover{background:var(--green);color:#fff;}
.icon-btn{width:30px;height:30px;border-radius:8px;border:none;background:none;cursor:pointer;color:var(--text3);display:flex;align-items:center;justify-content:center;font-size:.78rem;transition:all .15s;}
.icon-btn:hover{background:var(--surface2);color:var(--text);}
.icon-btn.del:hover{background:var(--red-light);color:var(--red);}

/* STAT GRID */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:14px;margin-bottom:20px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);}
.stat-card.green::before{background:var(--green);}
.stat-card.yellow::before{background:var(--yellow);}
.stat-card.purple::before{background:var(--purple);}
.stat-card.red::before{background:var(--red);}
.stat-lbl{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:6px;}
.stat-val{font-size:1.9rem;font-weight:700;font-family:'Space Grotesk',sans-serif;line-height:1;}
.stat-sub{font-size:.72rem;color:var(--text3);margin-top:5px;}
.stat-ico{position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:1.8rem;opacity:.07;}

/* FILTERS */
.filters-bar{display:flex;gap:8px;align-items:center;margin-bottom:18px;flex-wrap:wrap;}
.fchip{padding:5px 13px;border-radius:var(--rpill);font-size:.78rem;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);transition:all .15s;}
.fchip:hover,.fchip.active{background:var(--accent-light);border-color:var(--accent);color:var(--accent);}
.fchip.hi{border-color:var(--red);color:var(--red);background:var(--red-light);}
.fchip.hi.active{background:var(--red);color:#fff;}
.fchip.me{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-light);}
.fchip.me.active{background:var(--yellow);color:#fff;}
.fchip.lo{border-color:var(--green);color:var(--green);background:var(--green-light);}
.fchip.lo.active{background:var(--green);color:#fff;}
select.fsel{padding:5px 13px;border-radius:var(--rpill);font-size:.78rem;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);outline:none;font-family:'DM Sans',sans-serif;}

/* PROJECT GRID */
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(390px,1fr));gap:18px;}
.proj-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow-sm);overflow:hidden;display:flex;flex-direction:column;transition:box-shadow .2s,transform .2s;}
.proj-card:hover{box-shadow:var(--shadow);transform:translateY(-1px);}

/* CARD TOP */
.card-top{padding:16px 16px 12px;border-bottom:1px solid var(--border);}
.card-title-row{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px;}
.card-title{font-family:'Space Grotesk',sans-serif;font-size:1.05rem;font-weight:700;}
.card-acts{display:flex;gap:3px;}
.card-meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:8px;}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 9px;border-radius:var(--rpill);font-size:.68rem;font-weight:700;text-transform:uppercase;}
.badge-high{background:var(--red-light);color:var(--red);}
.badge-medium{background:var(--yellow-light);color:var(--yellow);}
.badge-low{background:var(--green-light);color:var(--green);}
.meta-it{font-size:.73rem;color:var(--text3);display:flex;align-items:center;gap:4px;}
.meta-it.overdue{color:var(--red);}
.meta-it.soon{color:var(--yellow);}

/* ASSIGNED BY */
.assigned-by-row{font-size:.75rem;color:var(--text2);display:flex;align-items:center;gap:5px;}
.assigned-by-row strong{color:var(--text);}

/* INLINE NUMBERS */
.num-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:10px;}
.num-cell{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 6px 4px;display:flex;flex-direction:column;align-items:center;}
.num-cell input{width:100%;background:none;border:none;outline:none;font-weight:700;font-size:.88rem;color:var(--text);font-family:'Space Grotesk',sans-serif;text-align:center;}
.num-cell .nl{font-size:.6rem;color:var(--text3);text-transform:uppercase;letter-spacing:.3px;margin-top:2px;}
.num-computed{background:var(--accent-light);border-color:var(--accent);}
.num-computed .nv{font-weight:700;font-size:.88rem;color:var(--accent);font-family:'Space Grotesk',sans-serif;}

/* PROGRESS */
.prog-section{padding:12px 16px;border-bottom:1px solid var(--border);}
.prog-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.prog-lbl{font-size:.72rem;color:var(--text2);font-weight:500;}
.prog-pct{font-size:.72rem;font-weight:700;}
.prog-bar{height:5px;background:var(--surface2);border-radius:10px;overflow:hidden;margin-bottom:8px;}
.prog-fill{height:100%;border-radius:10px;transition:width .4s;}
.pf-ann{background:var(--accent);}
.pf-rev{background:var(--green);}

/* ASSIGNEES */
.asn-section{padding:12px 16px;border-bottom:1px solid var(--border);}
.sec-hdr{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:7px;}
.asn-row{display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.asn-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:7px;}
.asn-tag{display:inline-flex;align-items:center;gap:4px;background:var(--accent-light);border:1px solid var(--accent);color:var(--accent);padding:2px 8px;border-radius:var(--rpill);font-size:.73rem;font-weight:500;}
.asn-tag.conflict{background:var(--red-light);border-color:var(--red);color:var(--red);}
.asn-tag button{background:none;border:none;color:inherit;cursor:pointer;padding:0;display:flex;align-items:center;font-size:.62rem;opacity:.7;}
.asn-tag button:hover{opacity:1;}
.emp-select-multi{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--rsm);background:var(--surface2);color:var(--text);font-size:.82rem;font-family:'DM Sans',sans-serif;outline:none;min-height:90px;}
.emp-select-multi option:checked{background:var(--accent);color:#fff;}
.select-hint{font-size:.67rem;color:var(--text3);margin-top:4px;}

/* COMMENTS */
.cmt-section{padding:12px 16px;}
.cmt-textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--rsm);background:var(--surface2);color:var(--text);font-size:.82rem;font-family:'DM Sans',sans-serif;resize:vertical;min-height:60px;outline:none;}
.cmt-textarea:focus{border-color:var(--accent);}
.save-cmt-btn{margin-top:6px;padding:5px 14px;font-size:.76rem;}

/* CONFLICT BANNER */
.conflict-banner{display:flex;align-items:center;gap:8px;padding:9px 14px;background:var(--red-light);border:1px solid var(--red);border-radius:var(--rsm);color:var(--red);font-size:.8rem;font-weight:600;margin-bottom:16px;}

/* EMPLOYEE TABLE */
.emp-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow-sm);}
table{width:100%;border-collapse:collapse;}
th{background:var(--surface2);padding:10px 14px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--text3);text-align:left;border-bottom:1px solid var(--border);}
td{padding:10px 14px;font-size:.84rem;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--surface2);}
.emp-status-free{color:var(--text3);font-size:.75rem;}
.emp-status-assigned{color:var(--green);font-weight:600;font-size:.75rem;}
.emp-status-conflict{color:var(--red);font-weight:700;font-size:.75rem;}
.gender-m{color:#3b82f6;font-size:.75rem;font-weight:600;}
.gender-f{color:#ec4899;font-size:.75rem;font-weight:600;}

/* WORKLOAD */
.wl-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow-sm);margin-bottom:18px;}
.wl-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);gap:10px;flex-wrap:wrap;}
.wl-row:last-child{border-bottom:none;}
.wl-name{font-weight:600;font-size:.88rem;min-width:160px;}
.wl-projs{color:var(--text3);font-size:.78rem;flex:1;}
.wl-bar-wrap{width:160px;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border-radius:20px;padding:26px;width:580px;max-width:95vw;box-shadow:0 20px 60px rgba(0,0,0,.2);transform:translateY(20px);transition:transform .2s;max-height:90vh;overflow-y:auto;}
.overlay.open .modal{transform:translateY(0);}
.modal-title{font-size:1.15rem;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
.ff{display:flex;flex-direction:column;gap:4px;}
.ff.full{grid-column:1/-1;}
.ff label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:var(--text3);}
.ff input,.ff select,.ff textarea{padding:8px 12px;border:1px solid var(--border);border-radius:var(--rsm);background:var(--surface2);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.86rem;outline:none;transition:border-color .15s;}
.ff input:focus,.ff select:focus,.ff textarea:focus{border-color:var(--accent);}
.modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:18px;padding-top:14px;border-top:1px solid var(--border);}

/* TOAST */
.toast-wrap{position:fixed;bottom:22px;right:22px;z-index:999;display:flex;flex-direction:column;gap:7px;}
.toast{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 16px;font-size:.83rem;box-shadow:var(--shadow);display:flex;align-items:center;gap:8px;animation:slideIn .2s ease;max-width:300px;}
.toast.success{border-color:var(--green);color:var(--green);}
.toast.error{border-color:var(--red);color:var(--red);}
.toast.info{border-color:var(--accent);color:var(--accent);}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* EMPTY */
.empty{text-align:center;padding:50px 20px;color:var(--text3);}
.empty i{font-size:2.5rem;margin-bottom:10px;display:block;}
.empty h3{font-size:.95rem;color:var(--text2);margin-bottom:5px;}

/* LOADING */
#loadingOverlay{position:fixed;inset:0;background:rgba(13,31,51,.5);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:#fff;font-family:'DM Sans',sans-serif;gap:14px;}
.spin{width:44px;height:44px;border:4px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:768px){
  .sidebar{transform:translateX(-100%);}
  .main{margin-left:0;max-width:100%;padding:14px;}
  .proj-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div id="loadingOverlay" style="display:none;">
  <div class="spin"></div>
  <div style="font-size:1rem;font-weight:600;">Loading data...</div>
</div>

<div class="layout">
<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <h2><i class="fas fa-layer-group"></i> AnnotateHQ</h2>
    <span>Data Annotation Platform</span>
  </div>
  <div class="nav-sec">Main</div>
  <button class="nav-item active" data-page="dashboard" onclick="switchPage('dashboard')"><i class="fas fa-th-large"></i> Dashboard</button>
  <button class="nav-item" data-page="projects" onclick="switchPage('projects')"><i class="fas fa-folder-open"></i> All Projects <span class="nav-badge" id="nb-proj">0</span></button>
  <button class="nav-item" data-page="employees" onclick="switchPage('employees')"><i class="fas fa-users"></i> Employees <span class="nav-badge" id="nb-emp">0</span></button>
  <button class="nav-item" data-page="workload" onclick="switchPage('workload')"><i class="fas fa-chart-bar"></i> Workload</button>
  <div class="nav-sec">Actions</div>
  <button class="nav-item" onclick="openProjModal()"><i class="fas fa-plus-circle"></i> New Project</button>
  <button class="nav-item" onclick="openEmpModal()"><i class="fas fa-user-plus"></i> Add Employee</button>
  <button class="nav-item" onclick="exportCSV()"><i class="fas fa-download"></i> Export CSV</button>
  <div class="sidebar-bottom">
    <button class="theme-btn" onclick="toggleTheme()"><i class="fas fa-moon" id="themeIco"></i><span id="themeLbl">Dark mode</span></button>
  </div>
</aside>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<main class="main">

<!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
<div class="page active" id="page-dashboard">
  <div class="topbar">
    <h1 class="page-title">Dashboard</h1>
    <div class="topbar-right">
      <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="Search projects..." id="globalSearch" oninput="handleSearch()"></div>
      <button class="btn btn-primary" onclick="openProjModal()"><i class="fas fa-plus"></i> New project</button>
    </div>
  </div>
  <div class="stat-grid" id="statGrid"></div>
  <div id="conflictBanner" style="display:none;" class="conflict-banner"><i class="fas fa-exclamation-triangle"></i><span id="conflictTxt"></span><button class="btn btn-ghost" style="margin-left:auto;padding:4px 11px;font-size:.72rem;" onclick="switchPage('employees')">View ‚Üí</button></div>
  <div class="filters-bar">
    <span style="font-size:.72rem;color:var(--text3);font-weight:700;">FILTER:</span>
    <button class="fchip active" onclick="setFilter('all',this)">All</button>
    <button class="fchip hi" onclick="setFilter('high',this)"><i class="fas fa-fire"></i> High</button>
    <button class="fchip me" onclick="setFilter('medium',this)"><i class="fas fa-minus"></i> Medium</button>
    <button class="fchip lo" onclick="setFilter('low',this)"><i class="fas fa-leaf"></i> Low</button>
    <select class="fsel" id="sortSel" onchange="renderProjects()">
      <option value="default">Sort: Default</option>
      <option value="name">Sort: Name A‚ÄìZ</option>
      <option value="progress">Sort: % Progress</option>
      <option value="deadline">Sort: Deadline</option>
      <option value="priority">Sort: Priority</option>
    </select>
  </div>
  <div class="proj-grid" id="projGrid"></div>
</div>

<!-- ‚îÄ‚îÄ ALL PROJECTS ‚îÄ‚îÄ -->
<div class="page" id="page-projects">
  <div class="topbar">
    <h1 class="page-title">All Projects</h1>
    <div class="topbar-right">
      <button class="btn btn-green" onclick="exportCSV()"><i class="fas fa-file-csv"></i> Export CSV</button>
      <button class="btn btn-primary" onclick="openProjModal()"><i class="fas fa-plus"></i> New project</button>
    </div>
  </div>
  <div class="proj-grid" id="projGridFull"></div>
</div>

<!-- ‚îÄ‚îÄ EMPLOYEES ‚îÄ‚îÄ -->
<div class="page" id="page-employees">
  <div class="topbar">
    <h1 class="page-title">Employees</h1>
    <div class="topbar-right">
      <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="Search name or email..." id="empSearch" oninput="renderEmployees()"></div>
      <button class="btn btn-primary" onclick="openEmpModal()"><i class="fas fa-user-plus"></i> Add employee</button>
    </div>
  </div>
  <div id="empConflictBanner" style="display:none;" class="conflict-banner"><i class="fas fa-exclamation-triangle"></i><span id="empConflictTxt"></span></div>
  <div class="emp-table-wrap">
    <table>
      <thead><tr>
        <th>#</th><th>Full Name</th><th>Email</th><th>Gender</th><th>Status</th><th>Assigned To</th><th>Actions</th>
      </tr></thead>
      <tbody id="empTableBody"></tbody>
    </table>
  </div>
</div>

<!-- ‚îÄ‚îÄ WORKLOAD ‚îÄ‚îÄ -->
<div class="page" id="page-workload">
  <div class="topbar"><h1 class="page-title">Workload Overview</h1></div>
  <div class="wl-card"><div style="font-size:.83rem;color:var(--text2);margin-bottom:14px;">Employees with at least one assignment are shown below.</div><div id="wlList"></div></div>
</div>

</main>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: PROJECT ‚ïê‚ïê‚ïê -->
<div class="overlay" id="projOverlay" onclick="closeProjModalIfBg(event)">
<div class="modal">
  <div class="modal-title"><i class="fas fa-folder-plus" style="color:var(--accent)"></i><span id="projModalTitle">New Project</span></div>
  <div class="form-grid">
    <div class="ff full"><label>Project name *</label><input type="text" id="fp-name" placeholder="e.g. Satellite buildings"></div>
    <div class="ff"><label>Priority</label>
      <select id="fp-priority">
        <option value="medium">‚ö° Medium</option>
        <option value="high">üî• High</option>
        <option value="low">üåø Low</option>
      </select>
    </div>
    <div class="ff"><label>Assigned By</label><input type="text" id="fp-assignedby" placeholder="e.g. Project Manager name"></div>
    <div class="ff"><label>Start Date</label><input type="date" id="fp-startdate"></div>
    <div class="ff"><label>Deadline</label><input type="date" id="fp-deadline"></div>
    <div class="ff"><label>Total Images</label><input type="number" id="fp-total" value="1000" min="0"></div>
    <div class="ff"><label>Annotated</label><input type="number" id="fp-annotated" value="0" min="0"></div>
    <div class="ff"><label>Reviewed</label><input type="number" id="fp-reviewed" value="0" min="0"></div>
    <div class="ff full"><label>Notes</label><textarea id="fp-notes" placeholder="Project notes..." style="min-height:55px;"></textarea></div>
    <div class="ff full"><label>Comments</label><textarea id="fp-comments" placeholder="Additional comments..." style="min-height:55px;"></textarea></div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-ghost" onclick="closeProjModal()">Cancel</button>
    <button class="btn btn-primary" onclick="saveProject()"><i class="fas fa-save"></i> Save project</button>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODAL: EMPLOYEE ‚ïê‚ïê‚ïê -->
<div class="overlay" id="empOverlay" onclick="closeEmpModalIfBg(event)">
<div class="modal" style="width:420px;">
  <div class="modal-title"><i class="fas fa-user-plus" style="color:var(--accent)"></i><span id="empModalTitle">Add Employee</span></div>
  <div class="form-grid">
    <div class="ff full"><label>Full Name *</label><input type="text" id="fe-name" placeholder="e.g. Ramyashree V R"></div>
    <div class="ff full"><label>Email ID *</label><input type="email" id="fe-email" placeholder="e.g. ramya@company.com"></div>
    <div class="ff full"><label>Gender</label>
      <select id="fe-gender">
        <option value="female">Female</option>
        <option value="male">Male</option>
      </select>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-ghost" onclick="closeEmpModal()">Cancel</button>
    <button class="btn btn-primary" onclick="saveEmployee()"><i class="fas fa-save"></i> Save employee</button>
  </div>
</div>
</div>

<!-- TOAST -->
<div class="toast-wrap" id="toastWrap"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SB_URL = 'https://phtzpswuqlixaroxhkmy.supabase.co';
const SB_KEY = 'sb_publishable_V1bOmccJ0AKXmRyV7bFctg_ka58Wb-L';
const sb = supabase.createClient(SB_URL, SB_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA ‚Äî real employee names
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let employees = [
  {id:'e1',  name:'Ramyashree V R',           email:'ramyashree@company.com',      gender:'female'},
  {id:'e2',  name:'Manoj Kumar Devanga Kotha',email:'manoj.devanga@company.com',   gender:'male'},
  {id:'e3',  name:'Dande Kalyani',             email:'dande.kalyani@company.com',   gender:'female'},
  {id:'e4',  name:'Dande Sandhya',             email:'dande.sandhya@company.com',   gender:'female'},
  {id:'e5',  name:'Challa Koteswaramma',       email:'challa.kotes@company.com',    gender:'female'},
  {id:'e6',  name:'Kadagandla Hariprasad',     email:'kadagandla.hari@company.com', gender:'male'},
  {id:'e7',  name:'Uma Krishnappa',            email:'uma.krishnappa@company.com',  gender:'female'},
  {id:'e8',  name:'Manjunath Kalakappa Bandihal',email:'manjunath.kb@company.com', gender:'male'},
  {id:'e9',  name:'Akshay Phatale',            email:'akshay.phatale@company.com',  gender:'male'},
  {id:'e10', name:'Maitra Salimath',           email:'maitra.salimath@company.com', gender:'female'},
  {id:'e11', name:'Yathish Gowda K H',         email:'yathish.gowda@company.com',   gender:'male'},
  {id:'e12', name:'Pavan Kalyan Yeddala',      email:'pavan.kalyan@company.com',    gender:'male'},
  {id:'e13', name:'Sabharmathi Selvam',        email:'sabharmathi@company.com',     gender:'female'},
  {id:'e14', name:'G Umesh',                   email:'g.umesh@company.com',         gender:'male'},
  {id:'e15', name:'Shilpa E',                  email:'shilpa.e@company.com',        gender:'female'},
  {id:'e16', name:'Prema Joshi',               email:'prema.joshi@company.com',     gender:'female'},
  {id:'e17', name:'Keerti Doddwad',            email:'keerti.doddwad@company.com',  gender:'female'},
  {id:'e18', name:'Ajay Reddy H',              email:'ajay.reddy@company.com',      gender:'male'},
  {id:'e19', name:'Varun Kumar H N',           email:'varun.kumar@company.com',     gender:'male'},
  {id:'e20', name:'Sneha B V',                 email:'sneha.bv@company.com',        gender:'female'},
  {id:'e21', name:'Fathima Reneesha',          email:'fathima.reneesha@company.com',gender:'female'},
  {id:'e22', name:'Vishruthi Raghu',           email:'vishruthi.raghu@company.com', gender:'female'},
  {id:'e23', name:'Sanjana G P',               email:'sanjana.gp@company.com',      gender:'female'},
  {id:'e24', name:'Dhanyasri A S',             email:'dhanyasri.as@company.com',    gender:'female'},
  {id:'e25', name:'Siddharth Anandan',         email:'siddharth.anandan@company.com',gender:'male'},
  {id:'e26', name:'Bindusree S N',             email:'bindusree.sn@company.com',    gender:'female'},
  {id:'e27', name:'Anil Kumar Pasala',         email:'anil.pasala@company.com',     gender:'male'},
  {id:'e28', name:'Mihir',                     email:'mihir@company.com',           gender:'male'},
  {id:'e29', name:'Suzan',                     email:'suzan@company.com',           gender:'female'},
  {id:'e30', name:'Umesh Nagappa Barker',      email:'umesh.barker@company.com',    gender:'male'},
  {id:'e31', name:'Sunil Kumar',               email:'sunil.kumar@company.com',     gender:'male'},
  {id:'e32', name:'Shanta Mantri',             email:'shanta.mantri@company.com',   gender:'female'},
  {id:'e33', name:'Nandini Keni',              email:'nandini.keni@company.com',    gender:'female'},
  {id:'e34', name:'Shweta Kannagar',           email:'shweta.kannagar@company.com', gender:'female'},
  {id:'e35', name:'Kishore Devaragudi',        email:'kishore.dev@company.com',     gender:'male'},
  {id:'e36', name:'Anil Gandreddi',            email:'anil.gandreddi@company.com',  gender:'male'},
  {id:'e37', name:'K Ganesh',                  email:'k.ganesh@company.com',        gender:'male'},
  {id:'e38', name:'Kiran Y',                   email:'kiran.y@company.com',         gender:'male'},
  {id:'e39', name:'Vishwas Reddy',             email:'vishwas.reddy@company.com',   gender:'male'},
];

let projects = [];
let currentFilter = 'all';
let searchQuery = '';
let editProjId = null;
let editEmpId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE ‚Äî PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProjects() {
  showLoading(true);
  try {
    const {data,error} = await sb.from('projects').select('*').order('created_at',{ascending:false});
    if (error) throw error;
    projects = (data||[]).map(r => ({
      id: r.id, name: r.name,
      total: r.total||0, annotated: r.annotated||0, reviewed: r.reviewed||0,
      priority: r.priority||'medium',
      startdate: r.startdate||'', deadline: r.deadline||'',
      assignedby: r.assignedby||'',
      notes: r.notes||'', comments: r.comments||'',
      assignedEmployees: r.assigned_employees ? r.assigned_employees.split(',').filter(Boolean) : []
    }));
    toast('Loaded from Supabase ‚úì','success');
  } catch(e) {
    console.error(e);
    toast('Supabase error: '+e.message,'error');
  } finally { showLoading(false); renderAll(); }
}

async function saveProjectToDB(p) {
  const row = {
    id:p.id, name:p.name,
    total:p.total, annotated:p.annotated, reviewed:p.reviewed,
    priority:p.priority,
    startdate:p.startdate||null, deadline:p.deadline||null,
    assignedby:p.assignedby||'',
    notes:p.notes||'', comments:p.comments||'',
    assigned_employees:(p.assignedEmployees||[]).join(',')
  };
  const {error} = await sb.from('projects').upsert(row);
  if (error) { toast('Save error: '+error.message,'error'); console.error(error); }
}

async function deleteProjFromDB(id) {
  const {error} = await sb.from('projects').delete().eq('id',id);
  if (error) toast('Delete error: '+error.message,'error');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE ‚Äî EMPLOYEES (optional persistence)
// We store employees in localStorage as backup
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveEmployeesLocal() {
  localStorage.setItem('ahq_employees', JSON.stringify(employees));
}
function loadEmployeesLocal() {
  try {
    const stored = localStorage.getItem('ahq_employees');
    if (stored) { const arr = JSON.parse(stored); if (arr.length > 0) employees = arr; }
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genId() { return crypto.randomUUID ? crypto.randomUUID() : 'id_'+Date.now()+'_'+Math.random().toString(36).substr(2,6); }
function esc(s) { return (s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function pct(a,b) { return b>0?Math.round((a/b)*100):0; }

function getAssignMap() {
  const m = new Map();
  projects.forEach(p => (p.assignedEmployees||[]).forEach(id => m.set(id,(m.get(id)||0)+1)));
  return m;
}
function isAvailable(empId, excludeProjId=null) {
  return !projects.some(p => p.id!==excludeProjId && (p.assignedEmployees||[]).includes(empId));
}
function getConflicts() {
  const m = getAssignMap();
  return [...m.entries()].filter(([,c])=>c>1).map(([id])=>id);
}
function fmtDate(d) {
  if (!d) return null;
  const dt = new Date(d+'T00:00:00');
  return dt.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
}
function deadlineMeta(d) {
  if (!d) return null;
  const dt = new Date(d+'T00:00:00');
  const diff = Math.ceil((dt - new Date())/86400000);
  return {label: fmtDate(d), diff};
}

function showLoading(v) { document.getElementById('loadingOverlay').style.display = v?'flex':'none'; }

function toast(msg,type='info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':type==='error'?'fa-times-circle':'fa-info-circle'}"></i>${msg}`;
  document.getElementById('toastWrap').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(p) {
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  document.querySelector(`[data-page="${p}"]`)?.classList.add('active');
  if (p==='employees') renderEmployees();
  if (p==='workload') renderWorkload();
  if (p==='projects') renderProjFull();
}

function renderAll() { renderProjects(); renderStats(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStats() {
  const totalImg = projects.reduce((s,p)=>s+(+p.total||0),0);
  const totalAnn = projects.reduce((s,p)=>s+(+p.annotated||0),0);
  const totalRev = projects.reduce((s,p)=>s+(+p.reviewed||0),0);
  const assigned = new Set(projects.flatMap(p=>p.assignedEmployees||[])).size;
  const conflicts = getConflicts().length;

  document.getElementById('statGrid').innerHTML = [
    {lbl:'Projects',       val:projects.length,          sub:`${projects.filter(p=>p.priority==='high').length} high priority`, cls:'',       ico:'fa-folder-open'},
    {lbl:'Total Images',   val:totalImg.toLocaleString(), sub:`${pct(totalAnn,totalImg)}% annotated`,             cls:'',       ico:'fa-images'},
    {lbl:'Annotated',      val:totalAnn.toLocaleString(), sub:`${pct(totalAnn,totalImg)}% done`,                  cls:'green',  ico:'fa-check-circle'},
    {lbl:'Reviewed',       val:totalRev.toLocaleString(), sub:`${pct(totalRev,totalImg)}% done`,                  cls:'yellow', ico:'fa-eye'},
    {lbl:'Employees Total',val:employees.length,          sub:`${assigned} assigned, ${employees.length-assigned} free`, cls:'purple',ico:'fa-users'},
    {lbl:'Conflicts',      val:conflicts,                 sub:conflicts>0?'double-booked!':'All clear ‚úì',         cls:conflicts>0?'red':'', ico:'fa-exclamation-triangle'},
  ].map(c=>`<div class="stat-card ${c.cls}">
    <div class="stat-lbl">${c.lbl}</div>
    <div class="stat-val">${c.val}</div>
    <div class="stat-sub">${c.sub}</div>
    <i class="fas ${c.ico} stat-ico"></i>
  </div>`).join('');

  document.getElementById('nb-proj').textContent = projects.length;
  document.getElementById('nb-emp').textContent = employees.length;

  const cc = getConflicts();
  const cb = document.getElementById('conflictBanner');
  if (cc.length>0) {
    cb.style.display='flex';
    document.getElementById('conflictTxt').textContent = `‚ö† ${cc.length} employee(s) double-booked: ${cc.map(id=>employees.find(e=>e.id===id)?.name||id).join(', ')}`;
  } else cb.style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD PROJECT CARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildCard(proj, aMap) {
  const T=+proj.total||0, A=+proj.annotated||0, R=+proj.reviewed||0;
  const annPct=pct(A,T), revPct=pct(R,T);
  const pendA=Math.max(T-A,0), pendR=Math.max(A-R,0);
  const assigned=proj.assignedEmployees||[];
  const dl = deadlineMeta(proj.deadline);
  const isOverdue = dl && dl.diff<0;
  const isSoon = dl && dl.diff>=0 && dl.diff<=7;
  const pLabel = {high:'üî• High',medium:'‚ö° Medium',low:'üåø Low'}[proj.priority]||'‚ö° Medium';

  // Available employees for multi-select (not already assigned to ANY project except this one)
  const availEmps = employees.filter(e => !assigned.includes(e.id) && isAvailable(e.id, proj.id));

  const assignedTags = assigned.map(id => {
    const emp = employees.find(e=>e.id===id)||{name:'Unknown'};
    const conflict = (aMap.get(id)||0)>1;
    return `<span class="asn-tag ${conflict?'conflict':''}">
      ${conflict?'‚ö† ':''}${esc(emp.name)}
      <button onclick="removeEmp('${proj.id}','${id}')"><i class="fas fa-times"></i></button>
    </span>`;
  }).join('');

  const empOptions = availEmps.map(e=>`<option value="${e.id}">${esc(e.name)}</option>`).join('');

  return `<div class="proj-card" id="card-${proj.id}">
    <div class="card-top">
      <div class="card-title-row">
        <span class="card-title">${esc(proj.name)}</span>
        <div class="card-acts">
          <button class="icon-btn" onclick="openEditProjModal('${proj.id}')" title="Edit"><i class="fas fa-pen"></i></button>
          <button class="icon-btn del" onclick="deleteProj('${proj.id}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>
      <div class="card-meta">
        <span class="badge badge-${proj.priority}">${pLabel}</span>
        ${proj.startdate?`<span class="meta-it"><i class="fas fa-play-circle"></i> Start: ${fmtDate(proj.startdate)}</span>`:''}
        ${dl?`<span class="meta-it ${isOverdue?'overdue':isSoon?'soon':''}"><i class="fas fa-calendar-alt"></i> Due: ${dl.label} ${isOverdue?'(Overdue)':isSoon?`(${dl.diff}d left)`:''}</span>`:''}
      </div>
      ${proj.assignedby?`<div class="assigned-by-row"><i class="fas fa-user-tie"></i> Assigned by: <strong>${esc(proj.assignedby)}</strong></div>`:''}
      <!-- Inline editable numbers -->
      <div class="num-grid">
        <div class="num-cell"><input type="number" value="${T}" min="0" onchange="updateField('${proj.id}','total',this.value)"><span class="nl">Total</span></div>
        <div class="num-cell"><input type="number" value="${A}" min="0" onchange="updateField('${proj.id}','annotated',this.value)"><span class="nl">Annotated</span></div>
        <div class="num-cell"><input type="number" value="${R}" min="0" onchange="updateField('${proj.id}','reviewed',this.value)"><span class="nl">Reviewed</span></div>
        <div class="num-cell num-computed"><div class="nv">${pendA}</div><span class="nl">Pend.Ann</span></div>
        <div class="num-cell num-computed"><div class="nv" style="color:var(--purple)">${pendR}</div><span class="nl">Pend.Rev</span></div>
      </div>
    </div>

    <!-- PROGRESS -->
    <div class="prog-section">
      <div class="prog-row"><span class="prog-lbl">Annotation</span><span class="prog-pct">${annPct}%</span></div>
      <div class="prog-bar"><div class="prog-fill pf-ann" style="width:${annPct}%"></div></div>
      <div class="prog-row"><span class="prog-lbl">Review</span><span class="prog-pct">${revPct}%</span></div>
      <div class="prog-bar"><div class="prog-fill pf-rev" style="width:${revPct}%"></div></div>
    </div>

    <!-- ASSIGNEES ‚Äî multi-select -->
    <div class="asn-section">
      <div class="sec-hdr"><i class="fas fa-users"></i> Assigned Employees (${assigned.length})</div>
      ${availEmps.length>0?`
      <select class="emp-select-multi" id="ms-${proj.id}" multiple size="4">
        ${empOptions}
      </select>
      <div class="select-hint">Hold <strong>Ctrl</strong> (Windows) or <strong>‚åò Cmd</strong> (Mac) to select multiple</div>
      <button class="btn btn-primary" style="margin-top:8px;padding:6px 14px;font-size:.78rem;" onclick="assignMultiple('${proj.id}')"><i class="fas fa-plus"></i> Assign selected</button>
      `:`<div style="font-size:.78rem;color:var(--text3);margin-bottom:8px;">All available employees assigned.</div>`}
      <div class="asn-tags" style="margin-top:10px;">
        ${assignedTags||'<span style="color:var(--text3);font-size:.76rem;">No employees assigned yet</span>'}
      </div>
    </div>

    <!-- NOTES -->
    ${proj.notes?`<div class="cmt-section" style="border-top:1px solid var(--border);">
      <div class="sec-hdr"><i class="fas fa-sticky-note"></i> Notes</div>
      <div style="font-size:.82rem;color:var(--text2);">${esc(proj.notes)}</div>
    </div>`:''}

    <!-- COMMENTS -->
    <div class="cmt-section" style="border-top:1px solid var(--border);">
      <div class="sec-hdr"><i class="fas fa-comments"></i> Comments</div>
      <textarea class="cmt-textarea" id="cmt-${proj.id}" placeholder="Type a comment here...">${esc(proj.comments||'')}</textarea>
      <button class="btn btn-ghost save-cmt-btn" onclick="saveComment('${proj.id}')"><i class="fas fa-save"></i> Save comment</button>
    </div>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFiltered() {
  const sort = document.getElementById('sortSel')?.value||'default';
  let list = [...projects];
  if (currentFilter!=='all') list=list.filter(p=>p.priority===currentFilter);
  if (searchQuery) {
    const q=searchQuery.toLowerCase();
    list=list.filter(p=>
      p.name.toLowerCase().includes(q)||
      (p.notes||'').toLowerCase().includes(q)||
      (p.comments||'').toLowerCase().includes(q)||
      (p.assignedby||'').toLowerCase().includes(q)||
      (p.assignedEmployees||[]).some(id=>employees.find(e=>e.id===id)?.name.toLowerCase().includes(q))
    );
  }
  if (sort==='name') list.sort((a,b)=>a.name.localeCompare(b.name));
  else if (sort==='progress') list.sort((a,b)=>pct(b.annotated,b.total)-pct(a.annotated,a.total));
  else if (sort==='deadline') list.sort((a,b)=>(a.deadline||'9999').localeCompare(b.deadline||'9999'));
  else if (sort==='priority') { const w={high:0,medium:1,low:2}; list.sort((a,b)=>(w[a.priority]||1)-(w[b.priority]||1)); }
  return list;
}

function renderProjects() {
  const list=getFiltered(), aMap=getAssignMap();
  const grid=document.getElementById('projGrid');
  grid.innerHTML = list.length===0
    ? `<div class="empty" style="grid-column:1/-1;"><i class="fas fa-folder-open"></i><h3>No projects found</h3><p>Adjust filters or add a new project.</p></div>`
    : list.map(p=>buildCard(p,aMap)).join('');
  renderStats();
}

function renderProjFull() {
  const aMap=getAssignMap();
  document.getElementById('projGridFull').innerHTML = projects.map(p=>buildCard(p,aMap)).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIELD EDITS & COMMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updateField(id,field,val) {
  const p=projects.find(x=>x.id===id); if(!p) return;
  p[field]=Math.max(0,parseInt(val)||0);
  renderProjects();
  await saveProjectToDB(p);
  toast('Saved ‚úì','success');
}

async function saveComment(projId) {
  const p=projects.find(x=>x.id===projId); if(!p) return;
  p.comments = document.getElementById(`cmt-${projId}`)?.value||'';
  await saveProjectToDB(p);
  toast('Comment saved ‚úì','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMPLOYEE ASSIGNMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function assignMultiple(projId) {
  const sel = document.getElementById(`ms-${projId}`);
  if (!sel) return;
  const chosen = [...sel.selectedOptions].map(o=>o.value);
  if (chosen.length===0) { toast('Please select at least one employee','error'); return; }
  const proj=projects.find(p=>p.id===projId); if(!proj) return;
  if (!proj.assignedEmployees) proj.assignedEmployees=[];
  let added=0;
  chosen.forEach(empId => {
    if (!isAvailable(empId,projId)) { toast(`${employees.find(e=>e.id===empId)?.name} already assigned elsewhere!`,'error'); return; }
    if (!proj.assignedEmployees.includes(empId)) { proj.assignedEmployees.push(empId); added++; }
  });
  if (added>0) { toast(`${added} employee(s) assigned ‚úì`,'success'); renderProjects(); await saveProjectToDB(proj); }
}

async function removeEmp(projId,empId) {
  const proj=projects.find(p=>p.id===projId); if(!proj) return;
  proj.assignedEmployees=(proj.assignedEmployees||[]).filter(e=>e!==empId);
  toast('Employee removed','info');
  renderProjects();
  await saveProjectToDB(proj);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE PROJECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function deleteProj(id) {
  if (!confirm('Delete this project? This cannot be undone.')) return;
  projects=projects.filter(p=>p.id!==id);
  toast('Project deleted','info');
  renderProjects();
  await deleteProjFromDB(id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProjModal() {
  editProjId=null;
  document.getElementById('projModalTitle').textContent='New Project';
  document.getElementById('fp-name').value='';
  document.getElementById('fp-priority').value='medium';
  document.getElementById('fp-assignedby').value='';
  document.getElementById('fp-startdate').value='';
  document.getElementById('fp-deadline').value='';
  document.getElementById('fp-total').value='1000';
  document.getElementById('fp-annotated').value='0';
  document.getElementById('fp-reviewed').value='0';
  document.getElementById('fp-notes').value='';
  document.getElementById('fp-comments').value='';
  document.getElementById('projOverlay').classList.add('open');
}
function openEditProjModal(id) {
  const p=projects.find(x=>x.id===id); if(!p) return;
  editProjId=id;
  document.getElementById('projModalTitle').textContent='Edit Project';
  document.getElementById('fp-name').value=p.name;
  document.getElementById('fp-priority').value=p.priority||'medium';
  document.getElementById('fp-assignedby').value=p.assignedby||'';
  document.getElementById('fp-startdate').value=p.startdate||'';
  document.getElementById('fp-deadline').value=p.deadline||'';
  document.getElementById('fp-total').value=p.total;
  document.getElementById('fp-annotated').value=p.annotated;
  document.getElementById('fp-reviewed').value=p.reviewed;
  document.getElementById('fp-notes').value=p.notes||'';
  document.getElementById('fp-comments').value=p.comments||'';
  document.getElementById('projOverlay').classList.add('open');
}
function closeProjModal() { document.getElementById('projOverlay').classList.remove('open'); }
function closeProjModalIfBg(e) { if(e.target===document.getElementById('projOverlay')) closeProjModal(); }

async function saveProject() {
  const name=document.getElementById('fp-name').value.trim();
  if (!name) { toast('Project name is required','error'); return; }
  const data={
    name,
    priority: document.getElementById('fp-priority').value,
    assignedby: document.getElementById('fp-assignedby').value.trim(),
    startdate: document.getElementById('fp-startdate').value,
    deadline: document.getElementById('fp-deadline').value,
    total: parseInt(document.getElementById('fp-total').value)||0,
    annotated: parseInt(document.getElementById('fp-annotated').value)||0,
    reviewed: parseInt(document.getElementById('fp-reviewed').value)||0,
    notes: document.getElementById('fp-notes').value.trim(),
    comments: document.getElementById('fp-comments').value.trim(),
  };
  let proj;
  if (editProjId) {
    const idx=projects.findIndex(p=>p.id===editProjId);
    if (idx>-1) { Object.assign(projects[idx],data); proj=projects[idx]; toast('Project updated ‚úì','success'); }
  } else {
    proj={id:genId(),assignedEmployees:[],...data};
    projects.push(proj);
    toast('Project created ‚úì','success');
  }
  closeProjModal(); renderProjects();
  if (proj) await saveProjectToDB(proj);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMPLOYEE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEmpModal(id=null) {
  editEmpId=id;
  if (id) {
    const e=employees.find(x=>x.id===id); if(!e) return;
    document.getElementById('empModalTitle').textContent='Edit Employee';
    document.getElementById('fe-name').value=e.name;
    document.getElementById('fe-email').value=e.email;
    document.getElementById('fe-gender').value=e.gender;
  } else {
    document.getElementById('empModalTitle').textContent='Add Employee';
    document.getElementById('fe-name').value='';
    document.getElementById('fe-email').value='';
    document.getElementById('fe-gender').value='female';
  }
  document.getElementById('empOverlay').classList.add('open');
}
function closeEmpModal() { document.getElementById('empOverlay').classList.remove('open'); }
function closeEmpModalIfBg(e) { if(e.target===document.getElementById('empOverlay')) closeEmpModal(); }

function saveEmployee() {
  const name=document.getElementById('fe-name').value.trim();
  const email=document.getElementById('fe-email').value.trim();
  const gender=document.getElementById('fe-gender').value;
  if (!name) { toast('Name is required','error'); return; }
  if (!email) { toast('Email is required','error'); return; }
  if (editEmpId) {
    const idx=employees.findIndex(e=>e.id===editEmpId);
    if (idx>-1) { employees[idx]={...employees[idx],name,email,gender}; toast('Employee updated ‚úì','success'); }
  } else {
    employees.push({id:'e_'+Date.now(),name,email,gender});
    toast('Employee added ‚úì','success');
  }
  saveEmployeesLocal();
  closeEmpModal(); renderEmployees(); renderStats();
}

function deleteEmployee(id) {
  if (!confirm('Remove this employee?')) return;
  employees=employees.filter(e=>e.id!==id);
  // also remove from all projects
  projects.forEach(p=>{ p.assignedEmployees=(p.assignedEmployees||[]).filter(e=>e!==id); });
  saveEmployeesLocal();
  renderEmployees(); renderStats();
  toast('Employee removed','info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER EMPLOYEES TABLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEmployees() {
  const aMap=getAssignMap();
  const conflicts=getConflicts();
  const q=(document.getElementById('empSearch')?.value||'').toLowerCase();
  const list=q?employees.filter(e=>e.name.toLowerCase().includes(q)||e.email.toLowerCase().includes(q)):employees;

  const cb=document.getElementById('empConflictBanner');
  if (conflicts.length>0) {
    cb.style.display='flex';
    document.getElementById('empConflictTxt').textContent=`‚ö† Double-booking: ${conflicts.map(id=>employees.find(e=>e.id===id)?.name||id).join(', ')}`;
  } else cb.style.display='none';

  document.getElementById('empTableBody').innerHTML = list.map((emp,i)=>{
    const cnt=aMap.get(emp.id)||0;
    const projs=projects.filter(p=>(p.assignedEmployees||[]).includes(emp.id));
    const statusCls=cnt>1?'emp-status-conflict':cnt===1?'emp-status-assigned':'emp-status-free';
    const statusTxt=cnt>1?`‚ö† In ${cnt} projects (CONFLICT)`:cnt===1?`‚úì ${projs[0]?.name}`:'Free';
    const genderCls=emp.gender==='male'?'gender-m':'gender-f';
    const genderTxt=emp.gender==='male'?'‚ôÇ Male':'‚ôÄ Female';
    return `<tr>
      <td style="color:var(--text3);font-size:.78rem;">${i+1}</td>
      <td><strong>${esc(emp.name)}</strong></td>
      <td style="color:var(--text2);font-size:.8rem;">${esc(emp.email)}</td>
      <td><span class="${genderCls}">${genderTxt}</span></td>
      <td><span class="${statusCls}">${statusTxt}</span></td>
      <td style="font-size:.78rem;color:var(--text3);">${projs.map(p=>esc(p.name)).join(', ')||'‚Äî'}</td>
      <td>
        <button class="icon-btn" onclick="openEmpModal('${emp.id}')" title="Edit"><i class="fas fa-pen"></i></button>
        <button class="icon-btn del" onclick="deleteEmployee('${emp.id}')" title="Remove"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWorkload() {
  const aMap=getAssignMap();
  const active=[...aMap.entries()].filter(([,c])=>c>0).sort((a,b)=>b[1]-a[1]);
  if (active.length===0) { document.getElementById('wlList').innerHTML='<div class="empty"><i class="fas fa-chart-bar"></i><h3>No assignments yet.</h3></div>'; return; }
  const max=Math.max(...active.map(([,c])=>c));
  document.getElementById('wlList').innerHTML=active.map(([id,cnt])=>{
    const emp=employees.find(e=>e.id===id);
    const projs=projects.filter(p=>(p.assignedEmployees||[]).includes(id));
    const bar=Math.round((cnt/max)*100);
    const isC=cnt>1;
    return `<div class="wl-row">
      <span class="wl-name">${emp?.name||id}</span>
      <span class="wl-projs">${projs.map(p=>p.name).join(' ¬∑ ')}</span>
      <div class="wl-bar-wrap">
        <div class="prog-bar" style="height:7px;"><div class="prog-fill ${isC?'':'pf-ann'}" style="width:${bar}%;${isC?'background:var(--red)':''}"></div></div>
        <div style="font-size:.68rem;color:${isC?'var(--red)':'var(--text3)'};margin-top:2px;text-align:right;">${cnt} project${cnt>1?'s':''} ${isC?'‚ö† CONFLICT':''}</div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS / SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFilter(val,el) {
  currentFilter=val;
  document.querySelectorAll('.fchip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); renderProjects();
}
function handleSearch() { searchQuery=document.getElementById('globalSearch').value; renderProjects(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
  const hdr=['Project Name','Priority','Assigned By','Start Date','Deadline','Total','Annotated','Reviewed','Pend.Annotation','Pend.Review','% Annotated','% Reviewed','Assigned Employees','Notes','Comments'];
  const rows=projects.map(p=>{
    const T=+p.total||0,A=+p.annotated||0,R=+p.reviewed||0;
    const emps=(p.assignedEmployees||[]).map(id=>employees.find(e=>e.id===id)?.name||id).join('; ');
    return [
      `"${p.name}"`,p.priority,`"${p.assignedby||''}"`,p.startdate||'',p.deadline||'',
      T,A,R,Math.max(T-A,0),Math.max(A-R,0),pct(A,T)+'%',pct(R,T)+'%',
      `"${emps}"`,`"${(p.notes||'').replace(/"/g,'""')}"`,`"${(p.comments||'').replace(/"/g,'""')}"`
    ].join(',');
  });
  const csv=[hdr.join(','),...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='annotation_projects.csv'; a.click();
  URL.revokeObjectURL(url);
  toast('CSV exported ‚úì','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme() {
  const dark=document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme',dark?'light':'dark');
  document.getElementById('themeIco').className=dark?'fas fa-moon':'fas fa-sun';
  document.getElementById('themeLbl').textContent=dark?'Dark mode':'Light mode';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadEmployeesLocal(); // load any previously added employees from local storage
loadProjects();       // load projects from Supabase
</script>
</body>
</html>
